"use strict";(self.webpackChunkreportServerHostModern=self.webpackChunkreportServerHostModern||[]).push([["insights"],{32488:function(Ie,ue,c){c.d(ue,{Me:function(){return ie},No:function(){return le},S7:function(){return ce},d6:function(){return oe},jo:function(){return w},nO:function(){return C},u1:function(){return re}});var C=40,w=16e3,ie=10,le=15e3,oe=10,ce=15,re="https://go.microsoft.com/fwlink/?LinkId=692069"},99266:function(Ie,ue,c){c.r(ue),c.d(ue,{InsightsModule:function(){return St}});var C=c(81337),w=c(4008),ie=c(72951),le=c(29767),oe=c(26898),ce=c(49092),re=c(38982),b=c(48145),F=c(83008),I=c(88565),j=c(3887),G=c(83342),ne=c(47639),ye=c(45114),H=c(1409),je=c(50522),se=c(47508),ze=c(56045),y=c(62458),me=c(47961),pe=c(82755),Pe=c(94477),O=c(95462),z=c(94419),Z=c(74082),Y=c(45413),Be=c(75074),ge=c(45551),de=c(58295),x=c(50423),Se="keyDrivers",Qe=ze.us,We={provide:"insightsAnalysisDefinitionBuilder",useFactory:function(s,e,t,r,n,i){return new Promise(function(a){a(new Ue(s,e,t,r,n,i))})},deps:[oe.i,b.U,F.D,I.S,ce.d,G.vZ]},Ue=function(){function s(e,t,r,n,i,a){this.conceptualSchemaProxy=e,this.explorationCapabilities=t,this.dataSources=r,this.visualQueryGenerator=n,this.dataProxy=i,this.featureSwitchService=a}return s.prototype.buildAnalysisDefinition=function(e,t,r,n,i){return(0,C.mG)(this,void 0,void 0,function(){var a;return(0,C.Jh)(this,function(o){switch(y.fF.assertValue(e,"visualType"),y.fF.assertValue(t,"visualQuery"),y.fF.assertAnyValue(r,"objects"),y.fF.assertAnyValue(n,"filter"),y.fF.assertAnyValue(i,"previousAnalysisDefinition"),a=new ye.g(t.defn.rewrite(new ie.X),t.projections,t.expansionStates),e){case se.L.keyDriversVisual.name:return[2,this.buildKeyDriversAnalysisDefinition(a,r,n,i)];case se.L.decompositionTreeVisual.name:return[2,this.buildDecompositionTreeAnalysisDefinition(a,n,r)];default:y.fF.assertFail("Unknown visual type")}return[2]})})},s.prototype.buildDecompositionTreeAnalysisDefinition=function(e,t,r){return(0,C.mG)(this,void 0,void 0,function(){var n,i,a,o,u,l,f,p,h,v,d,m,g,E,A,T,S,V,M,L;return(0,C.Jh)(this,function(k){switch(k.label){case 0:if(n=e.tryGetExpr(H.Fw.analyze,0),i=e.tryGetExprs(H.Fw.explainBy),a=(0,pe.NA)(r,{objectName:H.I8.analysis,propertyName:H.hq.aiEnabled},!0),o=(0,pe.NA)(r,{objectName:H.I8.analysis,propertyName:H.hq.aiMode},"absolute"),!a&&(u=(0,me.D5)(e.expansionStates,H.Fw.explainBy)))for(l=0;l<_.size(u.levels);l++)u.setAILevelInformation(l,void 0);return n?[4,this.conceptualSchemaProxy.get(this.dataSources.get())]:[2,{error:{code:0},isComplete:!1,canExecute:a,analysisType:"DecompositionTree"}];case 1:return f=k.sent(),p=(0,j.W)(n,this.explorationCapabilities.getCapabilities(),f),!(0,de.k)(n)||(0,Z.ez)(n)&&(0,ge.cH)(n)?[2,{error:{code:1},isComplete:!1,canExecute:a,analysisType:"DecompositionTree"}]:(h=e.getRolesUniqueProjectionRefs([H.Fw.explainBy]),v=_.map(h,function(D,W){return(0,me.DX)(e.expansionStates,[H.Fw.explainBy],W)}),d=_.findIndex(v,function(D){return D&&!D.disabled}),m=_.findLastIndex(v,function(D){return D}),g=-1===d?[]:_.slice(v,d,m+1),_.forEach(g,function(D){return y.fF.assertValue(D,"AI levels must be contiguous")}),g=_.takeWhile(g,function(D){return D}),E=(0,me.sz)(e.expansionStates,[H.Fw.explainBy]),A=e.getRolesActiveProjectionsRefs([H.Fw.explainBy],!0),y.fF.assert(function(){return _.size(g)<=E}),T=_.take((0,re.w9)(e,[H.Fw.explainBy]),d),S=_.size(A)>0&&_.size(g)>0&&_.size(T)>=d,V=O.yl.merge(_.map(T,function(D){return O.yl.fromSQExpr(D)})),M=_.map(g,function(D){return(0,w.zU)((0,w.N_)(D.method),o)}),L=this.liftFilterToSubquery(e,t),S&&a&&!p?[2,{error:{code:2},isComplete:!0,canExecute:!1,analysisType:"DecompositionTree"}]:[2,{definition:{findDecompositions:{target:n,dimensions:_.slice(i,E-g.length),filters:L,methods:S&&a&&p?M:void 0,path:V}},isComplete:S,canExecute:a&&p,warning:void 0,analysisType:"DecompositionTree"}])}})})},s.prototype.buildKeyDriversAnalysisDefinition=function(e,t,r,n){return(0,C.mG)(this,void 0,void 0,function(){var i,a,o,u,l,p,h,v,d,m,g,E,T,S,V,M,L,k,D,W,U,R,K,te,J,X;return(0,C.Jh)(this,function($){switch($.label){case 0:return[4,this.conceptualSchemaProxy.get(this.dataSources.get())];case 1:if(i=$.sent(),o=e.tryGetExpr((a=je.qG).target,0),u=e.tryGetExprs(a.explainBy),l=e.tryGetExprs(a.details),!_.some(i.schemas,function(P){return P.capabilities.insights.supportsKeyDrivers}))return[2,{error:{code:0},isComplete:!1,canExecute:!1,analysisType:"KeyDrivers"}];if(_.some(i.schemas,function(P){return P.capabilities.supportsDataSourceVariables}))return[2,{error:{code:7},isComplete:!1,canExecute:!1,analysisType:"KeyDrivers"}];if(!o)return[2,{error:{code:1},isComplete:!1,canExecute:!0,analysisType:"KeyDrivers"}];if(!(0,w.wg)(o,i))return[2,{error:{code:2},isComplete:!1,canExecute:!1,analysisType:"KeyDrivers"}];if(_.some(u,function(P){var fe=P.getTargetSchemaName(),ae=i.schema(fe);return ae&&ae.isExtensionSchema}))return[2,{error:{code:4},isComplete:!1,canExecute:!1,analysisType:"KeyDrivers"}];if(p=o&&o.getMetadata(i),h=p&&p.type&&(p.type.numeric||p.type.integer),v=o&&(0,de.k)(o),d=1,v){if(_.some(i.schemas,function(P){return!P.capabilities.supportsSubqueryRegrouping}))return[2,{error:{code:8},isComplete:!1,canExecute:!1,analysisType:"KeyDriversContinuous"}]}else{if(_.some(i.schemas,function(P){return P.capabilities.discourageQueryAggregateUsage}))return[2,{error:{code:9},isComplete:!1,canExecute:!1,analysisType:"KeyDriversCategorical"}];_.some(i.schemas,function(P){return P.capabilities.supportsExtensionColumns})||(d&=-2)}return _.isEmpty(l)||v?!(E=t?(0,pe.NA)(t,{objectName:Se,propertyName:"selectedNumericAnalysis"},void 0):void 0)&&h||v||E===Qe&&h?(T="KeyDriversContinuous",S=(0,pe.NA)(t,{objectName:Se,propertyName:"numericTargetSelectedKind"},0),(0,de.k)(o)||(V=O.yl.fromSQExpr((0,z.ff)((0,z.qu)(0,o,(0,z.IF)()))),r=r?O.yl.merge([r,V]):V),m={continuous:{expression:o,kind:S}},[3,5]):[3,2]:[2,{error:{code:6},isComplete:!1,canExecute:!1,analysisType:"KeyDrivers"}];case 2:return T="KeyDriversCategorical",M=(0,pe.NA)(t,{objectName:Se,propertyName:"targetValue"},void 0),k=(L=n&&n.findKeyDrivers&&n.findKeyDrivers.target)&&L.categorical&&L.categorical.expression,[4,this.conceptualSchemaProxy.get(this.dataSources.get())];case 3:return D=$.sent(),W=o.getKeyColumns(D),y.fF.assert(function(){return 1===_.size(W)},"only support 1 groupon key"),U=k&&k.getKeyColumns(D),y.fF.assert(function(){return!U||1===_.size(U)},"only 1 groupon key supported"),[4,(0,w.wW)(W[0],r,D,this.dataProxy,this.dataSources,this.visualQueryGenerator)];case 4:if(!(R=$.sent()))return[2,{error:{code:10},isComplete:!1,canExecute:!1,analysisType:"KeyDriversCategorical"}];if(R.error)return[2,{error:{code:11,details:R.error},isComplete:!1,canExecute:!1,analysisType:"KeyDriversCategorical"}];y.fF.assertValue(R.result,"either result of error has to be set"),(K=R.result).count>10&&(g=1),(L&&L.continuous||!M||U&&!(0,Y.fS)(W[0],U[0]))&&(M=(0,Pe.CI)(K.firstValue,W[0].getMetadata(D).type)),te=(0,ne.bE)(M),J=O.yl.fromSQExpr((0,z.Sh)([W[0]],[[te]])),m={categorical:{expression:o,targetValue:J}},$.label=5;case 5:return X=!0,_.isEmpty(u)&&(g=0,X=!1),[2,{definition:{findKeyDrivers:{target:m,filters:r,predictors:u,details:l,options:d}},warning:g,isComplete:X,canExecute:!0,analysisType:T}]}})})},s.prototype.liftFilterToSubquery=function(e,t){if(!t||!e)return t;for(var r=[],n=[],i=0,a=t.where();i<a.length;i++){var o=a[i];if(!_.isEmpty(o.target)&&o.condition){var u=new He;o.condition.accept(u),u.hasMeasure?r.push(o):n.push(o)}else n.push(o)}if(_.isEmpty(r))return t;var l=e.defn;l=l.addSemanticFilter(t);var f=O.yl.fromMeasureFilters(l,r,null),p=O.vQ.createWith({from:l.from(),select:l.select(),orderBy:l.orderBy(),top:l.top(),transforms:l.transforms(),groupBy:l.groupBy(),where:n});return p=p.addSemanticFilter(f),O.yl.fromSQFromAndSQFilters(p.from(),p.where())},s.prototype.getClientError=function(e){return(0,le.EL)(e,new Je)},s.prototype.getClientWarning=function(e){return(0,le.hj)(e,new Ze)},s.\u0275fac=function(t){return new(t||s)(x.\u0275\u0275inject(oe.i),x.\u0275\u0275inject(b.U),x.\u0275\u0275inject(F.D),x.\u0275\u0275inject(I.S),x.\u0275\u0275inject(ce.d),x.\u0275\u0275inject(G.vZ))},s.\u0275prov=x.\u0275\u0275defineInjectable({token:s,factory:s.\u0275fac}),s}(),He=function(s){function e(){return null!==s&&s.apply(this,arguments)||this}return(0,C.ZT)(e,s),e.prototype.visitMeasureRef=function(t){this.hasMeasure=!0},e.prototype.visitAggr=function(t){this.hasMeasure=!0},e.prototype.visitNativeMeasure=function(t){this.hasMeasure=!0},e}(Be.PA),Ze=function(){function s(){}return s.prototype.visitDecompositionTree=function(e){},s}(),Je=function(){function s(){}return s.prototype.visitDecompositionTree=function(e){var t=this.getErrorInfoKeys(e);return{code:t.errorInfoValue,source:"User",debugInfo:void 0,ignorable:!1,requestId:void 0,getDetails:function(n){return{message:n.get(t.errorInfoValue),displayableErrorInfo:[{errorInfoKey:n.get(t.errorInfoKey),errorInfoValue:n.get(t.errorInfoValue)}]}}}},s.prototype.visitExplainAnomalies=function(e){},s.prototype.getErrorInfoKeys=function(e){switch(e){case 0:return{errorInfoKey:"VisualContainer_FailedToLoadVisual",errorInfoValue:"DecompositionTree_Error_NoTargetMeasure"};case 1:return{errorInfoKey:"VisualContainer_FailedToLoadVisual",errorInfoValue:"AnalysisVisual_Error_UnsupportedTarget"};case 2:return{errorInfoKey:"DecompositionTree_AnalysisUnsupported_Title",errorInfoValue:"DecompositionTree_AnalysisUnsupported_Description"};default:return y.fF.assertFail("Unhandled error in builder result: ".concat(e)),{errorInfoKey:"VisualContainer_FailedToLoadVisual",errorInfoValue:"AnalysisVisual_Error_Generic"}}},s}(),Xe=c(7886),ve=c(3579),N=c(60661),q=c(32379),ke=c(74711),he=c(5265),Ee=c(78843),$e=c(26743),Ye=c(23320),qe=c(79006),xe=c(29866),Ve=function(){function s(e,t,r,n,i){this.dataSources=e,this.conceptualSchemaProxy=t,this.decompositionAuthoringCore=r,this.expandCollapseService=n,this.visualPlugin=i}return s.prototype.processAnalysisResult=function(e,t){return(0,C.mG)(this,void 0,void 0,function(){var r,n,i,a,o,u,l,f,p,h,v,d,m,g,E,A,T,S,V,L,D=this;return(0,C.Jh)(this,function(W){switch(W.label){case 0:return y.fF.assertValue(e,"visualContainer not defined"),y.fF.assertAnyValue(t," findDecompositions can be undefined when there is analysis error."),r=this.visualPlugin.capabilities((0,ve.s)(e)),y.fF.assertValue(i=(n=r&&r.insights&&r.insights.decomposition)&&n.explainByRole,"Capabilities is missing explainBy role"),a=this.decompositionAuthoringCore.getAILevelsInformation(e,i),o=_.size(a),u=-1===(u=_.findIndex(a,function(U){return!U.disabled}))?0:u,l=(0,N.Xf)(e),f=l.getRolesProjectionRefs([i]),p=l.tryGetExprs(i),h=this.decompositionAuthoringCore.getPinnedLevelsCount(e,i),d=(v=h-o)+u,t&&null!=t.warnings&&(m=this.processAnalysisWarning(t.warnings)),g=n&&n.highlightedAIMatrixNode,d<0?(y.fF.assertFail("Count of AI levels is greater than the number of dimensions"),[2,{clientWarnings:m}]):(E=t&&t.decompositions,_.isEmpty(E)?(0===v?this.decompositionAuthoringCore.collapseNode(e,i,{dataMap:{}}):this.decompositionAuthoringCore.truncatePath(e,i,v-1),[2,{clientWarnings:m}]):(this.clearHighlightedAIProperties(e,g),[4,this.conceptualSchemaProxy.get(this.dataSources.get())]));case 1:for(A=W.sent(),this.decompositionAuthoringCore.clearAILevelsInformation(e,i),y.fF.assert(function(){return o>=_.size(E)},"Received more AI results than requested"),this.decompositionAuthoringCore.truncatePath(e,i,d),T=function(R){var K,Q=E[R],te=S.findProjection(p,Q.dimension,A,d),J=f[te];if(!J)return y.fF.assertFail("Projection not found"),S.decompositionAuthoringCore.truncatePath(e,i,d+R-1),"break";if(S.decompositionAuthoringCore.replaceLevelAt(e,i,d+R,J),R<_.size(E)-1){y.fF.assertValue(Q.value,"Decomposition result is missing a value"),y.fF.assertValue(_.some(Q.value.where()),"Value is not a valid filter");var X=Q.value.where()[0].condition,$=(0,Ee.TZ)(X),P=S.decompositionAuthoringCore.expandNode(e,i,{dataMap:(K={},K[J]=[$],K),metadata:[J]});y.fF.assert(function(){return P},"Could not expand AI node")}},S=this,V=0;V<_.size(E)&&"break"!==T(V);V++);return this.expandCollapseService.pinLevels(e,[i],h),h<_.size(p)&&this.expandCollapseService.unpinLevels(e,[i],h),L=l.getRolesProjectionRefs([i]),_.map(a,function(U,R){return D.expandCollapseService.setAILevelInformation(e,[i],R+v,[L[R+v]],U)}),this.createDataViewObjectDefinitions(E,e,A,d,g),[2,{windowExpansionTransform:function(R){for(var K=(0,ke.W7)(_.first(l.expansionStates),R,l.defn.select(),A),Q=K.root,te=0;!_.isEmpty(Q.children);)Q=_.first(Q.children),te++;var J=d+_.size(E)-1;if(te===J){var X=_.last(E);if(-1!==D.findProjection(p,X.dimension,A,d)){y.fF.assertValue(X.value,"Decomposition result is missing a value"),y.fF.assertValue(_.some(X.value.where()),"Value is not a valid filter");var P=X.value.where()[0].condition,fe=(0,$e.Dh)(P);K.levels[J].identityKeys=_.map(fe,function(B){return B.left});var ae=_.map(fe,function(B){return B.right});return Q.windowValues=[],Q.children=[{children:[],identityValues:ae,windowValues:[]}],K}y.fF.assertFail("Projection not found")}else y.fF.assertFail("Incorrect expansion path length")},clientWarnings:m}]}})})},s.prototype.createDataViewObjectDefinitions=function(e,t,r,n,i){var a;if(!_.isEmpty(e)){y.fF.assertValue(t,"visualContainer"),y.fF.assertValue(r,"FederatedConceptualSchema"),y.fF.assert(function(){return n>=0},"firstActiveAILevel should not be negative.");var o=(0,N.GQ)(t);o||(o=t.config.singleVisual.objects={});for(var u=(0,N.Xf)(t),l=H.Fw.explainBy,f=re.JU(u,[l]),p=u.getRolesProjectionRefs([l]),h=u.tryGetExprs(l),v=_.size(e),d=0;d<v-1;d++){var m=(0,q.tV)(f[n+d]);if(y.fF.assertValue(m,"ExpansionPath should not be empty."),!m)break;m.metadata=null,(0,he.sO)(o,i,m,(0,z.O7)(!0))}var g=_.last(e),A=p[this.findProjection(h,g.dimension,r,n)],T=_.first(g.value.where());if(T){var S=(0,Ee.TZ)(T.condition),V=re.ud(f,[{dataMap:(a={},a[A]=[S],a),metadata:[A]}]),M=(0,q.tV)(_.last(V));M&&(M.metadata=null,(0,he.sO)(o,i,M,(0,z.O7)(!0)))}}},s.prototype.clearHighlightedAIProperties=function(e,t){y.fF.assertValue(e,"visualContainer"),y.fF.assertValue(t,"PropertyIdentifier of highlightedAIMatrixNode should exist.");var r=(0,N.GQ)(e);if(r){var n=r[t.objectName];if(!_.isEmpty(n)){for(var i=0,a=n;i<a.length;i++)(0,he.E2)(r,t.objectName,a[i].selector,t.propertyName);(0,he.u4)(r)}}},s.prototype.findProjection=function(e,t,r,n){return _.findIndex(e,function(i){if((0,Z.ez)(i)){var a=i.getTargetColumnRef(r);return(0,Z.ez)(t)&&(t=t.getTargetColumnRef(r)),(0,Y.fS)(a,t)}return(0,Y.fS)(i,t)},n)},s.prototype.processAnalysisWarning=function(e){y.fF.assertAnyValue(e,"DecompositionAnalysisWarnings");var t=[];if(1===e){var r="InvalidConstrainedJoin";t.push({code:r,columnNameFromIndex:function(i){},getDetails:function(i){return{message:i.get(r),displayableErrorInfo:[{errorInfoKey:i.get(r),errorInfoValue:i.get(r)}]}}})}return t},s.prototype.toClientErrorOrWarning=function(){throw new Error("Not applied to DecompositionTree result handler")},s.\u0275fac=function(t){return new(t||s)(x.\u0275\u0275inject(F.D),x.\u0275\u0275inject(oe.i),x.\u0275\u0275inject(Ye.e),x.\u0275\u0275inject(qe.v),x.\u0275\u0275inject(xe.D))},s.\u0275prov=x.\u0275\u0275defineInjectable({token:s,factory:s.\u0275fac}),s}(),et={provide:"insightsAnalysisResultHandler",useFactory:function(s){return new Promise(function(e){e(new tt(s))})},deps:[x.Injector]},tt=function(){function s(e){this.injector=e}return s.prototype.processAnalysisResult=function(e,t){if(y.fF.assertValue(e,"visualContainer not defined"),y.fF.assertValue(t,"analysisResultContainer not defined"),t.analysisDefinition.findDecompositions)return this.injector.get(Ve).processAnalysisResult(e,t.result&&t.result.findDecompositions);y.fF.assertFail("Unexpected analysis result")},s.prototype.toClientErrorOrWarning=function(e){return Xe.F.processAnalysisErrorToIClientErrorOrWarning(e)},s.\u0275fac=function(t){return new(t||s)(x.\u0275\u0275inject(x.Injector))},s.\u0275prov=x.\u0275\u0275defineInjectable({token:s,factory:s.\u0275fac}),s}(),ee=c(32488),it=c(32557),De=c(13702),Ae=c(8082),Ce=c(66977),Te=c(68273),rt=c(47287),nt=c(50550),be=c(41640),Fe=c(43286),st=c(72489),Me=c(5361),we=c(65181),ot={provide:"insightsAnalysisModern",useFactory:function(s,e,t,r,n,i,a){return new Promise(function(o){o(new ut(s,e,t,r,n,i,a))})},deps:[De.O,b.U,G.vZ,we.o,xe.D,Ce.f,Ae.s]},ut=function(){function s(e,t,r,n,i,a,o){this.displayNameService=e,this.explorationCapabilities=t,this.featureSwitchService=r,this.localizationService=n,this.visualPlugin=i,this.visualPluginOps=a,this.runningVisuals=o}return s.prototype.getOptions=function(e,t,r,n,i){y.fF.assertValue(e,"visualContainer"),y.fF.assertValue(n,"schema");var a,o=[];t instanceof O.yl?o=[t]:void 0!==t&&(a=t.query,t.dataFilters&&o.push.apply(o,_.map(t.dataFilters,function(g){return g.filter})),t.highlightFilters&&o.push(t.highlightFilters));var l=this.addFiltersToQuery(e,o);if(!l)return[];l=l.rewrite(new ct);var f=[];if(this.analysisTypeMatches(i,"ExplainChange")&&!_.isEmpty(r)){var p=this.getExplainChangeDefinitions(e,l,r,o,n,a);_.isEmpty(p)||f.push.apply(f,p||[])}this.analysisTypeMatches(i,"FindDistributionFactors")&&(h=this.getDistributionFactorOption(e,l,r,n,a))&&f.push(h);var h,v=this.featureSwitchService.featureSwitches;if(v.insightsDevModeEnabled&&this.analysisTypeMatches(i,"GetRelatedInsights")&&(h=this.getRelatedInsightsDefinition(e,l,r,n))&&f.push(h),v.decompositionAnalysisInsights&&this.analysisTypeMatches(i,"DecompositionTree")){var d=this.createDecompositionAnalysisOptions(e,r,n);d&&(f=f.concat(d))}if(v.daxTransformEnabled&&this.analysisTypeMatches(i,"ExplainAnomalies")){var m=this.getExplainAnomalyOptions(e,r,n,o);_.isEmpty(m)||(f=f.concat(m))}return f},s.prototype.getExplainChangeDefinition=function(e,t,r,n,i,a,o,u,l,f){y.fF.assertValue(e,"schema"),y.fF.assertValue(n,"selects"),y.fF.assertValue(i,"measureExpr"),y.fF.assertValue(a,"dimensionExpr"),y.fF.assertValue(o,"targetFilter"),y.fF.assertValue(u,"referenceFilter");var p=Ne(a,e);return this.getExplainChangeDefinitionInternal(e,t,r,n,i,p,o,u,l,f)},s.prototype.getFindDistributionAnalysisDefinition=function(e,t,r,n,i,a){if(y.fF.assertValue(e,"schema"),y.fF.assertValue(n,"selects"),y.fF.assertValue(i,"measureExpr"),y.fF.assertValue(a,"dimensionExpr"),this.isSupported(i,e)&&this.isSupported(a,e)&&(!t||this.isSupported(t,e)))return{definition:{findDistributionFactors:{measure:i,dimension:a,parentSpace:t,requestedInsights:ee.Me,timeoutInMS:ee.No}},insightQueryTransform:{queryRewriters:this.createRewriters(n,e),orderBy:r}}},s.prototype.getExplainChangeDefinitionInternal=function(e,t,r,n,i,a,o,u,l,f){if(o&&u&&a&&_.some(e.schemas,function(E){return E.capabilities.insights.supportsExplainChange})){var p=this.createRewriters(n,e);if(!_.isEmpty(p))for(var h=0,v=p;h<v.length;h++){var d=v[h];t=t&&t.rewrite(d),u=u.rewrite(d),o=o.rewrite(d)}if((!(t=this.removeRedundantFilters(t,u,o))||this.isSupported(t,e))&&this.isSupported(o,e)&&this.isSupported(u,e)&&this.isSupported(i,e))return{definition:{explainChange:{requestedInsights:ee.Me,timeoutInMS:ee.No,measure:i,reference:u,target:o,parentSpace:t,referenceValue:l,referenceDimensionValue:f}},insightQueryTransform:{queryRewriters:p,orderBy:r}}}},s.prototype.addFiltersToQuery=function(e,t){var r=(0,N.Xf)(e),n=r&&r.clone().defn;if(n){for(var i=0,a=t;i<a.length;i++)n=n.addSemanticFilter(a[i]);return n}},s.prototype.getRelatedInsightsDefinition=function(e,t,r,n){var i=this;if(_.some(n.schemas,function(o){return o.capabilities.insights.supportsRelatedInsights})){var a=r&&O.yl.merge(_.map(r,function(o){return i.getFilterFromSelector(o)}));return a&&(t=t.addSemanticFilter(a)),{analysisDefinition:{getRelatedInsights:{topicQuery:t,options:0,requestedInsights:ee.Me,timeoutInMS:ee.No}},question:this.localizationService.get("Insights_AnalysisScopedQuestion"),description:this.localizationService.get("Insights_AnalysisScopedDescription"),sourceVisualContainer:e,insightQueryTransform:{queryRewriters:this.createRewritersFromVisualContainerSelects(e,n)},selectors:r}}},s.prototype.getDistributionFactorOption=function(e,t,r,n,i){var a,o,u;if(_.some(n.schemas,function(B){return B.capabilities.insights.supportsDistributionFactors})){var l=(0,ve.s)(e);if(!(_.size(r)>1||l!==se.L.columnChart.name&&l!==se.L.clusteredColumnChart.name&&l!==se.L.barChart.name&&l!==se.L.clusteredBarChart.name&&l!==se.L.lineClusteredColumnComboChart.name&&l!==se.L.lineStackedColumnComboChart.name)){var f=this.visualPluginOps.dataViewKinds((0,ve.s)(e),(0,N.Xf)(e));if(f&&(0,Fe.yE)(f,1)&&void 0!==this.runningVisuals.getVisual(e)){var p=this.runningVisuals.getVisual(e).getDataViews();if(!_.every(p,function(B){return _.isEmpty(B.categorical.categories)||_.size(B.categorical.categories[0].values)<=1})){var h,v,d;if(_.isEmpty(r)){var E=(0,N.Xf)(e),A=E.projections,T=A[rt.au.y],S=T&&T.all();if(1!==_.size(S))return;h=null===(u=_.find(t.select(),function(B){return B.name===S[0].queryRef}))||void 0===u?void 0:u.expr;var V=_.filter(t.select(),function(B){return!(0,de.k)(B.expr)});if(1!==_.size(V)&&(V=_.filter(V,function(B){var Et=E.getRoleNameForExpr(B.expr);return _.includes(A[Et].activeProjectionRefs,B.name)})),1!==_.size(V))return;v=V[0].expr}else{var m=r[0],g=m.metadata;if(1!==_.size(g)||(h=null===(a=t.select().withName(g[0]))||void 0===a?void 0:a.expr,!(d=this.getCategoricalSelectorContext((0,q.tV)(m),e,n))||!d.categoryQueryName))return;v=null===(o=t.select().withName(d.categoryQueryName))||void 0===o?void 0:o.expr}if(h&&v){var M=(0,N.Xf)(e),L=M.getRoleNameForExpr(v),k=M.projections[L];if(!(_.size(k.all())>1&&1!==_.size(k.activeProjectionRefs))){if((0,Z.ZG)(h)){for(var W=0,U=_.map(h.filters,function(B){return O.yl.fromSQExpr(B.condition)});W<U.length;W++)t=t.addSemanticFilter(U[W]);h=h.expression}var Q,K=d&&d.legendFilter;K&&(t=t.addSemanticFilter(K)),_.isEmpty(t.where())||(Q=O.yl.fromSQFromAndSQFilters(t.from(),t.where()));var te=(0,N.cj)(e,this.visualPlugin),J=this.displayNameService.getDisplayName(h,n,te),X=this.displayNameService.getDisplayName(v,n,(0,N.cj)(e,this.visualPlugin)),$=this.localizationService.format("Insights_AnalysisDistributionFactorsDescription",[J,X]);K&&($=this.localizationService.format("Insights_AnalysisDistributionFactorsWithFiltersDescription",[J,X,this.displayNameService.getFilterRestatement(K,n,te)]));var P=(0,N.oJ)(e),fe=i&&i.orderBy(),ae=this.getFindDistributionAnalysisDefinition(n,Q,fe,P,h,v);if(ae)return{analysisDefinition:ae.definition,question:this.localizationService.get("Insights_AnalysisDistributionFactorsQuestion"),description:$,sourceVisualContainer:e,insightQueryTransform:ae.insightQueryTransform,selectors:r}}}}}}}},s.prototype.getExplainChangeDefinitions=function(e,t,r,n,i,a){if(_.some(i.schemas,function(d){return d.capabilities.insights.supportsExplainChange})){var u,o=this.visualPluginOps.dataViewKinds((0,ve.s)(e),(0,N.Xf)(e));if(null!=o&&void 0!==this.runningVisuals.getVisual(e)&&(_.isEmpty(n)||(u=O.yl.merge(n)),!_.some(r,function(d){return!d.dataMap}))){var l=r[0].metadata;if(1!==_.size(l)||_.some(r,function(d){return 1!==_.size(d.metadata)||d.metadata[0]!==l[0]}))return[];var f=t.select().withName(l[0]);if(!f)return[];var p=f.expr,h=[];if((0,Fe.yE)(o,1)){var v=this.getCategoricalBreakdownOptions(e,r,i,p,u,a);_.isEmpty(v)||h.push.apply(h,v||[])}else(0,Fe.yE)(o,2)&&(v=this.getMatrixBreakdownOptions(e,r,i,p,u,a),_.isEmpty(v)||h.push.apply(h,v||[]));return h}}},s.prototype.createExplainChangeOption=function(e,t,r,n,i,a,o,u){var l=e.value>t.value?"Increase":"Decrease",f=Math.abs(100*(e.value-t.value)/t.value).toFixed(2),p="Insights_Analysis".concat(l,"ChangeBreakdownQuestion"),h="Insights_Analysis".concat(l,"ChangeBreakdownDescription"),v=[f];v.push.apply(v,[this.displayNameService.getDisplayName(r,i,null),t.formattedCategoryValue,e.formattedCategoryValue]);var d=this.getExplainChangeDefinitionInternal(i,n,o&&o.orderBy(),(0,N.oJ)(a),r,!0,e.filter,t.filter,t.value,t.formattedCategoryValue);if(d)return{analysisDefinition:d.definition,question:this.localizationService.get(p),description:this.localizationService.format(h,v),sourceVisualContainer:a,insightQueryTransform:d.insightQueryTransform,selectors:u}},s.prototype.createDecompositionAnalysisOptions=function(e,t,r){var n=(0,N.cj)(e,this.visualPlugin);if(n&&n.analyze&&n.analyze.supportsAnalyzeHighLowValues){var i=this.getMeasureExprForDecomposition(e,t);if(i){var a=this.explorationCapabilities.getCapabilities();if((0,j.W)(i,a,r)){var o=this.displayNameService.getDisplayName(i,r,null);return[{analysisDefinition:{findDecompositions:{target:i,methods:[1],path:void 0,strategy:1}},question:this.localizationService.get("Insights_AnalysisFindMinDecompositionQuestion"),description:this.localizationService.format("Insights_AnalysisFindMinDecompositionDescription",[ee.S7,ee.d6,o]),sourceVisualContainer:e,selectors:t},{analysisDefinition:{findDecompositions:{target:i,methods:[2],path:void 0,strategy:1}},question:this.localizationService.get("Insights_AnalysisFindMaxDecompositionQuestion"),description:this.localizationService.format("Insights_AnalysisFindMaxDecompositionDescription",[ee.S7,ee.d6,o]),sourceVisualContainer:e,selectors:t}]}}}},s.prototype.getExplainAnomalyOptions=function(e,t,r,n){y.fF.assertValue(e,"sourceVisualContainer"),y.fF.assertAnyValue(t,"selectors"),y.fF.assertValue(r,"schema"),y.fF.assertAnyValue(n,"filters");var i=[];if(_.isEmpty(t))return i;var a=(0,N.cj)(e,this.visualPlugin);if(!a?.insights)return i;var o=this.explorationCapabilities.getCapabilities(),l=new it.ix(this.displayNameService,this.localizationService,this.runningVisuals).getAnalysisOption(e,n,_.first(t),r,a,o);return l&&i.push(l),i},s.prototype.createRewritersFromVisualContainerSelects=function(e,t){var r=(0,N.oJ)(e);return this.createRewriters(r,t)},s.prototype.createRewriters=function(e,t){for(var r=[],n=[],i=function(f){if((0,Z.ez)(f.expr)){var p=(0,ge.cH)(f.expr),h=f.expr.getTargetColumnRef(t).getTargetEntity();p&&h&&(_.some(n,function(v){return(0,Y.fS)(v,p,!1,!0)})||(r.push(new ft(h,p,t)),n.push(p)))}},a=0,o=e;a<o.length;a++)i(o[a]);return r},s.prototype.getCategoricalBreakdownOptions=function(e,t,r,n,i,a){var o=[],u=this.getCategoricalSelectorContext((0,q.tV)(t[0]),e,r);if(u){var l=u.isScalar,f=_.size(t);if(2===f){if(!(p=this.getCategoricalSelectorContext((0,q.tV)(t[1]),e,r)))return;var h=p.index>u.index?u:p,v=p.index>u.index?p:u;l&&!(0,be.GG)(u.value,p.value)&&(d=this.createExplainChangeOption(v,h,n,i,r,e,a,t))&&o.push(d)}else if(1===f&&l){var m=u.previousSelector;if(m){var p,d;if(!(p=this.getCategoricalSelectorContext(m,e,r)))return;(0,be.GG)(u.value,p.value)||(d=this.createExplainChangeOption(u,p,n,i,r,e,a,t))&&o.push(d)}}return o}},s.prototype.getCategoricalSelectorContext=function(e,t,r){for(var i=0,a=this.runningVisuals.getVisual(t).getDataViews();i<a.length;i++){var o=a[i],u=new lt(e,r,this.displayNameService,(0,N.cj)(t,this.visualPlugin));if((0,Te.aU)(o,u),u.context)return u.context}},s.prototype.getMatrixBreakdownOptions=function(e,t,r,n,i,a){var o;if(1===_.size(t)){var u=(0,q.tV)(t[0]),l=null===(o=u?.data)||void 0===o?void 0:o[0],f=l&&l.expr;if(f&&(0,Z.Hi)(f)&&2===_.size(f.values)){for(var p=this.runningVisuals.getVisual(e).getDataViews(),h=(0,z.Sh)(f.args,[f.values[0]]),v=(0,z.Sh)(f.args,[f.values[1]]),d=void 0,m=void 0,g=0,E=p;g<E.length;g++){var A=E[g];d=d||this.getValueFromMatrix(h,A,r),m=m||this.getValueFromMatrix(v,A,r)}if(!d||!m)return;var T=[];if(m.isScalar){var S=this.createExplainChangeOption(m,d,n,i,r,e,a,t);S&&T.push(S)}return T}}},s.prototype.getValueFromMatrix=function(e,t,r){if((0,Z.Hi)(e)&&1===_.size(e.values)){var n=e,i=t.matrix.rows.root.children,a=t.matrix.columns.root.children;if(!_.isEmpty(t.matrix.rows.root.childIdentityFields)&&!_.isEmpty(t.matrix.columns.root.childIdentityFields)){var o=t.matrix.rows.root.childIdentityFields,u=t.matrix.columns.root.childIdentityFields[0],l=_.map(o,function(S){return S.getMetadata(r)}),f=_.findIndex(n.args,function(S){return(0,Y.fS)(S,u)});if(!(f<0)){var p=(0,z.qu)(0,n.args[f],n.values[0][f]),h=_.findIndex(a,function(S){return S.identity&&(0,Y.fS)(S.identity.expr,p,!1,!0)});if(!(h<0))for(var v=0,d=i;v<d.length;v++){var m=d[v],g=(0,z.Sh)((0,C.ev)([],o||[],!0),[(0,C.ev)([],_.map(m.levelValues,function(S,V){return(0,z.kQ)(S.value,l[V]&&l[V].type)}),!0)]),E=m.values[h].value;if(null!=E&&this.isFilterSubset(e,g,0)){var A=l[l.length-1],T=A&&A.type;return{formattedCategoryValue:_.map(e.values[0],function(S,V){var M=e.args[V].getMetadata(r);return(0,st.WU)(S.value,M&&M.format)}).join(" "),value:E,index:0,previousSelector:null,isScalar:Re(T),filter:O.yl.fromSQExpr((0,z.Sh)(e.args,[e.values[0]]))}}}}}}},s.prototype.removeRedundantFilters=function(e,t,r){var n=this;if(e){var i=e.where(),a=_.filter(i,function(u){var l=!0,f=u.condition;if((0,Z.Hi)(f)&&2===_.size(f.values)){var p=(0,z.Sh)(f.args,[f.values[0]]),h=(0,z.Sh)(f.args,[f.values[1]]);l=!(_.some(t.where(),function(v){return n.isFilterSubset(v.condition,p,0)})&&_.some(r.where(),function(v){return n.isFilterSubset(v.condition,h,0)}))}return l}),o=_.size(a);if(o===_.size(i))return e;if(0!==o)return new O.yl(e.from(),a)}},s.prototype.isFilterSubset=function(e,t,r){var n=this;return(0,Z.Hi)(e)&&_.every(t.args,function(i,a){return _.some(e.args,function(o,u){return(0,Y.fS)(i,o,!1,!0)&&n.areValuesEqual(t.values[r][a],e.values[r][u])})})},s.prototype.areValuesEqual=function(e,t){return!(!e||!t)&&(_.isDate(e.value)&&_.isDate(t.value)?e.value.getTime()===t.value.getTime():e.value===t.value)},s.prototype.getFilterFromSelector=function(e){return(0,q.mV)([(0,q.tV)(e)])},s.prototype.isSupported=function(e,t){if(e instanceof z.Il)return!ie.B.isUnsupported(e,t);for(var n=0,i=e.where();n<i.length;n++)if(ie.B.isUnsupported(i[n].condition,t))return!1;if(e instanceof O.vQ)for(var u=0,l=e.select();u<l.length;u++)if(ie.B.isUnsupported(l[u].expr,t))return!1;return!0},s.prototype.isSimpleAdditiveMeasure=function(e,t){if((0,Z.iV)(e))return(0,Z.Lk)(e.arg)?2===e.func:0===e.func||5===e.func;if((0,Z.kb)(e)){var n=e.getConceptualProperty(t);y.fF.assertValue(n.measure,"expression has to be a conceptual measure");var i=n.measure.distributiveAggregate;if(null==i||0!==i&&1!==i)return!1}return!0},s.prototype.getMeasureExprForDecomposition=function(e,t){var r,n=_.first(t);if(!n||1!==t.length||!n.metadata||1!==n.metadata.length)return r;var i=(0,N.Xf)(e),a=_.first(n.metadata);return i.defn.select().withName(a).expr},s.prototype.analysisTypeMatches=function(e,t){return void 0===e||e===t},s.\u0275fac=function(t){return new(t||s)(x.\u0275\u0275inject(De.O),x.\u0275\u0275inject(b.U),x.\u0275\u0275inject(G.vZ),x.\u0275\u0275inject(we.o),x.\u0275\u0275inject(xe.D),x.\u0275\u0275inject(Ce.f),x.\u0275\u0275inject(Ae.s))},s.\u0275prov=x.\u0275\u0275defineInjectable({token:s,factory:s.\u0275fac}),s}(),lt=function(){function s(e,t,r,n){this.schema=t,this.displayNameService=r,this.visualCapabilities=n,this.identities=e.data,this.metadata=e.metadata}return s.prototype.visitCategoryColumns=function(){},s.prototype.visitValueColumnGroups=function(){},s.prototype.visitValueColumn=function(e){return this.metadata===e.source.queryName},s.prototype.visitValue=function(e,t,r,n,i){var a=this;if(!(0,Te.ON)(this.identities,t.data)&&_.isNumber(e)&&_.isFinite(e)&&!_.isEmpty(n)){var l,o=_.every(n[0].identityFields,function(p){return Ne(p,a.schema)}),u=_.filter(t.data,function(p){return p.key!==n[0].identity[i].key});i>0&&(l={dataMap:{category:[n[0].identity[i-1]]},metadata:[t.metadata]},_.size(t.data)>1&&(l.dataMap.series=u));var f=(0,q.mV)([t]);this.context={value:e,index:i,formattedCategoryValue:this.displayNameService.getFilterRestatement(f,this.schema,this.visualCapabilities),previousSelector:l?(0,q.tV)(l):void 0,isScalar:o,filter:f,categoryQueryName:n[0].source.queryName,legendFilter:u&&(0,Ee.SN)(u)}}},s}(),ct=function(s){function e(){return null!==s&&s.apply(this,arguments)||this}return(0,C.ZT)(e,s),e.prototype.visitGroupRef=function(t){return new z.Wh(t.source,t.ref)},e}(Me.b),ft=function(s){function e(t,r,n){var i=s.call(this)||this;i.variationTarget=t;var a=r;return(0,Z.jc)(r)&&(a=(0,z.Oh)(r.arg,r.property)),i.hierarchyLevelExprs=(0,nt.rY)((0,ge.wA)(n,a)),i.hierarchyTargetColumnRefs=_.map(i.hierarchyLevelExprs,function(o){return o.getTargetColumnRef(n)}),i.variationSourceTargetEntity=r.getTargetEntity(),i}return(0,C.ZT)(e,s),e.prototype.visitColumnRef=function(t){if((0,Y.fS)(t.source,this.variationTarget)){var r=_.findIndex(this.hierarchyTargetColumnRefs,function(n){return(0,Y.fS)(n,t)});return r>=0&&r<=_.size(this.hierarchyLevelExprs)-1?this.hierarchyLevelExprs[r]:t}return t},e.prototype.visitEntity=function(t){return(0,Y.fS)(t,this.variationTarget)?this.variationSourceTargetEntity:t},e}(Me.b);function Ne(s,e){var t=s.getOrderByColumns(e),i=(1===_.size(t)?t[0]:s).getMetadata(e);return Re(i&&i.type)}function Re(s){return!!s&&!!(s.dateTime||s.temporal||s.numeric||s.integer)}var pt=c(31486),dt=c(14172),vt=c(48787),yt={provide:"quickExploreSupportability",useFactory:function(s){return(0,C.mG)(this,void 0,void 0,function(){return(0,C.Jh)(this,function(e){return[2,new mt(s)]})})},deps:[G.vZ]},mt=function(){function s(e){this.featureSwitchService=e,this.isQuickExploreMultiTableEnabled$=this.featureSwitchService.featureSwitches$.pipe((0,dt.U)(function(t){return t.quickExploreMultiTable}))}return s.prototype.isQuickExploreSupported=function(e){return(0,C.mG)(this,void 0,void 0,function(){return(0,C.Jh)(this,function(r){switch(r.label){case 0:return[4,this.isQuickExploreMultiTableEnabled$.pipe((0,vt.q)(1)).toPromise()];case 1:return[2,r.sent()&&!e.isHidden&&!(1&~e.permissions)&&e.insightsQuerySuggestionsSupported]}})})},s.\u0275fac=function(t){return new(t||s)(x.\u0275\u0275inject(G.vZ))},s.\u0275prov=x.\u0275\u0275defineInjectable({token:s,factory:s.\u0275fac}),s}(),gt=c(77476),St=function(){function s(){}return s.\u0275fac=function(t){return new(t||s)},s.\u0275mod=x.\u0275\u0275defineNgModule({type:s}),s.\u0275inj=x.\u0275\u0275defineInjector({providers:[We,et,pt.v,ot,Ve,yt],imports:[gt.CommonModule]}),s}()},31486:function(Ie,ue,c){c.d(ue,{v:function(){return ce}});var C=c(8590),w=c(62458),ie=c(50423),le=c(43025),ce=function(){function b(F){var I=this;this.cache=[],this.globalSubscriptionManager=F.createChannelSubscriptionManager().subscribe(C.wW,function(j,G){return I.clear(G.dsr.modelId)})}return b.prototype.ngOnDestroy=function(){this.globalSubscriptionManager.unsubscribeAll()},b.prototype.set=function(F,I){w.fF.assertValue(F,"request"),w.fF.assertValue(I,"resultPromise");var j=re(F);_.find(this.cache,function(ne){return ne.key===j})&&w.fF.assertFail("Cache entry already exists"),_.size(this.cache)>=50&&this.cache.splice(0,1),this.cache.push({key:j,resultPromise:I,insertTimestamp:new Date,status:1,modelId:F.ModelId})},b.prototype.get=function(F,I){w.fF.assertValue(F,"request"),w.fF.assertAnyValue(I,"modelRefreshDate");var j=this.delete(F);if(j&&!(I&&j.insertTimestamp.getTime()<=I.getTime()))return this.cache.push(j),{resultPromise:j.resultPromise,status:j.status}},b.prototype.remove=function(F){var I=this.delete(F);if(I)return{resultPromise:I.resultPromise,status:I.status}},b.prototype.updateStatus=function(F,I,j){w.fF.assertValue(F,"request"),w.fF.assertValue(I,"status");var G=re(F),ne=_.find(this.cache,function(ye){return ye.key===G});j||w.fF.assertValue(ne,"Entry does not exist in cache"),ne&&(ne.status=I)},b.prototype.clear=function(F){w.fF.assertAnyValue(F,"modelId"),null==F?this.cache=[]:_.remove(this.cache,function(I){return I.modelId===F})},b.prototype.delete=function(F){w.fF.assertValue(F,"request");var I=re(F),j=_.remove(this.cache,function(ne){return ne.key===I}),G=_.size(j);if(w.fF.assert(function(){return G<=1},"Cache had multiple entries with same key"),0!==G)return j[0]},b.\u0275fac=function(I){return new(I||b)(ie.\u0275\u0275inject(le.Z))},b.\u0275prov=ie.\u0275\u0275defineInjectable({token:b,factory:b.\u0275fac}),b}();function re(b){return JSON.stringify(b)}}}]);