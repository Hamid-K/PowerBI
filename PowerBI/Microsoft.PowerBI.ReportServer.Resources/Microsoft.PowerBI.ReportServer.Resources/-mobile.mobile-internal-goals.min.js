"use strict";(self.webpackChunkmobile=self.webpackChunkmobile||[]).push([["mobile-internal-goals"],{55304:function(Ce,ce,i){i.r(ce),i.d(ce,{MobileInternalGoalsModule:function(){return tt}});var s=i(37343),Q=i(81337),q=i(51092),V=i(23296),H=i(41114),P="MBI.Metrics.FooterItemClicked",f=H.cx[P]=(0,H.b1)(P,{eventTypeId:6e4,level:"Info",mobileCategory:12}),c=i(46544),p=i(35510),u=i(59017),d=i(11547),M=i(22318),E=i(6663),B=i(59973),W=i(17653),N=i(14172),k=i(57243),j=i(81905),C=i(77526),o=i(50423),v=i(37092),U=i(25734),T=i(37838),w=i(42705),R=i(10167),z=i(65181),ie=i(7530),L=i(78364),F=i(51137),de=function(){function K(I,y,m,x,Y,ye,Ge,fe,le,De,xe){var Be=this;this.footerNotificationService=I,this.hostBackOperationHandlerService=y,this.hostTooltip=m,this.interactionsRegistry=x,this.localizationService=Y,this.nativeActionsNotification=ye,this.telemetryService=Ge,this.scopedServicesProvider=fe,this.scorecardApplicationApiService=le,this.scorecardHierarchiesService=De,this.zone=xe,this.closeMenuBackHandler={goBack:function(){Be.zone.run(function(){Be.closeMenu()})}},this.activeMenuSubject$=new p.X({activeMenu:0}),this.footerLoweredSubject$=new p.X(!1),this.canvasScrollInteraction=this.interactionsRegistry.canvasScroll(),this.initializeService()}return K.prototype.initializeService=function(){var I=this;this.scrollSubscription=this.canvasScrollInteraction.subscribe(function(y){(0,V.D5)(y,I.footerLoweredSubject$)}),this.activeMenu$=this.activeMenuSubject$.pipe((0,M.O)({activeMenu:void 0}),(0,E.G)(),(0,B.h)(function(y){return y[0].activeMenu!==y[1].activeMenu}),(0,W.b)(function(y){var x=y[1];0===y[0].activeMenu&&I.hostBackOperationHandlerService.push(I.closeMenuBackHandler),0===x.activeMenu&&I.hostBackOperationHandlerService.remove(I.closeMenuBackHandler)}),(0,N.U)(function(y){return y[1]}),(0,k.d)(1)),this.footerHidden$=this.scorecardApplicationApiService.scorecardApiOptions$.pipe((0,N.U)(function(y){var m;return!y||!(null!==(m=y.footerOptions)&&void 0!==m&&m.showFooter)})),this.smallIcon$=this.scorecardApplicationApiService.scorecardApiOptions$.pipe((0,N.U)(function(y){return"phoneLandscapeLayout"===y.scorecardLayout})),this.classes$=this.scorecardApplicationApiService.scorecardApiOptions$.pipe((0,N.U)(function(y){var m,x=null!==(m=y.footerOptions)&&void 0!==m?m:{},Y=[];return x.withNotch&&Y.push("withNotch"),x.withTransparentOsBar&&Y.push("withTransparentOsBar"),Y})),this.populateActions(),this.initFooterLowered()},K.prototype.closeMenu=function(){this.footerNotificationService.footerMenuClosed(),this.activeMenuSubject$.next({activeMenu:0})},K.prototype.openMenu=function(I){var y=(0,V.gi)(I);this.beforeAction(I),this.footerNotificationService.footerMenuOpened(y),this.activeMenuSubject$.next({activeMenu:y,delayOverride:void 0})},K.prototype.allActionsClicked=function(){this.openMenu(1)},K.prototype.clearAll=function(){this.closeMenu(),this.activeMenuSubject$.next({activeMenu:0}),this.scrollSubscription&&(this.scrollSubscription(),this.scrollSubscription=null),this.footerLoweredSubject$.next(!1)},K.prototype.lowerFooter=function(I){this.footerLoweredSubject$.next(I)},K.prototype.initFooterLowered=function(){var I=this,y=this.scopedServicesProvider.scopeChanged.pipe((0,j.w)(function(){return(0,u.aj)([I.activeMenu$,I.scorecardApplicationApiService.scorecardApiOptions$,I.availableActions$]).pipe((0,N.U)(function(m){return{activeMenu:m[0].activeMenu,scorecardApiOptions:m[1],availableActions:m[2]}}),(0,k.d)(1))}));y.pipe((0,C.x)(),(0,E.G)(),(0,N.U)(function(m){return I.mapFooterLoweredCases(m[0],m[1])})).subscribe(function(m){I.footerLoweredSubject$.next(m)}),this.footerLowered$=(0,u.aj)([this.footerLoweredSubject$,y]).pipe((0,N.U)(function(m){return I.lowerFooterConstraints(m[0],m[1])}),(0,C.x)())},K.prototype.lowerFooterConstraints=function(I,y){var m,x=null!==(m=y.scorecardApiOptions.footerOptions)&&void 0!==m?m:{};return!x.showFooter||0===y.availableActions.length||10!==y.activeMenu&&(0!==y.activeMenu||!x.footerLocked&&I)},K.prototype.mapFooterLoweredCases=function(I,y){var m,x=null!==(m=y.scorecardApiOptions.footerOptions)&&void 0!==m?m:{};return!(0===y.activeMenu&&y.activeMenu!==I.activeMenu||(_.isEqual(I.scorecardApiOptions,y.scorecardApiOptions)?(y.activeMenu===I.activeMenu&&this.setHideFooterTimeout(x.footerLocked),1):(this.setHideFooterTimeout(x.footerLocked),x.showFooter)))},K.prototype.setHideFooterTimeout=function(I){var y=this;this.hideFooterTimeoutId&&(clearTimeout(this.hideFooterTimeoutId),this.hideFooterTimeoutId=void 0),!I&&(this.hideFooterTimeoutId=setTimeout(function(){y.footerLoweredSubject$.next(!0)},q.T))},K.prototype.populateActions=function(){for(var I=this.createAll(),y=[],m=function(le){y.push(le.available$.pipe((0,N.U)(function(De){return{index:le.index,available:De}})))},x=0,Y=I;x<Y.length;x++)m(Y[x]);var Ge=_.clone(I);this.availableActions$=(0,u.aj)(y).pipe((0,N.U)(function(fe){for(var le=function(We){var Ke=_.findIndex(I,function(it){return it.index===We.index});Ge[Ke]=We.available?I[Ke]:void 0},De=0,xe=fe;De<xe.length;De++)le(xe[De]);return Ge}))},K.prototype.performNativeAction=function(I,y){this.beforeAction(I),this.nativeActionsNotification.invokeAndForgetHostService(y)},K.prototype.annotate=function(){var I=this;this.beforeAction(5),setTimeout(function(){I.nativeActionsNotification.invokeAndForgetHostService("annotate")},150..valueOf())},K.prototype.beforeAction=function(I){this.closeMenu(),this.footerNotificationService.notifyFooterActionOpened(I),this.buttonClickTelemetry(q.wp.get(I)),this.hostTooltip.hideAllTooltips({immediately:!0,isTouchEvent:!0})},K.prototype.buttonClickTelemetry=function(I){this.telemetryService.logEvent(f,{actionName:I})},K.prototype.getIcon=function(I){var y=this;return this.smallIcon$.pipe((0,j.w)(function(m){var x=(0,V.Y6)(I,m);return x?(0,d.of)(x):y.getLocalIcon(I)}))},K.prototype.getLocalIcon=function(I){return 101===I?this.getHierarchiesIcon():(0,d.of)("")},K.prototype.createAll=function(){for(var I=this,y=[{index:5,available$:this.scorecardApplicationApiService.scorecardApiOptions$.pipe((0,N.U)(function(fe){var le;return!(null===(le=fe.footerOptions)||void 0===le||!le.annotations)}),(0,k.d)(1)),title:function(){return I.localizationService.get("Annotate")},accessibleClick:function(){return I.annotate()}},{index:101,available$:(0,u.aj)([this.scorecardApplicationApiService.scorecardApiOptions$,this.scorecardHierarchiesService.hasHierarchies$]).pipe((0,N.U)(function(fe){var le;return!(null===(le=fe[0].footerOptions)||void 0===le||!le.hierarchies)&&fe[1]}),(0,k.d)(1)),title:function(){return I.localizationService.get("Hierarchies")},accessibleClick:function(){return I.openMenu(101)}},{index:100,available$:this.scorecardApplicationApiService.scorecardApiOptions$.pipe((0,N.U)(function(fe){var le;return!(null===(le=fe.footerOptions)||void 0===le||!le.share)}),(0,k.d)(1)),title:function(){return I.localizationService.get("ShareView_Invite")},accessibleClick:function(){return I.performNativeAction(100,"shareScorecard")}}],m=function(le){le.leftIcon$=x.smallIcon$.pipe((0,j.w)(function(De){return I.getIcon(le.index).pipe((0,N.U)(function(xe){return{class:xe,show:!0,size:De?20:24,sprite:"mobile-icons",hasAction:!1}}))}))},x=this,Y=0,ye=y;Y<ye.length;Y++)m(ye[Y]);return y},K.prototype.getHierarchiesIcon=function(){return(0,u.aj)([this.smallIcon$,this.scorecardHierarchiesService.selectedHierarchies$]).pipe((0,N.U)(function(I){var y=I[0],m=I[1];return m?.length?y?"organization_20_filled":"organization_24_filled":y?"organization_20_regular":"organization_24_regular"}))},K.\u0275fac=function(y){return new(y||K)(o.\u0275\u0275inject(v.w),o.\u0275\u0275inject(U.N),o.\u0275\u0275inject(R.Rz),o.\u0275\u0275inject(T.p),o.\u0275\u0275inject(z.o),o.\u0275\u0275inject(ie.v),o.\u0275\u0275inject(c.y0),o.\u0275\u0275inject(w.V),o.\u0275\u0275inject(L.d),o.\u0275\u0275inject(F._),o.\u0275\u0275inject(o.NgZone))},K.\u0275prov=o.\u0275\u0275defineInjectable({token:K,factory:K.\u0275fac}),K}(),Z=i(57535),D=i(61088),O=i(62831),J=i(62458),te=i(73221),X=i(59787),ne=i(83317),ae=i(6754),ue=i(83495),Se=i(18353),pe=i(9398),_e=i(33567),Re=i(58614),Oe=i(55433),Ae=i(82762),He=i(59822),Ue=i(61575),G=i(70849),e=i(60255),t=i(13125),r=function(K){function I(y,m,x){var Y=K.call(this,y,m,x)||this;return Y.cacheService=y,Y.activeFolderIdService=m,Y.hostTaskSchedulerService=x,Y}return(0,Q.ZT)(I,K),I.prototype.createCacheKey=function(y){return"ScorecardReport_".concat(y.reportObjectId)},I.\u0275fac=function(m){return new(m||I)(o.\u0275\u0275inject(G.Q),o.\u0275\u0275inject(e.j),o.\u0275\u0275inject(t.c))},I.\u0275prov=o.\u0275\u0275defineInjectable({token:I,factory:I.\u0275fac,providedIn:"root"}),I}(Ue.Z),a=i(94938),n=function(){function K(I,y,m,x){this.goalsHttpService=I,this.scorecardCacheService=y,this.networkAvailability=m,this.errorService=x}return K.prototype.get=function(I){var y=this,m={reportObjectId:I},x=this.startCacheCall(m),Y=this.startNetworkCall(I),ye=Y?.pipe((0,W.b)(function(fe){fe.scorecard&&y.saveToCache(m,fe.scorecard)}));return Oe.z.apply(void 0,[x,ye])},K.prototype.startCacheCall=function(I){return(0,Ae.D)(this.scorecardCacheService.loadContract(I)).pipe((0,N.U)(function(y){return{scorecard:y}}),(0,He.K)(function(){return(0,d.of)({isCacheError:!0})}))},K.prototype.startNetworkCall=function(I){return this.networkAvailability.isNetworkAvailable()?this.goalsHttpService.getScorecardByReportId(I,!0).pipe((0,N.U)(function(y){return{scorecard:y}}),(0,He.K)(function(){return(0,d.of)({isNetworkError:!0})})):(0,d.of)({isNetworkError:!0})},K.prototype.saveToCache=function(I,y){try{this.scorecardCacheService.saveContract(y,I)}catch(m){this.errorService.shipAssert("ScorecardLoadService","saveToCache","unable save to cache ".concat(m))}},K.\u0275fac=function(y){return new(y||K)(o.\u0275\u0275inject(Re.f),o.\u0275\u0275inject(r),o.\u0275\u0275inject(_e.SW),o.\u0275\u0275inject(a.s))},K.\u0275prov=o.\u0275\u0275defineInjectable({token:K,factory:K.\u0275fac,providedIn:"root"}),K}(),l=i(31459),h=i(77476),S=i(86883),g=i(87582),A=i(24958),b=i(76137),re=i(11960),ee=i(18460),se=i(80649),ve=i(99754),me=function(){return{ignoreOverlay:!1,ignoreMobile:!1}},oe=function(I){return{scorecard:I}},ge=function(K){function I(y){var m=K.call(this)||this;return m.localizationService=y,m.isTablet=!1,m.closeAction=new o.EventEmitter,m}return(0,Q.ZT)(I,K),I.prototype.closeMenu=function(){this.closeAction.emit()},Object.defineProperty(I.prototype,"hierarchyModulePath",{get:function(){return"@powerbi/mobile/Goals/hierarchies/mobile-hierarchy.module#MobileHierarchyModule"},enumerable:!1,configurable:!0}),I.\u0275fac=function(m){return new(m||I)(o.\u0275\u0275directiveInject(z.o))},I.\u0275cmp=o.\u0275\u0275defineComponent({type:I,selectors:[["mobile-hierarchies-menu"]],hostVars:2,hostBindings:function(m,x){2&m&&o.\u0275\u0275classProp("isTablet",x.isTablet)},inputs:{isTablet:"isTablet",scorecard:"scorecard"},outputs:{closeAction:"closeAction"},features:[o.\u0275\u0275ProvidersFeature((0,Q.ev)([],re.W,!0)),o.\u0275\u0275InheritDefinitionFeature],decls:4,vars:7,consts:[["title","Hierarchies","focus-nav-mode","Group",3,"isTablet","closeAction"],[1,"hierarchies-menu-list",3,"pbiScrollbar"],[1,"scorecard-hierarchies"],["componentId","MobileHierarchiesTreeComponentId",3,"modulePath","inputArgs"]],template:function(m,x){1&m&&(o.\u0275\u0275elementStart(0,"mobile-action-menu-header",0),o.\u0275\u0275listener("closeAction",function(){return x.closeMenu()}),o.\u0275\u0275elementEnd(),o.\u0275\u0275elementStart(1,"div",1)(2,"div",2),o.\u0275\u0275element(3,"pbi-lazy-load",3),o.\u0275\u0275elementEnd()()),2&m&&(o.\u0275\u0275property("isTablet",x.isTablet),o.\u0275\u0275advance(1),o.\u0275\u0275property("pbiScrollbar",o.\u0275\u0275pureFunction0(4,me)),o.\u0275\u0275advance(2),o.\u0275\u0275property("modulePath",x.hierarchyModulePath)("inputArgs",o.\u0275\u0275pureFunction1(5,oe,x.scorecard)))},dependencies:[ee.R,se.r,ve.V],styles:['[_nghost-%COMP%]{height:100%;border-color:var(--fluentThemeNeutralQuarterAltColor)!important}.isTablet[_nghost-%COMP%]{width:260px}.isTablet[_nghost-%COMP%]   .hierarchies-menu-list[_ngcontent-%COMP%]{padding-top:0;overflow-y:scroll;height:calc(100% - 48px)!important}.isTablet[_nghost-%COMP%]   .hierarchies-menu-list[_ngcontent-%COMP%]   div[_ngcontent-%COMP%] > .hierarchy-menu-type-group[_ngcontent-%COMP%]{margin-bottom:12px}html:not([dir="rtl"])   .isTablet[_nghost-%COMP%]   .hierarchies-menu-list[_ngcontent-%COMP%]   div[_ngcontent-%COMP%] > .hierarchy-menu-type-group[_ngcontent-%COMP%]{padding-left:10px}html[dir="rtl"]   .isTablet[_nghost-%COMP%]   .hierarchies-menu-list[_ngcontent-%COMP%]   div[_ngcontent-%COMP%] > .hierarchy-menu-type-group[_ngcontent-%COMP%]{padding-right:10px}[_nghost-%COMP%]   tri-svg-icon[_ngcontent-%COMP%]{fill:var(--fluentThemeNeutralDarkColor)}.hierarchies-menu-list[_ngcontent-%COMP%]{list-style-type:none;width:100%;padding:0;margin:0;font-size:14px;font-weight:600;list-style:none;box-sizing:border-box}.hierarchies-menu-list[_ngcontent-%COMP%]   .scorecard-hierarchies[_ngcontent-%COMP%]{height:100%}.hierarchies-menu-list[_ngcontent-%COMP%]   .scorecard-hierarchies[_ngcontent-%COMP%]   .scorecard-hierarchy-title[_ngcontent-%COMP%]{padding-top:22px;display:flex;box-sizing:border-box;height:48px}html:not([dir="rtl"])[_nghost-%COMP%]   .hierarchies-menu-list[_ngcontent-%COMP%]   .scorecard-hierarchies[_ngcontent-%COMP%]   .scorecard-hierarchy-title[_ngcontent-%COMP%], html:not([dir="rtl"])   [_nghost-%COMP%]   .hierarchies-menu-list[_ngcontent-%COMP%]   .scorecard-hierarchies[_ngcontent-%COMP%]   .scorecard-hierarchy-title[_ngcontent-%COMP%]{padding-left:20px}html[dir="rtl"][_nghost-%COMP%]   .hierarchies-menu-list[_ngcontent-%COMP%]   .scorecard-hierarchies[_ngcontent-%COMP%]   .scorecard-hierarchy-title[_ngcontent-%COMP%], html[dir="rtl"]   [_nghost-%COMP%]   .hierarchies-menu-list[_ngcontent-%COMP%]   .scorecard-hierarchies[_ngcontent-%COMP%]   .scorecard-hierarchy-title[_ngcontent-%COMP%]{padding-right:20px}.hierarchies-menu-list[_ngcontent-%COMP%]   .scorecard-hierarchies[_ngcontent-%COMP%]   div[_ngcontent-%COMP%] > .hierarchy-menu-type-group[_ngcontent-%COMP%]{width:calc(100% - 36px);font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif;padding-top:2px}html:not([dir="rtl"])[_nghost-%COMP%]   .hierarchies-menu-list[_ngcontent-%COMP%]   .scorecard-hierarchies[_ngcontent-%COMP%]   div[_ngcontent-%COMP%] > .hierarchy-menu-type-group[_ngcontent-%COMP%], html:not([dir="rtl"])   [_nghost-%COMP%]   .hierarchies-menu-list[_ngcontent-%COMP%]   .scorecard-hierarchies[_ngcontent-%COMP%]   div[_ngcontent-%COMP%] > .hierarchy-menu-type-group[_ngcontent-%COMP%]{float:left}html[dir="rtl"][_nghost-%COMP%]   .hierarchies-menu-list[_ngcontent-%COMP%]   .scorecard-hierarchies[_ngcontent-%COMP%]   div[_ngcontent-%COMP%] > .hierarchy-menu-type-group[_ngcontent-%COMP%], html[dir="rtl"]   [_nghost-%COMP%]   .hierarchies-menu-list[_ngcontent-%COMP%]   .scorecard-hierarchies[_ngcontent-%COMP%]   div[_ngcontent-%COMP%] > .hierarchy-menu-type-group[_ngcontent-%COMP%]{float:right}mobile-hierarchy-node[_ngcontent-%COMP%]{width:100%;display:flex;flex-direction:column}html:not([dir="rtl"])[_nghost-%COMP%]   mobile-hierarchy-node[_ngcontent-%COMP%], html:not([dir="rtl"])   [_nghost-%COMP%]   mobile-hierarchy-node[_ngcontent-%COMP%]{text-align:right}html[dir="rtl"][_nghost-%COMP%]   mobile-hierarchy-node[_ngcontent-%COMP%], html[dir="rtl"]   [_nghost-%COMP%]   mobile-hierarchy-node[_ngcontent-%COMP%]{text-align:left}*[_ngcontent-%COMP%]{background-color:var(--fluentThemeNeutralLighterAltColor);-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;cursor:default;color:var(--fluentThemeNeutralDarkColor)}*[_ngcontent-%COMP%]:focus{outline:none}'],changeDetection:0}),I}(te.w),he=i(30956);function Me(K,I){if(1&K){var y=o.\u0275\u0275getCurrentView();o.\u0275\u0275elementStart(0,"mobile-notification-bar-container",1),o.\u0275\u0275listener("barClosed",function(){o.\u0275\u0275restoreView(y);var Y=o.\u0275\u0275nextContext();return o.\u0275\u0275resetView(Y.userClose())}),o.\u0275\u0275pipe(1,"async"),o.\u0275\u0275elementEnd()}if(2&K){var m=o.\u0275\u0275nextContext();o.\u0275\u0275property("items",o.\u0275\u0275pipeBind1(1,1,m.notificationBarItemArr$))}}var Fe={name:"organization_24_filled",sprite:"mobile-icons"},we=function(){function K(I){this.scorecardHierarchiesService=I,this.closedByUser$=new p.X(!1)}return K.prototype.ngOnInit=function(){this.setNotificationBarItems(),this.isAllowed$=this.scorecardHierarchiesService.hasHierarchies$,this.showNotificationBar$=(0,u.aj)([this.closedByUser$,this.isAllowed$,this.notificationBarItemArr$]).pipe((0,N.U)(function(I){var x=I[2];return I[1]&&!I[0]&&!!x?.length}))},K.prototype.userClose=function(){this.closedByUser$.next(!0)},K.prototype.setNotificationBarItems=function(){this.notificationBarItemArr$=this.scorecardHierarchiesService.selectedHierarchies$.pipe((0,N.U)(function(I){return I?.map(function(y){var m=y.levels.slice(-1).pop();return{itemTitle:m,icon:(0,Q.pi)((0,Q.pi)({},Fe),{title:m})}})}))},K.\u0275fac=function(y){return new(y||K)(o.\u0275\u0275directiveInject(F._))},K.\u0275cmp=o.\u0275\u0275defineComponent({type:K,selectors:[["mobile-hierarchies-notification-bar"]],features:[o.\u0275\u0275ProvidersFeature((0,Q.ev)([],re.W,!0))],decls:2,vars:3,consts:[[3,"items","barClosed",4,"ngIf"],[3,"items","barClosed"]],template:function(y,m){1&y&&(o.\u0275\u0275template(0,Me,2,3,"mobile-notification-bar-container",0),o.\u0275\u0275pipe(1,"async")),2&y&&o.\u0275\u0275property("ngIf",o.\u0275\u0275pipeBind1(1,1,m.showNotificationBar$))},dependencies:[h.NgIf,he.Z,h.AsyncPipe],styles:["[_nghost-%COMP%]{position:relative;width:100%}.opacity-50[_nghost-%COMP%]{opacity:.5}mobile-notification-bar-container[_ngcontent-%COMP%]{display:inline-block}"],changeDetection:0}),K}(),Pe=["scorecardContainer"];function Ee(K,I){if(1&K&&(o.\u0275\u0275elementStart(0,"mobile-hierarchies-notification-bar"),o.\u0275\u0275pipe(1,"async"),o.\u0275\u0275elementEnd()),2&K){var y=o.\u0275\u0275nextContext();o.\u0275\u0275classProp("opacity-50",o.\u0275\u0275pipeBind1(1,2,y.hasActiveMenu$))}}function be(K,I){if(1&K&&(o.\u0275\u0275elementStart(0,"div",11)(1,"div",12),o.\u0275\u0275text(2),o.\u0275\u0275elementEnd()()),2&K){var y=o.\u0275\u0275nextContext();o.\u0275\u0275advance(1),o.\u0275\u0275attribute("aria-label",y.scorecard.description),o.\u0275\u0275advance(1),o.\u0275\u0275textInterpolate(y.scorecard.description)}}function Te(K,I){if(1&K){var y=o.\u0275\u0275getCurrentView();o.\u0275\u0275elementStart(0,"goals-cards",13),o.\u0275\u0275listener("onStatusSelected",function(Y){o.\u0275\u0275restoreView(y);var ye=o.\u0275\u0275nextContext();return o.\u0275\u0275resetView(ye.onGoalsCardSelectionChange(Y))}),o.\u0275\u0275pipe(1,"async"),o.\u0275\u0275elementEnd()}if(2&K){var m=o.\u0275\u0275nextContext();o.\u0275\u0275property("goals",m.allMetrics)("goalStatusesByScorecardId",m.goalStatusesByScorecardId)("goalStatusList",null==m.scorecard.goalStatuses?null:m.scorecard.goalStatuses.statuses)("selectedStatuses",o.\u0275\u0275pipeBind1(1,5,m.filterBy$).statuses)("enableSimpleMultiSelect",!0)}}function $e(K,I){if(1&K&&o.\u0275\u0275element(0,"scorecard-lazy",14),2&K){var y=o.\u0275\u0275nextContext();o.\u0275\u0275property("scorecardDetails",y.scorecardDetails)("scorecardConfiguration",y.scorecardConfiguration)}}function Ie(K,I){if(1&K){var y=o.\u0275\u0275getCurrentView();o.\u0275\u0275elementStart(0,"mobile-hierarchies-menu",15),o.\u0275\u0275listener("closeAction",function(){o.\u0275\u0275restoreView(y);var Y=o.\u0275\u0275nextContext();return o.\u0275\u0275resetView(Y.closeFooterMenu())}),o.\u0275\u0275elementEnd()}if(2&K){var m=o.\u0275\u0275nextContext();o.\u0275\u0275property("scorecard",m.scorecard)}}function je(K,I){if(1&K){var y=o.\u0275\u0275getCurrentView();o.\u0275\u0275elementStart(0,"div",16)(1,"mobile-hierarchies-menu",17),o.\u0275\u0275listener("closeAction",function(){o.\u0275\u0275restoreView(y);var Y=o.\u0275\u0275nextContext();return o.\u0275\u0275resetView(Y.closeHierarchiesSideMenu())}),o.\u0275\u0275elementEnd()()}if(2&K){var m=o.\u0275\u0275nextContext();o.\u0275\u0275advance(1),o.\u0275\u0275property("isTablet",!0)("scorecard",m.scorecard)}}var Le=function(){return{enabled:!0}},Ne=function(K){function I(y,m,x,Y,ye,Ge,fe){var le=K.call(this)||this;return le.mobileFooterService=y,le.scorecardLoadService=x,le.scorecardApplicationApiService=Y,le.scorecardHierarchiesService=ye,le.goalsActionService=Ge,le.ngZone=fe,le.hasSavedGoals$=new p.X(!1),le.filterBy$=new p.X({}),le.cssClassName="",le.cssDetailsPaneOpen="",le.reportObjectId=m.snapshot.queryParamMap.get("reportObjectId"),le.scorecardHierarchiesService.initSelectedHierarchies(m.snapshot.queryParamMap.get("hierarchyPath")),le}return(0,Q.ZT)(I,K),I.prototype.ngOnInit=function(){var y=this;this.loadScorecard(),this.maxFooterActionsDisplayed$=this.scorecardApplicationApiService.scorecardApiOptions$.pipe((0,N.U)(function(m){var x,Y;return null!==(Y=null===(x=m.footerOptions)||void 0===x?void 0:x.maxFooterActionsDisplayed)&&void 0!==Y?Y:5})),this.isFooterUnlocked$=this.scorecardApplicationApiService.scorecardApiOptions$.pipe((0,N.U)(function(m){var x;return!1===(null===(x=m.footerOptions)||void 0===x?void 0:x.footerLocked)})),this.detailsPaneVisibilityChange(),this.activeMenu$=this.mobileFooterService.activeMenu$.pipe((0,N.U)(function(m){return m.activeMenu}),(0,k.d)(1)),this.hasActiveMenu$=this.activeMenu$.pipe((0,N.U)(function(m){return 0!==m})),this.scorecardHierarchiesService.selectedHierarchies$.pipe((0,ne.R)(this.onDestroy$)).subscribe(function(){var m=y.filterBy$.value;m.statuses=[],y.filterBy$.next(m)})},I.prototype.ngOnDestroy=function(){return this.scorecardHierarchiesService.clearSelectedHierarchies(),this.scorecardHierarchiesService.toggleSideMenu(!1),K.prototype.ngOnDestroy.call(this)},I.prototype.ngAfterViewInit=function(){this.scrollEventListener()},I.prototype.closeFooterMenu=function(){this.mobileFooterService.closeMenu()},I.prototype.closeHierarchiesSideMenu=function(){this.scorecardHierarchiesService.toggleSideMenu(!1)},Object.defineProperty(I.prototype,"isSideMenuOpen$",{get:function(){return this.scorecardHierarchiesService.isSideMenuOpen$},enumerable:!1,configurable:!0}),Object.defineProperty(I.prototype,"hasHierarchies$",{get:function(){return this.scorecardHierarchiesService.hasHierarchies$},enumerable:!1,configurable:!0}),Object.defineProperty(I.prototype,"hierarchiesFooterAction",{get:function(){return 100},enumerable:!1,configurable:!0}),I.prototype.onGoalsCardSelectionChange=function(y){var m,x={keyword:null===(m=this.filterBy$.value)||void 0===m?void 0:m.keyword,statuses:y};this.filterBy$.next(x)},I.prototype.scrollEventListener=function(){var y=this;(0,X.R)(this.scorecardContainer.nativeElement,"scroll").pipe((0,ae.b)(100),(0,ne.R)(this.onDestroy$)).subscribe(function(){y.goalsActionService.invokeToNativeScorecardScroll(y.scorecardContainer.nativeElement.scrollTop)})},I.prototype.detailsPaneVisibilityChange=function(){var y=this;this.scorecardApplicationApiService.goalDetailsPaneVisibility$.pipe((0,ne.R)(this.onDestroy$)).subscribe(function(m){y.ngZone.run(function(){y.cssDetailsPaneOpen=m?.isOpen?"detailsPaneOpen":""})})},I.prototype.loadScorecard=function(){var y=this,x=this.scorecardApplicationApiService.refresh$.pipe((0,j.w)(function(){return y.scorecardLoadService.get(y.reportObjectId)}),(0,ue.B)());this.handleScorecardLoaded(x),this.handleScorecardNotLoaded(x)},I.prototype.handleScorecardLoaded=function(y){var m=this;y.pipe((0,ne.R)(this.onDestroy$),(0,B.h)(function(Y){return!!Y?.scorecard}),(0,C.x)()).subscribe(function(Y){m.ngZone.run(function(){var ye;m.scorecard!==Y.scorecard&&(m.setScorecard(Y.scorecard),m.scorecardDetails={groupId:m.scorecard.groupId,scorecardId:m.scorecard.id,prefetchedScorecard:null!==(ye=m.scorecardHierarchiesService.selectedHierarchies)&&void 0!==ye&&ye.length?void 0:m.scorecard,reload:!0,onFiltersUpdated:function(fe){return m.onFiltersUpdated(fe)},onScorecardUpdated:function(fe){return m.update(fe)},filterBy$:m.filterBy$.asObservable(),initialHierarchyPath:m.scorecardHierarchiesService.getEncodedHierarchies()})})}),(0,u.aj)([this.scorecardApplicationApiService.scorecardApiOptions$,y]).pipe((0,ne.R)(this.onDestroy$),(0,B.h)(function(Y){var ye=Y[0],Ge=Y[1];return!!Ge?.scorecard&&!!ye}),(0,C.x)()).subscribe(function(Y){var ye,Ge=Y[0],le=m.getSparklineDimensions(Ge.scorecardLayout);m.scorecardConfiguration={scorecardDisplayOptions:{isMobileLayout:!0,sparklineOptions:le}},m.cssClassName=[Ge.scorecardLayout,null!==(ye=Ge.footerOptions)&&void 0!==ye&&ye.showFooter?"showFooter":""].join(" ")})},I.prototype.update=function(y){y?(this.setScorecard(y),this.showStatus=D._.isColumnVisible(y.columnSettings,2),this.goalStatusesByScorecardId=Z.p.getGoalStatusesByScorecardId(y)):J.fF.assertFail("Missing scorecard details")},I.prototype.setScorecard=function(y){var m,x;this.scorecard=y,this.hasSavedGoals$.next((null===(x=null===(m=y?.goals)||void 0===m?void 0:m.filter(function(Y){return!Y?.isNew}))||void 0===x?void 0:x.length)>0),this.allMetrics=O.q.flattenGoals(y.goals)},I.prototype.onFiltersUpdated=function(y){this.filterBy$.next(y)},I.prototype.handleScorecardNotLoaded=function(y){var m=this;y.pipe((0,ne.R)(this.onDestroy$),(0,B.h)(function(x){return x?.isCacheError||x?.isNetworkError}),(0,Se.R)(function(x,Y){return x.isCacheError=Y.isCacheError?Y.isCacheError:x.isCacheError,x.isNetworkError=Y.isNetworkError?Y.isNetworkError:x.isNetworkError,x}),(0,B.h)(function(x){return x.isNetworkError&&x.isCacheError})).subscribe(function(x){m.goalsActionService.invokeToNativeScorecardLoaded(x),m.scorecardApplicationApiService.deferredScorecardLoadedTelemetryEvent.reject({errorCode:"-3",errorMessage:"Attempting to load scorecard failed both from cache and network for mobile device"})})},I.prototype.getSparklineDimensions=function(y){var m={height:48,width:120};switch(y){case"phonePortraitLayout":m={height:42,width:112};break;case"phoneLandscapeLayout":case"tabletPortraitLayout":m={height:38,width:90};break;case"tabletLandscapeLayout":case"windowsLandscapeLayout":m={height:38,width:140};break;case"windowsPortraitLayout":m={height:38,width:106}}return m},I.\u0275fac=function(m){return new(m||I)(o.\u0275\u0275directiveInject(q.Gc),o.\u0275\u0275directiveInject(pe.gz),o.\u0275\u0275directiveInject(n),o.\u0275\u0275directiveInject(L.d),o.\u0275\u0275directiveInject(F._),o.\u0275\u0275directiveInject(l.h),o.\u0275\u0275directiveInject(o.NgZone))},I.\u0275cmp=o.\u0275\u0275defineComponent({type:I,selectors:[["mobile-scorecard-container"]],viewQuery:function(m,x){var Y;(1&m&&o.\u0275\u0275viewQuery(Pe,5),2&m)&&(o.\u0275\u0275queryRefresh(Y=o.\u0275\u0275loadQuery())&&(x.scorecardContainer=Y.first))},hostVars:4,hostBindings:function(m,x){2&m&&(o.\u0275\u0275classMap(x.cssClassName),o.\u0275\u0275classProp("detailsPaneOpen",x.cssDetailsPaneOpen))},features:[o.\u0275\u0275ProvidersFeature([{provide:q.Gc,useClass:de}]),o.\u0275\u0275InheritDefinitionFeature],decls:19,vars:27,consts:[[1,"scorecard-container-content"],[3,"opacity-50",4,"ngIf"],[1,"metrics-content"],["class","header",4,"ngIf"],[3,"goals","goalStatusesByScorecardId","goalStatusList","selectedStatuses","enableSimpleMultiSelect","onStatusSelected",4,"ngIf"],[1,"mobileScorecardContainer",3,"modern-canvas-scroll"],["scorecardContainer",""],[3,"scorecardDetails","scorecardConfiguration",4,"ngIf"],["prevent-focus-loss","false",3,"maxFooterActionsDisplayed"],["class","hoveringFooter footerMenu",3,"scorecard","closeAction",4,"ngIf"],["class","side-pane",4,"ngIf"],[1,"header"],[1,"subtitle"],[3,"goals","goalStatusesByScorecardId","goalStatusList","selectedStatuses","enableSimpleMultiSelect","onStatusSelected"],[3,"scorecardDetails","scorecardConfiguration"],[1,"hoveringFooter","footerMenu",3,"scorecard","closeAction"],[1,"side-pane"],[3,"isTablet","scorecard","closeAction"]],template:function(m,x){1&m&&(o.\u0275\u0275elementStart(0,"div",0),o.\u0275\u0275template(1,Ee,2,4,"mobile-hierarchies-notification-bar",1),o.\u0275\u0275pipe(2,"async"),o.\u0275\u0275elementStart(3,"div",2),o.\u0275\u0275template(4,be,3,2,"div",3),o.\u0275\u0275template(5,Te,2,7,"goals-cards",4),o.\u0275\u0275pipe(6,"async"),o.\u0275\u0275elementStart(7,"div",5,6),o.\u0275\u0275pipe(9,"async"),o.\u0275\u0275template(10,$e,1,2,"scorecard-lazy",7),o.\u0275\u0275elementEnd(),o.\u0275\u0275elementStart(11,"mobile-footer",8),o.\u0275\u0275pipe(12,"async"),o.\u0275\u0275template(13,Ie,1,1,"mobile-hierarchies-menu",9),o.\u0275\u0275pipe(14,"async"),o.\u0275\u0275pipe(15,"async"),o.\u0275\u0275elementEnd()()(),o.\u0275\u0275template(16,je,2,2,"div",10),o.\u0275\u0275pipe(17,"async"),o.\u0275\u0275pipe(18,"async")),2&m&&(o.\u0275\u0275advance(1),o.\u0275\u0275property("ngIf",o.\u0275\u0275pipeBind1(2,10,x.hasHierarchies$)),o.\u0275\u0275advance(3),o.\u0275\u0275property("ngIf",x.scorecard&&x.scorecard.description),o.\u0275\u0275advance(1),o.\u0275\u0275property("ngIf",x.showStatus&&o.\u0275\u0275pipeBind1(6,12,x.hasSavedGoals$)),o.\u0275\u0275advance(2),o.\u0275\u0275classProp("footer-unlocked",o.\u0275\u0275pipeBind1(9,14,x.isFooterUnlocked$)),o.\u0275\u0275property("modern-canvas-scroll",o.\u0275\u0275pureFunction0(26,Le)),o.\u0275\u0275advance(3),o.\u0275\u0275property("ngIf",x.scorecardDetails),o.\u0275\u0275advance(1),o.\u0275\u0275property("maxFooterActionsDisplayed",o.\u0275\u0275pipeBind1(12,16,x.maxFooterActionsDisplayed$)),o.\u0275\u0275advance(2),o.\u0275\u0275property("ngIf",o.\u0275\u0275pipeBind1(14,18,x.activeMenu$)===x.hierarchiesFooterAction&&o.\u0275\u0275pipeBind1(15,20,x.hasHierarchies$)),o.\u0275\u0275advance(3),o.\u0275\u0275property("ngIf",o.\u0275\u0275pipeBind1(17,22,x.isSideMenuOpen$)&&o.\u0275\u0275pipeBind1(18,24,x.hasHierarchies$)))},dependencies:[h.NgIf,S.S,g.a,A.V,b.L,ge,we,h.AsyncPipe],styles:['[_nghost-%COMP%]{height:100vh;display:flex;flex-direction:row;background-color:var(--fluentThemeWhiteColor);overflow-y:hidden}.tabletPortraitLayout[_nghost-%COMP%]   .scorecard-container-content[_ngcontent-%COMP%]   .metrics-content[_ngcontent-%COMP%]   .header[_ngcontent-%COMP%], .tabletLandscapeLayout[_nghost-%COMP%]   .scorecard-container-content[_ngcontent-%COMP%]   .metrics-content[_ngcontent-%COMP%]   .header[_ngcontent-%COMP%], .windowsPortraitLayout[_nghost-%COMP%]   .scorecard-container-content[_ngcontent-%COMP%]   .metrics-content[_ngcontent-%COMP%]   .header[_ngcontent-%COMP%], .windowsLandscapeLayout[_nghost-%COMP%]   .scorecard-container-content[_ngcontent-%COMP%]   .metrics-content[_ngcontent-%COMP%]   .header[_ngcontent-%COMP%]{padding:20px 0 0}.tabletPortraitLayout[_nghost-%COMP%]   .scorecard-container-content[_ngcontent-%COMP%]   .metrics-content[_ngcontent-%COMP%], .windowsPortraitLayout[_nghost-%COMP%]   .scorecard-container-content[_ngcontent-%COMP%]   .metrics-content[_ngcontent-%COMP%]{padding:0 20px}.tabletLandscapeLayout[_nghost-%COMP%]   .scorecard-container-content[_ngcontent-%COMP%]   .metrics-content[_ngcontent-%COMP%], .windowsLandscapeLayout[_nghost-%COMP%]   .scorecard-container-content[_ngcontent-%COMP%]   .metrics-content[_ngcontent-%COMP%]{padding:0 76px}.detailsPaneOpen.phonePortraitLayout[_nghost-%COMP%]   .scorecard-container-content[_ngcontent-%COMP%]   .header[_ngcontent-%COMP%], .detailsPaneOpen.phonePortraitLayout[_nghost-%COMP%]   .scorecard-container-content[_ngcontent-%COMP%]   goals-cards[_ngcontent-%COMP%]{display:none}.side-pane[_ngcontent-%COMP%]{display:flex;flex-direction:column;background:var(var(--theme-secondary-alt-color, #444444));border-width:0 0 0 1px;border-style:solid;border-color:var(--theme-secondary-color, #000000);z-index:4;color:var(--fluentThemeWhiteColor);-webkit-transition:all .3s;transition:right .3s;border-color:var(--fluentThemeNeutralQuarterAltColor)!important}.scorecard-container-content[_ngcontent-%COMP%]{display:flex;flex-direction:column;overflow:auto;flex:1 1 auto}.scorecard-container-content[_ngcontent-%COMP%]   .metrics-content[_ngcontent-%COMP%]{display:flex;flex-direction:column;overflow:hidden}.scorecard-container-content[_ngcontent-%COMP%]   .metrics-content[_ngcontent-%COMP%]   .header[_ngcontent-%COMP%]{display:flex;flex-direction:row;background-color:var(--fluentThemeWhiteColor);font-size:12px;padding:20px 20px 0;justify-content:flex-start;align-items:center}.scorecard-container-content[_ngcontent-%COMP%]   .metrics-content[_ngcontent-%COMP%]   .header[_ngcontent-%COMP%]   .glyphicon[_ngcontent-%COMP%]{font-size:18px;color:var(--fluentThemeNeutralPrimaryAltColor)}html:not([dir="rtl"])[_nghost-%COMP%]   .scorecard-container-content[_ngcontent-%COMP%]   .metrics-content[_ngcontent-%COMP%]   .header[_ngcontent-%COMP%]   .glyphicon[_ngcontent-%COMP%], html:not([dir="rtl"])   [_nghost-%COMP%]   .scorecard-container-content[_ngcontent-%COMP%]   .metrics-content[_ngcontent-%COMP%]   .header[_ngcontent-%COMP%]   .glyphicon[_ngcontent-%COMP%]{padding-left:10px}html[dir="rtl"][_nghost-%COMP%]   .scorecard-container-content[_ngcontent-%COMP%]   .metrics-content[_ngcontent-%COMP%]   .header[_ngcontent-%COMP%]   .glyphicon[_ngcontent-%COMP%], html[dir="rtl"]   [_nghost-%COMP%]   .scorecard-container-content[_ngcontent-%COMP%]   .metrics-content[_ngcontent-%COMP%]   .header[_ngcontent-%COMP%]   .glyphicon[_ngcontent-%COMP%]{padding-right:10px}.scorecard-container-content[_ngcontent-%COMP%]   .metrics-content[_ngcontent-%COMP%]   .header[_ngcontent-%COMP%]   .subtitle[_ngcontent-%COMP%]{line-height:16px;color:var(--fluentThemeNeutralDarkColor)}.scorecard-container-content[_ngcontent-%COMP%]   .metrics-content[_ngcontent-%COMP%]   .mobileScorecardContainer[_ngcontent-%COMP%]{overflow-y:auto;will-change:scroll-position}.scorecard-container-content[_ngcontent-%COMP%]   .metrics-content[_ngcontent-%COMP%]   .mobileScorecardContainer[_ngcontent-%COMP%]   .footer-unlocked[_ngcontent-%COMP%]{min-height:calc(100vh - 100px)}.scorecard-container-content[_ngcontent-%COMP%]   .metrics-content[_ngcontent-%COMP%]     .cdk-overlay-pane .pbi-overlay-caret.pbi-overlay-caret-medium{background-color:var(--fluentThemeWhiteColor)!important;border:1px solid var(--fluentThemeWhiteColor)!important}.scorecard-container-content[_ngcontent-%COMP%]   .metrics-content[_ngcontent-%COMP%]     .cdk-overlay-pane .pbi-overlay-caret.pbi-overlay-caret-medium .pbi-tooltip-content{background-color:var(--fluentThemeWhiteColor)!important;color:var(--fluentThemeNeutralDarkColor)}.scorecard-container-content[_ngcontent-%COMP%]   .metrics-content[_ngcontent-%COMP%]     .cdk-overlay-pane .pbi-overlay-caret.pbi-overlay-caret-medium:after{background:var(--fluentThemeWhiteColor);border:1px solid var(--fluentThemeWhiteColor);border-radius:unset}']}),I}(te.w),Ve=i(59505),Je=i(76072),ke=i(77906),Qe=i(95859),Xe=i(8786),Ze=i(29396),Ye=i(72359),qe=i(17177),ze={loadChildren:function(){return i.e("mobile-hierarchy").then(i.bind(i,30636)).then(function(I){return I.MobileHierarchyModule})}};Je.E.addLazyLoadForLegacyMapping("@powerbi/mobile/Goals/hierarchies/mobile-hierarchy.module#MobileHierarchyModule",ze.loadChildren);var et=[{path:"",component:Ne},{loadChildren:ze.loadChildren,path:"dummy-mobile-hierarchies-module"}],tt=function(){function K(){}return K.\u0275fac=function(y){return new(y||K)},K.\u0275mod=o.\u0275\u0275defineNgModule({type:K}),K.\u0275inj=o.\u0275\u0275defineInjector({imports:[h.CommonModule,Ve.q,ke.N,pe.Bz.forChild(et),Ye.K,Qe.v,s.c,Xe.f.forRoot([Ze.V]),qe.T6]}),K}()},60166:function(Ce,ce,i){i.d(ce,{M:function(){return Q}});var Q=new(i(50423).InjectionToken)("ScorecardHostService")},98587:function(Ce,ce,i){i.d(ce,{u:function(){return Q}});var Q=new(i(50423).InjectionToken)("ScorecardSettingsService")},70060:function(Ce,ce,i){function s(Q){if(null==Q)return 0;if("number"==typeof Q)return Q;if("string"==typeof Q)switch(Q.toString().trim().toLowerCase()){case"none":return 0;case"read":default:return 1;case"write":return 2;case"readwrite":return 3}return 0}i.d(ce,{l:function(){return s}})},77695:function(Ce,ce,i){i.d(ce,{p:function(){return V}});var s=i(60042),Q=i(125),q=i(57535),V=function(){function H(){}return H.sortAndFilter=function(P,f,c,p){if(_.isEmpty(P))return P;var u=f.sortAscending?"asc":"desc",d=[this.sortingFunctions[f.sortBy]];return"Rank"===f.sortBy&&d.push(this.sortingFunctions.CreatedTime),d.push("Name"===f.sortBy?this.sortingFunctions.CreatedTime:this.sortingFunctions.Name),this.sortRecursive(P,u,d,c,p)},H.sort=function(P,f){return this.sortAndFilter(P,f,{},{})},H.toggleSort=function(P,f){return f?P.sortBy===f?P.sortAscending?{sortBy:P.sortBy,sortAscending:!1}:s.Ij:{sortBy:f,sortAscending:!0}:P},H.sortRecursive=function(P,f,c,p,u){for(var d=0,M=P=_.orderBy(P,c,[f,"asc"]);d<M.length;d++){var E=M[d];_.isEmpty(E.subGoals)||(E.subGoals=this.sortRecursive(E.subGoals,f,c,p,u)),_.isNil(u)?(delete E.isFilterMatch,delete E.isHidden):(E.isFilterMatch=H.matchesFilter(E,p,u),E.isHidden=!E.isFilterMatch&&!_.some(E.subGoals,function(B){return!B.isHidden}))}return P},H.matchesFilter=function(P,f,c){var p,u,d,M,E;if(_.isNil(c)||P.isNew||"Editing"===P.state||"Saving"===P.state)return!0;var B=null!==(p=Q.r.buildCurrentGoalValue(P).status)&&void 0!==p?p:0,W=q.p.getGoalStatusForScorecardId(B,P.scorecardId,f),N=!1,k=null===(u=c?.keyword)||void 0===u?void 0:u.toLocaleLowerCase();if(!_.isString(k)||_.isEmpty(k))N=!0;else if(!(null===(d=P.name)||void 0===d)&&d.toLocaleLowerCase().includes(k)&&(N=!0),c?.matchOwner&&!N&&((null===(M=P.ownerDisplayNames)||void 0===M?void 0:M.length)>=1?N=_.some(P.ownerDisplayNames,function(o){return o?.toLocaleLowerCase().includes(k)}):(N=null===(E=P.owner)||void 0===E?void 0:E.toLocaleLowerCase().includes(k))||(N=_.some(P.additionalOwners,function(o){var v,U=null!==(v=o.userPrincipalName)&&void 0!==v?v:o.aadAppId;return U?.toLocaleLowerCase().includes(k)}))),c?.matchStatus&&!N){var j=W.displayName;j?.toLocaleLowerCase().includes(k)&&(N=!0)}var C=!1;return(_.isNil(c?.statuses)||_.isEmpty(c?.statuses)||q.p.listIncludesMatchingStatus(c.statuses,W))&&(C=!0),N&&C},H.sortingFunctions={Rank:function(f){return f.rank},CreatedTime:function(f){return f.createdTime},Name:function(f){var c;return null===(c=f.name)||void 0===c?void 0:c.trim().toLocaleLowerCase()},Owner:function(f){var c,p,u;return null===(u=null!==(p=null===(c=f.ownerDisplayNames)||void 0===c?void 0:c[0])&&void 0!==p?p:f.owner)||void 0===u?void 0:u.trim().toLocaleLowerCase()},Status:function(f){return(Q.r.buildCurrentGoalValue(f).status+1)%6},Value:function(f){return Q.r.buildCurrentGoalValue(f).value},Change:function(f){return Q.r.calculateValueChange(f,!0).changeAmount},Milestone:function(f){return Q.r.buildCurrentGoalValue(f).nextTarget},Target:function(f){return Q.r.buildCurrentGoalValue(f).finalTarget},DueDate:function(f){return f.completionDate}},H}()},45017:function(Ce,ce,i){i.d(ce,{B:function(){return Q}});var s=i(62458),Q=function(){function q(){}return q.getGoalValueMap=function(V){var H=new Map;if(_.isEmpty(V))return H;for(var P=0,f=V;P<f.length;P++){var c=f[P];H.set(new Date(c.timestamp).getTime(),c)}return H},q.areGoalValuesEqual=function(V,H,P,f){return s.fF.assertValue(V,"goalValueOne"),s.fF.assertValue(H,"goalValueTwo"),!(!P&&V.value!==H.value||!f&&V.target!==H.target||V.trend!==H.trend||V.forecast!==H.forecast||V.status!==H.status)},q.diffGoalValues=function(V,H){s.fF.assertValue(V,"goalValueOne"),s.fF.assertValue(H,"goalValueTwo");var P={timestamp:V.timestamp,goalId:V.goalId,scorecardId:V.scorecardId,createdTime:V.createdTime,lastModifiedTime:V.lastModifiedTime};return V.value!==H.value&&(P.value=V.value),V.target!==H.target&&(P.target=V.target),V.trend!==H.trend&&(P.trend=V.trend),V.forecast!==H.forecast&&(P.forecast=V.forecast),V.status!==H.status&&(P.status=V.status),P},q.calculateGoalValueChanges=function(V,H){for(var P=[],f=new Map,c=0,p=V;c<p.length;c++){var u=p[c],d=new Date(u.timestamp).getTime();f.set(d,u.value)}for(var M=0,E=H;M<E.length;M++)u=E[M],d=new Date(u.timestamp).getTime(),f.has(d)?u.value!==f.get(d)&&P.push(u):P.push(u);for(var B=new Set,W=0,N=H;W<N.length;W++)u=N[W],d=new Date(u.timestamp).getTime(),B.add(d);for(var k=0,j=V;k<j.length;k++)u=j[k],d=new Date(u.timestamp).getTime(),B.has(d)||P.push({timestamp:u.timestamp,value:null});return P},q}()},61088:function(Ce,ce,i){i.d(ce,{_:function(){return q}});var s=i(81337),Q=i(558),q=function(){function V(){}return V.moveColumnSettingUp=function(H,P){if(!(_.size(H)<=1||0===P)){var f=H;return(0,s.ev)((0,s.ev)((0,s.ev)([],_.slice(f,0,P-1),!0),[f[P],f[P-1]],!1),_.slice(f,P+1),!0)}},V.moveColumnSettingDown=function(H,P){if(!(_.size(H)<=1||P===_.size(H)-1)){var f=H;return(0,s.ev)((0,s.ev)((0,s.ev)([],_.slice(f,0,P),!0),[f[P+1],f[P]],!1),_.slice(f,P+2),!0)}},V.canMoveLeft=function(H,P){if(P<=1)return!1;var f=_.slice(H,0,P);return _.findLastIndex(f,function(p){return p.show})>0},V.canMoveRight=function(H,P){return!(0===P||P>=H.length-1)&&_.findIndex(H,function(c){return c.show},P+1)>P},V.moveColumnLeft=function(H,P){var f=_.findIndex(H,function(u){return u.columnId===P}),c=_.slice(H,0,f),p=_.findLastIndex(c,function(u){return u.show});(0,Q.bA)(H,f,p)},V.moveColumnRight=function(H,P){var f=_.findIndex(H,function(p){return p.columnId===P}),c=_.findIndex(H,function(p){return p.show},f+1);(0,Q.bA)(H,f,c)},V.hideColumn=function(H,P){var f=_.findIndex(H,function(c){return c.columnId===P});f>=0&&(H[f].show=!1)},V.showColumn=function(H,P){var f=_.findIndex(H,function(c){return c.columnId===P});f>=0&&(H[f].show=!0)},V.isColumnVisible=function(H,P){var f=_.find(H,function(c){return c.columnId===P});return!!_.isUndefined(f?.show)||f.show},V.mergeColumns=function(H,P){for(var f=new Array,c=new Set(P.map(function(N){return N.columnId})),p=new Set,u=0,d=H;u<d.length;u++){var M=d[u];c.has(M.columnId)&&!p.has(M.columnId)&&(f.push(M),p.add(M.columnId))}for(var E=0,B=P;E<B.length;E++){var W=B[E];p.has(W.columnId)||f.push(W)}return f},V.removeColumnSettings=function(H,P){var f=new Set(P);_.remove(H,function(c){return f.has(c.columnId)})},V.adjustColumnSettings=function(H,P){H.featureSwitches.scorecardSplitColumns||(V.removeColumnSettings(P,[7,8,9]),V.isColumnVisible(P,3)||V.showColumn(P,3)),H.featureSwitches.scorecardCompactView||V.removeColumnSettings(P,[10])},V}()},11960:function(Ce,ce,i){i.d(ce,{W:function(){return W}});var s=i(33014),Q=i(74521),q=i(34340),V=i(99327),H=i(73911),P=i(21719),f=i(87426),c=i(20930),p=i(93379),u=i(62087),d=i(32027),M=i(49223),E=i(50423),B=i(60166),W=[s.D,q.c,V.X,H.$,P.D,f.G,Q.D,c.N,p.Nw,u.l,M.G,d.w,{provide:B.M,useFactory:function(k){return k},deps:[[new E.Optional,new E.SkipSelf,B.M]]}]},33014:function(Ce,ce,i){i.d(ce,{D:function(){return k}});var s=i(81337),Q=i(50423),q=i(34071),V=i(98632),H=i(43633),P=i(60166),f=i(62458),c=i(43286),p=i(14172),u=i(59973),d=i(85732),M=i(50911),E=i(19178),B=i(94420),W=i(18942),N=i(76746),k=function(){function j(C,o,v,U,T,w,R){this.store=C,this.datasetStore=o,this.domSanitizer=v,this.groupStoreService=U,this.reportStore=T,this.appSettings=w,this.scorecardHost=R}return j.prototype.getConnectedReport=function(C){var o,v;f.fF.assertValue(C.reportUrl,"No connected report url");var U=null===(o=C.reportUrl.match(/\/reports\/([a-zA-Z0-9\-]+)/))||void 0===o?void 0:o[1],T=null===(v=C.reportUrl.match(/\/groups\/([a-zA-Z0-9\-]+)/))||void 0===v?void 0:v[1];return this.getReport(U,T)},j.prototype.getConnectedReportDisplayName=function(C){var o,v=null===(o=C.reportUrl.match(/\/apps\/([a-zA-Z0-9\-]+)/))||void 0===o?void 0:o[1];return this.getConnectedReport(C).pipe((0,p.U)(function(U){return v?U.ownerFullname:U.displayName}))},j.prototype.goToConnectedReport=function(C){f.fF.assertValue(C.reportUrl,"No connected report url");var v,o=C.reportUrl.indexOf("?")>=0?"&":"?";if(v=this.appSettings.tenantId?"".concat(C.reportUrl).concat(o,"ctid=").concat(this.appSettings.tenantId):C.reportUrl,this.scorecardHost)this.scorecardHost.openReport(v);else{var U=new URL(v,window.location.origin).href;window.open(this.domSanitizer.sanitize(Q.SecurityContext.URL,U),"_blank")}},j.prototype.getReport=function(C,o){return this.store.dispatch(new V.yi({reportObjectId:C,workspaceObjectId:o})),this.store.select(H.W4,{id:C}).pipe((0,u.h)(function(v){return!!v&&!v.loading}))},j.prototype.getConnectedGoalsWithoutBuildPermissions=function(C){var o,v;return(0,s.mG)(this,void 0,void 0,function(){var U,T,w,R,z,ie,L;return(0,s.Jh)(this,function(F){switch(F.label){case 0:return U=[],[4,this.groupStoreService.ensureGroupArtifactsLoaded(q.fm,!0)];case 1:F.sent(),T=0,w=C,F.label=2;case 2:return T<w.length?(R=w[T]).valueConnection?[4,this.datasetStore.findDatasetByObjectId(R.valueConnection.datasetId)]:[3,5]:[3,9];case 3:return(!(z=F.sent())||!this.hasDatasetBuildPermission(z))&&U.push(R.name),f.fF.assertValue(R.valueConnection.reportUrl,"No value connected report url"),ie=null===(o=R.valueConnection.reportUrl.match(/\/reports\/([a-zA-Z0-9\-]+)/))||void 0===o?void 0:o[1],[4,this.reportStore.findByObjectId(ie)];case 4:(!(L=F.sent())||!this.hasReportReadPermission(L))&&U.push(R.name),F.label=5;case 5:return R.targetConnection?[4,this.datasetStore.findDatasetByObjectId(R.targetConnection.datasetId)]:[3,8];case 6:return(!(z=F.sent())||!this.hasDatasetBuildPermission(z))&&U.push(R.name),f.fF.assertValue(R.targetConnection.reportUrl,"No target connected report url"),ie=null===(v=R.targetConnection.reportUrl.match(/\/reports\/([a-zA-Z0-9\-]+)/))||void 0===v?void 0:v[1],[4,this.reportStore.findByObjectId(ie)];case 7:(!(L=F.sent())||!this.hasReportReadPermission(L))&&U.push(R.name),F.label=8;case 8:return T++,[3,2];case 9:return[2,_.uniq(U)]}})})},j.prototype.hasReportReadPermission=function(C){return(0,c.yE)(C.permissions,1)},j.prototype.hasDatasetBuildPermission=function(C){return(0,c.yE)(C?.permissions,3)||(0,c.yE)(C?.permissions,9)||(0,c.yE)(C?.userPermissions,9)||(0,c.yE)(C?.userPermissions,3)},j.\u0275fac=function(o){return new(o||j)(Q.\u0275\u0275inject(d.yh),Q.\u0275\u0275inject(M.s),Q.\u0275\u0275inject(W.H7),Q.\u0275\u0275inject(E.Y),Q.\u0275\u0275inject(B.R),Q.\u0275\u0275inject(N.de),Q.\u0275\u0275inject(P.M,8))},j.\u0275prov=Q.\u0275\u0275defineInjectable({token:j,factory:j.\u0275fac}),j}()},74521:function(Ce,ce,i){i.d(ce,{D:function(){return N}});var s=i(81337),Q=i(8297),q=i(60042),V=i(62831),H=i(62458),P=i(86940),f=i(25512),c=i(35510),p=i(30794),u=i(50423),d=i(49223),M=i(93379),E=i(33014),B=i(62087),W=i(9380),N=function(){function k(j,C,o,v,U,T){this.scorecardService=j,this.capabilityService=C,this.overlay=o,this.goalConnectionService=v,this.expansionService=U,this.featureSwitches=T,this.contextMenuOpenGoalId$=new c.X(void 0),this.onDestroy$=new p.xQ}return k.prototype.ngOnDestroy=function(){this.onDestroy$.next(!0),this.onDestroy$.complete()},Object.defineProperty(k.prototype,"scorecardSelectionMode",{get:function(){return this.scorecardService.scorecardSelectionMode},enumerable:!1,configurable:!0}),k.prototype.capabilities=function(j){return this.capabilityService.getCurrentGoalCapabilities(j)},k.prototype.canSelectGoal=function(j){var C,o;return null===(o=null===(C=this.capabilities(j).selectGoal)||void 0===C?void 0:C.enabled)||void 0===o||o},k.prototype.isSelected=function(j){var C,o;return null===(o=null===(C=this.scorecardService.getCurrentScorecard())||void 0===C?void 0:C.selectedGoalIds)||void 0===o?void 0:o[j.id]},k.prototype.onRowClick=function(j,C){this.canSelectGoal(j)&&this.scorecardService.toggleSelectedGoal(j.id,!1,this.isClickMultiselect(C))},k.prototype.onNameClick=function(j,C){if(this.canSelectGoal(j))if((_.isNil(this.scorecardSelectionMode)||"ctrl"===this.scorecardSelectionMode)&&1===this.scorecardService.numberOfSelectedGoals()&&this.isSelected(j)&&_.isNil(this.scorecardService.getCurrentScorecard().activeGoalId))this.scorecardService.setActiveGoal(j.id);else{var o=this.isClickMultiselect(C);this.scorecardService.toggleSelectedGoal(j.id,!(o||"single"===this.scorecardSelectionMode),o)}C?.stopPropagation()},k.prototype.onCheckboxClick=function(j,C){this.canSelectGoal(j)&&this.scorecardService.toggleSelectedGoal(j.id,!1,"single"!==this.scorecardSelectionMode),C?.stopPropagation()},k.prototype.getGoalActionIcons=function(j,C,o){var v=this.getGoalActions(j);return _.map(_.filter(o?C?this.featureSwitches.featureSwitches.scorecardCompactView?[v.editGoal,v.openNotes,v.openContextMenu]:[v.openNotes,v.editGoal,v.openContextMenu]:this.featureSwitches.featureSwitches.scorecardCompactView?[v.goToReport,v.toggleFollow,v.openNotes]:[v.goToReport,v.openNotes,v.toggleFollow]:[v.openContextMenu],function(T){return!T.hidden}),function(T){return(0,s.pi)((0,s.pi)({},T),{onClick:function(R){T.onClick(),R.stopPropagation()}})})},k.prototype.getGoalMenuOptions=function(j,C,o){var v=this,U=this.getGoalActions(j),T=[];return C?(T=[U.goToReport,U.seeDetails,U.addSubGoal,U.toggleFollow,U.goToLinkedSource,U.deleteGoal],o||T.unshift(U.editGoal)):o?H.fF.assertFail("When action icons are shown, read mode has no context menu"):T=[U.goToReport,U.openNotes,U.toggleFollow],_.map(_.filter(T,function(w){return!w.hidden}),function(w){return(0,s.pi)((0,s.pi)({},w),{onClick:function(){w.onClick(),v.overlay.closeAll()}})})},k.prototype.onContextMenuClick=function(j,C,o,v,U){var T=this;this.overlay.isOverlayOpen&&this.overlay.closeAll();var w=this.getGoalMenuOptions(j,v,U),z=C.pointerType?{x:C.x,y:C.y}:o,ie=this.overlay.open({component:Q.H,data:{goalActions:w},closeOnBackdropClick:!0,disableForwardClickOnBackdropClick:!0,hasCaret:!1,options:{hasBackdrop:!0,backdropClass:P.L,positionStrategy:this.overlay.position().flexibleConnectedTo(z).withPositions([(0,f.Iz)(),(0,f.Kb)(),(0,f.Zz)(),(0,f.J7)()]).withPush(!0).withGrowAfterOpen(!0)}});return this.contextMenuOpenGoalId$.next(j.id),ie.onClose.subscribe(function(L){return T.contextMenuOpenGoalId$.next(void 0)}),C.stopPropagation(),ie},k.prototype.getGoalActions=function(j){var o,v,U,T,C=this,w=this.capabilities(j);return{goToReport:{id:"goToReport",onClick:function(){return C.goalConnectionService.goToConnectedReport(j.valueConnection)},labelKey:"TileMenuOption_GoToReport",iconTooltipKey:"Metrics_Tooltip_Open_Report",iconName:"barchart",iconType:"pbi",hidden:_.isNil(j.valueConnection)},openNotes:{id:"openNotes",onClick:function(){C.canSelectGoal(j)&&C.scorecardService.setActiveGoal(j.id)},labelKey:"OpenNotes",iconTooltipKey:"Notes",iconName:"comment_16_regular",iconType:"tri"},seeDetails:{id:"seeDetails",onClick:function(){return C.scorecardService.setActiveGoal(j.id)},labelKey:"VisualContainer_ShowErrorDetails",iconName:"list",iconType:"pbi"},editGoal:{id:"editGoal",onClick:function(){return C.scorecardService.setGoalState(j.id,"Editing")},labelKey:"Metrics_Tooltip_Edit_Metric",iconName:"edit",iconType:"pbi",disabled:!(null!==(o=w?.editGoal)&&void 0!==o&&o.enabled),disabledTooltipKey:null===(v=w?.editGoal)||void 0===v?void 0:v.disabledMessageKey},toggleFollow:{id:"toggleFollow",onClick:function(){j.isFollowed?C.scorecardService.unfollowGoal(j.id):C.scorecardService.followGoal(j.id)},labelKey:j.isFollowed?"Metrics_Follow_Goals_Unfollow_This_Metric":"Metrics_Follow_Goals_Follow_This_Metric",iconName:j.isFollowed?"alert_16_filled":"alert_16_regular",iconType:"tri",hidden:!w.followGoal},addSubGoal:{id:"addSubGoal",onClick:function(){C.scorecardService.addSubGoal(j.id),C.expansionService.expandGoal(j.id)},labelKey:"NewSubmetric",iconName:"add-multiple",iconType:"pbi",hidden:V.q.computeGoalLevel(this.scorecardService.getCurrentScorecard().goals,j)>=q.gT.MaxSubGoals,disabled:!(null!==(U=w.createSubgoal)&&void 0!==U&&U.enabled),disabledTooltipKey:null===(T=w.createSubgoal)||void 0===T?void 0:T.disabledMessageKey},deleteGoal:{id:"deleteGoal",onClick:function(){return C.scorecardService.deleteGoal(j.id)},labelKey:j.isLinked?"Metrics_LinkedMetrics_RemoveLinkedMetric":"Metrics_Tooltip_Delete_Metric",iconName:"delete",iconType:"pbi",hidden:!w.deleteGoal},goToLinkedSource:{id:"goToLinkedSource",onClick:function(){return C.scorecardService.openLinkedSourceScorecard(j)},labelKey:"Metrics_LinkedMetrics_GoToSource",iconName:"open_16_regular",iconType:"tri",hidden:!j.isLinked},openContextMenu:{id:"openContextMenu",onClick:function(){return H.fF.assertFail("OpenContextMenu must be set up in template")},labelKey:"Options_Menu",iconName:"pbi-glyph-more-vertical",iconType:"mat"}}},k.prototype.isClickMultiselect=function(j){switch(this.scorecardSelectionMode){case"multiple":return!0;case"ctrl":return j?.ctrlKey;default:return!1}},k.\u0275fac=function(C){return new(C||k)(u.\u0275\u0275inject(d.G),u.\u0275\u0275inject(M.Nw),u.\u0275\u0275inject(P._),u.\u0275\u0275inject(E.D),u.\u0275\u0275inject(B.l),u.\u0275\u0275inject(W.vZ))},k.\u0275prov=u.\u0275\u0275defineInjectable({token:k,factory:k.\u0275fac}),k}()},34340:function(Ce,ce,i){i.d(ce,{E:function(){return j},c:function(){return C}});var s=i(81337),Q=i(60042),q=i(62831),V=i(60166),H=i(33554),P=i(11547),f=i(14172),c=i(17653),p=i(87088);function u(o,v,U,T){U&&"function"!=typeof U&&(T=U);var w="function"==typeof U?U:void 0,R=new H.t(o,v,T);return function(z){return(0,p.O)(function(){return R},w)(z)}}var d=i(46266),M=i(83317),E=i(77526),B=i(42195),W=i(50423),N=i(41819),k=i(87426),j=function(o){return o[o.Default=0]="Default",o[o.ShowCheckin=1]="ShowCheckin",o[o.ShowStatusRules=2]="ShowStatusRules",o}({}),C=function(){function o(v,U,T){this.sideFlyoutService=v,this.scorecardHost=U,this.hierarchyService=T,this.destroy$=new H.t(1)}return o.prototype.openGoalDetails=function(v,U,T,w){var R=this;v.selectGoal(U);var z=v.getCurrentScorecard(),ie=q.q.getGoal(z.goals,U),L=v.getGoalValueCategoryLists(ie),F=v.getGoalStatuses(ie),de=this.traverse(v.getActiveGoal(),v).pipe((0,f.U)(function(Z){var D,O=null===(D=z.goals)||void 0===D?void 0:D.findIndex(function(J){return J.id===Z});return Q.gT.ColorPalette[O>0?O%Q.gT.ColorPalette.length:0]}));this.destroy$&&(this.destroy$.next(!0),this.destroy$.complete()),this.destroy$=new H.t(1),this.sideFlyoutService.show({componentManifest:{componentId:"GoalsDetailsPaneComponentId",modulePath:"@powerbi/GoalsDetailsPane/goals-details-pane.module#GoalsDetailsPaneModule",inputArgs:{goal$:v.getActiveGoal().pipe((0,c.b)(function(Z){Z&&v.expandGoalValues(Z.id)}),u(1),(0,d.x)(),(0,M.R)(this.destroy$)),scorecardHierarchyInfo$:this.hierarchyService?this.hierarchyService.getHierarchyDisplayInfoObservable(v.hierarchyPaths$):(0,P.of)({showingAll:!0}),openAction:T,scorecardConfiguration:w,goalPreviewColor$:de,goalValueCategories:L,goalStatuses:F,showGoalTargetsInChart$:v.getScorecard().pipe((0,f.U)(function(Z){return Z.showGoalTargetsInChart})),close:function(){R.sideFlyoutService.hide(),v.unselectAllGoals()},saveGoalValue:function(D,O){return(0,s.mG)(R,void 0,void 0,function(){var J,te,X,ne;return(0,s.Jh)(this,function(ae){switch(ae.label){case 0:return[4,v.saveGoalValue(D,O)];case 1:return ae.sent(),J=v.getCurrentScorecard(),te=q.q.getGoal(J.goals,D),null===(X=this.scorecardHost)||void 0===X||X.onUpdateScorecard(J),null===(ne=this.scorecardHost)||void 0===ne||ne.updateCachedGoal(te),[2]}})})},insertNote:function(D,O,J){return v.insertNote(D,O,J)},deleteNote:function(D){return v.deleteNote(D)},editNote:function(D,O,J,te){return v.editNote(D,O,J,te)},deleteGoalValue:function(D){return v.deleteGoalValue(D)},saveGoal:function(D){return v.saveGoal(D.id,D)},deleteGoalQueryConnection:function(D,O){return v.deleteGoalQueryConnection(D,O)},getRefreshHistory:function(D){return v.getRefreshHistory(D)},refreshGoalValue:function(D,O){return v.refreshGoalValue(D,O)},isEditMode$:v.isEditMode(),columnSettings$:v.getColumnSettings(),saveStatusRules:function(D,O){return v.saveStatusRules(D,O)},getStatusRules:function(D){return v.getStatusRules(D)},updateGoalValueConnectionSettings:function(D,O){return v.updateGoalValueConnectionSettings(D,O)},takeOverConnection:function(D,O){return v.takeOverGoalQueryConnection(D,O)},toggleShowGoalTargets:function(D){return v.toggleShowGoalTargetsInChart(D)},followGoal:function(D){return v.followGoal(D)},unfollowGoal:function(D){return v.unfollowGoal(D)}}}})},o.prototype.openGoalStatusRulesPane=function(v,U,T,w){var R=this;this.sideFlyoutService.show({componentManifest:{componentId:"StatusRulesPaneComponentId",modulePath:"@powerbi/GoalsDetailsPane/goals-details-pane.module#GoalsDetailsPaneModule",inputArgs:{goal:U,goalStatuses:v,statusRules:T,close:function(){return R.sideFlyoutService.hide()},saveStatusRules:function(ie){return(0,s.mG)(R,void 0,void 0,function(){return(0,s.Jh)(this,function(L){switch(L.label){case 0:return[4,w(ie)];case 1:return L.sent(),this.sideFlyoutService.hide(),[2]}})})}}}})},o.prototype.openEditStatusesPane=function(v,U,T){var w=this;this.sideFlyoutService.show({componentManifest:{componentId:"EditStatusesPaneComponentId",modulePath:"@powerbi/GoalsDetailsPane/goals-details-pane.module#GoalsDetailsPaneModule",inputArgs:{goalStatuses$:v.getScorecard().pipe((0,f.U)(function(R){return R.goalStatuses}),(0,E.x)()),onSave:U,close:function(){return w.sideFlyoutService.hide()},isReadOnly:T}}})},o.prototype.openScorecardSettingsPane=function(v,U,T){var w=this;this.sideFlyoutService.show({componentManifest:{componentId:"ScorecardSettingsPaneComponentId",modulePath:"@powerbi/GoalsDetailsPane/goals-details-pane.module#GoalsDetailsPaneModule",inputArgs:{scorecard$:v.getScorecard(),roles$:v.getScorecard().pipe((0,c.b)(function(R){v.ensureRolesLoaded()}),(0,f.U)(function(R){return R.roles}),u(1),(0,d.x)()),scorecardSettingsPaneTabIndex:T,onSave:U,close:function(){return w.sideFlyoutService.hide()},setAsDefaultRole:function(z){return v.setAsDefaultRole(z)},editRole:function(z){return w.openRoleSettingsPane(v,!1,z)},deleteRole:function(z){return v.deleteRole(z)},openRoleSettingsPaneWithNewRole:function(){return w.openRoleSettingsPane(v,!0)}}}})},o.prototype.openScorecardColumnSettingsPane=function(v){var U=this;this.sideFlyoutService.show({componentManifest:{componentId:"ScorecardColumnSettingsPaneComponentId",modulePath:"@powerbi/GoalsDetailsPane/goals-details-pane.module#GoalsDetailsPaneModule",inputArgs:{scorecardService:v,close:function(){return U.sideFlyoutService.hide()}}}})},o.prototype.openCategoryListsEditPane=function(v,U,T){var w=this;this.sideFlyoutService.show({componentManifest:{componentId:"CategoryListsEditPaneComponentId",modulePath:"@powerbi/GoalsDetailsPane/goals-details-pane.module#GoalsDetailsPaneModule",inputArgs:{scorecardService:v,creatingNewList:U,applyChanges:T,close:function(){return w.sideFlyoutService.hide()}}}})},o.prototype.openCategoricalValuesEditPane=function(v){this.sideFlyoutService.show({componentManifest:{componentId:"CategoricalValuesEditPaneComponentId",modulePath:"@powerbi/GoalsDetailsPane/goals-details-pane.module#GoalsDetailsPaneModule",inputArgs:{goalValueCategoryListsService:v}}})},o.prototype.openRoleSettingsPane=function(v,U,T){var w=this;this.sideFlyoutService.show({componentManifest:{componentId:"RoleSettingsPaneComponentId",modulePath:"@powerbi/GoalsDetailsPane/goals-details-pane.module#GoalsDetailsPaneModule",inputArgs:{scorecard$:v.getScorecard(),goals$:v.getGoals(),roles$:v.getScorecard().pipe((0,c.b)(function(R){v.ensureRolesLoaded()}),(0,f.U)(function(R){return R.roles})),close:function(){return w.sideFlyoutService.hide()},cancel:function(){return w.openScorecardSettingsPane(v,function(z){return v.updateScorecard(z)},1)},createRole:function(z){return v.createRole(z)},updateRole:function(z,ie){return v.updateRole(z,ie)},setAsDefaultRole:function(z){return v.setAsDefaultRole(z)},deleteRole:function(z){return v.deleteRole(z)},addNewRole:U,selectedRoleId:T}},paneClass:"role-settings"})},o.prototype.openBulkEditingPane=function(v,U){var T=this,w=v.getGoalStatuses(),R=v.getGoalValueCategoryLists();this.sideFlyoutService.show({componentManifest:{componentId:"BulkEditingPaneComponentId",modulePath:"@powerbi/GoalsDetailsPane/goals-details-pane.module#GoalsDetailsPaneModule",inputArgs:{selectedGoalIds$:v.getSelectedGoalIdsObservable(),selectedGoals$:v.getSelectedGoalsObservable(),goalStatuses:w,goalValueCategories:R,onSave:U,close:function(){return T.sideFlyoutService.hide()}}}})},o.prototype.closeGoalDetails=function(){this.destroy$&&(this.destroy$.next(!0),this.destroy$.complete()),this.sideFlyoutService.hide()},o.prototype.traverse=function(v,U){var T=this;return v.pipe((0,B.zg)(function(w){return w.parentId?T.traverse(U.getGoal(w.parentId),U):(0,P.of)(w.id)}))},o.\u0275fac=function(U){return new(U||o)(W.\u0275\u0275inject(N.p),W.\u0275\u0275inject(V.M,8),W.\u0275\u0275inject(k.G,8))},o.\u0275prov=W.\u0275\u0275defineInjectable({token:o,factory:o.\u0275fac}),o}()},99327:function(Ce,ce,i){i.d(ce,{X:function(){return H}});var s=i(50547),Q=i(50423),q=i(81213),V=i(65181),H=function(){function P(f,c){this.errorService=f,this.localizationService=c}return P.prototype.showUserError=function(f,c,p){var u;void 0===p&&(p="GenericErrorDescription"),this.errorService.error(this.localizationService.get(p),c,{requestId:f?.requestId,statusCode:null===(u=f?.status)||void 0===u?void 0:u.toString()})},P.prototype.showThrottlingError=function(){this.errorService.errorNoDefaultAdditionalErrorInfo(this.localizationService.get("You_Have_Exceeded_Limit_Try_Again_Later"),"throttling",{title:this.localizationService.get("Rate_Limit_Is_Exceeded"),level:s.U.Information,isDismissable:!0,showAdditionalErrorInfo:!1})},P.\u0275fac=function(c){return new(c||P)(Q.\u0275\u0275inject(q.T),Q.\u0275\u0275inject(V.o))},P.\u0275prov=Q.\u0275\u0275defineInjectable({token:P,factory:P.\u0275fac}),P}()},73911:function(Ce,ce,i){i.d(ce,{$:function(){return j}});var s=i(81337),Q=i(60042),q=i(29730),V=i(58614),H=i(62458),P=i(35510),f=i(30794),c=i(59017),p=i(83317),u=i(14172),d=i(57243),M=i(48787),E=i(50423),B=i(49223),W=i(87426),N=i(65181),k=i(32027),j=function(){function C(o,v,U,T,w){var R=this;this.scorecardService=o,this.hierarchyService=v,this.localizationService=U,this.viewsService=T,this.goalsHttpService=w,this._goalsByHierarchyItemId$=new P.X({}),this._selectedHierarchyItems$=new P.X([]),this._displaySettings$=new P.X({}),this.onDestroy$=new f.xQ,this._isLoadingView$=new P.X(!1),this.hierarchyService.hierarchyItems$.pipe((0,p.R)(this.onDestroy$)).subscribe(function(z){var ie;if(R._selectedHierarchyItems$.value.length>1){for(var L=[],F=(0,s.pi)({},R._goalsByHierarchyItemId$.value),de=0,Z=R._selectedHierarchyItems$.value;de<Z.length;de++){var D=Z[de];if(D.id){var O=(0,q.IX)(D),J=null===(ie=(0,q.qB)([O],z))||void 0===ie?void 0:ie[0];if(J?.id&&J.id!==D.id){L.push(J),F[J.id]=F[D.id],delete F[D.id];continue}}L.push(D)}R._selectedHierarchyItems$.next(L),R._goalsByHierarchyItemId$.next(F)}}),this.totalItem={id:void 0,value:this.localizationService.get("Visual_Totals"),parent:void 0,parentHierarchyItemId:void 0,level:0},this._hasViewChanges$=(0,c.aj)([this.selectedHierarchyItems$,this.viewsService.getDefaultView("Heatmap")]).pipe((0,u.U)(function(z){var ie=z[0],L=z[1];return L?!_.isEqual((0,q.t7)(ie),L.heatmapViewDetails.hierarchyItemPaths):_.size(ie)>1}),(0,d.d)({bufferSize:1,refCount:!0})),this._hasSettingsChanges$=(0,c.aj)([this._displaySettings$,this.viewsService.getDefaultView("Heatmap")]).pipe((0,u.U)(function(z){var ie,L=z[0],F=z[1],de=null!==(ie=F?.heatmapViewDetails.heatmapDisplaySettings)&&void 0!==ie?ie:Q.rl;return!_.isEqual(L,de)}),(0,d.d)({bufferSize:1,refCount:!0}))}return C.prototype.ngOnDestroy=function(){this.onDestroy$.next(!0),this.onDestroy$.complete()},Object.defineProperty(C.prototype,"goalsByHierarchyItemId$",{get:function(){return this._goalsByHierarchyItemId$},enumerable:!1,configurable:!0}),Object.defineProperty(C.prototype,"selectedHierarchyItems$",{get:function(){return this._selectedHierarchyItems$},enumerable:!1,configurable:!0}),Object.defineProperty(C.prototype,"selectedHierarchyItems",{get:function(){return this._selectedHierarchyItems$.value},enumerable:!1,configurable:!0}),Object.defineProperty(C.prototype,"displaySettings$",{get:function(){return this._displaySettings$},enumerable:!1,configurable:!0}),Object.defineProperty(C.prototype,"hasViewChanges$",{get:function(){return this._hasViewChanges$},enumerable:!1,configurable:!0}),Object.defineProperty(C.prototype,"hasSettingsChanges$",{get:function(){return this._hasSettingsChanges$},enumerable:!1,configurable:!0}),Object.defineProperty(C.prototype,"isSaving$",{get:function(){return this.viewsService.isSaving$},enumerable:!1,configurable:!0}),Object.defineProperty(C.prototype,"isLoading$",{get:function(){return this._isLoadingView$},enumerable:!1,configurable:!0}),C.prototype.addHierarchyItem=function(o){return(0,s.mG)(this,void 0,void 0,function(){var v;return(0,s.Jh)(this,function(U){switch(U.label){case 0:return v=_.uniqBy((0,s.ev)((0,s.ev)([],this._selectedHierarchyItems$.value,!0),[o],!1),function(T){return T.id}),this._selectedHierarchyItems$.next(v),[4,this.loadGoalsForHierarchyItem(o)];case 1:return U.sent(),[2]}})})},C.prototype.removeHierarchyItem=function(o){o.id?this._selectedHierarchyItems$.next(_.filter(this._selectedHierarchyItems$.value,function(v){return v.id!==o.id})):H.fF.assertFail("Cannot remove totals")},C.prototype.setHierarchyItems=function(o){return(0,s.mG)(this,void 0,void 0,function(){var v,U,T,w;return(0,s.Jh)(this,function(z){switch(z.label){case 0:for(v=_.uniqBy((0,s.ev)([this.totalItem],o,!0),function(ie){return ie.id}),this._selectedHierarchyItems$.next(v),U=[],T=0,w=v;T<w.length;T++)U.push(this.loadGoalsForHierarchyItem(w[T]));return[4,Promise.all(U)];case 1:return z.sent(),[2]}})})},C.prototype.reset=function(o){void 0===o&&(o=!1),this._selectedHierarchyItems$.next([this.totalItem]),o&&this.clearCache()},C.prototype.refreshAll=function(){for(var o=0,v=this._selectedHierarchyItems$.value;o<v.length;o++)this.loadGoalsForHierarchyItem(v[o],!0)},C.prototype.clearCache=function(){this._goalsByHierarchyItemId$.next({})},C.prototype.loadDefaultView=function(o,v,U){var T,w;return(0,s.mG)(this,void 0,void 0,function(){var R,z,ie;return(0,s.Jh)(this,function(L){switch(L.label){case 0:if(!o&&!v)return H.fF.assertFail("loadDefaultView called without restoring items or settings"),[2];this._isLoadingView$.next(!0),L.label=1;case 1:return L.trys.push([1,,8,9]),[4,this.viewsService.loadViews(!1)];case 2:return L.sent(),[4,this.viewsService.getDefaultView("Heatmap").pipe((0,M.q)(1)).toPromise()];case 3:return R=L.sent(),v&&(z=null===(T=R?.heatmapViewDetails)||void 0===T?void 0:T.heatmapDisplaySettings,this.setDisplaySettings((0,s.pi)((0,s.pi)({},Q.rl),z))),o?(ie=void 0,R?[4,this.hierarchyService.getHierarchyItemsForPath(null===(w=R?.heatmapViewDetails)||void 0===w?void 0:w.hierarchyItemPaths).pipe((0,M.q)(1)).toPromise()]:[3,5]):[3,7];case 4:ie=L.sent(),L.label=5;case 5:return[4,this.setHierarchyItems(ie=ie||U||[])];case 6:L.sent(),L.label=7;case 7:return[3,9];case 8:return this._isLoadingView$.next(!1),[7];case 9:return[2]}})})},C.prototype.saveView=function(o,v){return(0,s.mG)(this,void 0,void 0,function(){var U;return(0,s.Jh)(this,function(T){switch(T.label){case 0:return o||v?[4,this.viewsService.getDefaultView("Heatmap").pipe((0,M.q)(1)).toPromise()]:(H.fF.assertFail("saveView called without saving items or settings"),[2]);case 1:return U=T.sent(),U=_.cloneDeep(U)||{isDefault:!0,name:"",viewType:"Heatmap",id:void 0,scorecardId:this.scorecardId,heatmapViewDetails:{heatmapDisplaySettings:void 0,hierarchyItemPaths:void 0}},o&&(U.heatmapViewDetails.hierarchyItemPaths=(0,q.t7)(this.selectedHierarchyItems)),v&&(U.heatmapViewDetails.heatmapDisplaySettings=this._displaySettings$.value),[4,this.viewsService.saveView(U)];case 2:return T.sent(),[2]}})})},C.prototype.loadGoalsForHierarchyItem=function(o,v){return void 0===v&&(v=!1),(0,s.mG)(this,void 0,void 0,function(){var U,T,w,R=this;return(0,s.Jh)(this,function(z){switch(z.label){case 0:return U=this.scorecardService.getCurrentScorecard(),H.fF.assertValue(U,"scorecard not loaded"),this.scorecardId!==U.id&&(this._goalsByHierarchyItemId$.next({}),this.scorecardId=U.id,v=!0),!v&&this._goalsByHierarchyItemId$.value[o?.id]?[2]:(this._goalsByHierarchyItemId$.next((0,s.pi)((0,s.pi)({},this._goalsByHierarchyItemId$.value),((w={})[o?.id]={},w))),T=o?.id?(0,q.t7)([o]):void 0,[4,this.goalsHttpService.getScorecard(U.groupId,U.id,!0,T).toPromise().then(function(ie){var L,F=R.checkGoalsConnectedToHierarchy(T,ie.goals),de=_.keyBy(F,"id");R._goalsByHierarchyItemId$.next((0,s.pi)((0,s.pi)({},R._goalsByHierarchyItemId$.value),((L={})[o?.id]=de,L)))}).catch(function(ie){var L;H.fF.assertFail(ie),R._goalsByHierarchyItemId$.next((0,s.pi)((0,s.pi)({},R._goalsByHierarchyItemId$.value),((L={})[o?.id]=null,L)))})]);case 1:return z.sent(),[2]}})})},C.prototype.setDisplaySettings=function(o){this._displaySettings$.next(o)},C.prototype.checkGoalsConnectedToHierarchy=function(o,v){var U=this;return _.map(v,function(T){var w,R,z=!_.isEmpty(o),ie=z&&T.valueConnection&&!U.hierarchyService.isDatasetMappedToHierarchyPath(null===(w=T.valueConnection)||void 0===w?void 0:w.datasetId,o),L=z&&T.targetConnection&&!U.hierarchyService.isDatasetMappedToHierarchyPath(null===(R=T.targetConnection)||void 0===R?void 0:R.datasetId,o);return(0,s.pi)((0,s.pi)({},T),{isCurrentValueNotConnectedToHierarchy:ie,isTargetValueNotConnectedToHierarchy:L})})},C.\u0275fac=function(v){return new(v||C)(E.\u0275\u0275inject(B.G),E.\u0275\u0275inject(W.G),E.\u0275\u0275inject(N.o),E.\u0275\u0275inject(k.w),E.\u0275\u0275inject(V.f))},C.\u0275prov=E.\u0275\u0275defineInjectable({token:C,factory:C.\u0275fac}),C}()},21719:function(Ce,ce,i){i.d(ce,{D:function(){return u}});var s=i(81337),Q=i(14786),q=i(35510),V=i(33554),H=i(50423),P=i(41819),f=i(49223),c=i(87426),p=i(96608),u=function(){function d(M,E,B,W){this.sideFlyoutService=M,this.scorecardService=E,this.hierarchyService=B,this.telemetryService=W,this._showHierarchiesPane$=new q.X(!1),this._showHeatmapConfigurationPane$=new q.X(!1),this._showHeatmapDisplaySettingsPane$=new q.X(!1),this.showHierarchiesPane$=this._showHierarchiesPane$.asObservable(),this.showHeatmapConfigurationPane$=this._showHeatmapConfigurationPane$.asObservable(),this.showHeatmapDisplaySettingsPane$=this._showHeatmapDisplaySettingsPane$.asObservable()}return d.prototype.openHierarchiesBuilder=function(M){return(0,s.mG)(this,void 0,void 0,function(){var E,W,N=this;return(0,s.Jh)(this,function(k){switch(k.label){case 0:return this.telemetryService.logEvent(Q.AY,{entryPoint:M}),E=new V.t(1),this.sideFlyoutService.show({componentManifest:{componentId:"HierarchyBuilderPaneComponentId",modulePath:"@powerbi/GoalsHierarchy/goals-hierarchy.module#GoalsHierarchyModule",inputArgs:{scorecard$:this.scorecardService.getScorecard(),close:function(C){N.sideFlyoutService.hide(),E.next(C),E.complete()},saveQueryHierarchyAsUser:function(C){N.scorecardService.updateScorecard({queryHierarchyAsUser:C})}}},paneClass:"hierarchy-builder"}),[4,E.toPromise()];case 1:return k.sent()&&(W=this.scorecardService.getCurrentScorecard(),this.scorecardService.setActiveHierarchy(void 0),this.hierarchyService.loadHierarchies(W.groupId,W.id,!1)),[2]}})})},d.prototype.showHierarchiesPane=function(){this._showHierarchiesPane$.next(!0)},d.prototype.hideHierarchiesPane=function(){this._showHierarchiesPane$.next(!1)},d.prototype.showHeatmapConfigurationPane=function(){this.hideHeatmapDisplaySettingsPane(),this._showHeatmapConfigurationPane$.next(!0)},d.prototype.hideHeatmapConfigurationPane=function(){this._showHeatmapConfigurationPane$.next(!1)},d.prototype.showHeatmapDisplaySettingsPane=function(){this.hideHeatmapConfigurationPane(),this._showHeatmapDisplaySettingsPane$.next(!0)},d.prototype.hideHeatmapDisplaySettingsPane=function(){this._showHeatmapDisplaySettingsPane$.next(!1)},d.\u0275fac=function(E){return new(E||d)(H.\u0275\u0275inject(P.p),H.\u0275\u0275inject(f.G),H.\u0275\u0275inject(c.G),H.\u0275\u0275inject(p.y0))},d.\u0275prov=H.\u0275\u0275defineInjectable({token:d,factory:d.\u0275fac}),d}()},87426:function(Ce,ce,i){i.d(ce,{G:function(){return Z}});var s=i(81337),Q=i(29730),q=i(3468),V=i(62458);function f(D){return(0,s.pi)((0,s.pi)({},D),{connections:_.map(D.connections,function(O){return function(D,O){var J={datasetId:D.datasetId,levels:_.map(O,function(te){return function(D){return{levelId:D.levelId,fieldExpr:D.field?q.ib.deserializeExpr(JSON.parse(D.field)):void 0,filter:D.fieldFilter?q.ib.deserializeFilter(JSON.parse(D.fieldFilter)):void 0}}(_.find(D.levels,function(ne){return ne.levelId===te.id})??{levelId:te.id,field:void 0})})};return D.ownerField&&(J.ownerFieldExpr=q.ib.deserializeExpr(JSON.parse(D.ownerField))),J}(O,D.levels)})})}function c(D){return{id:D.id,levels:D.levels,name:D.name,scorecardId:D.scorecardId,owner:D.owner,connections:_.map(D.connections,function(O){return function(D){var O={datasetId:D.datasetId,levels:_.map(D.levels,function(J){return function(D){return{levelId:D.levelId,field:D.fieldExpr?JSON.stringify(q.ib.serializeExpr(D.fieldExpr)):void 0,fieldFilter:D.filter?JSON.stringify(q.ib.serializeFilter(D.filter)):void 0}}(J)})};return D.ownerFieldExpr&&(O.ownerField=JSON.stringify(q.ib.serializeExpr(D.ownerFieldExpr))),O}(O)})}}var N=i(58614),k=i(72489),j=i(74466),C=i(35510),o=i(11547),v=i(9936),U=i(59017),T=i(77526),w=i(59973),R=i(14172),z=i(48787),ie=i(57243),L=i(50423),F=i(81213),de=i(65181),Z=function(){function D(O,J,te){this.goalsHttpService=O,this.errorService=J,this.localization=te,this._hierarchies$=new C.X(null),this._hierarchyItems$=new C.X({}),this._hierarchyErrors$=new C.X({}),this._isSaving$=new C.X(!1),this.loadingHierarchyItems=new Set,this.isLoadingHierarchies=!1,this.isSaving$=this._isSaving$,this.hierarchies$=this._hierarchies$.pipe((0,T.x)()),this.hierarchyItems$=this._hierarchyItems$.pipe((0,w.h)(function(X){return!_.isEmpty(X)}),(0,T.x)()),this.hierarchyErrors$=this._hierarchyErrors$.pipe((0,T.x)()),this.hasHierarchies$=this.hierarchies$.pipe((0,w.h)(function(X){return!!X}),(0,R.U)(function(X){return!_.isEmpty(X)}),(0,T.x)())}return Object.defineProperty(D.prototype,"hierarchies",{get:function(){return this._hierarchies$.value},enumerable:!1,configurable:!0}),Object.defineProperty(D.prototype,"hierarchyItems",{get:function(){return this._hierarchyItems$.value},enumerable:!1,configurable:!0}),Object.defineProperty(D.prototype,"hierarchyErrors",{get:function(){return this._hierarchyErrors$.value},enumerable:!1,configurable:!0}),D.prototype.setHierarchies=function(O){this._hierarchies$.next(O)},D.prototype.setHierarchyItems=function(O,J){var te=_.find(this.hierarchies,function(X){return X.id===O});V.fF.assertValue(te,"No hierarchies with id ".concat(O)),this._hierarchyItems$.next((0,j.Uy)(this.hierarchyItems,function(X){X[O]=J}))},D.prototype.setHierarchyErrors=function(O){this._hierarchyErrors$.next(O)},D.prototype.saveHierarchies=function(){var O;return(0,s.mG)(this,void 0,void 0,function(){var J,te,X,ne,ae,ue,Se,pe,Re,Oe,Ae,He,Ue,G,t,r=this;return(0,s.Jh)(this,function(a){switch(a.label){case 0:if(!this.hierarchies||!this.scorecardId||this.isLoadingHierarchies)return V.fF.assertFail("Hierarchies not loaded"),[2];if(this._isSaving$.value)return V.fF.assertFail("Save already in progress"),[2];if(_.some(this.hierarchyErrors,function(n){return _.some(n,function(l){return"Error"===l.severity})}))return V.fF.assertFail("Save blocked by error"),[2];this._isSaving$.next(!0),a.label=1;case 1:return a.trys.push([1,11,12,13]),[4,this.goalsHttpService.getScorecardHierarchies(this.groupId,this.scorecardId).toPromise()];case 2:for(J=a.sent(),te=_.filter(J,function(n){return!_.some(r.hierarchies,function(l){return n.id===l.id})}),X=[],ne=_.filter(_.flatten(_.values(this.hierarchyErrors)),function(n){return"MetricsHierarchy_NoDatasetAccess"===n.code}),ae=function(l){var h=_.find(ue.hierarchies,function(g){return g.id===l.hierarchyId});V.fF.assertValue(h,"Hierarchy with id ".concat(l.hierarchyId," not found to clear invalid mapping"));var S=_.find(h.connections,function(g){return g.datasetId===l.datasetId});V.fF.assertValue(S,"Connection with id ".concat(l.datasetId," not found to clear invalid mapping")),S.levels.forEach(function(g){g.fieldExpr=void 0,g.filter=void 0})},ue=this,Se=0,pe=ne;Se<pe.length;Se++)ae(pe[Se]);Re=function(l){var h,S,g,A;return(0,s.Jh)(this,function(b){switch(b.label){case 0:return l.isNew?_.some(l.connections,function(re){return _.some(re?.levels,function(ee){return!!ee?.fieldExpr})})?(S=function(D){var O=c(D);return{name:O.name,levels:O.levels,connections:O.connections}}(l),[4,Oe.goalsHttpService.createScorecardHierarchy(Oe.groupId,Oe.scorecardId,S).toPromise()]):[3,2]:[3,3];case 1:g=b.sent(),A=f(g),X.push(A),b.label=2;case 2:return[3,7];case 3:return(h=_.find(J,function(re){return re.id===l.id}))?[3,4]:(V.fF.assertFail("Cannot updated a deleted hierarchy"),[3,7]);case 4:return _.isEqual(c(f(h)),c(l))?[3,6]:(S=function(D){return{hierarchy:c(D)}}(l),[4,Oe.goalsHttpService.updateScorecardHierarchy(Oe.groupId,Oe.scorecardId,l.id,S).toPromise()]);case 5:return g=b.sent(),A=f(g),X.push(A),[3,7];case 6:X.push(l),b.label=7;case 7:return[2]}})},Oe=this,Ae=0,He=this.hierarchies,a.label=3;case 3:return Ae<He.length?[5,Re(He[Ae])]:[3,6];case 4:a.sent(),a.label=5;case 5:return Ae++,[3,3];case 6:Ue=0,G=te,a.label=7;case 7:return Ue<G.length?[4,this.goalsHttpService.deleteScorecardHierarchy(this.groupId,this.scorecardId,G[Ue].id).toPromise()]:[3,10];case 8:a.sent(),a.label=9;case 9:return Ue++,[3,7];case 10:return this.setHierarchies(X),[3,13];case 11:throw t=a.sent(),this.errorService.error(this.localization.get("MetricsHierarchy_Cannot_Save_Hierarchies"),"GoalsCannotSaveHierarchies",{requestId:t?.requestId,statusCode:null===(O=t?.status)||void 0===O?void 0:O.toString()}),t;case 12:return this._isSaving$.next(!1),[7];case 13:return[2]}})})},D.prototype.loadHierarchies=function(O,J,te){var X=this;return void 0===te&&(te=!0),this.scorecardId===J&&te&&this.hierarchies||this.scorecardId===J&&this.isLoadingHierarchies||(this.scorecardId=J,this.groupId=O,this.isLoadingHierarchies=!0,this.goalsHttpService.getScorecardHierarchies(O,this.scorecardId).toPromise().then(function(ne){if(X.setHierarchies(function(D){return _.map(D,function(O){return f(O)})}(ne)),!te&&!_.isEmpty(X.hierarchyItems))for(var ae in X.hierarchyItems)X.loadHierarchyItems(ae,!1)}).catch(function(ne){throw X.setHierarchies([]),ne}).finally(function(){X.isLoadingHierarchies=!1,X.gc()})),this.hierarchies$},D.prototype.loadHierarchyItems=function(O,J){var te=this;return void 0===J&&(J=!0),V.fF.assertValue(this.scorecardId,"No scorecard loaded"),(!J||_.isEmpty(this.hierarchyItems[O])&&!this.loadingHierarchyItems.has(O))&&(this.loadingHierarchyItems.add(O),this.goalsHttpService.getScorecardHierarchyItems(this.groupId,this.scorecardId,O).toPromise().then(function(X){return te.setHierarchyItems(O,function(D){for(var O=_.cloneDeep(D),J=_.groupBy(O,function(Se){return Se.id}),te=[],X=0,ne=O;X<ne.length;X++){var ae=ne[X];if(ae.parentHierarchyItemId){var ue=_.first(J[ae.parentHierarchyItemId]);ae.parent=ue,ue?ue.children?ue.children.push(ae):ue.children=[ae]:V.fF.assertFail("Parent item missing")}else te.push(ae)}return te}(X))}).catch(function(X){var ne;V.fF.assertFail("Error loading hierarchy items. "+(null===(ne=X?.error)||void 0===ne?void 0:ne.message)),te.setHierarchyItems(O,[])}).finally(function(){return te.loadingHierarchyItems.delete(O)})),this.hierarchyItems$.pipe((0,R.U)(function(X){return X[O]}),(0,T.x)())},D.prototype.getHierarchyItemsForPath=function(O){var J=this;return _.isEmpty(O)?(0,o.of)(null):(0,v.D)(_.map(O,function(te){return J.loadHierarchyItems(te.hierarchyId).pipe((0,w.h)(function(X){return!!X}),(0,z.q)(1))})).pipe((0,R.U)(function(){return(0,Q.qB)(O,J.hierarchyItems)}))},D.prototype.getHierarchyDisplayInfoObservable=function(O){var J=this;return(0,U.aj)([O,this.hierarchies$]).pipe((0,R.U)(function(te){return J.getHierarchyDisplayInfo(te[1],te[0])}),(0,ie.d)({bufferSize:1,refCount:!0}))},D.prototype.getHierarchyDisplayInfo=function(O,J){var X,te=this.localization.get("All"),ne=_.map(J,function(pe){return(0,s.pi)((0,s.pi)({},pe),{levels:pe.levels.map(function(_e){return(0,k.WU)(_e)})})}),ae=_.keyBy(ne,function(pe){return pe.hierarchyId});if(!_.isEmpty(J)){var ue=_.map(O,function(pe){var _e;return _.last(null===(_e=ae[pe.id])||void 0===_e?void 0:_e.levels)});X=_.join(_.compact(ue),", ")}var Se=_.map(O,function(pe){return _.has(ae,pe.id)?(0,s.pi)((0,s.pi)({},ae[pe.id]),{hierarchyName:pe.name}):{hierarchyId:pe.id,hierarchyName:pe.name,levels:[te]}});return{showingAll:_.isEmpty(J),displayLabel:X,displayPaths:Se}},D.prototype.formatHierarchyItemPath=function(O){var J;return(0,s.pi)((0,s.pi)({},O),{levels:O.levels.map(function(te){return(0,k.WU)(te)}),hierarchyName:null===(J=this.hierarchies.find(function(te){return te.id===O.hierarchyId}))||void 0===J?void 0:J.name})},D.prototype.getActiveHierarchies=function(O){return _.intersectionWith(this.hierarchies,O,function(J,te){return J.id===te.hierarchyId})},D.prototype.isDatasetMappedToHierarchyPath=function(O,J){if(_.isNil(O)||_.isEmpty(J))return V.fF.assertFail("Expected datasetId and hierarchyPaths to be defined"),!1;var te=this.getActiveHierarchies(J);return _.some(te,function(X){return _.some(X.connections,function(ne){return ne.datasetId===O&&_.some(ne.levels,function(ae){return!!ae.fieldExpr})})})},D.prototype.isGoalOwnerMappedToHierarchy=function(O,J){if(!O.valueConnection&&!O.targetConnection||_.isEmpty(J))return!1;var te=this.getActiveHierarchies(J);return _.some(te,function(X){var ne=_.find(X.connections,function(ae){var ue,Se;return ae.datasetId===(null===(ue=O.valueConnection)||void 0===ue?void 0:ue.datasetId)||ae.datasetId===(null===(Se=O.targetConnection)||void 0===Se?void 0:Se.datasetId)});return!!ne?.ownerFieldExpr})},D.prototype.gc=function(){var O=this,J=new Set(_.map(this.hierarchies,function(X){return X.id})),te=(0,j.Uy)(this.hierarchyItems,function(X){for(var ne=0,ae=Object.keys(O.hierarchyItems);ne<ae.length;ne++){var ue=ae[ne];J.has(ue)||delete X[ue]}});te!==this.hierarchyItems&&this._hierarchyItems$.next(te)},D.\u0275fac=function(J){return new(J||D)(L.\u0275\u0275inject(N.f),L.\u0275\u0275inject(F.T),L.\u0275\u0275inject(de.o))},D.\u0275prov=L.\u0275\u0275defineInjectable({token:D,factory:D.\u0275fac}),D}()},20930:function(Ce,ce,i){i.d(ce,{N:function(){return P}});var s=i(60042),Q=i(14786),q=i(50423),V=i(65181),H=i(56083),P=function(){function f(c,p){this.localizationService=c,this.tutorialPopupService=p}return f.prototype.startFirstGoalTutorial=function(){this.tutorialPopupService.startTutorial(this.createFirstGoalTutorialModel())},f.prototype.createFirstGoalTutorialModel=function(){var c,p="ScorecardTutorialFirstGoalName",u="ScorecardTutorialFirstGoalCurrent",d="ScorecardTutorialFirstGoalTarget";return{isSequentialTutorial:!0,itemKeys:[p,u,d],items:(c={},c[p]={title:this.localizationService.get("ScorecardTutorial_MetricName_Title"),text:this.localizationService.get("ScorecardTutorial_MetricName_Text"),buttonLabel:this.localizationService.get("TutorialPopup_Next"),dataStoreKey:p,canShow:function(){return $(s.gT.ScorecardTutorial_FirstGoalNameSelector).length>0},attachTo:function(){return $(s.gT.ScorecardTutorial_FirstGoalNameSelector)},offset:{top:0,left:-10}},c[u]={title:this.localizationService.get("ScorecardTutorial_MetricCurrent_Title"),text:this.localizationService.get("ScorecardTutorial_MetricCurrent_Text"),buttonLabel:this.localizationService.get("TutorialPopup_Next"),dataStoreKey:u,canShow:function(){return $(s.gT.ScorecardTutorial_FirstGoalCurrentSelector).length>0},attachTo:function(){return $(s.gT.ScorecardTutorial_FirstGoalCurrentSelector)},offset:{top:0,left:-10}},c[d]={title:this.localizationService.get("ScorecardTutorial_MetricTarget_Title"),text:this.localizationService.get("ScorecardTutorial_MetricTarget_Text"),buttonLabel:this.localizationService.get("Done_ButtonText"),dataStoreKey:d,canShow:function(){return $(s.gT.ScorecardTutorial_FirstGoalTargetSelector).length>0},attachTo:function(){return $(s.gT.ScorecardTutorial_FirstGoalTargetSelector)},offset:{top:0,left:-10}},c)}},f.prototype.startGoalRollupsTutorial=function(){this.tutorialPopupService.startTutorial(this.createGoalRollupsTutorialModel())},f.prototype.createGoalRollupsTutorialModel=function(){var c,p="GoalRollupsTutorial",u=s.gT.ScorecardTutorial_GoalRollupSelector;return{itemKeys:[p],items:(c={},c[p]={title:this.localizationService.get("TutorialPopup_MetricsRollupsTitle"),text:this.localizationService.get("TutorialPopup_MetricsRollupsContent"),buttonLabel:this.localizationService.get("TutorialPopup_GotIt"),dataStoreKey:p,canShow:function(){return!!$(u)},attachTo:function(){return $(u)},preferredOrientation:"bottom",telemetryEventArgs:[Q._9],customClass:"goal-rollups-tutorial"},c)}},f.prototype.startGoalRollupsDetailsPaneTutorial=function(){this.tutorialPopupService.startTutorial(this.createGoalRollupsDetailsPaneTutorialModel())},f.prototype.createGoalRollupsDetailsPaneTutorialModel=function(){var c,p="GoalRollupsDetailsPaneTutorial",u=s.gT.ScorecardTutorial_GoalRollupDetailsPaneSelector;return{itemKeys:[p],items:(c={},c[p]={title:this.localizationService.get("TutorialPopup_MetricsRollupsTitle_DetailsPane"),text:this.localizationService.get("TutorialPopup_MetricsRollupsContent_DetailsPane"),buttonLabel:this.localizationService.get("TutorialPopup_GotIt"),dataStoreKey:p,canShow:function(){return!!$(u)},attachTo:function(){return $(u)},learnMoreText:this.localizationService.get("LearnMore"),learnMoreUrl:"https://learn.microsoft.com/en-us/power-bi/create-reports/service-metrics-submetrics#get-started-creating-rollups",preferredOrientation:"right",telemetryEventArgs:[Q.Fg],customClass:"show-goal-rollups-coachmark"},c)}},f.\u0275fac=function(p){return new(p||f)(q.\u0275\u0275inject(V.o),q.\u0275\u0275inject(H.yU))},f.\u0275prov=q.\u0275\u0275defineInjectable({token:f,factory:f.\u0275fac}),f}()},93379:function(Ce,ce,i){i.d(ce,{jL:function(){return C},Nw:function(){return U}});var s=i(70060),Q=i(62458),V=i(62831),H=i(60166),P=i(43286),f=i(35510),c=i(59017),p=i(11547),u=i(77526),d=i(14172),M=i(81905),E=i(57243),B=i(50423),W=i(9380),N=i(49223),k=i(19178),C=function(){function T(w){this.capability=w,this.capability||(this.capability={enabled:!0,disabledReasons:new Set})}return T.clone=function(w){return new T(_.cloneDeep(w))},T.prototype.disableIf=function(w,R,z){return w&&(this.capability.enabled=!1,this.capability.disabledReasons.add(R),z&&!this.capability.disabledMessageKey&&(this.capability.disabledMessageKey=z)),new T(this.capability)},T.prototype.disableWithMultiple=function(w){var R=this;return this.capability.enabled=!1,w.forEach(function(z){return R.capability.disabledReasons.add(z)}),new T(this.capability)},T.prototype.build=function(){return this.capability},T}();function o(T,w){return(0,P.yE)(T,w)}var v=["id","permissions","hierarchyPaths"],U=function(){function T(w,R,z,ie){var L=this;this.featureSwitchService=w,this.scorecardService=R,this.groupStore=z,this.scorecardHost=ie,this.capabilityInputs$=new f.X([void 0,"List",!1]);var F=this.scorecardService.getScorecard().pipe((0,u.x)(function(Z,D){return!Z&&!D||!!Z&&!!D&&_.every(v,function(O){return _.isEqual(Z[O],D[O])})})),de=F.pipe((0,d.U)(function(Z){return Z.groupId}),(0,u.x)(),(0,M.w)(function(Z){return L.groupStore.getGroupById(Z||"me")}),(0,d.U)(function(Z){return void 0!==Z?.capacitySkuTier&&6!==Z.capacitySkuTier}));this.inputSub=(0,c.aj)([F,this.scorecardService.viewType$,de]).subscribe(this.capabilityInputs$),this.scorecardCapabilities$=this.capabilityInputs$.pipe((0,d.U)(function(Z){return L.calculateScorecardCapabilities(Z)}),(0,E.d)(1))}return T.prototype.ngOnDestroy=function(){this.inputSub.unsubscribe()},T.prototype.getCurrentScorecardCapabilities=function(){return this.calculateScorecardCapabilities(this.capabilityInputs$.value)},T.prototype.getScorecardCapabilities=function(){return this.scorecardCapabilities$},T.prototype.getCurrentGoalCapabilities=function(w){return _.isNil(w)?{}:this.calculateGoalCapabilities(w,this.capabilityInputs$.value)},T.prototype.getGoalCapabilities=function(w){var R=this;return _.isNil(w)?(0,p.of)({}):this.capabilityInputs$.pipe((0,d.U)(function(z){return R.calculateGoalCapabilities(w,z)}),(0,E.d)(1))},T.prototype.getMultipleGoalCapabilities=function(w){var R=this;return _.isEmpty(w)?(0,p.of)({}):this.capabilityInputs$.pipe((0,d.U)(function(z){for(var ie=_.map(w,function(J){return R.calculateGoalCapabilities(J,z)}),L=ie[0],F={},de=function(te){var X=te,ne=L[X];if("scorecardCapabilities"===X)F[X]=L.scorecardCapabilities;else if("boolean"==typeof ne)F[X]=_.every(ie,function(Re){return Re[X]});else if(function(T){return"enabled"in T}(ne)){for(var ae=new C,ue=0,Se=ie;ue<Se.length;ue++){var _e=Se[ue][X];_e.enabled||ae.disableWithMultiple(_e.disabledReasons)}F[X]=ae.build()}else Q.fF.assertFail("Unexpected type for key ".concat(X," when getting multiple goal capabilities"))},Z=0,D=_.keys(L);Z<D.length;Z++)de(D[Z]);return F}),(0,E.d)(1))},T.prototype.calculateScorecardCapabilities=function(w){var R=w[0],z=w[1],ie=w[2],L={},F=o((0,s.l)(R?.permissions),2),de=!_.isEmpty(R?.hierarchyPaths),Z="List"===z;return L.customizeStatus=this.featureSwitchService.featureSwitches.goalsCustomizeStatus&&F,L.createGoal=(new C).disableIf(!F,"NoWritePermission","Metrics_Tooltip_NoPermission").disableIf(de,"Hierarchical","Metrics_Tooltip_Create_Metric_Disabled_Hierarchical").disableIf(!Z,"UnsupportedView","Metrics_Tooltip_Create_Metric_Disabled_UnsupportedView").build(),L.createLinkedGoal=(new C).disableIf(!F,"NoWritePermission","Metrics_Tooltip_NoPermission").disableIf(de,"Hierarchical","Metrics_Tooltip_Create_Metric_Disabled_Hierarchical").disableIf("Heatmap"===z,"UnsupportedView","Metrics_Tooltip_Create_Metric_Disabled_UnsupportedView").build(),L.deleteGoal=F&&!de,L.reorderGoal=this.featureSwitchService.featureSwitches.powerBIGoalsDragAndDrop&&F&&!de&&Z,L.editHierarchies=(new C).disableIf(!F,"NoWritePermission","MetricsHierarchy_NoPermission").disableIf(!ie&&this.featureSwitchService.featureSwitches.scorecardHierarchiesPremium,"NoPremiumWorkspace","MetricsHierarchy_NotAllowedInShared").build(),L.editHeatmap=F,L},T.prototype.calculateGoalCapabilities=function(w,R){var z,ie,L={scorecardCapabilities:this.calculateScorecardCapabilities(R)},F=R[0],de=R[1],Z=w.isNew?31:function(T){if(_.isNil(T))return 0;if(!isNaN(T))return Number(T);switch(T.toString().trim().toLowerCase()){case"none":return 0;case"view":return 1;case"updatecurrentvalue":return 3;case"updatetargetvalue":return 5;case"updatenotes":return 9;case"updatestatus":return 17;case"updatevalues":return 7;case"all":return 31;default:Q.fF.assertValue(T,"can't cast GoalPermission value")}}(w.permissions),D=o((0,s.l)(F?.permissions),2),O=!!w.valuesCategoryId,J=(null===(ie=null===(z=w.aggregations)||void 0===z?void 0:z.find(function(_e){return"NumberOfTargets"===_e.type}))||void 0===ie?void 0:ie.value)>1,te=!_.isEmpty(F?.hierarchyPaths),X=V.q.isSampleScorecard(F),ne=te&&w.isLinked,ae="List"===de;L.selectGoal=this.scorecardHost?this.scorecardHost.canSelectGoal(w):{enabled:!0},L.editGoal=(new C).disableIf(!D,"NoWritePermission","Metrics_Tooltip_NoPermission").disableIf(w.isLinked,"LinkedMetric","Metrics_Tooltip_Edit_Metric_Disabled_Linked").disableIf(!ae,"UnsupportedView","Metrics_Tooltip_Edit_Metric_Disabled_UnsupportedView").build();var ue=D&&!w.isLinked&&!te;L.editName=ue,L.editStartDate=ue,L.editDueDate=ue,L.editStatusRules=ue,L.editPeriodicity=ue,L.connectCurrentValueToData=ue,L.connectTargetValueToData=ue,L.changeValueFormat=ue,L.editOwners=ue,L.deleteGoal=L.scorecardCapabilities.deleteGoal,L.createSubgoal=L.scorecardCapabilities.createGoal,L.editStatus=o(Z,17)&&!ne&&!w.hasStatusRules,L.addNotes=o(Z,9)&&!ne;var Se=o(Z,3)&&!ne&&!w.valueConnection&&!w.valueRollup;L.editCurrentValue=Se,L.editMultipleValues=Se&&!O&&!te&&!w.isLinked;var pe=o(Z,5)&&!w.isLinked;return L.editTargetValue=pe&&!w.targetConnection&&!w.targetRollup&&!J,L.editMultipleTargets=pe&&(!!this.featureSwitchService.featureSwitches.goalsRollups||!w.targetConnection&&!w.targetRollup)&&(!O||J)&&!te,L.deleteCheckIn=D,L.followGoal=this.featureSwitchService.featureSwitches.goalsFavoriteGoals&&!X&&!te,L.useCategoricalValues=!!this.featureSwitchService.featureSwitches.goalsCategoricalValues&&(!J||O)&&!w.valueRollup&&!w.targetRollup&&!w.valueConnection&&!w.targetConnection,L.supportMultipleTargetsEditing=!!this.featureSwitchService.featureSwitches.powerBIGoalsMultipleTargets,L.supportMultipleValuesEditing=!!this.featureSwitchService.featureSwitches.goalsMultipleValuesEditor,L.supportsRollup=!!this.featureSwitchService.featureSwitches.goalsRollups,L.editCalculationType=ue,L.usePickerRollup=L.editCalculationType&&!O,L},T.\u0275fac=function(R){return new(R||T)(B.\u0275\u0275inject(W.vZ),B.\u0275\u0275inject(N.G),B.\u0275\u0275inject(k.Y),B.\u0275\u0275inject(H.M,8))},T.\u0275prov=B.\u0275\u0275defineInjectable({token:T,factory:T.\u0275fac}),T}()},62087:function(Ce,ce,i){i.d(ce,{l:function(){return d}});var s=i(81337),Q=i(62831),q=i(35510),V=i(30794),H=i(14172),P=i(77526),f=i(83317),c=i(50423),p=i(49223),u=i(9380),d=function(){function M(E,B){var W=this;this.scorecardService=E,this.featureSwitches=B,this._expansionMap$=new q.X({}),this._expandableGoals$=new q.X([]),this._showAllExpanded$=new q.X(!1),this.onDestroy$=new V.xQ,this.expandByDefault=!this.featureSwitches.featureSwitches.collapseGoalsByDefault,this.scorecardService.getScorecard().pipe((0,H.U)(function(N){return _.map(Q.q.filterGoals(N.goals,function(k){return!_.isEmpty(k.subGoals)}),function(k){return k.id})}),(0,P.x)(_.isEqual),(0,f.R)(this.onDestroy$)).subscribe(this._expandableGoals$),this._expandableGoals$.pipe((0,f.R)(this.onDestroy$)).subscribe(function(N){var k=new Set(N),j=_.pickBy(W.expansionMap,function(o,v){return k.has(v)});if(W._expansionMap$.next(j),W.expandByDefault){var C=_.filter(N,function(o){return _.isNil(W.expansionMap[o])});W.setExpansion(C,!0)}}),this._expansionMap$.pipe((0,f.R)(this.onDestroy$)).subscribe(function(){var N=W.expandedGoalIds.length;0===N?W._showAllExpanded$.next(!1):N===W._expandableGoals$.value.length&&W._showAllExpanded$.next(!0)})}return Object.defineProperty(M.prototype,"expansionMap$",{get:function(){return this._expansionMap$},enumerable:!1,configurable:!0}),Object.defineProperty(M.prototype,"expansionMap",{get:function(){return this._expansionMap$.value},enumerable:!1,configurable:!0}),Object.defineProperty(M.prototype,"expandedGoalIds",{get:function(){return _.keys(_.pickBy(this.expansionMap,function(B){return B}))},enumerable:!1,configurable:!0}),Object.defineProperty(M.prototype,"showAllExpanded$",{get:function(){return this._showAllExpanded$},enumerable:!1,configurable:!0}),Object.defineProperty(M.prototype,"showAllExpanded",{get:function(){return this._showAllExpanded$.value},enumerable:!1,configurable:!0}),Object.defineProperty(M.prototype,"hasExpandableGoals$",{get:function(){return this._expandableGoals$.pipe((0,H.U)(function(B){return!_.isEmpty(B)}))},enumerable:!1,configurable:!0}),M.prototype.ngOnDestroy=function(){this.onDestroy$.next(!0),this.onDestroy$.complete()},M.prototype.isExpanded=function(E){var B;return null!==(B=this.expansionMap[E])&&void 0!==B?B:this.expandByDefault},M.prototype.expandGoal=function(E){this.setExpansion([E],!0)},M.prototype.collapseGoal=function(E){this.setExpansion([E],!1)},M.prototype.expandGoals=function(E){this.setExpansion(E,!0)},M.prototype.collapseGoals=function(E){this.setExpansion(E,!1)},M.prototype.expandAllGoals=function(){this.setExpansion(this._expandableGoals$.value,!0)},M.prototype.collapseAllGoals=function(){this.setExpansion(this._expandableGoals$.value,!1)},M.prototype.toggleExpandAll=function(){this.showAllExpanded?this.collapseAllGoals():this.expandAllGoals()},M.prototype.setExpansion=function(E,B){var W=this;if(_.some(E,function(k){return W.expansionMap[k]!==B})){var N=(0,s.pi)({},this.expansionMap);_.forEach(E,function(k){N[k]=B}),this._expansionMap$.next(N)}},M.\u0275fac=function(B){return new(B||M)(c.\u0275\u0275inject(p.G),c.\u0275\u0275inject(u.vZ))},M.\u0275prov=c.\u0275\u0275defineInjectable({token:M,factory:M.\u0275fac}),M}()},62831:function(Ce,ce,i){i.d(ce,{q:function(){return P}});var s=i(81337),Q=i(44603),q=i(4444),V=i(62458),H=i(38078),P=function(){function f(){}return f.isSampleScorecard=function(c){return"00000000-0000-0000-0000-000000000000"===c.id},f.getGoalCreateRequest=function(c){var p;return V.fF.assertValue(c,"goal"),{name:c.name,completionDate:c.completionDate,owner:c.owner,additionalOwners:c.additionalOwners,parentId:null!==(p=c.parentId)&&void 0!==p?p:null,startDate:c.startDate,unit:c.unit,datesFormatString:c.datesFormatString,valuesFormatString:c.valuesFormatString,valuesCategoryId:c.valuesCategoryId}},f.getGoalUpdateRequest=function(c){var p;return V.fF.assertValue(c,"goal"),{name:c.name,completionDate:c.completionDate,owner:c.owner,additionalOwners:c.additionalOwners,parentId:null!==(p=c.parentId)&&void 0!==p?p:null,startDate:c.startDate,unit:c.unit,datesFormatString:c.datesFormatString,valuesFormatString:c.valuesFormatString,description:c.description,cycle:c.cycle,cyclePeriod:c.cyclePeriod,valuesCategoryId:c.valuesCategoryId,metadata:c.metadata,cycleMetadata:c.cycleMetadata}},f.getGoalValueCreateRequest=function(c){return V.fF.assertValue(c,"goalValue"),{timestamp:c.timestamp,value:c.value,target:c.target,trend:c.trend,forecast:c.forecast,status:c.status}},f.getGoalValueUpdateRequest=function(c){return V.fF.assertValue(c,"goalValue"),{value:c.value,target:c.target,trend:c.trend,forecast:c.forecast,status:c.status}},f.getGoalStatusRulesUpdateRequest=function(c){V.fF.assertValue(c,"statusRules");var p=function(W){return{dateTime:W.dateTime,field:W.field,number:W.number,percentOf:W.percentOf?{field:W.percentOf.field,percent:W.percentOf.percent}:void 0}},u=function(W){return{field:W.field,operator:W.operator,value:p(W.value)}};return{rules:_.map(c.rules,function(B){return W=B,{conditions:_.map(W.conditions,function(N){return function(W){return{fieldComparison:u(W.fieldComparison),expression:W.expression}}(N)}),output:W.output};var W}),defaultOutput:c.defaultOutput}},f.isGoalMetadataUpdated=function(c,p){return!_.isEqual(f.getGoalUpdateRequest(c),f.getGoalUpdateRequest(p))},f.createNewGoal=function(c,p,u){V.fF.assertValue(c,"owner"),V.fF.assertValue(p,"scorecardId");var d=new Date,M=Q.E.getCurrentUTCDay().toISOString(),E=Q.E.getCurrentLocalDay();E.setMonth(E.getMonth()+1);var B=Q.E.treatAsUTCDate(E).toISOString();return{name:null,id:"new-".concat(H.b$.generateGuid()),scorecardId:p,createdTime:d.toISOString(),lastModifiedBy:c,lastModifiedTime:d.toISOString(),owner:c,additionalOwners:[],startDate:M,completionDate:B,unit:0,parentId:u??null,goalValues:[],subGoals:[],isNew:!0,state:"Editing",valuesCategoryId:null,isExpanded:!0}},f.getGoal=function(c,p){return this.findGoal(c,function(u){return u.id===p})},f.buildGoalTree=function(c){for(var p={},u=0,d=c;u<d.length;u++)p[(M=d[u]).id]=M;for(var E=[],B=0,W=c;B<W.length;B++){var M;if((M=W[B]).parentId&&p[M.parentId]){var N=p[M.parentId];N.subGoals?N.subGoals.push(M):N.subGoals=[M]}else E.push(M)}return E},f.findGoal=function(c,p){if(_.some(c)){var u=_.find(c,function(B){return p(B)});if(u)return u;for(var d=0,M=c;d<M.length;d++)if(u=this.findGoal(M[d].subGoals,p))return u}return null},f.forEachGoal=function(c,p){if(_.some(c))for(var u=0,d=c;u<d.length;u++){var M=d[u];p(M),this.forEachGoal(M?.subGoals,p)}},f.countSubGoals=function(c,p){var u=this;return void 0===p&&(p=function(){return!0}),_.isEmpty(c?.subGoals)?0:c.subGoals.filter(p).length+c.subGoals.reduce(function(M,E){return M+u.countSubGoals(E,p)},0)},f.flattenGoals=function(c){return function u(d){return _.flatMap(d,function(M){return(0,s.ev)([M],u(M.subGoals),!0)})}(c)},f.filterGoals=function(c,p){return _.filter(this.flattenGoals(c),p)},f.mapGoals=function(c,p){return _.map(this.flattenGoals(c),p)},f.anyGoals=function(c,p){var u;if(_.some(c))for(var d=0,M=c;d<M.length;d++){var E=M[d];if(p(E)||this.anyGoals(null!==(u=E.subGoals)&&void 0!==u?u:[],p))return!0}return!1},f.computeGoalHeight=function(c){return _.isEmpty(c?.subGoals)?0:Math.max.apply(Math,c.subGoals.map(function(p){return 1+f.computeGoalHeight(p)}))},f.computeGoalLevel=function(c,p){for(var u=0,d=p;d;)u++,d=d.parentId?f.getGoal(c,d.parentId):void 0;return u-1},f.filterGoalsAndReassignParents=function(c,p){var u=function d(M,E){var B=[],W=E;return p(M)&&(B.push((0,s.pi)((0,s.pi)({},M),{parentId:E})),W=M.id),_.concat(B,_.flatMap(M.subGoals,function(N){return d(N,W)}))};return _.flatMap(c,function(d){return u(d)})},f.isEditing=function(c){return!!f.findGoal(c?.goals,function(p){return!!p.isNew||"Editing"===p.state})},f.isDarkMode=function(){return window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches},f.getCurrentUser=function(){var c;return null===(c=(0,q.bG)())||void 0===c?void 0:c.name},f.isCurrentUser=function(c){var p=f.getCurrentUser();return p&&c&&(0,H.vr)(p,c)},f.compareGoalQueryConnections=function(c,p){return _.isEqual(c?.query,p?.query)&&_.isEqual(c?.datasetId,p?.datasetId)&&_.isEqual(c?.reportUrl,p?.reportUrl)},f.getGoalValueCategoriesCreateRequest=function(c){return V.fF.assertValue(!_.isEmpty(c),"getGoalValueCategoriesCreateRequest categoricalValues"),{name:"",categories:_.map(c,function(p,u){return{id:u,displayName:p}})}},f.getGoalValueCategoriesUpdateRequest=function(c){return V.fF.assertValue(c,"getGoalValueCategoriesUpdateRequest categoryList"),{name:c.name,categories:c.categories}},f.getGoalOwners=function(c){if(_.some(c)){var u={};return function d(M,E){if(_.some(M))for(var B=0,W=M;B<W.length;B++){var N=W[B];if(N.owner&&(E[N.owner]={displayName:void 0,userPrincipalName:N.owner,objectId:void 0,objectType:3,isSecurityGroup:void 0}),_.some(N.additionalOwners))for(var k=0,j=N.additionalOwners;k<j.length;k++){var C=j[k];C.userPrincipalName&&(E[C.userPrincipalName]={displayName:void 0,userPrincipalName:C.userPrincipalName,objectId:void 0,objectType:3,isSecurityGroup:void 0})}d(N.subGoals,E)}}(c,u),_.values(u)}return[]},f.observeAndRemoveFocusableAttributes=function(c){if(c){var p=new MutationObserver(function(u){_.some(u,function(M){var E;return(null===(E=M.addedNodes)||void 0===E?void 0:E.length)>0})&&function M(E){E&&(E.removeAttribute("tabindex"),E.removeAttribute("focusable"),_.forEach(E.children,M))}(c)});return p.observe(c,{attributeFilter:["tabindex","focusable"],characterData:!1,childList:!0,subtree:!0}),p}return null},f.getGoalsWithRollups=function(c,p,u){for(var M,d=[];p&&null!=(M=f.getGoal(c,p))&&!0!==M.isLinked&&(p=M.parentId,1===u&&null!=M.valueRollup||2===u&&null!=M.targetRollup);)d.push(M);return d},f}()},32027:function(Ce,ce,i){i.d(ce,{w:function(){return d}});var s=i(81337),Q=i(58614),q=i(35510),V=i(59973),H=i(77526),P=i(14172),f=i(57243),c=i(50423),p=i(49223),u=i(99327),d=function(){function M(E,B,W){this.goalsHttpService=E,this.scorecardService=B,this.goalsErrorService=W,this._viewsById$=new q.X(null),this._isSaving$=new q.X(!1),this._isLoading$=new q.X(!1),this.isLoading$=this._isLoading$,this.isSaving$=this._isSaving$,this.views$=this._viewsById$.pipe((0,V.h)(function(N){return!!N}),(0,H.x)(),(0,P.U)(function(N){return _.values(N)}),(0,f.d)({bufferSize:1,refCount:!0}))}return Object.defineProperty(M.prototype,"defaultListView",{get:function(){return _.find(this._viewsById$.value,function(B){return B.isDefault&&"List"===B.viewType})},enumerable:!1,configurable:!0}),M.prototype.getDefaultView=function(E){return this.views$.pipe((0,P.U)(function(B){return _.find(B,function(W){return W.isDefault&&W.viewType===E})}))},M.prototype.loadViews=function(E){return void 0===E&&(E=!1),(0,s.mG)(this,void 0,void 0,function(){var B,W;return(0,s.Jh)(this,function(N){switch(N.label){case 0:if(B=this.scorecardService.getCurrentScorecard(),!E&&null!==this._viewsById$.value||this._isLoading$.value)return[2];this._isLoading$.next(!0),N.label=1;case 1:return N.trys.push([1,,3,4]),[4,this.goalsHttpService.getScorecardViews(B.groupId,B.id).toPromise()];case 2:return W=N.sent(),this._viewsById$.next(_.keyBy(W,function(k){return k.id})),[3,4];case 3:return this._isLoading$.next(!1),[7];case 4:return[2]}})})},M.prototype.saveView=function(E){return(0,s.mG)(this,void 0,void 0,function(){var B,W;return(0,s.Jh)(this,function(N){switch(N.label){case 0:return B=this.scorecardService.getCurrentScorecard(),[4,this.loadViews()];case 1:N.sent(),this._isSaving$.next(!0),N.label=2;case 2:return N.trys.push([2,8,9,10]),this._viewsById$.value[E.id]?[4,this.goalsHttpService.updateScorecardView(B.groupId,B.id,E).toPromise()]:[3,4];case 3:return N.sent(),[3,6];case 4:return[4,this.goalsHttpService.createScorecardView(B.groupId,B.id,E).toPromise()];case 5:N.sent(),N.label=6;case 6:return[4,this.loadViews(!0)];case 7:return N.sent(),[3,10];case 8:return W=N.sent(),this.goalsErrorService.showUserError(W,"SaveViewError"),[3,10];case 9:return this._isSaving$.next(!1),[7];case 10:return[2]}})})},M.prototype.clearCache=function(){this._viewsById$.next(null)},M.\u0275fac=function(B){return new(B||M)(c.\u0275\u0275inject(Q.f),c.\u0275\u0275inject(p.G),c.\u0275\u0275inject(u.X))},M.\u0275prov=c.\u0275\u0275defineInjectable({token:M,factory:M.\u0275fac}),M}()},49223:function(Ce,ce,i){i.d(ce,{G:function(){return Ue}});var s=i(81337),Q=i(70060),q=i(77695),V=i(57535),H=i(60042),P=i(44603),f=i(125),c=i(61088),p=function(){function G(){}return G.ManuallyUpdatingConnectedGoalValueNotAllowed="ManuallyUpdatingConnectedGoalValueNotAllowed",G.ManuallyUpdatingConnectedMetricValueNotAllowed="ManuallyUpdatingConnectedMetricValueNotAllowed",G.MultiGeoNotSupported="MultiGeoNotSupported",G.InvalidScorecardColumnSetting="InvalidScorecardColumnSetting",G.CircularRelationshipsNotAllowed="CircularRelationshipsNotAllowed",G}(),u=i(62831),d=i(62458),M=i(30794),E=i(11547),B=i(18353),W=i(42195),N=i(70032),k=i(48787),j=function(){function G(e){var t,r=this;this.scorecardService=e,this.MinPollingInterval=200,this.MaxPollingInterval=4e3,this.MaxPollingRequests=40,this.PollingDelay=function(a){return r.MinPollingInterval+(r.MaxPollingInterval-r.MinPollingInterval)*a/r.MaxPollingRequests},this.ConnectionTypeAsText=((t={})[1]="Current",t[2]="Target",t)}return G.prototype.startPollingAsync=function(e,t,r){return(0,s.mG)(this,void 0,void 0,function(){var a,l=this;return(0,s.Jh)(this,function(h){switch(h.label){case 0:if(this.setGoalRefreshState(e.id,t,!0),a=r?.lastRefreshTimestamp,null!=a)return[3,4];h.label=1;case 1:return h.trys.push([1,3,,4]),[4,this.getLastRefreshTimestamp(e.id,t)];case 2:return a=h.sent(),[3,4];case 3:return h.sent(),this.setGoalRefreshState(e.id,t,!1),[2];case 4:return(0,s.mG)(l,void 0,void 0,function(){var S,g,A,re,b=this;return(0,s.Jh)(this,function(ee){switch(ee.label){case 0:return ee.trys.push([0,,9,10]),S=new M.xQ,(g=S.pipe((0,B.R)(function(se){return se+1},-1),(0,W.zg)(function(se){return(0,E.of)(void 0).pipe((0,N.g)(b.PollingDelay(se)))}),(0,k.q)(this.MaxPollingRequests))).subscribe(function(){return(0,s.mG)(b,void 0,void 0,function(){return(0,s.Jh)(this,function(se){switch(se.label){case 0:return[4,this.getLastRefreshTimestamp(e.id,t)];case 1:return A=se.sent(),a===A?S.next():(d.fF.assertValue(A>a,"Expected new refresh history count to be higher"),S.complete()),[2]}})})}),S.next(),[4,g.toPromise()];case 1:return ee.sent(),r?.refreshGoal?[4,this.scorecardService.refreshGoal(e.id)]:[3,3];case 2:ee.sent(),ee.label=3;case 3:return r?.refreshGoalValues?[4,this.scorecardService.expandGoalValues(e.id,!0)]:[3,5];case 4:ee.sent(),ee.label=5;case 5:return r?.refreshRollups&&e.parentId?[4,this.startRollupPolling(e.parentId,t,A)]:[3,7];case 6:ee.sent(),ee.label=7;case 7:return[4,null===(re=r?.onComplete)||void 0===re?void 0:re.call(r,A)];case 8:return ee.sent(),[3,10];case 9:return this.setGoalRefreshState(e.id,t,!1),[7];case 10:return[2]}})}),[2]}})})},G.prototype.refreshRollups=function(e,t){return(0,s.mG)(this,void 0,void 0,function(){var r,a,n,l,h,S,g,A,b;return(0,s.Jh)(this,function(se){switch(se.label){case 0:if(!e.parentId||null!=e.valuesCategoryId)return[3,2];if(r=[],a=this.scorecardService.getCurrentScorecard(),!(n=u.q.getGoal(a.goals,e.parentId)))return[3,2];for(l=!1,h=!1,S=function(me){var oe=new Date(me.timestamp).getTime(),ge=_.find(e.goalValues,function(he){return new Date(he.timestamp).getTime()===oe});if(g.isPartOfParentGoalRollup(n.valueRollup,me)&&(l||(l=ge?.value!==me.value)),g.isPartOfParentGoalRollup(n.targetRollup,me)&&(h||(h=ge?.target!==me.target)),l&&h)return"break"},g=this,A=0,b=t;A<b.length&&"break"!==S(b[A]);A++);return l&&r.push(this.startRollupPolling(e.parentId,1)),h&&r.push(this.startRollupPolling(e.parentId,2)),_.some(r)?[4,Promise.all(r)]:[3,2];case 1:se.sent(),se.label=2;case 2:return[2]}})})},G.prototype.refreshRollupsAfterMove=function(e){var t;return(0,s.mG)(this,void 0,void 0,function(){var r,n,l,h,S,g,A;return(0,s.Jh)(this,function(b){switch(b.label){case 0:return r=this.scorecardService.getCurrentScorecard(),null!=u.q.getGoal(r.goals,e.goalToMove.goalId).valuesCategoryId?[2]:(n=[],l=[],null!=e.goalToMove.currentParentId&&(n.push.apply(n,u.q.getGoalsWithRollups(r.goals,h=e.goalToMove.currentParentId,1)),l.push.apply(l,u.q.getGoalsWithRollups(r.goals,h,2))),null!=(null===(t=e.newParent)||void 0===t?void 0:t.goalId)&&(g=u.q.getGoalsWithRollups(r.goals,S=e.newParent.goalId,1),A=u.q.getGoalsWithRollups(r.goals,S,2),n=this.mergeParents(n,g),l=this.mergeParents(l,A)),[4,Promise.all([this.startRollupPollingForGoals(n,1),this.startRollupPollingForGoals(l,2)])]);case 1:return b.sent(),[2]}})})},G.prototype.refreshRollupsAfterGoalDelete=function(e){return(0,s.mG)(this,void 0,void 0,function(){var t,r,a,n,S=this;return(0,s.Jh)(this,function(g){switch(g.label){case 0:return e.parentId&&null==e.valuesCategoryId?(t=this.scorecardService.getCurrentScorecard(),(r=u.q.getGoal(t.goals,e.parentId))?(a=[],n=[],_.isNil(r.valueRollup)||_.some(e.goalValues,function(A){return!_.isNil(A.value)&&S.isPartOfParentGoalRollup(r.valueRollup,A)})&&a.push.apply(a,u.q.getGoalsWithRollups(t.goals,r.id,1)),_.isNil(r.targetRollup)||_.some(e.goalValues,function(A){return!_.isNil(A.target)&&S.isPartOfParentGoalRollup(r.targetRollup,A)})&&n.push.apply(n,u.q.getGoalsWithRollups(t.goals,r.id,2)),[4,Promise.all([this.startRollupPollingForGoals(a,1),this.startRollupPollingForGoals(n,2)])]):[3,2]):[3,2];case 1:g.sent(),g.label=2;case 2:return[2]}})})},G.prototype.refreshRollupsAfterGoalValueDelete=function(e,t){return(0,s.mG)(this,void 0,void 0,function(){var r,a,n,l;return(0,s.Jh)(this,function(g){switch(g.label){case 0:return e.parentId&&null==e.valuesCategoryId?(r=this.scorecardService.getCurrentScorecard(),(a=u.q.getGoal(r.goals,e.parentId))?(n=[],l=[],_.isNil(a.valueRollup)||!_.isNil(t.value)&&this.isPartOfParentGoalRollup(a.valueRollup,t)&&n.push.apply(n,u.q.getGoalsWithRollups(r.goals,a.id,1)),_.isNil(a.targetRollup)||!_.isNil(t.target)&&this.isPartOfParentGoalRollup(a.targetRollup,t)&&l.push.apply(l,u.q.getGoalsWithRollups(r.goals,a.id,2)),[4,Promise.all([this.startRollupPollingForGoals(n,1),this.startRollupPollingForGoals(l,2)])]):[3,2]):[3,2];case 1:g.sent(),g.label=2;case 2:return[2]}})})},G.prototype.isPartOfParentGoalRollup=function(e,t){return e&&(_.isNil(e.startDate)||new Date(t.timestamp).getTime()>=new Date(e.startDate).getTime())},G.prototype.startRollupPolling=function(e,t,r){return(0,s.mG)(this,void 0,void 0,function(){var a,n;return(0,s.Jh)(this,function(l){switch(l.label){case 0:return a=this.scorecardService.getCurrentScorecard(),n=u.q.getGoalsWithRollups(a.goals,e,t),[4,this.startRollupPollingForGoals(n,t,r)];case 1:return l.sent(),[2]}})})},G.prototype.startRollupPollingForGoals=function(e,t,r){return(0,s.mG)(this,void 0,void 0,function(){var a,n=this;return(0,s.Jh)(this,function(l){switch(l.label){case 0:return _.some(e)?(a=e.shift(),[4,this.startPollingAsync(a,t,{lastRefreshTimestamp:r,refreshGoal:!0,refreshGoalValues:!0,onComplete:function(S){return n.startRollupPollingForGoals(e,t,S)}})]):[3,2];case 1:l.sent(),l.label=2;case 2:return[2]}})})},G.prototype.getLastRefreshTimestamp=function(e,t){var r;return(0,s.mG)(this,void 0,void 0,function(){var a,n,l;return(0,s.Jh)(this,function(S){switch(S.label){case 0:return a=this.ConnectionTypeAsText[t],[4,this.scorecardService.getRefreshHistory(e)];case 1:return n=S.sent(),l=_.filter(n,function(g){return g.connectionType===t||g.connectionType===a}),[2,null===(r=_.maxBy(l,function(g){return g.timestamp}))||void 0===r?void 0:r.timestamp]}})})},G.prototype.mergeParents=function(e,t){if(!_.some(e))return t;var r=_.intersectionBy(e,t,function(h){return h.id});if(_.isEmpty(r))return(0,s.ev)((0,s.ev)([],e,!0),t,!0);for(var a=_.findIndex(t,function(h){return h.id===r[0].id}),n=[],l=0;l<a;l++)n.push(t[l]);return n.push.apply(n,e),n},G.prototype.setGoalRefreshState=function(e,t,r){this.scorecardService.setGoalRefreshState(e,t,r)},G}(),C=i(14786),o=i(45017),v=i(74076),U=i(58614),T=i(60166),w=i(98587),R=i(10723),z=i(50547),ie=i(43286),L=i(91055),F=i(74466),de=i(33554),Z=i(35510),D=i(59017),O=i(14172),J=i(77526),te=i(83317),X=i(68549),ne=i(81905),ae=i(50423),ue=i(58938),Se=i(81213),pe=i(65181),_e=i(21976),Re=i(9380),Oe=i(99327),Ae=i(96608),He=i(85732),Ue=function(){function G(e,t,r,a,n,l,h,S,g,A,b,re,ee){var ve,me,se=this;this.goalsHttpService=e,this.userDetailsService=t,this.dialogService=r,this.errorService=a,this.localizationService=n,this.userInfo=l,this.featureSwitches=h,this.goalsErrorService=S,this.telemetryService=g,this.tabFacade=A,this.store=b,this.scorecardHost=re,this.scorecardSettings=ee,this.scorecard=void 0,this._scorecard$=new de.t(1),this._selectedGoalIds$=this._scorecard$.pipe((0,O.U)(function(oe){return oe?.selectedGoalIds}),(0,J.x)(_.isEqual)),this._activeGoalId$=this._scorecard$.pipe((0,O.U)(function(oe){return oe?.activeGoalId}),(0,J.x)()),this.isEditMode$=new Z.X(!1),this.loading$=new Z.X(0),this._viewType$=new Z.X("List"),this._scorecardSelectionMode$=new Z.X(null),this.switchingHierarchyPath$=new Z.X(!1),this.linkedScorecardsById={},this._goalStatusesByScorecardId$=new Z.X({}),this.onHierarchyNotFound$=new M.xQ,this.onDestroy$=new M.xQ,this.requestId=0,this.pollingService=new j(this),this.scorecardHost&&(this.getSelectedGoalsObservable().pipe((0,te.R)(this.onDestroy$)).subscribe(function(oe){se.scorecardHost.onSelectGoals(oe)}),this._scorecard$.pipe((0,O.U)(function(oe){return oe.hierarchyPaths}),(0,J.x)(),(0,te.R)(this.onDestroy$)).subscribe(function(oe){se.scorecardHost.onChangeHierarchyPath(oe)})),this._scorecard$.pipe((0,J.x)(function(oe,ge){var he,Me;return _.isEqual(null===(he=oe?.goalStatuses)||void 0===he?void 0:he.statuses,null===(Me=ge?.goalStatuses)||void 0===Me?void 0:Me.statuses)&&oe?.linkedScorecards===ge?.linkedScorecards}),(0,O.U)(function(oe){return V.p.getGoalStatusesByScorecardId(oe)}),(0,te.R)(this.onDestroy$)).subscribe(this._goalStatusesByScorecardId$),(0,D.aj)([this.isEditMode$,this.viewType$,null!==(me=null===(ve=this.scorecardSettings)||void 0===ve?void 0:ve.settings)&&void 0!==me?me:(0,E.of)({})]).pipe((0,O.U)(function(oe){var ge=oe[0],he=oe[1],Me=oe[2];return"tile"===Me?.displayMode?se.featureSwitches.featureSwitches.multipleGoalTilesVisual?"multiple":"single":Me?.useMultiselectMode?"multiple":"List"===he&&ge?"ctrl":null}),(0,J.x)(),(0,te.R)(this.onDestroy$)).subscribe(this._scorecardSelectionMode$)}return G.prototype.ngOnDestroy=function(){this.onDestroy$.next(!0),this.onDestroy$.complete()},G.prototype.loadScorecard=function(e,t,r,a){var n=this;if(u.q.isEditing(this.scorecard)&&!r)this.promptUserConfirmation({title:this.localizationService.get("MetricsUnsavedChangesTitle"),message:this.localizationService.get("MetricsUnsavedChangesDescription"),okButtonText:this.localizationService.get("Refresh"),panelClass:["updateConfirmationDialogPanel"],onConfirmation:function(){return(0,s.mG)(n,void 0,void 0,function(){return(0,s.Jh)(this,function(S){return[2,this.loadScorecard(e,t,!0,a)]})})}});else{this.loading$.next(this.loading$.value+1),this.requestId++;var l=this.requestId;this.goalsHttpService.getScorecard(e,t,!0,a).toPromise().then(function(h){n.loading$.next(n.loading$.value-1),!(l<n.requestId)&&(n.switchingHierarchyPath$.next(!1),n.setScorecardWithGoals(h))}).catch(function(h){if(n.loading$.next(n.loading$.value-1),!(l<n.requestId)){if(n.switchingHierarchyPath$.next(!1),_.isEmpty(a))n.scorecard=null;else if(n.goalsErrorService.showUserError(h,"LoadHierarchy","MetricsHierarchy_Loading_Error"),404===h?.status&&(n.setActiveHierarchy(void 0,!0),n.onHierarchyNotFound$.next(a),!n.scorecard))return;n.commit()}})}return this._scorecard$.asObservable()},G.prototype.setActiveHierarchy=function(e,t){return(0,s.mG)(this,void 0,void 0,function(){var r,a=this;return(0,s.Jh)(this,function(n){switch(n.label){case 0:return r=function(h,S){return _.isEmpty(h)&&_.isEmpty(S)||_.isEqual(h,S)},this.scorecard&&!r(this.scorecard.hierarchyPaths,e)?u.q.isEditing(this.scorecard)&&!t?[2,this.promptUserConfirmation({title:this.localizationService.get("MetricsUnsavedChangesTitle"),message:this.localizationService.get("MetricsUnsavedChangesDescription"),okButtonText:this.localizationService.get("ModalDialogButtonText_Continue"),panelClass:["updateConfirmationDialogPanel"],onConfirmation:function(){return(0,s.mG)(a,void 0,void 0,function(){return(0,s.Jh)(this,function(h){return[2,this.setActiveHierarchy(e,!0)]})})}})]:[3,1]:[3,3];case 1:return this.switchingHierarchyPath$.next(!0),[4,this.loadScorecard(this.scorecard.groupId,this.scorecard.id,!0,e).pipe((0,X.o)(function(l){return!r(l.hierarchyPaths,e)},!0)).toPromise()];case 2:return[2,n.sent()];case 3:return[2]}})})},Object.defineProperty(G.prototype,"onHierarchyNotFound",{get:function(){return this.onHierarchyNotFound$},enumerable:!1,configurable:!0}),Object.defineProperty(G.prototype,"isHierarchicalScorecard",{get:function(){var t;return!_.isEmpty(null===(t=this.scorecard)||void 0===t?void 0:t.hierarchyPaths)},enumerable:!1,configurable:!0}),G.prototype.assertNoActivehierarchy=function(e){return void 0===e&&(e=!1),!this.isHierarchicalScorecard||(e?this.dialogService.showSimpleDialog(this.localizationService.get("Coming_Soon"),this.localizationService.get("MetricsHierarchy_ComingSoon")):d.fF.assertFail("Cannot perform this operation on a hierarchical scorecard. ".concat((new Error).stack)),!1)},Object.defineProperty(G.prototype,"hierarchyPaths$",{get:function(){return this._scorecard$.pipe((0,O.U)(function(t){return t?.hierarchyPaths}),(0,J.x)())},enumerable:!1,configurable:!0}),G.prototype.assertScorecardLoaded=function(e){return!(e.id!==this.scorecard.id||!_.isEqual(e.hierarchyPaths,this.scorecard.hierarchyPaths))||(d.fF.assertFail("Scorecard has changed. Active scorecard: ".concat(JSON.stringify(this.scorecard.hierarchyPaths),". Previous scorecard ").concat(JSON.stringify(e.hierarchyPaths))),!1)},G.prototype.isSwitchingHierarchyPath=function(){return this.switchingHierarchyPath$.asObservable()},G.prototype.saveGoal=function(e,t){var r,a,n,l,h,S;return(0,s.mG)(this,void 0,void 0,function(){var g,A,b,re,ee,se,ve,me=this;return(0,s.Jh)(this,function(oe){switch(oe.label){case 0:if(d.fF.assertValue(this.scorecard,"No scorecard loaded"),g=u.q.getGoal(this.scorecard.goals,e),d.fF.assertValue(g,"goal"),A=u.q.isGoalMetadataUpdated(g,t),!g.isNew&&!A)return[2,e];if(b=(null===(r=t.metadata)||void 0===r?void 0:r.showFinalTarget)!==(null===(a=g.metadata)||void 0===a?void 0:a.showFinalTarget)||(null===(n=t.metadata)||void 0===n?void 0:n.showPercentChange)!==(null===(l=g.metadata)||void 0===l?void 0:l.showPercentChange)||!_.isEqual(null!==(h=g.cycleMetadata)&&void 0!==h?h:{},null!==(S=t.cycleMetadata)&&void 0!==S?S:{}),!this.assertNoActivehierarchy(!0))return[2,e];oe.label=1;case 1:return oe.trys.push([1,9,,10]),re=this.scorecard,g.isNew?[4,this.goalsHttpService.createGoal(this.scorecard.groupId,this.scorecard.id,u.q.getGoalCreateRequest(t)).toPromise()]:[3,5];case 2:return ee=oe.sent(),t.metadata?[4,this.goalsHttpService.updateGoal(this.scorecard.groupId,this.scorecard.id,ee.id,{metadata:t.metadata}).toPromise()]:[3,4];case 3:ee=oe.sent(),oe.label=4;case 4:return[3,7];case 5:return A?[4,this.goalsHttpService.updateGoal(this.scorecard.groupId,this.scorecard.id,g.id,u.q.getGoalUpdateRequest(t)).toPromise()]:[3,7];case 6:ee=oe.sent(),oe.label=7;case 7:return this.assertScorecardLoaded(re)?[4,this.getOwnerDisplayNames(g)]:[2];case 8:return se=oe.sent(),this.scorecard=(0,F.Uy)(this.scorecard,function(ge){var he=u.q.getGoal(ge.goals,e);me.assignGoal(he,ee),he.isNew=!1,he.ownerDisplayNames=se}),e=ee.id,[3,10];case 9:throw ve=oe.sent(),this.goalsErrorService.showUserError(ve,"SaveGoalError"),ve;case 10:return b?[4,this.refreshGoal(e)]:[3,12];case 11:return oe.sent(),[3,13];case 12:this.commit(),oe.label=13;case 13:return[2,e]}})})},G.prototype.moveGoal=function(e,t,r){var a;return(0,s.mG)(this,void 0,void 0,function(){var n,l,h,S,b,re;return(0,s.Jh)(this,function(ee){switch(ee.label){case 0:return d.fF.assertValue(this.scorecard,"No scorecard loaded"),d.fF.assertValue(this.scorecard.goals,"Scorecard should have at least one goal to move"),this.assertNoActivehierarchy()?(n=u.q.getGoal(this.scorecard.goals,e),d.fF.assertValue(n,"Source goal does not exist"),l=u.q.computeGoalHeight(n),h=r?u.q.getGoal(this.scorecard.goals,r):void 0,d.fF.assertValue(!r||h,"Destination parent goal does not exist"),S=h?u.q.computeGoalLevel(this.scorecard.goals,h):void 0,(_.isNil(S)?l:l+S+1)>H.gT.MaxSubGoals?[4,this.dialogService.showSimpleInfoDialog({title:this.localizationService.get("MetricCannotBeMovedTitle"),message:this.localizationService.format("MetricCannotBeMovedMessage",H.gT.MaxSubGoals)},{autoFocus:!0}).afterClosed().toPromise()]:[3,2]):[2];case 1:return ee.sent(),[2];case 2:b={goalToMove:{goalId:e}},this.scorecard=(0,F.Uy)(this.scorecard,function(se){var ve,me,oe,ge,he=u.q.getGoal(se.goals,e);b.goalToMove.currentParentId=null!==(ve=he.parentId)&&void 0!==ve?ve:void 0;var Me=he.parentId?u.q.getGoal(se.goals,he.parentId):void 0;he.parentId&&!Me||_.remove(he.parentId?Me.subGoals:se.goals,function(Ie){return Ie.id===he.id});var we=r?u.q.getGoal(se.goals,r):void 0;we&&(b.newParent={goalId:we.id,currentParentId:null!==(me=we.parentId)&&void 0!==me?me:void 0});var Pe=we?we.subGoals:se.goals;if(Pe){var Ee=t?Pe.findIndex(function(Ie){return Ie.id===t}):Pe.length;d.fF.assertValue(-1!==Ee,"Destination next goal does not exist");var be=Ee-1>=0?Pe[Ee-1]:void 0;be&&(b.newPrevious={goalId:be.id,currentParentId:null!==(oe=be.parentId)&&void 0!==oe?oe:void 0});var Te=Ee<Pe.length?Pe[Ee]:void 0;d.fF.assertValue(!Te||Te.parentId===r,"Destination next goal parent should be the same as the destination parent goal"),Te&&(b.newNext={goalId:Te.id,currentParentId:null!==(ge=Te.parentId)&&void 0!==ge?ge:void 0}),Pe.splice(Ee,0,he);var $e=0;Pe.forEach(function(Ie){Ie.rank=$e,$e++})}else he.rank=0,we.subGoals=[he];return he.parentId=r,he.state="Saving",se}),this.loading$.next(this.loading$.value+1),this.commit(),ee.label=3;case 3:return ee.trys.push([3,6,10,11]),[4,this.pollingService.refreshRollupsAfterMove(b)];case 4:return ee.sent(),[4,this.goalsHttpService.moveGoal(this.scorecard.groupId,this.scorecard.id,b).toPromise()];case 5:return ee.sent(),this.setGoalState(e,"Consumption"),[3,11];case 6:return re=ee.sent(),(null===(a=re?.error)||void 0===a?void 0:a.code)!==p.CircularRelationshipsNotAllowed?[3,8]:[4,this.loadScorecard(this.scorecard.groupId,this.scorecard.id,!0)];case 7:return ee.sent(),this.dialogService.showSimpleDialog(this.localizationService.get("Unable_to_move_metric"),this.localizationService.get("Metrics_Circular_Relationships_Not_Allowed")),[3,9];case 8:throw this.goalsErrorService.showUserError(re,"MoveGoalError"),re;case 9:return[3,11];case 10:return this.loading$.next(this.loading$.value-1),[7];case 11:return[2]}})})},G.prototype.refreshGoal=function(e){return(0,s.mG)(this,void 0,void 0,function(){var t,r,a,n,l=this;return(0,s.Jh)(this,function(h){switch(h.label){case 0:d.fF.assertValue(this.scorecard,"No scorecard loaded"),h.label=1;case 1:return h.trys.push([1,4,,5]),t=this.scorecard,[4,this.goalsHttpService.getGoal(this.scorecard.groupId,this.scorecard.id,e,!1,this.scorecard.hierarchyPaths).toPromise()];case 2:return r=h.sent(),this.assertScorecardLoaded(t)?[4,this.getOwnerDisplayNames(r)]:[2];case 3:return a=h.sent(),this.scorecard=(0,F.Uy)(this.scorecard,function(S){var g=u.q.getGoal(S.goals,e);l.assignGoal(g,r),g.ownerDisplayNames=a}),[3,5];case 4:throw n=h.sent(),this.goalsErrorService.showUserError(n,"RefreshGoalError"),n;case 5:return this.commit(),[2]}})})},G.prototype.saveGoalValue=function(e,t){var r,a;return(0,s.mG)(this,void 0,void 0,function(){var n,l,h,S,g,A;return(0,s.Jh)(this,function(b){switch(b.label){case 0:return d.fF.assertValue(this.scorecard,"No scorecard loaded"),[4,this.expandGoalValues(e)];case 1:b.sent(),n=u.q.getGoal(this.scorecard.goals,e),d.fF.assertValue(n,"goal"),l=_.find(n.goalValues,function(re){return new Date(re.timestamp).getTime()===new Date(t.timestamp).getTime()}),d.fF.assert(function(){return!n.valueConnection||_.isNil(t.value)},"Value cannot be updated when it is connected to data"),d.fF.assert(function(){return!n.targetConnection||_.isNil(t.target)},"Target cannot be updated when it is connected to data"),n.hasStatusRules&&(t.status=null),b.label=2;case 2:return b.trys.push([2,9,15,16]),this.loading$.next(this.loading$.value+1),[4,this.pollingService.refreshRollups(n,[t])];case 3:return b.sent(),h=this.scorecard,l?[4,this.goalsHttpService.updateGoalValue(this.scorecard.groupId,this.scorecard.id,e,new Date(t.timestamp).toISOString(),u.q.getGoalValueUpdateRequest(t),this.scorecard.hierarchyPaths).toPromise()]:[3,5];case 4:return S=b.sent(),this.assertScorecardLoaded(h)?(this.scorecard=(0,F.Uy)(this.scorecard,function(re){var ee=u.q.getGoal(re.goals,e);d.fF.assertValue(ee,"Goal not found");var se=_.find(ee.goalValues,function(ve){return new Date(ve.timestamp).getTime()===new Date(S.timestamp).getTime()});d.fF.assertValue(se,"Goal value not found"),Object.assign(se,S)}),[3,7]):[2];case 5:return[4,this.goalsHttpService.createGoalValue(this.scorecard.groupId,this.scorecard.id,e,u.q.getGoalValueCreateRequest(t),this.scorecard.hierarchyPaths).toPromise()];case 6:if(g=b.sent(),!this.assertScorecardLoaded(h))return[2];this.scorecard=(0,F.Uy)(this.scorecard,function(re){var ee=u.q.getGoal(re.goals,e);d.fF.assertValue(ee,"Goal not found"),ee.goalValues?ee.goalValues.push(g):ee.goalValues=[g]}),b.label=7;case 7:return[4,this.refreshGoal(e)];case 8:return b.sent(),[3,16];case 9:if(A=b.sent(),(null===(r=A?.error)||void 0===r?void 0:r.code)!==p.ManuallyUpdatingConnectedGoalValueNotAllowed&&(null===(a=A?.error)||void 0===a?void 0:a.code)!==p.ManuallyUpdatingConnectedMetricValueNotAllowed)return[3,10];throw this.errorService.errorNoDefaultAdditionalErrorInfo(this.localizationService.get("Updating_Connected_MetricValue_Not_Allowed"),"Not_Allowed",{title:this.localizationService.get("Operation_Not_Allowed"),level:z.U.Information,isDismissable:!0,showAdditionalErrorInfo:!1}),A;case 10:return l||409!==A?.status?[3,13]:(this.errorService.errorNoDefaultAdditionalErrorInfo(this.localizationService.get("Metrics_Existing_Checkin_Found"),"Checkin_Exists",{title:this.localizationService.get("Metrics_Existing_Checkin_Found_Title"),level:z.U.Information,isDismissable:!0,showAdditionalErrorInfo:!1,hideGetHelpLink:!0}),[4,this.refreshGoal(e)]);case 11:return b.sent(),[4,this.expandGoalValues(e,!0)];case 12:return b.sent(),[3,14];case 13:throw this.goalsErrorService.showUserError(A,"SaveGoalValueError"),A;case 14:return[3,16];case 15:return this.loading$.next(this.loading$.value-1),[7];case 16:return this.commit(),[2]}})})},G.prototype.expandGoalValues=function(e,t){return void 0===t&&(t=!1),(0,s.mG)(this,void 0,void 0,function(){var r,a,n,l;return(0,s.Jh)(this,function(h){switch(h.label){case 0:if(d.fF.assertValue(this.scorecard,"No scorecard loaded"),this.scorecard.isSample)return[2];if(r=u.q.getGoal(this.scorecard.goals,e),d.fF.assertValue(r,"goal"),!r||r.isExpanded&&!t)return[2];h.label=1;case 1:return h.trys.push([1,3,4,5]),this.loading$.next(this.loading$.value+1),a=this.scorecard,[4,this.goalsHttpService.getGoalValues(this.scorecard.groupId,this.scorecard.id,r.id,!0,this.scorecard.hierarchyPaths).toPromise()];case 2:return n=h.sent(),this.assertScorecardLoaded(a)?(this.scorecard=(0,F.Uy)(this.scorecard,function(S){var g=u.q.getGoal(S.goals,e);d.fF.assertValue(g,"goal"),g.goalValues=n,g.isExpanded=!0}),this.commit(),[3,5]):[2];case 3:throw l=h.sent(),this.goalsErrorService.showUserError(l,"ExpandGoalValues"),l;case 4:return this.loading$.next(this.loading$.value-1),[7];case 5:return[2]}})})},G.prototype.upsertGoalValues=function(e,t){return(0,s.mG)(this,void 0,void 0,function(){var r,a,n;return(0,s.Jh)(this,function(l){switch(l.label){case 0:if(!this.assertNoActivehierarchy(!0))return[2];r=u.q.getGoal(this.scorecard.goals,e),d.fF.assertValue(r,"goal"),l.label=1;case 1:return l.trys.push([1,5,6,7]),this.loading$.next(this.loading$.value+1),[4,this.pollingService.refreshRollups(r,t)];case 2:return l.sent(),[4,this.goalsHttpService.upsertGoalValues(this.scorecard.groupId,this.scorecard.id,e,t).toPromise()];case 3:return a=l.sent(),[4,this.refreshGoal(e)];case 4:return l.sent(),this.scorecard=(0,F.Uy)(this.scorecard,function(h){var S=u.q.getGoal(h.goals,e);S.goalValues=a,S.isExpanded=!0}),this.commit(),[3,7];case 5:throw n=l.sent(),this.goalsErrorService.showUserError(n,"UpsertGoalValues"),n;case 6:return this.loading$.next(this.loading$.value-1),[7];case 7:return[2]}})})},G.prototype.overwriteMultipleGoalValues=function(e,t){var r,a;return(0,s.mG)(this,void 0,void 0,function(){var n,l,h,S,g;return(0,s.Jh)(this,function(A){switch(A.label){case 0:return this.assertNoActivehierarchy(!0)?[4,this.expandGoalValues(e)]:[2];case 1:return A.sent(),l=u.q.getGoal(this.scorecard.goals,e),h=null!==(a=null===(r=l.goalValues)||void 0===r?void 0:r.filter(function(b){return!_.isNil(b.value)}).map(function(b){return{timestamp:b.timestamp,value:b.value}}))&&void 0!==a?a:[],S=t.map(function(b){return{timestamp:b.timestamp,value:b.value}}),(n=o.B.calculateGoalValueChanges(h,S)).length>0?(g=n.map(function(b){return{timestamp:b.timestamp,value:b.value}}),[4,this.upsertGoalValues(e,g)]):[3,3];case 2:A.sent(),A.label=3;case 3:return[2]}})})},G.prototype.overwriteGoalTargets=function(e,t){var r,a;return(0,s.mG)(this,void 0,void 0,function(){var n,l,h,S,g;return(0,s.Jh)(this,function(A){switch(A.label){case 0:return this.assertNoActivehierarchy(!0)?[4,this.expandGoalValues(e)]:[2];case 1:return A.sent(),n=u.q.getGoal(this.scorecard.goals,e),l=null!==(a=null===(r=n.goalValues)||void 0===r?void 0:r.filter(function(b){return!_.isNil(b.target)}).map(function(b){return{timestamp:b.timestamp,value:b.target}}))&&void 0!==a?a:[],h=t.map(function(b){return{timestamp:b.timestamp,value:b.target}}),(S=o.B.calculateGoalValueChanges(l,h)).length>0?(g=S.map(function(b){return{timestamp:b.timestamp,target:b.value}}),[4,this.upsertGoalValues(e,g)]):[3,3];case 2:A.sent(),A.label=3;case 3:return[2]}})})},G.prototype.followGoal=function(e){return(0,s.mG)(this,void 0,void 0,function(){var t;return(0,s.Jh)(this,function(r){switch(r.label){case 0:if(!this.assertNoActivehierarchy(!0))return[2];if(u.q.isSampleScorecard(this.scorecard))return[2];d.fF.assertValue(this.scorecard,"No scorecard loaded"),r.label=1;case 1:return r.trys.push([1,3,,4]),[4,this.goalsHttpService.followGoal(this.scorecard.groupId,this.scorecard.id,e).toPromise()];case 2:return r.sent(),this.scorecard=(0,F.Uy)(this.scorecard,function(a){var n=u.q.getGoal(a.goals,e);d.fF.assertValue(n,"Goal not found"),n.isFollowed=!0}),this.commit(),[3,4];case 3:throw t=r.sent(),this.goalsErrorService.showUserError(t,"Follow Metric Error"),t;case 4:return[2]}})})},G.prototype.unfollowGoal=function(e){return(0,s.mG)(this,void 0,void 0,function(){var t;return(0,s.Jh)(this,function(r){switch(r.label){case 0:if(!this.assertNoActivehierarchy(!0))return[2];if(u.q.isSampleScorecard(this.scorecard))return[2];d.fF.assertValue(this.scorecard,"No scorecard loaded"),r.label=1;case 1:return r.trys.push([1,3,,4]),[4,this.goalsHttpService.unfollowGoal(this.scorecard.groupId,this.scorecard.id,e).toPromise()];case 2:return r.sent(),this.scorecard=(0,F.Uy)(this.scorecard,function(a){var n=u.q.getGoal(a.goals,e);d.fF.assertValue(n,"Goal not found"),n.isFollowed=!1}),this.commit(),[3,4];case 3:throw t=r.sent(),this.goalsErrorService.showUserError(t,"Unfollow Metric Error"),t;case 4:return[2]}})})},G.prototype.editNote=function(e,t,r,a){return(0,s.mG)(this,void 0,void 0,function(){var n,l,h;return(0,s.Jh)(this,function(S){switch(S.label){case 0:d.fF.assertValue(this.scorecard,"No scorecard loaded"),S.label=1;case 1:return S.trys.push([1,3,,4]),n=this.scorecard,[4,this.goalsHttpService.editNote(this.scorecard.groupId,this.scorecard.id,e,r,t,a,this.scorecard.hierarchyPaths).toPromise()];case 2:return l=S.sent(),this.assertScorecardLoaded(n)?(this.scorecard=(0,F.Uy)(this.scorecard,function(g){var A=u.q.getGoal(g.goals,e);d.fF.assertValue(A,"Goal not found");var b=_.find(A.goalValues,function(ee){return new Date(ee.timestamp).getTime()===new Date(t).getTime()});if(d.fF.assertValue(b,"Goal value not found"),!_.isEmpty(b)){var re=b.notes.findIndex(function(ee){return ee.id===r});d.fF.assertValue(b.notes,"Goal note not found"),b.notes[re]=l}}),this.commit(),[3,4]):[2];case 3:throw h=S.sent(),this.goalsErrorService.showUserError(h,"EditGoalNoteError"),h;case 4:return[2]}})})},G.prototype.insertNote=function(e,t,r){return(0,s.mG)(this,void 0,void 0,function(){var a,n,l;return(0,s.Jh)(this,function(h){switch(h.label){case 0:d.fF.assertValue(this.scorecard,"No scorecard loaded"),h.label=1;case 1:return h.trys.push([1,3,,4]),a=this.scorecard,[4,this.goalsHttpService.insertNote(this.scorecard.groupId,this.scorecard.id,e,t,r,this.scorecard.hierarchyPaths).toPromise()];case 2:return n=h.sent(),this.assertScorecardLoaded(a)?(this.scorecard=(0,F.Uy)(this.scorecard,function(S){var g=u.q.getGoal(S.goals,e);d.fF.assertValue(g,"Goal not found");var A=_.find(g.goalValues,function(b){return new Date(b.timestamp).getTime()===new Date(t).getTime()});d.fF.assertValue(A,"Goal value not found"),g.notesCount=_.isFinite(g.notesCount)?g.notesCount+1:1,A.notes=(0,s.ev)((0,s.ev)([],A.notes||[],!0),[n],!1)}),this.commit(),[3,4]):[2];case 3:throw l=h.sent(),this.goalsErrorService.showUserError(l,"InsertGoalNoteError"),l;case 4:return[2]}})})},G.prototype.getGoal=function(e){return d.fF.assertValue(this.scorecard,"No scorecard loaded"),this._scorecard$.pipe((0,O.U)(function(t){return u.q.getGoal(t.goals,e)}),(0,J.x)())},G.prototype.getGoals=function(){return d.fF.assertValue(this.scorecard,"No scorecard loaded"),this._scorecard$.pipe((0,O.U)(function(e){return e.goals}))},G.prototype.getActiveGoal=function(){var e=this;return this._activeGoalId$.pipe((0,ne.w)(function(t){return t?e.getGoal(t):(0,E.of)(void 0)}))},G.prototype.getActiveGoalId=function(){return this._activeGoalId$},G.prototype.deleteNote=function(e){var t=this;return this.promptUserConfirmation({title:this.localizationService.get("ScorecardDialog_Delete_Note_Title"),message:this.localizationService.get("ScorecardDialog_Action_Cant_be_Undone"),panelClass:["updateDeleteNoteConfirmationDialogPanel"],onConfirmation:function(){return(0,s.mG)(t,void 0,void 0,function(){return(0,s.Jh)(this,function(a){switch(a.label){case 0:return[4,this.deleteNoteRequest(e)];case 1:return a.sent(),[2,!0]}})})}})},G.prototype.deleteNoteRequest=function(e){return(0,s.mG)(this,void 0,void 0,function(){var t,r;return(0,s.Jh)(this,function(a){switch(a.label){case 0:d.fF.assertValue(this.scorecard,"No scorecard loaded"),t=this.scorecard,a.label=1;case 1:return a.trys.push([1,3,,4]),[4,this.goalsHttpService.deleteNote(this.scorecard.groupId,this.scorecard.id,e.goalId,e.id,e.valueTimestamp,this.scorecard.hierarchyPaths).toPromise()];case 2:return a.sent(),[3,4];case 3:if(r=a.sent(),404!==r?.status)throw this.goalsErrorService.showUserError(r,"DeleteGoalNoteError"),r;return[3,4];case 4:return this.assertScorecardLoaded(t)?(this.scorecard=(0,F.Uy)(this.scorecard,function(n){var l=u.q.getGoal(n.goals,e.goalId);if(d.fF.assertValue(l,"Goal not found"),!_.isEmpty(l.goalValues)){var h=_.find(l.goalValues,function(S){return new Date(S.timestamp).getTime()===new Date(e.valueTimestamp).getTime()});h.notes=_.filter(h.notes,function(S){return S.id!==e.id})}l.notesCount=null==l.notesCount?0:l.notesCount-1}),this.commit(),[2]):[2]}})})},G.prototype.deleteGoal=function(e){return(0,s.mG)(this,void 0,void 0,function(){var t,r,a,n,l=this;return(0,s.Jh)(this,function(h){switch(h.label){case 0:return this.assertNoActivehierarchy()?[4,this.getGoal(e).pipe((0,k.q)(1)).toPromise()]:[2];case 1:return t=h.sent(),r=!_.isEmpty(t.subGoals),a=this.localizationService.get(t.isLinked?r?"ScorecardDialog_Delete_Metric_Title_Linked":"ScorecardDialog_Delete_Metric_Title_Linked_Submetrics":r?"ScorecardDialog_Delete_Metric_Title":"ScorecardDialog_Delete_Metric_Title_Submetrics"),n=t.isLinked?this.localizationService.get("ScorecardDialog_Delete_Metric_Message_Linked")+(r?this.localizationService.get("ScorecardDialog_Delete_Metric_Message_Linked_Submetrics"):""):this.localizationService.get("ScorecardDialog_Delete_Metric_Message_First_Line"),[2,this.promptUserConfirmation({title:a,message:n,panelClass:["updateConfirmationDialogPanel"],onConfirmation:function(){return(0,s.mG)(l,void 0,void 0,function(){return(0,s.Jh)(this,function(g){switch(g.label){case 0:return[4,this.pollingService.refreshRollupsAfterGoalDelete(t)];case 1:return g.sent(),[4,this.deleteGoalRequest(e)];case 2:return g.sent(),[2,!0]}})})}})]}})})},G.prototype.applySortAndFilter=function(e,t){return(0,s.mG)(this,void 0,void 0,function(){var r=this;return(0,s.Jh)(this,function(a){switch(a.label){case 0:return this.scorecard?[4,this.ensureUsersLoaded()]:[2];case 1:return a.sent(),this.scorecard=(0,F.Uy)(this.scorecard,function(n){n.goals=q.p.sortAndFilter(n.goals,e,r._goalStatusesByScorecardId$.value,t)}),this.commit(),[2]}})})},G.prototype.deleteGoalRequest=function(e){return(0,s.mG)(this,void 0,void 0,function(){var t,r;return(0,s.Jh)(this,function(a){switch(a.label){case 0:if(!this.assertNoActivehierarchy())return[2];if(d.fF.assertValue(this.scorecard,"No scorecard loaded"),t=u.q.getGoal(this.scorecard.goals,e),d.fF.assertValue(t,"Goal not found"),t.isNew)return[3,4];a.label=1;case 1:return a.trys.push([1,3,,4]),this.setGoalState(e,"Deleting"),[4,this.goalsHttpService.deleteGoal(this.scorecard.groupId,this.scorecard.id,t.id).toPromise()];case 2:return a.sent(),[3,4];case 3:if(r=a.sent(),404!==r?.status)throw this.goalsErrorService.showUserError(r,"DeleteGoalError"),this.setGoalState(e,"Consumption"),r;return[3,4];case 4:return this.scorecard=(0,F.Uy)(this.scorecard,function(n){var l=u.q.getGoal(n.goals,t.parentId);l?.subGoals?l.subGoals=l.subGoals.filter(function(h){return h.id!==e}):n.goals&&(n.goals=n.goals.filter(function(h){return h.id!==e}))}),this.commit(),[2]}})})},G.prototype.deleteGoalValue=function(e){var t=this;return this.promptUserConfirmation({title:this.localizationService.get("ScorecardDialog_Delete_CheckIn_Message_title"),message:"".concat(this.localizationService.get("ScorecardDialog_Delete_CheckIn_Message_First_Line"),"\n\n            ").concat(this.localizationService.get("ScorecardDialog_Action_Cant_be_Undone")),panelClass:["updateDeleteCheckInConfirmationDialogPanel"],onConfirmation:function(){return(0,s.mG)(t,void 0,void 0,function(){var a;return(0,s.Jh)(this,function(n){switch(n.label){case 0:return[4,this.getGoal(e.goalId).pipe((0,k.q)(1)).toPromise()];case 1:return a=n.sent(),[4,this.pollingService.refreshRollupsAfterGoalValueDelete(a,e)];case 2:return n.sent(),[4,this.deleteGoalValueRequest(e)];case 3:return n.sent(),[2,!0]}})})}})},G.prototype.deleteGoalValueRequest=function(e){return(0,s.mG)(this,void 0,void 0,function(){var t,r;return(0,s.Jh)(this,function(a){switch(a.label){case 0:d.fF.assertValue(this.scorecard,"No scorecard loaded"),t=this.scorecard,a.label=1;case 1:return a.trys.push([1,3,,4]),[4,this.goalsHttpService.deleteGoalValue(this.scorecard.groupId,this.scorecard.id,e.goalId,e.timestamp,this.scorecard.hierarchyPaths).toPromise()];case 2:return a.sent(),[3,4];case 3:if(r=a.sent(),404!==r?.status)throw this.goalsErrorService.showUserError(r,"DeleteGoalValueError"),r;return[3,4];case 4:return this.assertScorecardLoaded(t)?(this.scorecard=(0,F.Uy)(this.scorecard,function(n){var l=u.q.getGoal(n.goals,e.goalId);d.fF.assertValue(l,"Goal not found"),l.goalValues=_.filter(l.goalValues,function(h){return h.timestamp!==e.timestamp})}),[4,this.refreshGoal(e.goalId)]):[2];case 5:return a.sent(),this.commit(),[2]}})})},G.prototype.updateGoalQueryConnection=function(e,t,r){return(0,s.mG)(this,void 0,void 0,function(){var a,l,h,S=this;return(0,s.Jh)(this,function(g){switch(g.label){case 0:if(d.fF.assertValue(this.scorecard,"No scorecard loaded"),a=u.q.getGoal(this.scorecard.goals,e),d.fF.assertValue(a,"goal"),u.q.compareGoalQueryConnections(1===t?a.valueConnection:a.targetConnection,r))return[2];if(!this.assertNoActivehierarchy())return[2];g.label=1;case 1:return g.trys.push([1,4,,5]),[4,this.pollingService.startPollingAsync(a,t,{refreshGoal:!0,refreshGoalValues:!0,refreshRollups:!0})];case 2:return g.sent(),[4,this.goalsHttpService.updateGoalQueryConnection(this.scorecard.groupId,this.scorecard.id,e,t,(0,s.pi)((0,s.pi)({},r),{userId:this.userInfo.uoid})).toPromise()];case 3:return l=g.sent(),this.scorecard=(0,F.Uy)(this.scorecard,function(A){a=u.q.getGoal(A.goals,e),S.assignGoal(a,l)}),this.commit(),[3,5];case 4:throw h=g.sent(),this.goalsErrorService.showUserError(h,"UpdateGoalQueryConnectionError"),h;case 5:return[2]}})})},G.prototype.deleteGoalQueryConnection=function(e,t){return(0,s.mG)(this,void 0,void 0,function(){var r=this;return(0,s.Jh)(this,function(a){return this.assertNoActivehierarchy()?[2,this.promptUserConfirmation({title:this.localizationService.get("ScorecardDialog_Delete_Metric_Query_Connection_Title"),message:"".concat(this.localizationService.format("ScorecardDialog_Delete_Metric_Query_Connection_Message_Line_1",[this.localizationService.get(1===t?"CurrentValue":"Target")]),"\n\n            ").concat(this.localizationService.get("ScorecardDialog_Action_Cant_be_Undone")),onConfirmation:function(){return(0,s.mG)(r,void 0,void 0,function(){var l,h,S=this;return(0,s.Jh)(this,function(g){switch(g.label){case 0:d.fF.assertValue(this.scorecard,"No scorecard loaded"),g.label=1;case 1:return g.trys.push([1,5,,6]),[4,this.goalsHttpService.deleteGoalQueryConnection(this.scorecard.groupId,this.scorecard.id,e,t).toPromise()];case 2:return l=g.sent(),this.scorecard=(0,F.Uy)(this.scorecard,function(A){var b=u.q.getGoal(A.goals,e);if(!b)throw"Goal not found";b.valueConnection=l.valueConnection,b.targetConnection=l.targetConnection,S.assignGoal(b,l)}),[4,this.refreshGoal(e)];case 3:return g.sent(),[4,this.expandGoalValues(e)];case 4:return g.sent(),this.commit(),[3,6];case 5:throw h=g.sent(),this.goalsErrorService.showUserError(h,"DeleteGoalQueryConnectionError"),h;case 6:return[2,!0]}})})}})]:[2]})})},G.prototype.takeOverGoalQueryConnection=function(e,t){return(0,s.mG)(this,void 0,void 0,function(){var r=this;return(0,s.Jh)(this,function(a){return this.assertNoActivehierarchy()?[2,this.promptUserConfirmation({title:this.localizationService.get("MetricsDetailsPane_ConnectionsTab_TakeOver_Confirmation_Title"),message:this.localizationService.get("MetricsDetailsPane_ConnectionsTab_TakeOver_Confirmation"),okButtonText:this.localizationService.get("MetricsDetailsPane_ConnectionsTab_TakeOver"),onConfirmation:function(){return(0,s.mG)(r,void 0,void 0,function(){var l,h,S=this;return(0,s.Jh)(this,function(g){switch(g.label){case 0:d.fF.assertValue(this.scorecard,"No scorecard loaded"),g.label=1;case 1:return g.trys.push([1,3,,4]),[4,this.goalsHttpService.takeOverGoalQueryConnection(this.scorecard.groupId,this.scorecard.id,e,t).toPromise()];case 2:return l=g.sent(),this.scorecard=(0,F.Uy)(this.scorecard,function(A){var b=u.q.getGoal(A.goals,e);S.assignGoal(b,l)}),this.commit(),[3,4];case 3:if(h=g.sent(),400!==h?.status)throw this.goalsErrorService.showUserError(h,"TakeOverGoalQueryConnectionError"),h;return this.errorService.errorNoDefaultAdditionalErrorInfo(this.localizationService.get("MetricsDetailsPane_ConnectionsTab_TakeOver_Error"),"TakeOverGoalQueryConnectionError",{title:this.localizationService.get("MetricsDetailsPane_ConnectionsTab_TakeOver_Error_Title"),level:z.U.Information}),[3,4];case 4:return[2]}})})}})]:[2]})})},G.prototype.getRefreshHistory=function(e){var t;return(0,s.mG)(this,void 0,void 0,function(){var a;return(0,s.Jh)(this,function(n){switch(n.label){case 0:if(d.fF.assertValue(this.scorecard,"No scorecard loaded"),this.scorecard.isSample)return[2,[]];if(!u.q.getGoal(null===(t=this.scorecard)||void 0===t?void 0:t.goals,e))return d.fF.assertFail("goal"),[2];n.label=1;case 1:return n.trys.push([1,3,,4]),[4,this.goalsHttpService.getRefreshHistory(this.scorecard.groupId,this.scorecard.id,e).toPromise()];case 2:return[2,n.sent()];case 3:throw a=n.sent(),this.goalsErrorService.showUserError(a,"GetRefreshHistoryError"),a;case 4:return[2]}})})},G.prototype.refreshGoalValue=function(e,t){var r;return(0,s.mG)(this,void 0,void 0,function(){var a,n;return(0,s.Jh)(this,function(l){switch(l.label){case 0:if(d.fF.assertValue(this.scorecard,"No scorecard loaded"),!(a=u.q.getGoal(null===(r=this.scorecard)||void 0===r?void 0:r.goals,e)))return d.fF.assertFail("goal"),[2];if(1===t&&!a.valueConnection||2===t&&!a.targetConnection)return[2];l.label=1;case 1:return l.trys.push([1,4,,5]),[4,this.pollingService.startPollingAsync(a,t,{refreshGoal:!0,refreshGoalValues:!0,refreshRollups:!0})];case 2:return l.sent(),[4,this.goalsHttpService.refreshGoalValue(this.scorecard.groupId,this.scorecard.id,e,t).toPromise()];case 3:return l.sent(),this.showRefreshConfirmation(),[3,5];case 4:if(n=l.sent(),429===n?.status)return this.goalsErrorService.showThrottlingError(),this.setGoalRefreshState(e,t,!1),[2];throw this.goalsErrorService.showUserError(n,"RefreshGoalValue"),n;case 5:return[2]}})})},G.prototype.upsertGoalValueRollup=function(e,t,r){return(0,s.mG)(this,void 0,void 0,function(){var a,n,l,h,g,A=this;return(0,s.Jh)(this,function(b){switch(b.label){case 0:if(!this.assertNoActivehierarchy())return[2];d.fF.assertValue(this.scorecard,"No scorecard loaded"),a=u.q.getGoal(this.scorecard.goals,e),d.fF.assertValue(a,"goal"),b.label=1;case 1:return b.trys.push([1,10,,11]),l=void 0,h=P.E.getCurrentLocalDay(),_.isEmpty(a.subGoals)?[3,3]:[4,this.pollingService.startPollingAsync(a,t,{refreshGoal:!0,refreshGoalValues:!0,refreshRollups:!0})];case 2:b.sent(),b.label=3;case 3:switch(l=f.r.hasHistoricalGoalValue(a.goalValues,t)?{rollupType:r,startDate:h.toISOString()}:{rollupType:r},t){case 1:return[3,4];case 2:return[3,6]}return[3,8];case 4:return[4,this.goalsHttpService.upsertGoalCurrentValueRollup(this.scorecard.groupId,this.scorecard.id,e,l).toPromise()];case 5:return n=b.sent(),[3,9];case 6:return[4,this.goalsHttpService.upsertGoalTargetValueRollup(this.scorecard.groupId,this.scorecard.id,e,l).toPromise()];case 7:return n=b.sent(),[3,9];case 8:d.fF.assertNever(t),b.label=9;case 9:return this.scorecard=(0,F.Uy)(this.scorecard,function(re){a=u.q.getGoal(re.goals,e),A.assignGoal(a,n)}),this.commit(),[3,11];case 10:throw g=b.sent(),this.goalsErrorService.showUserError(g,"upsertGoalValueRollupError"),g;case 11:return[2]}})})},G.prototype.deleteGoalValueRollup=function(e,t){return(0,s.mG)(this,void 0,void 0,function(){var r,a,l,h=this;return(0,s.Jh)(this,function(S){switch(S.label){case 0:if(!this.assertNoActivehierarchy())return[2];d.fF.assertValue(this.scorecard,"No scorecard loaded"),r=u.q.getGoal(this.scorecard.goals,e),d.fF.assertValue(r,"goal"),S.label=1;case 1:switch(S.trys.push([1,8,,9]),t){case 1:return[3,2];case 2:return[3,4]}return[3,6];case 2:return[4,this.goalsHttpService.deleteGoalCurrentValueRollup(this.scorecard.groupId,this.scorecard.id,e).toPromise()];case 3:return a=S.sent(),[3,7];case 4:return[4,this.goalsHttpService.deleteGoalTargetValueRollup(this.scorecard.groupId,this.scorecard.id,e).toPromise()];case 5:return a=S.sent(),[3,7];case 6:d.fF.assertNever(t),S.label=7;case 7:return this.scorecard=(0,F.Uy)(this.scorecard,function(g){(r=u.q.getGoal(g.goals,e)).valueRollup=a.valueRollup,r.targetRollup=a.targetRollup,h.assignGoal(r,a)}),this.commit(),[3,9];case 8:throw l=S.sent(),this.goalsErrorService.showUserError(l,"deleteGoalValueRollupError"),l;case 9:return[2]}})})},G.prototype.getStatusRules=function(e){var t;return(0,s.mG)(this,void 0,void 0,function(){var r,a;return(0,s.Jh)(this,function(n){switch(n.label){case 0:if(d.fF.assertValue(this.scorecard,"No scorecard loaded"),this.scorecard.isSample)return[2,null];if(!(r=u.q.getGoal(null===(t=this.scorecard)||void 0===t?void 0:t.goals,e)))return d.fF.assertFail("goal"),[2];if(!r.hasStatusRules)return[2,null];n.label=1;case 1:return n.trys.push([1,3,,4]),[4,this.goalsHttpService.getGoalStatusRules(this.scorecard.groupId,this.scorecard.id,e).toPromise()];case 2:return[2,n.sent()];case 3:throw a=n.sent(),this.goalsErrorService.showUserError(a,"GetStatusRulesError"),a;case 4:return[2]}})})},G.prototype.saveStatusRules=function(e,t){var r,a,n,l;return(0,s.mG)(this,void 0,void 0,function(){var h,S,g,A;return(0,s.Jh)(this,function(b){switch(b.label){case 0:return this.assertNoActivehierarchy()?(d.fF.assertValue(this.scorecard,"No scorecard loaded"),(h=u.q.getGoal(null===(r=this.scorecard)||void 0===r?void 0:r.goals,e))?!t||_.isEmpty(t.rules)?h.hasStatusRules?[4,this.goalsHttpService.deleteGoalStatusRules(this.scorecard.groupId,this.scorecard.id,e).toPromise()]:[3,4]:[3,5]:(d.fF.assertFail("goal"),[2])):[2,t];case 1:return b.sent(),this.scorecard=(0,F.Uy)(this.scorecard,function(re){(h=u.q.getGoal(re.goals,e)).hasStatusRules=!1}),this.commit(),[4,this.refreshGoal(e)];case 2:return b.sent(),[4,this.expandGoalValues(e,!0)];case 3:b.sent(),b.label=4;case 4:return[2];case 5:return b.trys.push([5,9,,10]),S=u.q.getGoalStatusRulesUpdateRequest(t),[4,this.goalsHttpService.upsertGoalStatusRules(this.scorecard.groupId,this.scorecard.id,e,S).toPromise()];case 6:return g=b.sent(),this.scorecard=(0,F.Uy)(this.scorecard,function(re){(h=u.q.getGoal(re.goals,e)).hasStatusRules=!0}),this.commit(),[4,this.refreshGoal(e)];case 7:return b.sent(),[4,this.expandGoalValues(e,!0)];case 8:return b.sent(),[2,g];case 9:throw A=b.sent(),400===A?.status?this.errorService.errorNoDefaultAdditionalErrorInfo(this.localizationService.get("MetricsDetailsPane_StatusRulesTab_SaveRulesError_Description"),"GetStatusRulesError",{title:this.localizationService.get("MetricsDetailsPane_StatusRulesTab_SaveRulesError"),level:z.U.Information,isDismissable:!0,showAdditionalErrorInfo:!0,errorDetails:null===(l=null===(n=null===(a=A?.error)||void 0===a?void 0:a.details)||void 0===n?void 0:n[0])||void 0===l?void 0:l.message}):this.goalsErrorService.showUserError(A,"GetStatusRulesError"),A;case 10:return[2]}})})},G.prototype.loadPrefetchedScorecard=function(e){return this.setScorecardWithGoals(e),this._scorecard$.asObservable()},G.prototype.addGoal=function(){var e=this;if(this.assertNoActivehierarchy()){d.fF.assertValue(this.scorecard,"No scorecard loaded"),d.fF.assert(function(){return e.userHasWritePermissions()},"has write permissions");var t=u.q.getCurrentUser(),r=u.q.createNewGoal(t,this.scorecard.id);return this.scorecard=(0,F.Uy)(this.scorecard,function(a){if(a.goals?a.goals.push(r):a.goals=[r],-1!==a.goals.findIndex(function(h){return!_.isNil(h.rank)})){var l=0;a.goals.forEach(function(h){h.rank=l,l++})}}),this.commit(),r.id}},G.prototype.addSubGoal=function(e,t){var r=this;void 0===t&&(t=!0),this.assertNoActivehierarchy()&&(d.fF.assertValue(this.scorecard,"No scorecard loaded"),this.scorecard=(0,F.Uy)(this.scorecard,function(a){var n=u.q.getGoal(a.goals,e);d.fF.assertValue(n,"Parent goal not found");var l=u.q.getCurrentUser(),h=u.q.createNewGoal(l,r.scorecard.id,n.id);if(n.subGoals?n.subGoals.push(h):n.subGoals=[h],t&&(a.activeGoalId=void 0,a.selectedGoalIds={}),!_.isNil(n.rank)||-1!==n.subGoals.findIndex(function(A){return!_.isNil(A.rank)})){var g=0;n.subGoals.forEach(function(A){A.rank=g,g++})}}),this.commit())},G.prototype.updateScorecard=function(e){return(0,s.mG)(this,void 0,void 0,function(){var t,r,a,n=this;return(0,s.Jh)(this,function(l){switch(l.label){case 0:return l.trys.push([0,4,,5]),t=void 0!==e.localTimeZoneId&&e.localTimeZoneId!==this.scorecard.localTimeZoneId,[4,this.goalsHttpService.updateScorecard(this.scorecard.groupId,this.scorecard.id,e).toPromise()];case 1:return r=l.sent(),e.name&&this.store.select(v.iF).pipe((0,k.q)(1)).subscribe(function(h){n.tabFacade.updateTab(h===n.scorecard.groupId?{id:"me##"+n.scorecard.id,title:e.name}:{id:n.scorecard.groupId+"##"+n.scorecard.id,title:e.name})}),this.scorecard=(0,F.Uy)(this.scorecard,function(h){for(var g=0,A=_.keys(e);g<A.length;g++){var b=A[g];h[b]=r[b]}}),this.commit(),t?[4,this.loadScorecard(this.scorecard.groupId,this.scorecard.id,!1,this.scorecard.hierarchyPaths)]:[3,3];case 2:l.sent(),l.label=3;case 3:return[3,5];case 4:throw a=l.sent(),this.goalsErrorService.showUserError(a,"UpdateScorecardError"),a;case 5:return[2]}})})},G.prototype.setGoalState=function(e,t){d.fF.assertValue(this.scorecard,"No scorecard loaded"),this.scorecard=(0,F.Uy)(this.scorecard,function(r){var a=u.q.getGoal(r.goals,e);d.fF.assertValue(a,"Goal not found"),a.state=t,("Editing"===a.state||"Deleting"===a.state)&&(r.selectedGoalIds[a.id]||r.activeGoalId===a.id)&&(r.activeGoalId=void 0,"Deleting"===a.state&&delete r.selectedGoalIds[a.id])}),this.commit()},G.prototype.cancelEditing=function(e){d.fF.assertValue(this.scorecard,"No scorecard loaded");var t=u.q.getGoal(this.scorecard.goals,e);d.fF.assertValue(t,"Goal not found"),t.isNew?this.deleteGoalRequest(e):this.setGoalState(e,"Consumption")},G.prototype.setViewType=function(e,t){var r=this;e!==this.viewType&&(u.q.isEditing(this.scorecard)&&!t?this.promptUserConfirmation({title:this.localizationService.get("MetricsUnsavedChangesTitle"),message:this.localizationService.get("MetricsUnsavedChangesDescription_SwitchView"),okButtonText:this.localizationService.get("ModalDialogButtonText_Continue"),panelClass:["updateConfirmationDialogPanel"],onConfirmation:function(){return(0,s.mG)(r,void 0,void 0,function(){var l=this;return(0,s.Jh)(this,function(h){return u.q.filterGoals(this.scorecard.goals,function(S){return!!S.isNew||"Editing"===S.state}).forEach(function(S){return l.cancelEditing(S.id)}),this.setViewType(e,!0),[2]})})}}):(this.telemetryService.logEvent(C.HE,{viewType:e}),"Heatmap"===e&&this.setActiveHierarchy(void 0),this._viewType$.next(e)))},Object.defineProperty(G.prototype,"viewType",{get:function(){return this._viewType$.value},enumerable:!1,configurable:!0}),Object.defineProperty(G.prototype,"viewType$",{get:function(){return this._viewType$},enumerable:!1,configurable:!0}),Object.defineProperty(G.prototype,"scorecardSelectionMode",{get:function(){return this._scorecardSelectionMode$.value},enumerable:!1,configurable:!0}),Object.defineProperty(G.prototype,"scorecardSelectionMode$",{get:function(){return this._scorecardSelectionMode$},enumerable:!1,configurable:!0}),G.prototype.setEditMode=function(e){this.isEditMode$.next(e),!e&&this.scorecard&&_.some(this.scorecard.goals)&&(this.scorecard=(0,F.Uy)(this.scorecard,function(t){(function a(n,l){for(var h,S=function(ee){ee.isNew&&(n?n.subGoals=n.subGoals.filter(function(se){return se.id!==ee.id}):t.goals=t.goals.filter(function(se){return se.id!==ee.id})),ee.state="Consumption",(null===(h=ee.subGoals)||void 0===h?void 0:h.length)>0&&a(ee,ee.subGoals)},g=0,A=l;g<A.length;g++)S(A[g])})(null,t.goals),t.activeGoalId=void 0,t.selectedGoalIds={}}),this.commit())},G.prototype.isEditMode=function(){return this.isEditMode$.asObservable()},G.prototype.isLoading=function(){return this.loading$.pipe((0,O.U)(function(e){return e>0}))},G.prototype.getColumnSettings=function(){return this._scorecard$.pipe((0,O.U)(function(e){return e.columnSettings}))},G.prototype.setGoalRefreshState=function(e,t,r){this.scorecard=(0,F.Uy)(this.scorecard,function(a){var n=u.q.getGoal(a.goals,e);switch(t){case 1:n.currentRefreshInProgress=r;break;case 2:n.targetRefreshInProgress=r;break;default:d.fF.assertNever(t)}}),this.commit()},G.prototype.fetchUserDetails=function(e){return(0,s.mG)(this,void 0,void 0,function(){var t;return(0,s.Jh)(this,function(r){return t=_.chain(e).map(function(a){return _.concat(_.map(a.additionalOwners,function(n){var l;return null!==(l=n?.userPrincipalName)&&void 0!==l?l:n?.aadAppId}),a.owner)}).flattenDeep().filter(function(a){return!!a}).uniq().value(),[2,this.userDetailsService.getUserDetails(t).toPromise()]})})},G.prototype.populateUserDisplayNames=function(e,t){if(!_.isEmpty(e)&&!_.isEmpty(t)){for(var r={},a=0,n=e;a<n.length;a++){var l=n[a];r[l.userPrincipalName]=l,r[l.aadAppId]=l}for(var h=0,S=t;h<S.length;h++){var g=S[h],A=_.concat([g.owner],_.map(g.additionalOwners,function(b){var re;return null!==(re=b?.userPrincipalName)&&void 0!==re?re:b?.aadAppId}));g.ownerDisplayNames=_.map(A,function(b){return r[b]?r[b].displayName:b})}}},G.prototype.toggleSelectedGoal=function(e,t,r){var a=this;return void 0===t&&(t=!0),void 0===r&&(r=!1),d.fF.assertValue(this.scorecard,"No scorecard loaded"),this.scorecard=(0,F.Uy)(this.scorecard,function(n){var l,h=u.q.getGoal(n.goals,e);d.fF.assertValue(h,"Goal not found"),!h.isNew&&(n.activeGoalId=void 0,a.numberOfSelectedGoals()>1||r?(r||(t&&(n.activeGoalId=e),n.selectedGoalIds={}),n.selectedGoalIds[e]||"Deleting"===h.state?delete n.selectedGoalIds[e]:n.selectedGoalIds[e]=!0):n.selectedGoalIds[e]||"Deleting"===h.state?n.selectedGoalIds={}:(t&&(n.activeGoalId=e),n.selectedGoalIds=((l={})[e]=!0,l)))}),this.commit(),this.scorecard.selectedGoalIds[e]},G.prototype.setActiveGoal=function(e){d.fF.assertValue(this.scorecard,"No scorecard loaded"),this.scorecard=(0,F.Uy)(this.scorecard,function(t){t.activeGoalId=e}),this.commit()},G.prototype.selectGoal=function(e,t){void 0===t&&(t=!0),d.fF.assertValue(this.scorecard,"No scorecard loaded");var r=u.q.getGoal(this.scorecard.goals,e);d.fF.assertValue(r,"Goal not found"),!r.isNew&&!this.scorecard.selectedGoalIds[e]&&"Deleting"!==r.state&&(this.scorecard=(0,F.Uy)(this.scorecard,function(a){var n;t&&(a.activeGoalId=e),a.selectedGoalIds=((n={})[e]=!0,n)}),this.commit())},G.prototype.multiSelectGoal=function(e){d.fF.assertValue(this.scorecard,"No scorecard loaded");var t=u.q.getGoal(this.scorecard.goals,e);d.fF.assertValue(t,"Goal not found"),!t.isNew&&this.scorecard.selectedGoalIds[e]&&"Deleting"!==t.state&&(this.scorecard=(0,F.Uy)(this.scorecard,function(r){r.selectedGoalIds[e]=!0}),this.commit())},G.prototype.toggleSelectAllGoals=function(){var e=this;d.fF.assertValue(this.scorecard,"No scorecard loaded"),this.scorecard=(0,F.Uy)(this.scorecard,function(t){t.selectedGoalIds={};var r=u.q.filterGoals(t.goals,function(h){return!h.isNew&&(!e.scorecardHost||e.scorecardHost.canSelectGoal(h).enabled)});if(r.length!==e.numberOfSelectedGoals())for(var a=0,n=r;a<n.length;a++)t.selectedGoalIds[n[a].id]=!0}),this.commit()},G.prototype.unselectAllGoals=function(){d.fF.assertValue(this.scorecard,"No scorecard loaded"),this.scorecard=(0,F.Uy)(this.scorecard,function(e){e.activeGoalId=void 0,e.selectedGoalIds={}}),this.commit()},G.prototype.getSelectedGoalIdsObservable=function(){return this._selectedGoalIds$},G.prototype.getSelectedGoalsObservable=function(){var e=this;return this._selectedGoalIds$.pipe((0,O.U)(function(t){return u.q.filterGoals(e.scorecard.goals,function(a){return t[a.id]&&!a.isNew})}))},G.prototype.getFirstSelectedGoalId=function(){if(this.numberOfSelectedGoals()>0)return Object.keys(this.scorecard.selectedGoalIds)[0]},G.prototype.numberOfSelectedGoals=function(){return _.isNil(this.scorecard.selectedGoalIds)?0:Object.keys(this.scorecard.selectedGoalIds).length},G.prototype.isCurrentlyInEditMode=function(){return this.isEditMode$.value},G.prototype.getCurrentScorecard=function(){return this.scorecard},G.prototype.getScorecard=function(){return this._scorecard$.asObservable()},G.prototype.flatten=function(){return u.q.flattenGoals(this.scorecard.goals)},G.prototype.getBoard=function(){return this._scorecard$.pipe((0,O.U)(function(e){return e.board}))},G.prototype.addGroupToBoard=function(e,t){var r={id:e,name:t,goals:[]};this.scorecard=(0,F.Uy)(this.scorecard,function(a){_.isUndefined(a.board)&&(a.board={id:"",groups:[]}),a.board.id="boardVisual",a.board.groups.push(r)}),this.commit()},G.prototype.deleteGroupFromBoard=function(e){this.scorecard=(0,F.Uy)(this.scorecard,function(t){t.board.groups=t.board.groups.filter(function(r){return r.id!==e})}),this.commit()},G.prototype.isEditing=function(){return this._scorecard$.pipe((0,O.U)(function(e){return u.q.isEditing(e)}))},G.prototype.ensureRolesLoaded=function(){return(0,s.mG)(this,void 0,void 0,function(){var e,t;return(0,s.Jh)(this,function(r){switch(r.label){case 0:if(d.fF.assertValue(this.scorecard,"No scorecard loaded"),!_.isEmpty(this.scorecard.roles))return[2];r.label=1;case 1:return r.trys.push([1,6,,7]),[4,this.goalsHttpService.getRoles(this.scorecard.groupId,this.scorecard.id).toPromise()];case 2:return e=r.sent(),_.isEmpty(e)?[4,this.initStartingRoles()]:[3,4];case 3:return r.sent(),[3,5];case 4:this.scorecard=(0,F.Uy)(this.scorecard,function(a){a.roles=e}),this.commit(),r.label=5;case 5:return[3,7];case 6:throw t=r.sent(),this.goalsErrorService.showUserError(t,"LoadRoles"),t;case 7:return[2]}})})},G.prototype.initStartingRoles=function(){return(0,s.mG)(this,void 0,void 0,function(){var e,t,r,a=this;return(0,s.Jh)(this,function(n){switch(n.label){case 0:d.fF.assertValue(this.scorecard,"No scorecard loaded"),n.label=1;case 1:return n.trys.push([1,3,,4]),e=[{name:this.localizationService.get("EditScorecardSettings_Role_Card_Default_Role_View_All"),isDefaultRole:!0,permissions:[{goalId:void 0,permissions:1,applyToChildGoals:!0}]},{name:this.localizationService.get("EditScorecardSettings_Role_Card_Default_Role_View_And_Update_All"),isDefaultRole:!1,permissions:[{goalId:void 0,permissions:27,applyToChildGoals:!0}]}],[4,Promise.all(e.map(function(l){return a.goalsHttpService.createRole(a.scorecard.groupId,a.scorecard.id,l).toPromise()}))];case 2:return t=n.sent(),this.scorecard=(0,F.Uy)(this.scorecard,function(l){var h;_.isEmpty(l.roles)?l.roles=t:(h=l.roles).push.apply(h,t)}),this.commit(),[2,t];case 3:throw r=n.sent(),this.goalsErrorService.showUserError(r,"InitStartingRolesError"),r;case 4:return[2]}})})},G.prototype.deleteRole=function(e){return(0,s.mG)(this,void 0,void 0,function(){var t=this;return(0,s.Jh)(this,function(r){switch(r.label){case 0:return[4,this.ensureRolesLoaded()];case 1:return r.sent(),[2,this.promptUserConfirmation({title:this.localizationService.get("ScorecardDialog_Delete_Role_Title"),message:"".concat(this.localizationService.get("ScorecardDialog_Delete_Role_Message_First_Line"),"\n\n            ").concat(this.localizationService.get("ScorecardDialog_Action_Cant_be_Undone")),panelClass:["updateConfirmationDialogPanel"],onConfirmation:function(){return(0,s.mG)(t,void 0,void 0,function(){var n,l,h;return(0,s.Jh)(this,function(S){switch(S.label){case 0:d.fF.assertValue(this.scorecard,"No scorecard loaded"),n=null===(h=this.scorecard.roles)||void 0===h?void 0:h.find(function(g){return g.id===e}),d.fF.assertValue(n,"Role not found"),S.label=1;case 1:return S.trys.push([1,3,,4]),[4,this.goalsHttpService.deleteRole(this.scorecard.groupId,this.scorecard.id,n.id).toPromise()];case 2:return S.sent(),[3,4];case 3:throw l=S.sent(),this.goalsErrorService.showUserError(l,"DeleteRoleError"),l;case 4:return this.scorecard=(0,F.Uy)(this.scorecard,function(g){g.roles=g.roles.filter(function(A){return A.id!==e})}),this.commit(),[2,!0]}})})}})]}})})},G.prototype.setAsDefaultRole=function(e){var t,r,a;return(0,s.mG)(this,void 0,void 0,function(){var n,l,h,S=this;return(0,s.Jh)(this,function(g){switch(g.label){case 0:return[4,this.ensureRolesLoaded()];case 1:return g.sent(),d.fF.assertValue(this.scorecard,"No scorecard loaded"),n=null===(t=this.scorecard.roles)||void 0===t?void 0:t.find(function(A){return A.id===e}),d.fF.assertValue(n,"Role not found"),l=null===(a=null===(r=this.scorecard.roles)||void 0===r?void 0:r.find(function(A){return A.isDefaultRole}))||void 0===a?void 0:a.name,h=n.name,[2,this.promptUserConfirmation({title:this.localizationService.get("EditScorecardSettings_Permission_Pane_Change_Default_Role_title"),message:_.isNil(l)?this.localizationService.format("EditScorecardSettings_Permission_Pane_Set_Default_Role_Message",[h]):this.localizationService.format("EditScorecardSettings_Permission_Pane_Change_Default_Role_Message",[l,h]),okButtonText:this.localizationService.get("ModalDialogButtonText_Continue"),panelClass:["updateRoleConfirmationDialogPanel"],onConfirmation:function(){return(0,s.mG)(S,void 0,void 0,function(){var b;return(0,s.Jh)(this,function(re){switch(re.label){case 0:return re.trys.push([0,2,,3]),[4,this.goalsHttpService.updateRole(this.scorecard.groupId,this.scorecard.id,n.id,{isDefaultRole:!0}).toPromise()];case 1:return re.sent(),[3,3];case 2:throw b=re.sent(),this.goalsErrorService.showUserError(b,"UpdateRoleError"),b;case 3:return this.scorecard=(0,F.Uy)(this.scorecard,function(ee){ee.roles.forEach(function(se){se.isDefaultRole=se.id===e})}),this.commit(),[2,!0]}})})}})]}})})},G.prototype.createRole=function(e){return(0,s.mG)(this,void 0,void 0,function(){var t,r;return(0,s.Jh)(this,function(a){switch(a.label){case 0:d.fF.assertValue(this.scorecard,"No scorecard loaded"),a.label=1;case 1:return a.trys.push([1,3,,4]),[4,this.goalsHttpService.createRole(this.scorecard.groupId,this.scorecard.id,e).toPromise()];case 2:return t=a.sent(),this.scorecard=(0,F.Uy)(this.scorecard,function(n){_.isEmpty(n.roles)?n.roles=[t]:n.roles.push(t)}),this.commit(),[2,t];case 3:throw r=a.sent(),this.goalsErrorService.showUserError(r,"UpdateRoleError"),r;case 4:return[2]}})})},G.prototype.updateRole=function(e,t){var r;return(0,s.mG)(this,void 0,void 0,function(){var a,n,l;return(0,s.Jh)(this,function(h){switch(h.label){case 0:return[4,this.ensureRolesLoaded()];case 1:h.sent(),d.fF.assertValue(this.scorecard,"No scorecard loaded"),a=null===(r=this.scorecard.roles)||void 0===r?void 0:r.find(function(S){return S.id===e}),d.fF.assertValue(a,"Role not found"),h.label=2;case 2:return h.trys.push([2,4,,5]),[4,this.goalsHttpService.updateRole(this.scorecard.groupId,this.scorecard.id,e,t).toPromise()];case 3:return n=h.sent(),this.scorecard=(0,F.Uy)(this.scorecard,function(S){S.roles=S.roles.map(function(g){return g.id===e?n:g})}),this.commit(),[2,n];case 4:throw l=h.sent(),this.goalsErrorService.showUserError(l,"UpdateRoleError"),l;case 5:return[2]}})})},G.prototype.updateGoalValueConnectionSettings=function(e,t){return(0,s.mG)(this,void 0,void 0,function(){var r,a;return(0,s.Jh)(this,function(n){switch(n.label){case 0:d.fF.assertValue(this.scorecard,"No scorecard loaded"),r=u.q.getGoal(this.scorecard.goals,e),d.fF.assertValue(r,"Goal not found"),n.label=1;case 1:return n.trys.push([1,3,,4]),[4,this.goalsHttpService.updateConnectionSettings(this.scorecard.groupId,this.scorecard.id,e,t).toPromise()];case 2:return n.sent(),this.scorecard=(0,F.Uy)(this.scorecard,function(l){var h=u.q.getGoal(l.goals,e);h.valueConnection&&1===t.connectionType?h.valueConnection=(0,s.pi)((0,s.pi)({},h.valueConnection),{shouldClearGoalValues:t.shouldClearGoalValues}):h.targetConnection&&2===t.connectionType&&(h.targetConnection=(0,s.pi)((0,s.pi)({},h.targetConnection),{shouldClearGoalValues:t.shouldClearGoalValues}))}),this.commit(),[3,4];case 3:throw a=n.sent(),this.goalsErrorService.showUserError(a,"UpdateGoalValueConnectionSettingsError"),a;case 4:return[2]}})})},G.prototype.setScorecardWithGoals=function(e){var t=this;this.linkedScorecardsById=_.keyBy(e.linkedScorecards,"id"),this.scorecard=(0,F.Uy)(e,function(r){var a,n;r.columnSettings=_.isEmpty(r.columnSettings)?H.om:c._.mergeColumns(r.columnSettings,H.om),c._.adjustColumnSettings(t.featureSwitches,r.columnSettings),t.featureSwitches.featureSwitches.goalsLinkedGoals?null===(a=r.goals)||void 0===a||a.forEach(function(l){return l.isLinked=f.r.isLinked(l,r)}):r.goals=_.filter(r.goals,function(l){return l.scorecardId===r.id}),r.isSample=u.q.isSampleScorecard(e),_.some(r?.goals)&&(r.goals=q.p.sort(u.q.buildGoalTree(r.goals),H.Ij)),(null===(n=t.scorecard)||void 0===n?void 0:n.id)===e.id?(r.activeGoalId=t.scorecard.activeGoalId,r.selectedGoalIds=t.scorecard.selectedGoalIds):r.selectedGoalIds={},r.showGoalTargetsInChart=!1}),this.commit()},G.prototype.commit=function(){this._scorecard$.next(this.scorecard)},G.prototype.ensureUsersLoaded=function(){return(0,s.mG)(this,void 0,void 0,function(){var e,t=this;return(0,s.Jh)(this,function(r){switch(r.label){case 0:return d.fF.assertValue(this.scorecard,"No scorecard loaded"),this.scorecard.usersLoaded?[2]:[4,this.fetchUserDetails(u.q.flattenGoals(this.scorecard.goals))];case 1:return e=r.sent(),this.scorecard=(0,F.Uy)(this.scorecard,function(a){t.populateUserDisplayNames(e,u.q.flattenGoals(a.goals)),a.usersLoaded=!0}),this.commit(),[2]}})})},G.prototype.showRefreshConfirmation=function(){this.dialogService.showSimpleDialog(this.localizationService.get("Refresh_Scheduled"),this.localizationService.get("Refresh_Scheduled_Data_Will_Be_Updated"))},G.prototype.promptUserConfirmation=function(e){var t,r;return(0,s.mG)(this,void 0,void 0,function(){return(0,s.Jh)(this,function(l){switch(l.label){case 0:return d.fF.assertValue(e,"args"),d.fF.assertValue(e.title,"args.title"),d.fF.assertValue(e.message,"args.message"),[4,this.dialogService.showConfirmationDialog({title:e.title,message:e.message,okButtonText:null!==(t=e.okButtonText)&&void 0!==t?t:this.localizationService.get("Delete"),cancelButtonText:null!==(r=e.cancelButtonText)&&void 0!==r?r:this.localizationService.get("Cancel_ButtonText")},{autoFocus:!0,panelClass:e.panelClass}).afterClosed().toPromise()];case 1:return 1===l.sent()&&e.onConfirmation?[4,e.onConfirmation()]:[3,3];case 2:return[2,l.sent()];case 3:return[2,void 0]}})})},G.prototype.assignGoal=function(e,t){var r=e.rank;d.fF.assertValue(e,"existingGoal"),d.fF.assertValue(t,"newGoal"),Object.assign(e,t),e.cycle=t.cycle,e.cyclePeriod=t.cyclePeriod,e.rank=r,e.valuesCategoryId=t.valuesCategoryId},G.prototype.createCategoryList=function(e){return(0,s.mG)(this,void 0,void 0,function(){var t,r;return(0,s.Jh)(this,function(a){switch(a.label){case 0:d.fF.assertValue(this.scorecard,"createCategoryList No scorecard loaded"),d.fF.assert(function(){return!_.isEmpty(e)},"createCategoryList Categorical values are empty"),a.label=1;case 1:return a.trys.push([1,3,,4]),[4,this.goalsHttpService.createGoalValueCategories(this.scorecard.groupId,this.scorecard.id,u.q.getGoalValueCategoriesCreateRequest(e)).toPromise()];case 2:return t=a.sent(),this.scorecard=(0,F.Uy)(this.scorecard,function(n){_.isUndefined(n.goalValueCategories)&&(n.goalValueCategories=[]),n.goalValueCategories.push(t)}),[3,4];case 3:throw r=a.sent(),this.goalsErrorService.showUserError(r,"SaveGoalError"),r;case 4:return this.commit(),[2,t]}})})},G.prototype.updateCategoryList=function(e){return(0,s.mG)(this,void 0,void 0,function(){var t,r,a=this;return(0,s.Jh)(this,function(n){switch(n.label){case 0:d.fF.assertValue(this.scorecard,"updateCategoryList No scorecard loaded"),d.fF.assertValue(e,"updateCategoryList categoryList"),d.fF.assertValue(_.find(this.scorecard.goalValueCategories,function(l){return l.id===e.id}),"updateCategoryList No category list found to update"),n.label=1;case 1:return n.trys.push([1,3,,4]),[4,this.goalsHttpService.updateGoalValueCategories(this.scorecard.groupId,this.scorecard.id,e.id,u.q.getGoalValueCategoriesUpdateRequest(e)).toPromise()];case 2:return t=n.sent(),this.scorecard=(0,F.Uy)(this.scorecard,function(l){var h=_.findIndex(a.scorecard.goalValueCategories,function(S){return S.id===t.id});l.goalValueCategories[h]=t}),[3,4];case 3:throw r=n.sent(),this.goalsErrorService.showUserError(r,"SaveGoalError"),r;case 4:return this.commit(),[2,t]}})})},G.prototype.deleteCategoryList=function(e){return(0,s.mG)(this,void 0,void 0,function(){var t;return(0,s.Jh)(this,function(r){switch(r.label){case 0:d.fF.assertValue(this.scorecard,"deleteCategoryList No scorecard loaded"),d.fF.assertValue(_.find(this.scorecard.goalValueCategories,function(a){return a.id===e}),"deleteCategoryList No category list found to delete."),r.label=1;case 1:return r.trys.push([1,3,,4]),[4,this.goalsHttpService.deleteGoalValueCategories(this.scorecard.groupId,this.scorecard.id,e).toPromise()];case 2:return r.sent(),this.scorecard=(0,F.Uy)(this.scorecard,function(a){_.remove(a.goalValueCategories,function(n){return n.id===e})}),[3,4];case 3:throw t=r.sent(),this.goalsErrorService.showUserError(t,"SaveGoalError"),t;case 4:return this.commit(),[2]}})})},G.prototype.getGoalValueCategoryLists=function(e){var t,r;return d.fF.assertValue(this.scorecard,"No scorecard loaded"),e?null!==(t=this.getSourceScorecard(e).goalValueCategories)&&void 0!==t?t:[]:null!==(r=this.scorecard.goalValueCategories)&&void 0!==r?r:[]},G.prototype.getGoalValueCategories=function(e){var t,r;if(e.valuesCategoryId){var a=this.getGoalValueCategoryLists(e);return null!==(r=null===(t=_.find(a,function(n){return n.id===e.valuesCategoryId}))||void 0===t?void 0:t.categories)&&void 0!==r?r:[]}},Object.defineProperty(G.prototype,"goalStatusesByScorecardId$",{get:function(){return this._goalStatusesByScorecardId$},enumerable:!1,configurable:!0}),G.prototype.getGoalStatuses=function(e){var t,r,a,n;return d.fF.assertValue(this.scorecard,"No scorecard loaded"),e?null!==(r=null===(t=this.getSourceScorecard(e).goalStatuses)||void 0===t?void 0:t.statuses)&&void 0!==r?r:[]:null!==(n=null===(a=this.scorecard.goalStatuses)||void 0===a?void 0:a.statuses)&&void 0!==n?n:[]},G.prototype.userHasWritePermissions=function(){var e,t=(0,Q.l)(null===(e=this.scorecard)||void 0===e?void 0:e.permissions);return(0,ie.yE)(t,2)},G.prototype.bulkDeleteGoalsPrompt=function(){return(0,s.mG)(this,void 0,void 0,function(){var e,t,r=this;return(0,s.Jh)(this,function(a){switch(a.label){case 0:return this.assertNoActivehierarchy(!0)?[4,this.getSelectedGoalsObservable().pipe((0,k.q)(1)).toPromise()]:[2];case 1:return e=a.sent(),t=_.some(e,function(n){return n.isLinked}),[2,this.promptUserConfirmation({title:this.localizationService.format("ScorecardDialog_BulkDelete_Metric_Title",[this.numberOfSelectedGoals()]),message:this.localizationService.get(t?"ScorecardDialog_BulkDelete_Metric_Message_Linked":"ScorecardDialog_BulkDelete_Metric_Message_First_Line"),panelClass:["updateConfirmationDialogPanel"],onConfirmation:function(){return(0,s.mG)(r,void 0,void 0,function(){return(0,s.Jh)(this,function(l){switch(l.label){case 0:return[4,this.bulkDeleteGoals()];case 1:return l.sent(),[2,!0]}})})}})]}})})},G.prototype.bulkDeleteGoals=function(){return(0,s.mG)(this,void 0,void 0,function(){var e,t=this;return(0,s.Jh)(this,function(r){switch(r.label){case 0:return this.assertNoActivehierarchy(!0)?(d.fF.assertValue(this.scorecard,"No scorecard loaded"),e=u.q.filterGoals(this.scorecard.goals,function(a){return t.scorecard.selectedGoalIds[a.id]&&!a.isNew}),[4,this.bulkDeleteGoalsRequest(e)]):[2];case 1:return r.sent(),[2]}})})},G.prototype.bulkDeleteGoalsRequest=function(e){return(0,s.mG)(this,void 0,void 0,function(){var t,r,n,l;return(0,s.Jh)(this,function(h){switch(h.label){case 0:for(t=0,r=e;t<r.length;t++)this.setGoalState(r[t].id,"Deleting");h.label=1;case 1:return h.trys.push([1,4,,5]),n=_.map(e,"id"),_.isEmpty(n)?[3,3]:[4,this.goalsHttpService.bulkDeleteGoals(this.scorecard.groupId,this.scorecard.id,{goalIds:n}).toPromise()];case 2:h.sent(),h.label=3;case 3:return[3,5];case 4:if(l=h.sent(),404!==l?.status)throw this.goalsErrorService.showUserError(l,"BulkDeleteGoalError"),l;return[3,5];case 5:return this.scorecard=(0,F.Uy)(this.scorecard,function(S){for(var g=function(se){var ve=u.q.getGoal(S.goals,se.parentId);ve?.subGoals?ve.subGoals=ve.subGoals.filter(function(me){return me.id!==se.id}):S.goals&&(S.goals=S.goals.filter(function(me){return me.id!==se.id}))},A=0,b=e;A<b.length;A++)g(b[A])}),this.commit(),[2]}})})},G.prototype.bulkUpdateGoals=function(e){var t,r,a;return(0,s.mG)(this,void 0,void 0,function(){var n,l,h,S,A,b,re,ee,se,ve,me,oe,ge,he,Me,Fe,we=this;return(0,s.Jh)(this,function(Pe){switch(Pe.label){case 0:if(!this.assertNoActivehierarchy(!0))return[2];if(d.fF.assertValue(this.scorecard,"No scorecard loaded"),d.fF.assertValue(e,"No bulk request"),(null===(t=e.goalIds)||void 0===t?void 0:t.length)<=0)return[2];for(n=e.target,delete e.target,l=0,h=e.goalIds;l<h.length;l++)this.setGoalState(oe=h[l],"Saving");return S=_.map(e.owners,function(Ee){var be;return null!==(be=Ee.userPrincipalName)&&void 0!==be?be:Ee.aadAppId}),_.isEmpty(e.owners)?[3,2]:[4,this.userDetailsService.getUserDetails(S).toPromise()];case 1:return A=Pe.sent(),[3,3];case 2:A=[],Pe.label=3;case 3:for(b={},re=0,ee=A;re<ee.length;re++)b[(se=ee[re]).userPrincipalName]=se,b[se.aadAppId]=se;Pe.label=4;case 4:if(Pe.trys.push([4,10,,11]),_.isNil(n))return[3,8];ve=0,me=e.goalIds,Pe.label=5;case 5:return ve<me.length?(ge=u.q.getGoal(this.scorecard.goals,oe=me[ve]),he=null!==(a=null===(r=_.find(ge.aggregations,function(Ee){return"Target"===Ee.type}))||void 0===r?void 0:r.timestamp)&&void 0!==a?a:e.timestamp,[4,this.upsertGoalValues(oe,[{timestamp:he,target:n}])]):[3,8];case 6:Pe.sent(),Pe.label=7;case 7:return ve++,[3,5];case 8:return[4,this.goalsHttpService.bulkUpdateGoals(this.scorecard.groupId,this.scorecard.id,e).toPromise()];case 9:return Me=Pe.sent(),this.scorecard=(0,F.Uy)(this.scorecard,function(Ee){for(var be=0,Te=Me;be<Te.length;be++){var $e=Te[be],Ie=u.q.getGoal(Ee.goals,$e.id),je=Ie.additionalOwners;we.assignGoal(Ie,$e),_.isEmpty(e.owners)?Ie.additionalOwners=je:Ie.ownerDisplayNames=_.map(S,function(Le){var Ne,Ve;return null!==(Ve=null===(Ne=b[Le])||void 0===Ne?void 0:Ne.displayName)&&void 0!==Ve?Ve:Le}),Ie.state="Consumption"}}),[3,11];case 10:throw Fe=Pe.sent(),this.goalsErrorService.showUserError(Fe,"BulkUpdateGoalError"),Fe;case 11:return this.commit(),[2]}})})},G.prototype.toggleShowGoalTargetsInChart=function(e){this.scorecard=(0,F.Uy)(this.scorecard,function(t){t.showGoalTargetsInChart=e}),this.commit()},G.prototype.createLinkedGoals=function(e,t){return(0,s.mG)(this,void 0,void 0,function(){var r,a,n,l,h,S,g,A;return(0,s.Jh)(this,function(b){switch(b.label){case 0:if(_.isEmpty(e))return[2];r=new Set(u.q.mapGoals(this.scorecard.goals,function(re){return re.id})),a=new Set,(n=e.length)>1&&(l=this.dialogService.showSimpleWaitDialog(this.localizationService.format("Metrics_LinkedMetrics_Linking",n),n>100?this.localizationService.get("This_Might_Take_A_Moment"):"")),h=0,b.label=1;case 1:if(!(h<n))return[3,9];if(r.has((S=e[h]).id))return d.fF.assertFail("Selected goal to link already exists on this scorecard."),[3,8];(g=S.parentId)&&!a.has(g)&&(d.fF.assertFail("Attempting to link goal with parentId ".concat(g," without having linked parent.")),g=void 0),b.label=2;case 2:return b.trys.push([2,4,,8]),[4,this.goalsHttpService.createLinkedGoals(this.scorecard.groupId,this.scorecard.id,{goalIds:[S.id],scorecardId:S.scorecardId,parentGoalId:g??t}).toPromise()];case 3:return b.sent(),a.add(S.id),[3,8];case 4:return 429!==(A=b.sent()).status?[3,6]:[4,new Promise(function(re){return setTimeout(re,5e3)})];case 5:return b.sent(),h--,[3,7];case 6:return this.goalsErrorService.showUserError(A,"CreateLinkedGoalsError","Metrics_LinkedMetrics_Error"),[3,9];case 7:return[3,8];case 8:return h++,[3,1];case 9:return this.loadScorecard(this.scorecard.groupId,this.scorecard.id,!0,this.scorecard.hierarchyPaths),l?.close(),[2]}})})},G.prototype.getSourceScorecard=function(e){if(e.isLinked){var t=this.linkedScorecardsById[e.scorecardId];if(t)return t;d.fF.assertFail("No linked scorecard with id "+e.scorecardId)}return this.scorecard},G.prototype.openLinkedSourceScorecard=function(e){d.fF.assert(function(){return e.isLinked},"Goal is not linked");var t=this.getSourceScorecard(e);this.scorecardHost.openScorecard(t,e)},G.prototype.getOwnerDisplayNames=function(e){return(0,s.mG)(this,void 0,void 0,function(){var t,r,a;return(0,s.Jh)(this,function(n){switch(n.label){case 0:return t=_.concat([e.owner],_.map(e.additionalOwners,function(l){var h;return null!==(h=l?.userPrincipalName)&&void 0!==h?h:l?.aadAppId})),[4,this.userDetailsService.getUserDetails(t).toPromise()];case 1:return r=n.sent(),a=_.map(r,function(l){return l?.displayName}),[2,_.isEmpty(a)?t:a]}})})},G.\u0275fac=function(t){return new(t||G)(ae.\u0275\u0275inject(U.f),ae.\u0275\u0275inject(R.K),ae.\u0275\u0275inject(ue.x),ae.\u0275\u0275inject(Se.T),ae.\u0275\u0275inject(pe.o),ae.\u0275\u0275inject(_e.a),ae.\u0275\u0275inject(Re.vZ),ae.\u0275\u0275inject(Oe.X),ae.\u0275\u0275inject(Ae.y0),ae.\u0275\u0275inject(L.SN),ae.\u0275\u0275inject(He.yh),ae.\u0275\u0275inject(T.M,8),ae.\u0275\u0275inject(w.u,8))},G.\u0275prov=ae.\u0275\u0275defineInjectable({token:G,factory:G.\u0275fac}),G}()},14786:function(Ce,ce,i){i.d(ce,{AY:function(){return D},Bn:function(){return d},Fg:function(){return L},GW:function(){return W},HE:function(){return de},JP:function(){return f},Lc:function(){return w},V8:function(){return E},_9:function(){return z},dT:function(){return H},h2:function(){return U},ib:function(){return C},pN:function(){return p},tj:function(){return k},z8:function(){return o}});var s=i(41114),Q="PBI.Goal.ContextMenu.CreateAPowerAutomateFlow",V=(s.cx[Q]=(0,s.b1)(Q),"PBI.Goal.TargetsEditor.Action.Opened"),H=s.cx[V]=(0,s.b1)(V),P="PBI.Goal.TargetsEditor.Action.Canceled",f=s.cx[P]=(0,s.b1)(P),c="PBI.Goal.TargetsEditor.Action.Done",p=s.cx[c]=(0,s.b1)(c),u="PBI.Goal.ValuesEditor.Action.Opened",d=s.cx[u]=(0,s.b1)(u),M="PBI.Goal.ValuesEditor.Action.Canceled",E=s.cx[M]=(0,s.b1)(M),B="PBI.Goal.ValuesEditor.Action.Done",W=s.cx[B]=(0,s.b1)(B),N="PBI.ScorecardHeader.LabelInlineEdit",k=s.cx[N]=(0,s.b1)(N),j="PBI.ScorecardHeader.DescriptionInlineEdit",C=s.cx[j]=(0,s.b1)(j),o=function(O){return O.Manual="Manual",O.Connect="Connect",O.Rollup="Rollup",O}({}),v="PBI.WebScorecard.SaveCurrentValueSelection",U=s.cx[v]=(0,s.b1)(v),T="PBI.WebScorecard.SaveTargetValueSelection",w=s.cx[T]=(0,s.b1)(T),R="PBI.DatasetDetailsPage.GoalRollupsCoachmarkTriggered",z=s.cx[R]=(0,s.b1)(R),ie="PBI.DatasetDetailsPage.GoalRollupsDetailsPaneCoachmarkTriggered",L=s.cx[ie]=(0,s.b1)(ie),F="PBI.Scorecard.ChangeViewType",de=s.cx[F]=(0,s.b1)(F),Z="PBI.Scorecard.Hierarchies.Builder.Open",D=s.cx[Z]=(0,s.b1)(Z)}}]);