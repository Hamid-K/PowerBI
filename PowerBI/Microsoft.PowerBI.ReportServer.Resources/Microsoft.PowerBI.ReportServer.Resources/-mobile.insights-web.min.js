"use strict";(self.webpackChunkmobile=self.webpackChunkmobile||[]).push([["insights-web","insights"],{32488:function(Ze,Ee,d){d.d(Ee,{Me:function(){return k},No:function(){return le},S7:function(){return pe},d6:function(){return Fe},jo:function(){return C},nO:function(){return N},u1:function(){return w}});var N=40,C=16e3,k=10,le=15e3,Fe=10,pe=15,w="https://go.microsoft.com/fwlink/?LinkId=692069"},48895:function(Ze,Ee,d){d.r(Ee),d.d(Ee,{InsightsWebModule:function(){return nt}});var N=d(99266),C=d(81337),k=d(32488),le=d(68862),Fe=d(41114),pe=d(46544),w=d(50423),Q=d(18873),G=d(44204),j=d(76072),q=d(65181),ee=d(50911),be=function(){function n(e,i,u,c,g,x){this.navigationService=e,this.telemetryService=i,this.notificationToastService=u,this.lazyProvider=c,this.localizationService=g,this.datasetStore=x}return n.prototype.start=function(e,i,u){return(0,C.mG)(this,void 0,void 0,function(){var c,g,x;return(0,C.Jh)(this,function(z){switch(z.label){case 0:return[4,this.datasetStore.findModelByDBName(e,i)];case 1:return(c=z.sent())?(g={dataSourceDefinition:{model:c},analysisDefinition:{explore:{requestedInsights:k.nO,timeoutInMS:k.jo,options:0}}},[4,this.lazyProvider.get("@powerbi/Insights/insights-web.module#InsightsWebModule","InsightsServiceModern")]):[2];case 2:switch(x=z.sent(),x.getAnalysisStatus(g)){case 2:return[3,3];case 0:return[3,4]}return[3,6];case 3:return this.navigationService.showInsightsPanel({groupGUID:this.navigationService.currentGroupGUID,dataGUID:e,appGUID:u}),[3,6];case 4:return[4,this.getInsights(c,this.navigationService.currentGroupGUID,u,x)];case 5:return z.sent(),[3,6];case 6:return[2]}})})},n.prototype.getInsights=function(e,i,u,c){return(0,C.mG)(this,void 0,void 0,function(){var g,x,V,T,z,$,ce;return(0,C.Jh)(this,function(ne){switch(ne.label){case 0:return g=this.telemetryService.startEvent(le.$M,{insightCount:0,contentProviderId:e.contentProviderId,hashedModelId:(0,Fe.Gv)(e.dbName),isScoped:!1}),x={dataSourceDefinition:{model:e},analysisDefinition:{explore:{requestedInsights:k.nO,timeoutInMS:k.jo,options:0}}},V=this.showInsightsLoadingNotification(e),[4,c.execute(x,g.event).resultPromise];case 1:return T=ne.sent(),z=T&&T.result,$=_.size(z&&z.explore&&z.explore.insights),ce=$>0,g.event.info.insightCount=$,g.event.info.telemetryId=T.telemetryId,T&&!T.error||ce?g.resolve():g.reject(),this.notificationToastService.hide(V),this.showInsightsLoadedNotification(e,ce,i,u),[2]}})})},n.prototype.showInsightsLoadingNotification=function(e){return this.notificationToastService.notify({title:this.localizationService.get("Insights_LoadingTitle"),message:this.localizationService.format("Insights_LoadingSubtitle",[e.displayName]),notificationType:3,sticky:!0})},n.prototype.showInsightsLoadedNotification=function(e,i,u,c){var g=this,x=this.localizationService,V={displayText:x.get("Insights_FinishedLoadingButtonText"),action:function(){g.navigationService.showInsightsPanel({groupGUID:u,dataGUID:e.dbName,appGUID:c})}},T={displayText:x.get("LearnMore"),action:function(){window.open(k.u1,"_blank")}};this.notificationToastService.notify(i?{title:x.get("Insights_FinishedLoadingTitle"),message:x.format("Insights_FinishedLoadingSubtitle",[e.displayName]),notificationType:4,actionButtons:[V],sticky:!0}:{title:x.get("Insights_FinishedLoadingNoInsightsTitle"),message:x.format("Insights_FinishedLoadingNoInsightsSubtitle",[e.displayName]),notificationType:8,actionButtons:[T]})},n.\u0275fac=function(i){return new(i||n)(w.\u0275\u0275inject(Q.W),w.\u0275\u0275inject(pe.y0),w.\u0275\u0275inject(G.Q),w.\u0275\u0275inject(j.E),w.\u0275\u0275inject(q.o),w.\u0275\u0275inject(ee.s))},n.\u0275prov=w.\u0275\u0275defineInjectable({token:n,factory:n.\u0275fac}),n}(),we=d(31486),U=d(6794),A=d(62458),Ve=d(65363),je=d(38078),F=d(70604),Qe=d(73875),Ne=d(9439),Xe="insights/derive/queue",re=function(){function n(e,i){this.httpService=e,this.requestManager=new st,i.addInsightsListener(this)}return n.prototype.execute=function(e){return function(n){var e=n.AnalysisDefinition;return!(!e.SuggestCompatibleFields&&!e.SuggestQueries)}(e)?this.executeSync(e):this.executeAsync(e)},n.prototype.executeAsync=function(e){var i=this;return new Promise(function(u){var c=je.b$.generateGuid(),g=i.createDeriveInsightsQueueRequest(e,c),x=new Ve.GG;i.httpService.post(Xe,g,i.httpService.powerbiRequestOptions()).subscribe(function(T){var z=T.data.JobId;A.fF.assertValue(z,"JobId cannot be null or undefined"),x.resolve(z)},function(T){x.reject(i.processErrorResponse(T,g.Analysis.TelemetryId))});var V=new Ve.GG;i.requestManager.pushRequest(e,c,x,V),V.promise.then(function(T){return u(T)}).catch(function(T){return u(T)})})},n.prototype.executeSync=function(e){var i=this,u=je.b$.generateGuid(),c=je.b$.generateGuid(),g=this.createDeriveInsightsSyncQueueRequest(e,c,u),x=new F.B;x.resolve(u);var V=new F.B;return this.requestManager.pushRequest(e,c,x,V),this.httpService.post("insights/derive",g,this.httpService.powerbiRequestOptions()).subscribe(function(T){V.resolve(i.processSuccessResponse(T.data,c,T.responseRequestId)),i.requestManager.popRequestByJobId(u)},function(T){V.resolve(i.processErrorResponse(T,c)),i.requestManager.popRequestByJobId(u)}),V.promise},n.prototype.cancel=function(e){var i=this;this.requestManager.popRequest(e).then(function(u){if(u){var c=u.jobId;i.httpService.post("insights/derive/queue/"+c+"/cancel",c,i.httpService.powerbiRequestOptions())}})},n.prototype.createDeriveInsightsQueueRequest=function(e,i){var u=_.cloneDeep(e);return u.AnalysisDefinition.TelemetryId=i,{VirtualServerName:u.VsName,DatabaseName:u.DbName,ModelId:u.ModelId,Analysis:u.AnalysisDefinition,Version:1,Impersonation:u.Impersonation,AnchorTime:u.AnchorTime}},n.prototype.createDeriveInsightsSyncQueueRequest=function(e,i,u){var c=_.cloneDeep(e);return c.AnalysisDefinition.TelemetryId=i,{VirtualServerName:c.VsName,DatabaseName:c.DbName,ModelId:c.ModelId,Analysis:c.AnalysisDefinition,Version:1,Impersonation:c.Impersonation,AnchorTime:c.AnchorTime,JobId:u}},n.prototype.onInsightsAvailable=function(e){var i=this;this.requestManager.popRequestByJobId(e).then(function(u){u&&i.httpService.get(Xe+"/"+e+"/results",i.httpService.powerbiRequestOptions()).subscribe(function(g){u.result.resolve(i.processSuccessResponse(g.data.Results,u.telemetryId,g.responseRequestId))},function(g){u.result.resolve(i.processErrorResponse(g,u.telemetryId))})})},n.prototype.processSuccessResponse=function(e,i,u){var x,c=e.Error,g=U.Vm(e.Warnings,function(B){return U.Yo(B)});if(c){var V=c.Details?(0,C.pi)({},c.Details):{},T=U.V(c.ErrorCode),z="AnalysisErrorCode: ".concat(T,", AnalysisWarnings: [").concat(_.join(g,","),"] }");V.ErrorMessage=z,x={errorCategory:"Host",code:c.ErrorCode,codeString:T,source:3===c.ErrorSource?"User":"PowerBI",details:_.map(V,function(B,$){return{errorInfoKey:$,errorInfoValue:B}})}}return{analysisResult:c?void 0:e.AnalysisResult,hostWarnings:g,isCancelled:!(!c||7!==c.ErrorCode),telemetryId:i,error:x,responseRequestId:u}},n.prototype.processErrorResponse=function(e,i){return this.processHttpErrorResponse(e,i)},n.prototype.processHttpErrorResponse=function(e,i){var u,c="PowerBI";if(e.error&&e.error.code){var g=e.error.code;"InitialRequestValidationFailed"===g?u=1002:"RequestBlocked"===g?u=1003:"InvalidModelRequested"===g?u=1004:"UnauthorizedRequest"===g?u=1001:"UnsafeUserInfo"===g&&(u=1005);var x=e.error["pbi.error"];x&&null!=x.exceptionCulprit&&(c=1===x.exceptionCulprit?"User":"PowerBI")}if(!u){var V=e.status;u=400===V?400:401===V?401:403===V?403:503===V?503:500===V?500:1e3}var T=U.V(u),z="AnalysisErrorCode: ".concat(T,", AnalysisWarnings: []");return{telemetryId:i,isCancelled:!1,error:{errorCategory:"Host",code:u,source:c,codeString:U.V(u),details:[{errorInfoKey:"ErrorMessage",errorInfoValue:z}],data:e.error},responseRequestId:e.responseRequestId}},n.\u0275fac=function(i){return new(i||n)(w.\u0275\u0275inject(Qe.O),w.\u0275\u0275inject(Ne._))},n.\u0275prov=w.\u0275\u0275defineInjectable({token:n,factory:n.\u0275fac}),n}(),st=function(){function n(){this.jobIdPromises={},this.resultPromises={}}return n.prototype.pushRequest=function(e,i,u,c){var g=this,x=this.getRequestMapKey(e);this.jobIdPromises[x]=u,u.promise.then(function(V){g.jobIdPromises[x]&&(g.resultPromises[V]={promise:c,request:e,telemetryId:i})},function(V){c.resolve(V),delete g.jobIdPromises[x]})},n.prototype.popRequest=function(e){var i=this;return new Promise(function(u,c){var g=i.getRequestMapKey(e),x=i.jobIdPromises[g];x||u(null),delete i.jobIdPromises[g],x.promise.then(function(V){var T=i.resultPromises[V];delete i.resultPromises[V],u({jobId:V,result:T.promise,telemetryId:T.telemetryId})})})},n.prototype.popRequestByJobId=function(e){var i=this;return new Promise(function(u){var c=i.resultPromises[e];c||u(null);var g=i.getRequestMapKey(c.request);i.jobIdPromises[g]||u(null),delete i.jobIdPromises[g],delete i.resultPromises[e],u({jobId:e,result:c.promise,telemetryId:c.telemetryId})})},n.prototype.getRequestMapKey=function(e){return JSON.stringify(e)},n}(),We=d(7886),Te=d(29767),p=d(3468);function Ae(n){return A.fF.assertValue(n,"analysisDefinition"),(0,Te.rL)(n,new ot)}function at(n){return A.fF.assertValue(n,"analysisResult"),(0,Te.D$)(n,new ut)}var ot=function(){function n(){}return n.prototype.visitExplore=function(e){return{Explore:{Options:e.options,RequestedInsights:e.requestedInsights,TimeoutInMS:e.timeoutInMS}}},n.prototype.visitGetRelated=function(e){return{GetRelatedInsights:{Options:e.options,RequestedInsights:e.requestedInsights,TimeoutInMS:e.timeoutInMS,TopicQuery:p.ib.serializeQuery(e.topicQuery)}}},n.prototype.visitExplainChange=function(e){return{ExplainChange:{RequestedInsights:e.requestedInsights,TimeoutInMS:e.timeoutInMS,Measure:p.ib.serializeExpr(e.measure),Reference:p.ib.serializeFilter(e.reference),Target:p.ib.serializeFilter(e.target),ParentSpace:e.parentSpace?p.ib.serializeFilter(e.parentSpace):void 0,ContinuationToken:e.continuationToken?{Start:e.continuationToken.start,Include:e.continuationToken.include}:void 0}}},n.prototype.visitFindDistributionFactors=function(e){return{FindDistributionFactors:{RequestedInsights:e.requestedInsights,TimeoutInMS:e.timeoutInMS,Measure:p.ib.serializeExpr(e.measure),ParentSpace:e.parentSpace?p.ib.serializeFilter(e.parentSpace):void 0,Dimension:p.ib.serializeExpr(e.dimension),Candidates:e.candidates?_.map(e.candidates,function(i){return p.ib.serializeExpr(i)}):void 0,ContinuationToken:e.continuationToken?{Start:e.continuationToken.start,Include:e.continuationToken.include}:void 0}}},n.prototype.visitFindKeyDrivers=function(e){return{FindKeyDrivers:{Target:e.target?{Categorical:e.target.categorical?{TargetValue:p.ib.serializeFilter(e.target.categorical.targetValue)}:void 0,Numeric:e.target.continuous?{Expression:p.ib.serializeExpr(e.target.continuous.expression),Kind:e.target.continuous.kind}:void 0}:void 0,Filters:e.filters?p.ib.serializeFilter(e.filters):void 0,Predictors:e.predictors?_.map(e.predictors,function(i){return p.ib.serializeExpr(i)}):void 0,Details:e.details?_.map(e.details,function(i){return p.ib.serializeExpr(i)}):void 0,Options:e.options}}},n.prototype.visitDecompositionTree=function(e){return{FindDecompositions:{Value:p.ib.serializeExpr(e.target),Dimensions:e.dimensions?_.map(e.dimensions,function(i){return p.ib.serializeExpr(i)}):void 0,Filters:e.filters?p.ib.serializeFilter(e.filters):void 0,Path:e.path?p.ib.serializeFilter(e.path):void 0,Methods:e.methods,Strategy:e.strategy,ContinuationToken:e.continuationToken?{Start:e.continuationToken.start,Include:e.continuationToken.include}:void 0}}},n.prototype.visitGenerateSummaries=function(e){var i;return{GenerateSummaries:{Subjects:e.subjects?_.map(e.subjects,function(u){return{Name:u.name,Kind:u.kind,Properties:u.properties?_.map(u.properties,function(c){return{DisplayName:c.displayName,Kind:c.kind,RoleKind:c.roleKind,Expression:p.ib.serializeExpr(c.expression),Id:c.id}}):void 0,Weight:u.weight,Filters:u.filters?p.ib.serializeFilter(u.filters):void 0}}):void 0,MaxTotalTemplates:e.maxTotalTemplates,MaxTemplatesPerSubject:e.maxTemplatesPerSubject,AllowedTemplates:e.allowedTemplates?_.map(e.allowedTemplates,function(u){return{Category:u.category,SubCategory:u.subCategory}}):void 0,CultureName:null!==(i=e.cultureName)&&void 0!==i?i:"en-US",AllowTemplateReuse:!!e.allowTemplateReuse}}},n.prototype.visitExplainAnomalies=function(e){return{ExplainAnomalies:{Measure:p.ib.serializeExpr(e.measure),Filters:e.filters?p.ib.serializeFilter(e.filters):void 0,MeasureGranularity:_.map(e.measureGranularity,function(i){return p.ib.serializeExpr(i)}),GranularityScalarKey:p.ib.serializeExpr(e.granularityScalarKey),Anomalies:_.map(e.anomalies,function(i){return{Location:p.ib.serializeExpr(i.location),Value:p.ib.serializeExpr(i.value),ExpectedValue:p.ib.serializeExpr(i.expectedValue),ExplanationWindow:p.ib.serializeFilter(i.explanationWindow)}}),Predictors:_.map(e.predictors,function(i){return p.ib.serializeExpr(i)}),Sensitivity:e.sensitivity,SeasonalityPeriod:e.seasonalityPeriod}}},n.prototype.visitSuggestCompatibleFields=function(e){return{SuggestCompatibleFields:{Measures:e.measures,Dimensions:e.dimensions}}},n.prototype.visitSuggestQueries=function(e){return{SuggestQueries:{RequiredFields:_.map(e.requiredFields,function(i){return p.ib.serializeExpr(i)}),Options:e.options}}},n.prototype.visitExplainVarianceToTarget=function(e){return{ExplainVarianceToTarget:{Value:p.ib.serializeExpr(e.value),Target:{Direction:e.target.direction,Expression:e.target.expr?p.ib.serializeExpr(e.target.expr):void 0},Scope:p.ib.serializeFilter(e.scope),Filters:e.filters?p.ib.serializeFilter(e.filters):void 0,Predictors:_.map(e.predictors,function(i){return p.ib.serializeExpr(i)})}}},n}(),ut=function(){function n(){}return n.prototype.visitExplore=function(e){return{explore:{insights:Ge(e.Insights),warnings:e.Warnings}}},n.prototype.visitGetRelated=function(e){return{getRelatedInsights:{insights:Ge(e.Insights),warnings:e.Warnings}}},n.prototype.visitDistributionFactors=function(e){return{findDistributionFactors:{insights:Ge(e.Insights),warnings:e.Warnings,continuationToken:Me(e.ContinuationToken),executionStatistics:Ue(e.ExecutionStatistics)}}},n.prototype.visitChange=function(e){return{explainChange:{insights:Ge(e.Insights),warnings:e.Warnings,metadataWarnings:e.MetadataWarnings,continuationToken:Me(e.ContinuationToken),executionStatistics:Ue(e.ExecutionStatistics)}}},n.prototype.visitKeyDrivers=function(e){return{keyDrivers:{drivers:_.map(e.Drivers,function(i){return{field:p.ib.deserializeExpr(i.Field),scale:i.Scale,score:i.Score,value:i.Value?p.ib.deserializeFilter(i.Value):void 0,groupIndex:i.GroupIndex,support:i.Support}}),profiles:_.map(e.Profiles,function(i){return{filters:p.ib.deserializeFilter(i.Filters)}}),groups:e.Groups?_.map(e.Groups,function(i){return{expression:p.ib.deserializeExpr(i.Expression),groups:_.map(i.Groups,function(u){return p.ib.deserializeFilter(u)})}}):void 0,simplifiedAggregates:e.SimplifiedAggregates?_.map(e.SimplifiedAggregates,function(i){return{original:p.ib.deserializeExpr(i.Original),target:p.ib.deserializeExpr(i.Target)}}):void 0,measureGranularity:e.MeasureGranularity?_.map(e.MeasureGranularity,function(i){return p.ib.deserializeExpr(i)}):void 0,warnings:e.Warnings}}},n.prototype.visitDecompositionTree=function(e){return{findDecompositions:{decompositions:_.map(e.Decompositions,function(i){return{dimension:i.Dimension?p.ib.deserializeExpr(i.Dimension):void 0,value:i.Value?p.ib.deserializeFilter(i.Value):void 0,score:i.Score}}),warnings:e.Warnings,continuationToken:Me(e.ContinuationToken),executionStatistics:Ue(e.ExecutionStatistics)}}},n.prototype.visitSummaries=function(e){return{generateSummaries:{values:e.Values?_.map(e.Values,function(i){var u,c,g=e.Queries[i.QueryIndex];return{name:i.Name,selectName:i.SelectName,sourceSubjectName:i.SourceSubjectName,description:i.Description,query:g?p.ib.deserializeQuery(g):void 0,formatString:null!==(c=null===(u=i.Format)||void 0===u?void 0:u.FormatString)&&void 0!==c?c:void 0,type:i.Type}}):void 0,summaries:e.Summaries?_.map(e.Summaries,function(i){return{standardSummary:i.StandardSummary?ct(i.StandardSummary):void 0,conditionalSummary:i.ConditionalSummary?dt(i.ConditionalSummary):void 0}}):void 0}}},n.prototype.visitExplainAnomalies=function(e){return{explainAnomalies:{explanations:_.map(e.Explanations,function(i){return{anomalyIndex:i.AnomalyIndex,factors:_.map(i.Factors,function(u){return{field:p.ib.deserializeExpr(u.Field),value:p.ib.deserializeFilter(u.Value)}}),value:p.ib.deserializeExpr(i.Value),expectedValue:p.ib.deserializeExpr(i.ExpectedValue),score:i.Score}})}}},n.prototype.visitSuggestCompatibleFields=function(e){return{suggestCompatibleFields:{dimensions:e.Dimensions?_.map(e.Dimensions,function(i){return p.ib.deserializeExpr(i)}):void 0,measures:e.Measures?_.map(e.Measures,function(i){return p.ib.deserializeExpr(i)}):void 0}}},n.prototype.visitSuggestQueries=function(e){return{suggestQueries:{requiredFields:_.map(e.RequiredFields,function(i){return p.ib.deserializeExpr(i)}),queries:_.map(e.Queries,function(i){return{dataQuery:lt(i.DataQuery)}})}}},n.prototype.visitExplainVarianceToTarget=function(e){return{explainVarianceToTarget:{explanations:_.map(e.Explanations,function(i){return{explanation:p.ib.deserializeFilter(i.Explanation),measureValue:p.ib.deserializeExpr(i.MeasureValue),targetValue:{direction:i.TargetValue.Direction,expr:i.TargetValue.Expression?p.ib.deserializeExpr(i.TargetValue.Expression):void 0},score:i.Score}}),warnings:e.Warnings}}},n}();function lt(n){return{query:p.ib.deserializeQuery(n.Query),score:{base:n.Score.Base,fieldMatch:n.Score.FieldMatch,overall:n.Score.Overall},dimensionGroupings:_.map(n.DimensionGroupings,function(e){return{expressionNames:e.ExpressionNames}}),statistics:n.Statistics?{count:n.Statistics.Count,groupingStatistics:_.map(n.Statistics.GroupingStatistics,function(e){return{count:e.count}})}:void 0}}function Ge(n,e){return _.map(n,function(i){return{type:i.Type,visualConfiguration:i.VisualConfiguration,score:e?i.TopicRelevance:i.Score,structuredDescription:_.map(i.StructuredDescription,function(u){return{text:u.Text,type:u.Type,hover:u.Hover}}),statistics:i.Statistics}})}function Ue(n){if(n)return{completionPercentage:n.CompletionPercentage,total:n.Total}}function ct(n){return{sourceSubjectName:n.SourceSubjectName,description:n.Description,summaryElements:n.SummaryElements?De(n.SummaryElements):void 0,properties:n.Properties?$e(n.Properties):void 0,title:n.Title?Be(n.Title):void 0}}function dt(n){return{sourceSubjectName:n.SourceSubjectName,description:n.Description,conditionValueName:n.ConditionValueName,cases:n.Cases?_.map(n.Cases,function(e){return{condition:e.Condition?p.ib.deserializeExpr(e.Condition):void 0,summaryElements:e.SummaryElements?De(e.SummaryElements):void 0}}):void 0,defaultCase:n.DefaultCase?De(n.DefaultCase):void 0,properties:n.Properties?$e(n.Properties):void 0,title:n.Title?Be(n.Title):void 0}}function De(n){return _.map(n,function(e){return{staticText:e.StaticText,valueName:e.ValueName}})}function $e(n){A.fF.assertValue(n,"summaryProperties");var e="Unknown",i=n.Category;switch(i){case"Anomaly":case"Trend":case"KPI Insights":e=n.Subcategory}var u=new H;return{category:i,subcategory:e,priority:n.Priority,scoreExpr:n.Score?p.ib.deserializeExpr(n.Score):void 0,followUpActions:n.FollowUpActions?_.map(n.FollowUpActions,function(c){var g=(0,Te.dH)(c.Analysis,u);return A.fF.assertValue(g,"Unsupported follow up analysis."),{analysis:g,title:c.Title?Be(c.Title):void 0,description:c.Description?Be(c.Description):void 0}}):void 0}}function Be(n){if(A.fF.assertValue(n,"summaryElementSequence"),n.Standard)return{standard:{summaryElements:De(n.Standard.SummaryElements)}};var e=n.Conditional;return A.fF.assertValue(e,"conditionalElementSequence"),{conditional:{conditionValueName:e.ConditionValueName,cases:e.Cases?_.map(e.Cases,function(i){return{condition:i.Condition?p.ib.deserializeExpr(i.Condition):void 0,summaryElements:i.SummaryElements?De(i.SummaryElements):void 0}}):void 0,defaultCase:e.DefaultCase?De(e.DefaultCase):void 0}}}function Me(n){if(n)return{start:n.Start,include:_.clone(n.Include)}}var H=function(){function n(){}return n.prototype.visitExplore=function(e){},n.prototype.visitGetRelated=function(e){},n.prototype.visitExplainChange=function(e){return A.fF.assertValue(e,"changeAnalysisDefinition"),{explainChange:{timeoutInMS:e.TimeoutInMS,requestedInsights:e.RequestedInsights,measure:p.ib.deserializeExpr(e.Measure),reference:p.ib.deserializeFilter(e.Reference),target:p.ib.deserializeFilter(e.Target),parentSpace:e.ParentSpace?p.ib.deserializeFilter(e.ParentSpace):void 0,referenceDimensionValue:void 0,referenceValue:void 0,continuationToken:Me(e.ContinuationToken)}}},n.prototype.visitFindDistributionFactors=function(e){},n.prototype.visitFindKeyDrivers=function(e){},n.prototype.visitDecompositionTree=function(e){},n.prototype.visitGenerateSummaries=function(e){},n.prototype.visitExplainAnomalies=function(e){return A.fF.assertValue(e,"anomalyAnalysisDefinition"),{explainAnomalies:{measure:p.ib.deserializeExpr(e.Measure),filters:e.Filters?p.ib.deserializeFilter(e.Filters):void 0,measureGranularity:_.map(e.MeasureGranularity,function(i){return p.ib.deserializeExpr(i)}),granularityScalarKey:p.ib.deserializeExpr(e.GranularityScalarKey),anomalies:_.map(e.Anomalies,function(i){return{location:p.ib.deserializeExpr(i.Location),value:p.ib.deserializeExpr(i.Value),expectedValue:p.ib.deserializeExpr(i.ExpectedValue),explanationWindow:p.ib.deserializeFilter(i.ExplanationWindow)}}),predictors:e.Predictors?_.map(e.Predictors,function(i){return p.ib.deserializeExpr(i)}):void 0,sensitivity:e.Sensitivity,seasonalityPeriod:e.SeasonalityPeriod}}},n.prototype.visitSuggestCompatibleFields=function(e){},n.prototype.visitSuggestQueries=function(e){},n.prototype.visitExplainVarianceToTarget=function(e){return{explainVarianceToTarget:{value:p.ib.deserializeExpr(e.Value),target:{direction:e.Target.Direction,expr:e.Target.Expression?p.ib.deserializeExpr(e.Target.Expression):void 0},scope:p.ib.deserializeFilter(e.Scope),filters:e.Filters?p.ib.deserializeFilter(e.Filters):void 0,predictors:e.Predictors?_.map(e.Predictors,function(i){return p.ib.deserializeExpr(i)}):void 0}}},n}(),ye=d(5708),fe=d(38703),Oe=d(94477),He=d(80777),Ye=d(46381);function pt(n,e,i,u,c,g,x){return new ft(n,e,i,u,c,g,x)}var ft=function(){function n(e,i,u,c,g,x,V){this.cache=e,this.impersonationService=i,this.promiseFactory=u,this.telemetryService=c,this.insightsProxy=g,this.visualTimeSynchronizationService=x,this.embedModeService=V,this.requestToHostIds={}}return n.prototype.getAnalysisStatus=function(e){A.fF.assertValue(e,"analysisExecutionRequest");var i=Ke(e,this.impersonationService,this.visualTimeSynchronizationService,this.embedModeService),u=this.cache.get(i);return u?u.status:0},n.prototype.execute=function(e,i,u){var c=this;A.fF.assertValue(e,"analysisExecutionRequest"),A.fF.assertAnyValue(i,"parentEvent"),A.fF.assertAnyValue(u,"hostId"),A.fF.assertValue(e.analysisDefinition,"analysisDefinition"),A.fF.assertValue(e.dataSourceDefinition,"dataSourceDefinition"),A.fF.assert(function(){return!(!e.dataSourceDefinition.model&&!e.dataSourceDefinition.dataSource)},"either model of dataSource need to be defined");var g=new Je,x=(0,Te.rL)(e.analysisDefinition,g),V=this.embedModeService&&this.embedModeService.getEmbedTypeDescription(),T="ServiceThoroughMode";e.analysisDefinition.getRelatedInsights&&1===e.analysisDefinition.getRelatedInsights.options&&(T="ServiceQuickMode");var z=i?this.telemetryService.startChildEvent(i,le.Uy,{insightCount:0,source:T,analysisType:x,embedType:V}):this.telemetryService.startEvent(le.Uy,{insightCount:0,source:T,analysisType:x,embedType:V}),B=Ke(e,this.impersonationService,this.visualTimeSynchronizationService,this.embedModeService);this.registerHostForRequest(B,u);var $=z.event.info,ne=this.getCachedResult(B,e.dataSourceDefinition.model);if(ne)return u&&2===ne.status&&this.unregisterHostsForRequest(B,u),$.source="ClientCache",z.resolve(),ne;var Ce=this.promiseFactory.defer();return this.cache.set(B,Ce.promise),this.insightsProxy.execute(B).then(function(ve){var Re,l=ve.telemetryId,t=ve.isCancelled;if($.telemetryId=l,$.isCancelled=t,$.responseRequestId=ve.responseRequestId,ve.error)return c.cache.remove(B),c.resolveTelemetry(z,l,0,x,ve.error,ve.hostWarnings),void Ce.resolve({analysisDefinition:e.analysisDefinition,telemetryId:l,error:ve.error,isCancelled:t});var r=(Re=We.F.analyze(ve.analysisResult,x)).numberOfInsights,a=Re.error;c.resolveTelemetry(z,l,r,Re.analysisType,a,Re.warnings),c.unregisterHostsForRequest(B),t||c.updateCacheStatus(a,B),Ce.resolve({analysisDefinition:e.analysisDefinition,telemetryId:l,isCancelled:t,error:a,result:a?void 0:at(ve.analysisResult)})}),{resultPromise:Ce.promise,status:1,fromCache:!1}},n.prototype.cancel=function(e,i){A.fF.assertValue(e,"analysisExecutionRequest"),A.fF.assertAnyValue(i,"hostId");var u=Ke(e,this.impersonationService,this.visualTimeSynchronizationService,this.embedModeService);if(i&&this.unregisterHostsForRequest(u,i)){var c=this.cache.remove(u);if(!c||1!==c.status)return;this.insightsProxy.cancel(u)}},n.prototype.clearCache=function(){this.cache.clear()},n.prototype.getCachedResult=function(e,i){var u;i&&(u=(0,ye.ee)(i.lastRefreshTime));var c=this.cache.get(e,u);if(c)return(0,C.pi)((0,C.pi)({},c),{fromCache:!0})},n.prototype.updateCacheStatus=function(e,i){e&&"User"!==e.source?this.cache.remove(i):this.cache.updateStatus(i,2,!0)},n.prototype.registerHostForRequest=function(e,i){if(A.fF.assertValue(e,"request"),A.fF.assertAnyValue(i,"hostId"),i){var u=JSON.stringify(e),c=this.requestToHostIds[u]||[];c.push(i),this.requestToHostIds[u]=_.uniq(c)}},n.prototype.unregisterHostsForRequest=function(e,i){A.fF.assertValue(e,"request"),A.fF.assertAnyValue(i,"hostId");var u=JSON.stringify(e),c=this.requestToHostIds[u];return!(_.isEmpty(c)||(i?_.remove(c,function(g){return i===g}):_.remove(c,_.stubTrue),!_.isEmpty(c))||(delete this.requestToHostIds[u],0))},n.prototype.resolveTelemetry=function(e,i,u,c,g,x){var V;void 0===x&&(x=[]);for(var T=g?(0,C.ev)((0,C.ev)([],x||[],!0),[g.code],!1):x,z=g?U.Bb("User"===g.source?3:1):void 0,B=0,$=T;B<$.length;B++)this.telemetryService.logChildEvent(e.event,le.H_,{warning:$[B],attempt:0,telemetryId:i,errorSource:z,errorCode:null===(V=g?.data)||void 0===V?void 0:V.code});var ne=e.event.info;ne.insightCount=u,ne.analysisType=c,g?(ne.sourceOfError=g.source,e.reject({errorCode:g.codeString,errorSource:z})):e.resolve()},(0,C.gn)([(0,C.fM)(6,(0,w.Optional)()),(0,C.w6)("design:paramtypes",[we.v,Ye.h,Object,pe.y0,Object,Object,Object])],n)}(),Je=function(){function n(){}return n.prototype.visitExplore=function(e){return"Explore"},n.prototype.visitGetRelated=function(e){return"GetRelatedInsights"},n.prototype.visitExplainChange=function(e){return"ExplainChange"},n.prototype.visitFindDistributionFactors=function(e){return"FindDistributionFactors"},n.prototype.visitFindKeyDrivers=function(e){return e.target.categorical?"KeyDriversCategorical":"KeyDriversContinuous"},n.prototype.visitDecompositionTree=function(e){return"DecompositionTree"},n.prototype.visitGenerateSummaries=function(e){return"GenerateSummaries"},n.prototype.visitExplainAnomalies=function(e){return"ExplainAnomalies"},n.prototype.visitSuggestCompatibleFields=function(e){return"SuggestCompatibleFields"},n.prototype.visitSuggestQueries=function(e){return"SuggestQueries"},n.prototype.visitExplainVarianceToTarget=function(e){return"ExplainVarianceToTarget"},n}();function Ke(n,e,i,u){var g,T,c=n.dataSourceDefinition;if(A.fF.assert(function(){return!(!c.model&&!c.dataSource)},"either model or datasource need to be defined"),e&&e.impersonating){var x=e.getImpersonationState();g={ImpersonatedUserPrincipalName:x.impersonatedUserPrincipalName,ImpersonatedRoles:x.impersonatedRoles}}if((!u||!u.isAnonymousLiveEmbed())&&function(n){return(0,Te.rL)(n,new ht)}(n.analysisDefinition)){var z=i.getAnchorTime();T=(0,Oe.CI)(z,He.Ge.fromExtendedType(519))}return{AnalysisDefinition:Ae(n.analysisDefinition),AnchorTime:T,DbName:c.model?c.model.dbName:c.dataSource.dsr.dbName,VsName:c.model?c.model.vsName:c.dataSource.dsr.vsName,ModelId:c.model?c.model.id:c.dataSource.dsr.modelId,Impersonation:g}}var ht=function(){function n(){}return n.prototype.visitExplore=function(e){return!1},n.prototype.visitGetRelated=function(e){return(0,fe.hN)(e.topicQuery)},n.prototype.visitExplainChange=function(e){var u=e.target,c=e.reference;return(0,fe.hN)(e.parentSpace)||(0,fe.hN)(u)||(0,fe.hN)(c)},n.prototype.visitFindDistributionFactors=function(e){return(0,fe.hN)(e.parentSpace)},n.prototype.visitFindKeyDrivers=function(e){var i=e.filters,u=!!e.target&&!!e.target.categorical&&(0,fe.hN)(e.target.categorical.targetValue);return(0,fe.hN)(i)||u},n.prototype.visitDecompositionTree=function(e){return(0,fe.hN)(e.filters)},n.prototype.visitGenerateSummaries=function(e){return!1},n.prototype.visitExplainAnomalies=function(e){return A.fF.assertValue(e,"anomalyAnalysisDefinition"),(0,fe.hN)(e.filters)},n.prototype.visitSuggestCompatibleFields=function(e){return!1},n.prototype.visitSuggestQueries=function(e){return!1},n.prototype.visitExplainVarianceToTarget=function(e){A.fF.assertValue(e,"varianceToTargetAnalysisDefinition");var u=e.filters;return(0,fe.hN)(e.scope)||(0,fe.hN)(u)},n}(),ke=d(84688),gt={provide:"quickExploreInsightsProxy",useFactory:function(n,e){return(0,C.mG)(this,void 0,void 0,function(){return(0,C.Jh)(this,function(i){return[2,new _e(n,e)]})})},deps:[j.E,ke.e]},_e=function(){function n(e,i){this.lazyProvider=e,this.insightsProxyPathToken=i,this.pendingRequestsMap=new Map,this.hostId=je.b$.generateGuid()}return n.prototype.execute=function(e,i,u,c){var g;return void 0===c&&(c=!0),(0,C.mG)(this,void 0,void 0,function(){var V,T,z,B,$,ce=this;return(0,C.Jh)(this,function(ne){switch(ne.label){case 0:return[4,this.ensureInsightsService()];case 1:return ne.sent(),V={dataSourceDefinition:i,analysisDefinition:{suggestQueries:{requiredFields:e}}},!c&&_.size(this.pendingRequestsMap)>0&&this.pendingRequestsMap.forEach(function(Ce,ve){Ce.isStale||(ce.pendingRequestsMap.set(ve,{analysisRequest:Ce.analysisRequest,isStale:!0}),ce.insightsService.cancel(Ce.analysisRequest,ce.hostId))}),T=this.serializeAnalysisDefinition(V.analysisDefinition),c||this.pendingRequestsMap.set(T,{analysisRequest:V,isStale:!1}),[4,this.insightsService.execute(V,u,this.hostId).resultPromise];case 2:return z=ne.sent(),c?[2,z]:(B=this.serializeAnalysisDefinition(z.analysisDefinition),A.fF.assert(function(){return ce.pendingRequestsMap.has(B)},"pendingRequestMap should contain the request key"),$=null===(g=this.pendingRequestsMap.get(B))||void 0===g?void 0:g.isStale,this.pendingRequestsMap.delete(B),$&&!z.isCancelled?[2]:[2,z])}})})},n.prototype.cancel=function(e){return(0,C.mG)(this,void 0,void 0,function(){return(0,C.Jh)(this,function(i){switch(i.label){case 0:return[4,this.ensureInsightsService()];case 1:return i.sent(),this.insightsService.cancel(e,this.hostId),[2]}})})},n.prototype.ensureInsightsService=function(){return(0,C.mG)(this,void 0,void 0,function(){var i;return(0,C.Jh)(this,function(u){switch(u.label){case 0:return this.insightsService?[2]:(i=this,[4,this.lazyProvider.get(this.insightsProxyPathToken||"@powerbi/Insights/insights-web.module#InsightsWebModule","InsightsServiceModern")]);case 1:return i.insightsService=u.sent(),[2]}})})},n.prototype.serializeAnalysisDefinition=function(e){return JSON.stringify(Ae(e))},n.\u0275fac=function(i){return new(i||n)(w.\u0275\u0275inject(j.E),w.\u0275\u0275inject(ke.e,8))},n.\u0275prov=w.\u0275\u0275defineInjectable({token:n,factory:n.\u0275fac}),n}(),et=d(77476),tt=d(90917),it=d(32288),mt=d(76521),yt=d(66877),rt=d(14463),qe=d(77906),St=d(45125),nt=function(){function n(){}return n.\u0275fac=function(i){return new(i||n)},n.\u0275mod=w.\u0275\u0275defineNgModule({type:n}),n.\u0275inj=w.\u0275\u0275defineInjector({providers:[re,{provide:"insightsBootstrapModern",useClass:be},{provide:"InsightsServiceModern",useFactory:pt,deps:[we.v,Ye.h,rt.t,pe.y0,re,tt.a,[new w.Optional,yt.X]]},gt],imports:[et.CommonModule,it.J,mt.A3,St.z,qe.N,N.InsightsModule]}),n}()},99266:function(Ze,Ee,d){d.r(Ee),d.d(Ee,{InsightsModule:function(){return Re}});var N=d(81337),C=d(4008),k=d(72951),le=d(29767),Fe=d(26898),pe=d(49092),w=d(38982),Q=d(48145),G=d(83008),j=d(88565),q=d(3887),ee=d(9380),be=d(47639),we=d(45114),U=d(1409),A=d(50522),Ve=d(47508),je=d(56045),F=d(62458),Qe=d(47961),Ne=d(82755),Xe=d(94477),X=d(95462),Z=d(94419),re=d(74082),me=d(45413),st=d(75074),We=d(45551),Te=d(58295),p=d(50423),Ae="keyDrivers",lt=je.us,Ue={provide:"insightsAnalysisDefinitionBuilder",useFactory:function(l,t,r,a,o,s){return new Promise(function(f){f(new ct(l,t,r,a,o,s))})},deps:[Fe.i,Q.U,G.D,j.S,pe.d,ee.vZ]},ct=function(){function l(t,r,a,o,s,f){this.conceptualSchemaProxy=t,this.explorationCapabilities=r,this.dataSources=a,this.visualQueryGenerator=o,this.dataProxy=s,this.featureSwitchService=f}return l.prototype.buildAnalysisDefinition=function(t,r,a,o,s){return(0,N.mG)(this,void 0,void 0,function(){var f;return(0,N.Jh)(this,function(v){switch(F.fF.assertValue(t,"visualType"),F.fF.assertValue(r,"visualQuery"),F.fF.assertAnyValue(a,"objects"),F.fF.assertAnyValue(o,"filter"),F.fF.assertAnyValue(s,"previousAnalysisDefinition"),f=new we.g(r.defn.rewrite(new k.X),r.projections,r.expansionStates),t){case Ve.L.keyDriversVisual.name:return[2,this.buildKeyDriversAnalysisDefinition(f,a,o,s)];case Ve.L.decompositionTreeVisual.name:return[2,this.buildDecompositionTreeAnalysisDefinition(f,o,a)];default:F.fF.assertFail("Unknown visual type")}return[2]})})},l.prototype.buildDecompositionTreeAnalysisDefinition=function(t,r,a){return(0,N.mG)(this,void 0,void 0,function(){var o,s,f,v,h,m,y,S,b,E,I,M,D,R,L,W,P,O,J,se;return(0,N.Jh)(this,function(Ie){switch(Ie.label){case 0:if(o=t.tryGetExpr(U.Fw.analyze,0),s=t.tryGetExprs(U.Fw.explainBy),f=(0,Ne.NA)(a,{objectName:U.I8.analysis,propertyName:U.hq.aiEnabled},!0),v=(0,Ne.NA)(a,{objectName:U.I8.analysis,propertyName:U.hq.aiMode},"absolute"),!f&&(h=(0,Qe.D5)(t.expansionStates,U.Fw.explainBy)))for(m=0;m<_.size(h.levels);m++)h.setAILevelInformation(m,void 0);return o?[4,this.conceptualSchemaProxy.get(this.dataSources.get())]:[2,{error:{code:0},isComplete:!1,canExecute:f,analysisType:"DecompositionTree"}];case 1:return y=Ie.sent(),S=(0,q.W)(o,this.explorationCapabilities.getCapabilities(),y),!(0,Te.k)(o)||(0,re.ez)(o)&&(0,We.cH)(o)?[2,{error:{code:1},isComplete:!1,canExecute:f,analysisType:"DecompositionTree"}]:(b=t.getRolesUniqueProjectionRefs([U.Fw.explainBy]),E=_.map(b,function(K,ue){return(0,Qe.DX)(t.expansionStates,[U.Fw.explainBy],ue)}),I=_.findIndex(E,function(K){return K&&!K.disabled}),M=_.findLastIndex(E,function(K){return K}),D=-1===I?[]:_.slice(E,I,M+1),_.forEach(D,function(K){return F.fF.assertValue(K,"AI levels must be contiguous")}),D=_.takeWhile(D,function(K){return K}),R=(0,Qe.sz)(t.expansionStates,[U.Fw.explainBy]),L=t.getRolesActiveProjectionsRefs([U.Fw.explainBy],!0),F.fF.assert(function(){return _.size(D)<=R}),W=_.take((0,w.w9)(t,[U.Fw.explainBy]),I),P=_.size(L)>0&&_.size(D)>0&&_.size(W)>=I,O=X.yl.merge(_.map(W,function(K){return X.yl.fromSQExpr(K)})),J=_.map(D,function(K){return(0,C.zU)((0,C.N_)(K.method),v)}),se=this.liftFilterToSubquery(t,r),P&&f&&!S?[2,{error:{code:2},isComplete:!0,canExecute:!1,analysisType:"DecompositionTree"}]:[2,{definition:{findDecompositions:{target:o,dimensions:_.slice(s,R-D.length),filters:se,methods:P&&f&&S?J:void 0,path:O}},isComplete:P,canExecute:f&&S,warning:void 0,analysisType:"DecompositionTree"}])}})})},l.prototype.buildKeyDriversAnalysisDefinition=function(t,r,a,o){return(0,N.mG)(this,void 0,void 0,function(){var s,f,v,h,m,S,b,E,I,M,D,R,W,P,O,J,se,Ie,K,ue,de,Y,ae,ze,he,ge;return(0,N.Jh)(this,function(xe){switch(xe.label){case 0:return[4,this.conceptualSchemaProxy.get(this.dataSources.get())];case 1:if(s=xe.sent(),v=t.tryGetExpr((f=A.qG).target,0),h=t.tryGetExprs(f.explainBy),m=t.tryGetExprs(f.details),!_.some(s.schemas,function(te){return te.capabilities.insights.supportsKeyDrivers}))return[2,{error:{code:0},isComplete:!1,canExecute:!1,analysisType:"KeyDrivers"}];if(_.some(s.schemas,function(te){return te.capabilities.supportsDataSourceVariables}))return[2,{error:{code:7},isComplete:!1,canExecute:!1,analysisType:"KeyDrivers"}];if(!v)return[2,{error:{code:1},isComplete:!1,canExecute:!0,analysisType:"KeyDrivers"}];if(!(0,C.wg)(v,s))return[2,{error:{code:2},isComplete:!1,canExecute:!1,analysisType:"KeyDrivers"}];if(_.some(h,function(te){var Le=te.getTargetSchemaName(),Pe=s.schema(Le);return Pe&&Pe.isExtensionSchema}))return[2,{error:{code:4},isComplete:!1,canExecute:!1,analysisType:"KeyDrivers"}];if(S=v&&v.getMetadata(s),b=S&&S.type&&(S.type.numeric||S.type.integer),E=v&&(0,Te.k)(v),I=1,E){if(_.some(s.schemas,function(te){return!te.capabilities.supportsSubqueryRegrouping}))return[2,{error:{code:8},isComplete:!1,canExecute:!1,analysisType:"KeyDriversContinuous"}]}else{if(_.some(s.schemas,function(te){return te.capabilities.discourageQueryAggregateUsage}))return[2,{error:{code:9},isComplete:!1,canExecute:!1,analysisType:"KeyDriversCategorical"}];_.some(s.schemas,function(te){return te.capabilities.supportsExtensionColumns})||(I&=-2)}return _.isEmpty(m)||E?!(R=r?(0,Ne.NA)(r,{objectName:Ae,propertyName:"selectedNumericAnalysis"},void 0):void 0)&&b||E||R===lt&&b?(W="KeyDriversContinuous",P=(0,Ne.NA)(r,{objectName:Ae,propertyName:"numericTargetSelectedKind"},0),(0,Te.k)(v)||(O=X.yl.fromSQExpr((0,Z.ff)((0,Z.qu)(0,v,(0,Z.IF)()))),a=a?X.yl.merge([a,O]):O),M={continuous:{expression:v,kind:P}},[3,5]):[3,2]:[2,{error:{code:6},isComplete:!1,canExecute:!1,analysisType:"KeyDrivers"}];case 2:return W="KeyDriversCategorical",J=(0,Ne.NA)(r,{objectName:Ae,propertyName:"targetValue"},void 0),Ie=(se=o&&o.findKeyDrivers&&o.findKeyDrivers.target)&&se.categorical&&se.categorical.expression,[4,this.conceptualSchemaProxy.get(this.dataSources.get())];case 3:return K=xe.sent(),ue=v.getKeyColumns(K),F.fF.assert(function(){return 1===_.size(ue)},"only support 1 groupon key"),de=Ie&&Ie.getKeyColumns(K),F.fF.assert(function(){return!de||1===_.size(de)},"only 1 groupon key supported"),[4,(0,C.wW)(ue[0],a,K,this.dataProxy,this.dataSources,this.visualQueryGenerator)];case 4:if(!(Y=xe.sent()))return[2,{error:{code:10},isComplete:!1,canExecute:!1,analysisType:"KeyDriversCategorical"}];if(Y.error)return[2,{error:{code:11,details:Y.error},isComplete:!1,canExecute:!1,analysisType:"KeyDriversCategorical"}];F.fF.assertValue(Y.result,"either result of error has to be set"),(ae=Y.result).count>10&&(D=1),(se&&se.continuous||!J||de&&!(0,me.fS)(ue[0],de[0]))&&(J=(0,Xe.CI)(ae.firstValue,ue[0].getMetadata(K).type)),ze=(0,be.bE)(J),he=X.yl.fromSQExpr((0,Z.Sh)([ue[0]],[[ze]])),M={categorical:{expression:v,targetValue:he}},xe.label=5;case 5:return ge=!0,_.isEmpty(h)&&(D=0,ge=!1),[2,{definition:{findKeyDrivers:{target:M,filters:a,predictors:h,details:m,options:I}},warning:D,isComplete:ge,canExecute:!0,analysisType:W}]}})})},l.prototype.liftFilterToSubquery=function(t,r){if(!r||!t)return r;for(var a=[],o=[],s=0,f=r.where();s<f.length;s++){var v=f[s];if(!_.isEmpty(v.target)&&v.condition){var h=new dt;v.condition.accept(h),h.hasMeasure?a.push(v):o.push(v)}else o.push(v)}if(_.isEmpty(a))return r;var m=t.defn;m=m.addSemanticFilter(r);var y=X.yl.fromMeasureFilters(m,a,null),S=X.vQ.createWith({from:m.from(),select:m.select(),orderBy:m.orderBy(),top:m.top(),transforms:m.transforms(),groupBy:m.groupBy(),where:o});return S=S.addSemanticFilter(y),X.yl.fromSQFromAndSQFilters(S.from(),S.where())},l.prototype.getClientError=function(t){return(0,le.EL)(t,new $e)},l.prototype.getClientWarning=function(t){return(0,le.hj)(t,new De)},l.\u0275fac=function(r){return new(r||l)(p.\u0275\u0275inject(Fe.i),p.\u0275\u0275inject(Q.U),p.\u0275\u0275inject(G.D),p.\u0275\u0275inject(j.S),p.\u0275\u0275inject(pe.d),p.\u0275\u0275inject(ee.vZ))},l.\u0275prov=p.\u0275\u0275defineInjectable({token:l,factory:l.\u0275fac}),l}(),dt=function(l){function t(){return null!==l&&l.apply(this,arguments)||this}return(0,N.ZT)(t,l),t.prototype.visitMeasureRef=function(r){this.hasMeasure=!0},t.prototype.visitAggr=function(r){this.hasMeasure=!0},t.prototype.visitNativeMeasure=function(r){this.hasMeasure=!0},t}(st.PA),De=function(){function l(){}return l.prototype.visitDecompositionTree=function(t){},l}(),$e=function(){function l(){}return l.prototype.visitDecompositionTree=function(t){var r=this.getErrorInfoKeys(t);return{code:r.errorInfoValue,source:"User",debugInfo:void 0,ignorable:!1,requestId:void 0,getDetails:function(o){return{message:o.get(r.errorInfoValue),displayableErrorInfo:[{errorInfoKey:o.get(r.errorInfoKey),errorInfoValue:o.get(r.errorInfoValue)}]}}}},l.prototype.visitExplainAnomalies=function(t){},l.prototype.getErrorInfoKeys=function(t){switch(t){case 0:return{errorInfoKey:"VisualContainer_FailedToLoadVisual",errorInfoValue:"DecompositionTree_Error_NoTargetMeasure"};case 1:return{errorInfoKey:"VisualContainer_FailedToLoadVisual",errorInfoValue:"AnalysisVisual_Error_UnsupportedTarget"};case 2:return{errorInfoKey:"DecompositionTree_AnalysisUnsupported_Title",errorInfoValue:"DecompositionTree_AnalysisUnsupported_Description"};default:return F.fF.assertFail("Unhandled error in builder result: ".concat(t)),{errorInfoKey:"VisualContainer_FailedToLoadVisual",errorInfoValue:"AnalysisVisual_Error_Generic"}}},l}(),Be=d(7886),Me=d(3579),H=d(60661),ye=d(32379),fe=d(74711),Oe=d(5265),He=d(78843),Ye=d(26743),pt=d(23320),ft=d(79006),Je=d(29866),Ke=function(){function l(t,r,a,o,s){this.dataSources=t,this.conceptualSchemaProxy=r,this.decompositionAuthoringCore=a,this.expandCollapseService=o,this.visualPlugin=s}return l.prototype.processAnalysisResult=function(t,r){return(0,N.mG)(this,void 0,void 0,function(){var a,o,s,f,v,h,m,y,S,b,E,I,M,D,R,L,W,P,O,se,K=this;return(0,N.Jh)(this,function(ue){switch(ue.label){case 0:return F.fF.assertValue(t,"visualContainer not defined"),F.fF.assertAnyValue(r," findDecompositions can be undefined when there is analysis error."),a=this.visualPlugin.capabilities((0,Me.s)(t)),F.fF.assertValue(s=(o=a&&a.insights&&a.insights.decomposition)&&o.explainByRole,"Capabilities is missing explainBy role"),f=this.decompositionAuthoringCore.getAILevelsInformation(t,s),v=_.size(f),h=-1===(h=_.findIndex(f,function(de){return!de.disabled}))?0:h,m=(0,H.Xf)(t),y=m.getRolesProjectionRefs([s]),S=m.tryGetExprs(s),b=this.decompositionAuthoringCore.getPinnedLevelsCount(t,s),I=(E=b-v)+h,r&&null!=r.warnings&&(M=this.processAnalysisWarning(r.warnings)),D=o&&o.highlightedAIMatrixNode,I<0?(F.fF.assertFail("Count of AI levels is greater than the number of dimensions"),[2,{clientWarnings:M}]):(R=r&&r.decompositions,_.isEmpty(R)?(0===E?this.decompositionAuthoringCore.collapseNode(t,s,{dataMap:{}}):this.decompositionAuthoringCore.truncatePath(t,s,E-1),[2,{clientWarnings:M}]):(this.clearHighlightedAIProperties(t,D),[4,this.conceptualSchemaProxy.get(this.dataSources.get())]));case 1:for(L=ue.sent(),this.decompositionAuthoringCore.clearAILevelsInformation(t,s),F.fF.assert(function(){return v>=_.size(R)},"Received more AI results than requested"),this.decompositionAuthoringCore.truncatePath(t,s,I),W=function(Y){var ae,oe=R[Y],ze=P.findProjection(S,oe.dimension,L,I),he=y[ze];if(!he)return F.fF.assertFail("Projection not found"),P.decompositionAuthoringCore.truncatePath(t,s,I+Y-1),"break";if(P.decompositionAuthoringCore.replaceLevelAt(t,s,I+Y,he),Y<_.size(R)-1){F.fF.assertValue(oe.value,"Decomposition result is missing a value"),F.fF.assertValue(_.some(oe.value.where()),"Value is not a valid filter");var ge=oe.value.where()[0].condition,xe=(0,He.TZ)(ge),te=P.decompositionAuthoringCore.expandNode(t,s,{dataMap:(ae={},ae[he]=[xe],ae),metadata:[he]});F.fF.assert(function(){return te},"Could not expand AI node")}},P=this,O=0;O<_.size(R)&&"break"!==W(O);O++);return this.expandCollapseService.pinLevels(t,[s],b),b<_.size(S)&&this.expandCollapseService.unpinLevels(t,[s],b),se=m.getRolesProjectionRefs([s]),_.map(f,function(de,Y){return K.expandCollapseService.setAILevelInformation(t,[s],Y+E,[se[Y+E]],de)}),this.createDataViewObjectDefinitions(R,t,L,I,D),[2,{windowExpansionTransform:function(Y){for(var ae=(0,fe.W7)(_.first(m.expansionStates),Y,m.defn.select(),L),oe=ae.root,ze=0;!_.isEmpty(oe.children);)oe=_.first(oe.children),ze++;var he=I+_.size(R)-1;if(ze===he){var ge=_.last(R);if(-1!==K.findProjection(S,ge.dimension,L,I)){F.fF.assertValue(ge.value,"Decomposition result is missing a value"),F.fF.assertValue(_.some(ge.value.where()),"Value is not a valid filter");var te=ge.value.where()[0].condition,Le=(0,Ye.Dh)(te);ae.levels[he].identityKeys=_.map(Le,function(ie){return ie.left});var Pe=_.map(Le,function(ie){return ie.right});return oe.windowValues=[],oe.children=[{children:[],identityValues:Pe,windowValues:[]}],ae}F.fF.assertFail("Projection not found")}else F.fF.assertFail("Incorrect expansion path length")},clientWarnings:M}]}})})},l.prototype.createDataViewObjectDefinitions=function(t,r,a,o,s){var f;if(!_.isEmpty(t)){F.fF.assertValue(r,"visualContainer"),F.fF.assertValue(a,"FederatedConceptualSchema"),F.fF.assert(function(){return o>=0},"firstActiveAILevel should not be negative.");var v=(0,H.GQ)(r);v||(v=r.config.singleVisual.objects={});for(var h=(0,H.Xf)(r),m=U.Fw.explainBy,y=w.JU(h,[m]),S=h.getRolesProjectionRefs([m]),b=h.tryGetExprs(m),E=_.size(t),I=0;I<E-1;I++){var M=(0,ye.tV)(y[o+I]);if(F.fF.assertValue(M,"ExpansionPath should not be empty."),!M)break;M.metadata=null,(0,Oe.sO)(v,s,M,(0,Z.O7)(!0))}var D=_.last(t),L=S[this.findProjection(b,D.dimension,a,o)],W=_.first(D.value.where());if(W){var P=(0,He.TZ)(W.condition),O=w.ud(y,[{dataMap:(f={},f[L]=[P],f),metadata:[L]}]),J=(0,ye.tV)(_.last(O));J&&(J.metadata=null,(0,Oe.sO)(v,s,J,(0,Z.O7)(!0)))}}},l.prototype.clearHighlightedAIProperties=function(t,r){F.fF.assertValue(t,"visualContainer"),F.fF.assertValue(r,"PropertyIdentifier of highlightedAIMatrixNode should exist.");var a=(0,H.GQ)(t);if(a){var o=a[r.objectName];if(!_.isEmpty(o)){for(var s=0,f=o;s<f.length;s++)(0,Oe.E2)(a,r.objectName,f[s].selector,r.propertyName);(0,Oe.u4)(a)}}},l.prototype.findProjection=function(t,r,a,o){return _.findIndex(t,function(s){if((0,re.ez)(s)){var f=s.getTargetColumnRef(a);return(0,re.ez)(r)&&(r=r.getTargetColumnRef(a)),(0,me.fS)(f,r)}return(0,me.fS)(s,r)},o)},l.prototype.processAnalysisWarning=function(t){F.fF.assertAnyValue(t,"DecompositionAnalysisWarnings");var r=[];if(1===t){var a="InvalidConstrainedJoin";r.push({code:a,columnNameFromIndex:function(s){},getDetails:function(s){return{message:s.get(a),displayableErrorInfo:[{errorInfoKey:s.get(a),errorInfoValue:s.get(a)}]}}})}return r},l.prototype.toClientErrorOrWarning=function(){throw new Error("Not applied to DecompositionTree result handler")},l.\u0275fac=function(r){return new(r||l)(p.\u0275\u0275inject(G.D),p.\u0275\u0275inject(Fe.i),p.\u0275\u0275inject(pt.e),p.\u0275\u0275inject(ft.v),p.\u0275\u0275inject(Je.D))},l.\u0275prov=p.\u0275\u0275defineInjectable({token:l,factory:l.\u0275fac}),l}(),ht={provide:"insightsAnalysisResultHandler",useFactory:function(l){return new Promise(function(t){t(new ke(l))})},deps:[p.Injector]},ke=function(){function l(t){this.injector=t}return l.prototype.processAnalysisResult=function(t,r){if(F.fF.assertValue(t,"visualContainer not defined"),F.fF.assertValue(r,"analysisResultContainer not defined"),r.analysisDefinition.findDecompositions)return this.injector.get(Ke).processAnalysisResult(t,r.result&&r.result.findDecompositions);F.fF.assertFail("Unexpected analysis result")},l.prototype.toClientErrorOrWarning=function(t){return Be.F.processAnalysisErrorToIClientErrorOrWarning(t)},l.\u0275fac=function(r){return new(r||l)(p.\u0275\u0275inject(p.Injector))},l.\u0275prov=p.\u0275\u0275defineInjectable({token:l,factory:l.\u0275fac}),l}(),Se=d(32488),gt=d(32557),_e=d(13702),et=d(8082),tt=d(66977),it=d(68273),mt=d(47287),yt=d(50550),rt=d(41640),qe=d(43286),St=d(72489),nt=d(5361),n=d(65181),i={provide:"insightsAnalysisModern",useFactory:function(l,t,r,a,o,s,f){return new Promise(function(v){v(new u(l,t,r,a,o,s,f))})},deps:[_e.O,Q.U,ee.vZ,n.o,Je.D,tt.f,et.s]},u=function(){function l(t,r,a,o,s,f,v){this.displayNameService=t,this.explorationCapabilities=r,this.featureSwitchService=a,this.localizationService=o,this.visualPlugin=s,this.visualPluginOps=f,this.runningVisuals=v}return l.prototype.getOptions=function(t,r,a,o,s){F.fF.assertValue(t,"visualContainer"),F.fF.assertValue(o,"schema");var f,v=[];r instanceof X.yl?v=[r]:void 0!==r&&(f=r.query,r.dataFilters&&v.push.apply(v,_.map(r.dataFilters,function(D){return D.filter})),r.highlightFilters&&v.push(r.highlightFilters));var m=this.addFiltersToQuery(t,v);if(!m)return[];m=m.rewrite(new g);var y=[];if(this.analysisTypeMatches(s,"ExplainChange")&&!_.isEmpty(a)){var S=this.getExplainChangeDefinitions(t,m,a,v,o,f);_.isEmpty(S)||y.push.apply(y,S||[])}this.analysisTypeMatches(s,"FindDistributionFactors")&&(b=this.getDistributionFactorOption(t,m,a,o,f))&&y.push(b);var b,E=this.featureSwitchService.featureSwitches;if(E.insightsDevModeEnabled&&this.analysisTypeMatches(s,"GetRelatedInsights")&&(b=this.getRelatedInsightsDefinition(t,m,a,o))&&y.push(b),E.decompositionAnalysisInsights&&this.analysisTypeMatches(s,"DecompositionTree")){var I=this.createDecompositionAnalysisOptions(t,a,o);I&&(y=y.concat(I))}if(E.daxTransformEnabled&&this.analysisTypeMatches(s,"ExplainAnomalies")){var M=this.getExplainAnomalyOptions(t,a,o,v);_.isEmpty(M)||(y=y.concat(M))}return y},l.prototype.getExplainChangeDefinition=function(t,r,a,o,s,f,v,h,m,y){F.fF.assertValue(t,"schema"),F.fF.assertValue(o,"selects"),F.fF.assertValue(s,"measureExpr"),F.fF.assertValue(f,"dimensionExpr"),F.fF.assertValue(v,"targetFilter"),F.fF.assertValue(h,"referenceFilter");var S=V(f,t);return this.getExplainChangeDefinitionInternal(t,r,a,o,s,S,v,h,m,y)},l.prototype.getFindDistributionAnalysisDefinition=function(t,r,a,o,s,f){if(F.fF.assertValue(t,"schema"),F.fF.assertValue(o,"selects"),F.fF.assertValue(s,"measureExpr"),F.fF.assertValue(f,"dimensionExpr"),this.isSupported(s,t)&&this.isSupported(f,t)&&(!r||this.isSupported(r,t)))return{definition:{findDistributionFactors:{measure:s,dimension:f,parentSpace:r,requestedInsights:Se.Me,timeoutInMS:Se.No}},insightQueryTransform:{queryRewriters:this.createRewriters(o,t),orderBy:a}}},l.prototype.getExplainChangeDefinitionInternal=function(t,r,a,o,s,f,v,h,m,y){if(v&&h&&f&&_.some(t.schemas,function(R){return R.capabilities.insights.supportsExplainChange})){var S=this.createRewriters(o,t);if(!_.isEmpty(S))for(var b=0,E=S;b<E.length;b++){var I=E[b];r=r&&r.rewrite(I),h=h.rewrite(I),v=v.rewrite(I)}if((!(r=this.removeRedundantFilters(r,h,v))||this.isSupported(r,t))&&this.isSupported(v,t)&&this.isSupported(h,t)&&this.isSupported(s,t))return{definition:{explainChange:{requestedInsights:Se.Me,timeoutInMS:Se.No,measure:s,reference:h,target:v,parentSpace:r,referenceValue:m,referenceDimensionValue:y}},insightQueryTransform:{queryRewriters:S,orderBy:a}}}},l.prototype.addFiltersToQuery=function(t,r){var a=(0,H.Xf)(t),o=a&&a.clone().defn;if(o){for(var s=0,f=r;s<f.length;s++)o=o.addSemanticFilter(f[s]);return o}},l.prototype.getRelatedInsightsDefinition=function(t,r,a,o){var s=this;if(_.some(o.schemas,function(v){return v.capabilities.insights.supportsRelatedInsights})){var f=a&&X.yl.merge(_.map(a,function(v){return s.getFilterFromSelector(v)}));return f&&(r=r.addSemanticFilter(f)),{analysisDefinition:{getRelatedInsights:{topicQuery:r,options:0,requestedInsights:Se.Me,timeoutInMS:Se.No}},question:this.localizationService.get("Insights_AnalysisScopedQuestion"),description:this.localizationService.get("Insights_AnalysisScopedDescription"),sourceVisualContainer:t,insightQueryTransform:{queryRewriters:this.createRewritersFromVisualContainerSelects(t,o)},selectors:a}}},l.prototype.getDistributionFactorOption=function(t,r,a,o,s){var f,v,h;if(_.some(o.schemas,function(ie){return ie.capabilities.insights.supportsDistributionFactors})){var m=(0,Me.s)(t);if(!(_.size(a)>1||m!==Ve.L.columnChart.name&&m!==Ve.L.clusteredColumnChart.name&&m!==Ve.L.barChart.name&&m!==Ve.L.clusteredBarChart.name&&m!==Ve.L.lineClusteredColumnComboChart.name&&m!==Ve.L.lineStackedColumnComboChart.name)){var y=this.visualPluginOps.dataViewKinds((0,Me.s)(t),(0,H.Xf)(t));if(y&&(0,qe.yE)(y,1)&&void 0!==this.runningVisuals.getVisual(t)){var S=this.runningVisuals.getVisual(t).getDataViews();if(!_.every(S,function(ie){return _.isEmpty(ie.categorical.categories)||_.size(ie.categorical.categories[0].values)<=1})){var b,E,I;if(_.isEmpty(a)){var R=(0,H.Xf)(t),L=R.projections,W=L[mt.au.y],P=W&&W.all();if(1!==_.size(P))return;b=null===(h=_.find(r.select(),function(ie){return ie.name===P[0].queryRef}))||void 0===h?void 0:h.expr;var O=_.filter(r.select(),function(ie){return!(0,Te.k)(ie.expr)});if(1!==_.size(O)&&(O=_.filter(O,function(ie){var It=R.getRoleNameForExpr(ie.expr);return _.includes(L[It].activeProjectionRefs,ie.name)})),1!==_.size(O))return;E=O[0].expr}else{var M=a[0],D=M.metadata;if(1!==_.size(D)||(b=null===(f=r.select().withName(D[0]))||void 0===f?void 0:f.expr,!(I=this.getCategoricalSelectorContext((0,ye.tV)(M),t,o))||!I.categoryQueryName))return;E=null===(v=r.select().withName(I.categoryQueryName))||void 0===v?void 0:v.expr}if(b&&E){var J=(0,H.Xf)(t),se=J.getRoleNameForExpr(E),Ie=J.projections[se];if(!(_.size(Ie.all())>1&&1!==_.size(Ie.activeProjectionRefs))){if((0,re.ZG)(b)){for(var ue=0,de=_.map(b.filters,function(ie){return X.yl.fromSQExpr(ie.condition)});ue<de.length;ue++)r=r.addSemanticFilter(de[ue]);b=b.expression}var oe,ae=I&&I.legendFilter;ae&&(r=r.addSemanticFilter(ae)),_.isEmpty(r.where())||(oe=X.yl.fromSQFromAndSQFilters(r.from(),r.where()));var ze=(0,H.cj)(t,this.visualPlugin),he=this.displayNameService.getDisplayName(b,o,ze),ge=this.displayNameService.getDisplayName(E,o,(0,H.cj)(t,this.visualPlugin)),xe=this.localizationService.format("Insights_AnalysisDistributionFactorsDescription",[he,ge]);ae&&(xe=this.localizationService.format("Insights_AnalysisDistributionFactorsWithFiltersDescription",[he,ge,this.displayNameService.getFilterRestatement(ae,o,ze)]));var te=(0,H.oJ)(t),Le=s&&s.orderBy(),Pe=this.getFindDistributionAnalysisDefinition(o,oe,Le,te,b,E);if(Pe)return{analysisDefinition:Pe.definition,question:this.localizationService.get("Insights_AnalysisDistributionFactorsQuestion"),description:xe,sourceVisualContainer:t,insightQueryTransform:Pe.insightQueryTransform,selectors:a}}}}}}}},l.prototype.getExplainChangeDefinitions=function(t,r,a,o,s,f){if(_.some(s.schemas,function(I){return I.capabilities.insights.supportsExplainChange})){var h,v=this.visualPluginOps.dataViewKinds((0,Me.s)(t),(0,H.Xf)(t));if(null!=v&&void 0!==this.runningVisuals.getVisual(t)&&(_.isEmpty(o)||(h=X.yl.merge(o)),!_.some(a,function(I){return!I.dataMap}))){var m=a[0].metadata;if(1!==_.size(m)||_.some(a,function(I){return 1!==_.size(I.metadata)||I.metadata[0]!==m[0]}))return[];var y=r.select().withName(m[0]);if(!y)return[];var S=y.expr,b=[];if((0,qe.yE)(v,1)){var E=this.getCategoricalBreakdownOptions(t,a,s,S,h,f);_.isEmpty(E)||b.push.apply(b,E||[])}else(0,qe.yE)(v,2)&&(E=this.getMatrixBreakdownOptions(t,a,s,S,h,f),_.isEmpty(E)||b.push.apply(b,E||[]));return b}}},l.prototype.createExplainChangeOption=function(t,r,a,o,s,f,v,h){var m=t.value>r.value?"Increase":"Decrease",y=Math.abs(100*(t.value-r.value)/r.value).toFixed(2),S="Insights_Analysis".concat(m,"ChangeBreakdownQuestion"),b="Insights_Analysis".concat(m,"ChangeBreakdownDescription"),E=[y];E.push.apply(E,[this.displayNameService.getDisplayName(a,s,null),r.formattedCategoryValue,t.formattedCategoryValue]);var I=this.getExplainChangeDefinitionInternal(s,o,v&&v.orderBy(),(0,H.oJ)(f),a,!0,t.filter,r.filter,r.value,r.formattedCategoryValue);if(I)return{analysisDefinition:I.definition,question:this.localizationService.get(S),description:this.localizationService.format(b,E),sourceVisualContainer:f,insightQueryTransform:I.insightQueryTransform,selectors:h}},l.prototype.createDecompositionAnalysisOptions=function(t,r,a){var o=(0,H.cj)(t,this.visualPlugin);if(o&&o.analyze&&o.analyze.supportsAnalyzeHighLowValues){var s=this.getMeasureExprForDecomposition(t,r);if(s){var f=this.explorationCapabilities.getCapabilities();if((0,q.W)(s,f,a)){var v=this.displayNameService.getDisplayName(s,a,null);return[{analysisDefinition:{findDecompositions:{target:s,methods:[1],path:void 0,strategy:1}},question:this.localizationService.get("Insights_AnalysisFindMinDecompositionQuestion"),description:this.localizationService.format("Insights_AnalysisFindMinDecompositionDescription",[Se.S7,Se.d6,v]),sourceVisualContainer:t,selectors:r},{analysisDefinition:{findDecompositions:{target:s,methods:[2],path:void 0,strategy:1}},question:this.localizationService.get("Insights_AnalysisFindMaxDecompositionQuestion"),description:this.localizationService.format("Insights_AnalysisFindMaxDecompositionDescription",[Se.S7,Se.d6,v]),sourceVisualContainer:t,selectors:r}]}}}},l.prototype.getExplainAnomalyOptions=function(t,r,a,o){F.fF.assertValue(t,"sourceVisualContainer"),F.fF.assertAnyValue(r,"selectors"),F.fF.assertValue(a,"schema"),F.fF.assertAnyValue(o,"filters");var s=[];if(_.isEmpty(r))return s;var f=(0,H.cj)(t,this.visualPlugin);if(!f?.insights)return s;var v=this.explorationCapabilities.getCapabilities(),m=new gt.ix(this.displayNameService,this.localizationService,this.runningVisuals).getAnalysisOption(t,o,_.first(r),a,f,v);return m&&s.push(m),s},l.prototype.createRewritersFromVisualContainerSelects=function(t,r){var a=(0,H.oJ)(t);return this.createRewriters(a,r)},l.prototype.createRewriters=function(t,r){for(var a=[],o=[],s=function(y){if((0,re.ez)(y.expr)){var S=(0,We.cH)(y.expr),b=y.expr.getTargetColumnRef(r).getTargetEntity();S&&b&&(_.some(o,function(E){return(0,me.fS)(E,S,!1,!0)})||(a.push(new x(b,S,r)),o.push(S)))}},f=0,v=t;f<v.length;f++)s(v[f]);return a},l.prototype.getCategoricalBreakdownOptions=function(t,r,a,o,s,f){var v=[],h=this.getCategoricalSelectorContext((0,ye.tV)(r[0]),t,a);if(h){var m=h.isScalar,y=_.size(r);if(2===y){if(!(S=this.getCategoricalSelectorContext((0,ye.tV)(r[1]),t,a)))return;var b=S.index>h.index?h:S,E=S.index>h.index?S:h;m&&!(0,rt.GG)(h.value,S.value)&&(I=this.createExplainChangeOption(E,b,o,s,a,t,f,r))&&v.push(I)}else if(1===y&&m){var M=h.previousSelector;if(M){var S,I;if(!(S=this.getCategoricalSelectorContext(M,t,a)))return;(0,rt.GG)(h.value,S.value)||(I=this.createExplainChangeOption(h,S,o,s,a,t,f,r))&&v.push(I)}}return v}},l.prototype.getCategoricalSelectorContext=function(t,r,a){for(var s=0,f=this.runningVisuals.getVisual(r).getDataViews();s<f.length;s++){var v=f[s],h=new c(t,a,this.displayNameService,(0,H.cj)(r,this.visualPlugin));if((0,it.aU)(v,h),h.context)return h.context}},l.prototype.getMatrixBreakdownOptions=function(t,r,a,o,s,f){var v;if(1===_.size(r)){var h=(0,ye.tV)(r[0]),m=null===(v=h?.data)||void 0===v?void 0:v[0],y=m&&m.expr;if(y&&(0,re.Hi)(y)&&2===_.size(y.values)){for(var S=this.runningVisuals.getVisual(t).getDataViews(),b=(0,Z.Sh)(y.args,[y.values[0]]),E=(0,Z.Sh)(y.args,[y.values[1]]),I=void 0,M=void 0,D=0,R=S;D<R.length;D++){var L=R[D];I=I||this.getValueFromMatrix(b,L,a),M=M||this.getValueFromMatrix(E,L,a)}if(!I||!M)return;var W=[];if(M.isScalar){var P=this.createExplainChangeOption(M,I,o,s,a,t,f,r);P&&W.push(P)}return W}}},l.prototype.getValueFromMatrix=function(t,r,a){if((0,re.Hi)(t)&&1===_.size(t.values)){var o=t,s=r.matrix.rows.root.children,f=r.matrix.columns.root.children;if(!_.isEmpty(r.matrix.rows.root.childIdentityFields)&&!_.isEmpty(r.matrix.columns.root.childIdentityFields)){var v=r.matrix.rows.root.childIdentityFields,h=r.matrix.columns.root.childIdentityFields[0],m=_.map(v,function(P){return P.getMetadata(a)}),y=_.findIndex(o.args,function(P){return(0,me.fS)(P,h)});if(!(y<0)){var S=(0,Z.qu)(0,o.args[y],o.values[0][y]),b=_.findIndex(f,function(P){return P.identity&&(0,me.fS)(P.identity.expr,S,!1,!0)});if(!(b<0))for(var E=0,I=s;E<I.length;E++){var M=I[E],D=(0,Z.Sh)((0,N.ev)([],v||[],!0),[(0,N.ev)([],_.map(M.levelValues,function(P,O){return(0,Z.kQ)(P.value,m[O]&&m[O].type)}),!0)]),R=M.values[b].value;if(null!=R&&this.isFilterSubset(t,D,0)){var L=m[m.length-1],W=L&&L.type;return{formattedCategoryValue:_.map(t.values[0],function(P,O){var J=t.args[O].getMetadata(a);return(0,St.WU)(P.value,J&&J.format)}).join(" "),value:R,index:0,previousSelector:null,isScalar:T(W),filter:X.yl.fromSQExpr((0,Z.Sh)(t.args,[t.values[0]]))}}}}}}},l.prototype.removeRedundantFilters=function(t,r,a){var o=this;if(t){var s=t.where(),f=_.filter(s,function(h){var m=!0,y=h.condition;if((0,re.Hi)(y)&&2===_.size(y.values)){var S=(0,Z.Sh)(y.args,[y.values[0]]),b=(0,Z.Sh)(y.args,[y.values[1]]);m=!(_.some(r.where(),function(E){return o.isFilterSubset(E.condition,S,0)})&&_.some(a.where(),function(E){return o.isFilterSubset(E.condition,b,0)}))}return m}),v=_.size(f);if(v===_.size(s))return t;if(0!==v)return new X.yl(t.from(),f)}},l.prototype.isFilterSubset=function(t,r,a){var o=this;return(0,re.Hi)(t)&&_.every(r.args,function(s,f){return _.some(t.args,function(v,h){return(0,me.fS)(s,v,!1,!0)&&o.areValuesEqual(r.values[a][f],t.values[a][h])})})},l.prototype.areValuesEqual=function(t,r){return!(!t||!r)&&(_.isDate(t.value)&&_.isDate(r.value)?t.value.getTime()===r.value.getTime():t.value===r.value)},l.prototype.getFilterFromSelector=function(t){return(0,ye.mV)([(0,ye.tV)(t)])},l.prototype.isSupported=function(t,r){if(t instanceof Z.Il)return!k.B.isUnsupported(t,r);for(var o=0,s=t.where();o<s.length;o++)if(k.B.isUnsupported(s[o].condition,r))return!1;if(t instanceof X.vQ)for(var h=0,m=t.select();h<m.length;h++)if(k.B.isUnsupported(m[h].expr,r))return!1;return!0},l.prototype.isSimpleAdditiveMeasure=function(t,r){if((0,re.iV)(t))return(0,re.Lk)(t.arg)?2===t.func:0===t.func||5===t.func;if((0,re.kb)(t)){var o=t.getConceptualProperty(r);F.fF.assertValue(o.measure,"expression has to be a conceptual measure");var s=o.measure.distributiveAggregate;if(null==s||0!==s&&1!==s)return!1}return!0},l.prototype.getMeasureExprForDecomposition=function(t,r){var a,o=_.first(r);if(!o||1!==r.length||!o.metadata||1!==o.metadata.length)return a;var s=(0,H.Xf)(t),f=_.first(o.metadata);return s.defn.select().withName(f).expr},l.prototype.analysisTypeMatches=function(t,r){return void 0===t||t===r},l.\u0275fac=function(r){return new(r||l)(p.\u0275\u0275inject(_e.O),p.\u0275\u0275inject(Q.U),p.\u0275\u0275inject(ee.vZ),p.\u0275\u0275inject(n.o),p.\u0275\u0275inject(Je.D),p.\u0275\u0275inject(tt.f),p.\u0275\u0275inject(et.s))},l.\u0275prov=p.\u0275\u0275defineInjectable({token:l,factory:l.\u0275fac}),l}(),c=function(){function l(t,r,a,o){this.schema=r,this.displayNameService=a,this.visualCapabilities=o,this.identities=t.data,this.metadata=t.metadata}return l.prototype.visitCategoryColumns=function(){},l.prototype.visitValueColumnGroups=function(){},l.prototype.visitValueColumn=function(t){return this.metadata===t.source.queryName},l.prototype.visitValue=function(t,r,a,o,s){var f=this;if(!(0,it.ON)(this.identities,r.data)&&_.isNumber(t)&&_.isFinite(t)&&!_.isEmpty(o)){var m,v=_.every(o[0].identityFields,function(S){return V(S,f.schema)}),h=_.filter(r.data,function(S){return S.key!==o[0].identity[s].key});s>0&&(m={dataMap:{category:[o[0].identity[s-1]]},metadata:[r.metadata]},_.size(r.data)>1&&(m.dataMap.series=h));var y=(0,ye.mV)([r]);this.context={value:t,index:s,formattedCategoryValue:this.displayNameService.getFilterRestatement(y,this.schema,this.visualCapabilities),previousSelector:m?(0,ye.tV)(m):void 0,isScalar:v,filter:y,categoryQueryName:o[0].source.queryName,legendFilter:h&&(0,He.SN)(h)}}},l}(),g=function(l){function t(){return null!==l&&l.apply(this,arguments)||this}return(0,N.ZT)(t,l),t.prototype.visitGroupRef=function(r){return new Z.Wh(r.source,r.ref)},t}(nt.b),x=function(l){function t(r,a,o){var s=l.call(this)||this;s.variationTarget=r;var f=a;return(0,re.jc)(a)&&(f=(0,Z.Oh)(a.arg,a.property)),s.hierarchyLevelExprs=(0,yt.rY)((0,We.wA)(o,f)),s.hierarchyTargetColumnRefs=_.map(s.hierarchyLevelExprs,function(v){return v.getTargetColumnRef(o)}),s.variationSourceTargetEntity=a.getTargetEntity(),s}return(0,N.ZT)(t,l),t.prototype.visitColumnRef=function(r){if((0,me.fS)(r.source,this.variationTarget)){var a=_.findIndex(this.hierarchyTargetColumnRefs,function(o){return(0,me.fS)(o,r)});return a>=0&&a<=_.size(this.hierarchyLevelExprs)-1?this.hierarchyLevelExprs[a]:r}return r},t.prototype.visitEntity=function(r){return(0,me.fS)(r,this.variationTarget)?this.variationSourceTargetEntity:r},t}(nt.b);function V(l,t){var r=l.getOrderByColumns(t),s=(1===_.size(r)?r[0]:l).getMetadata(t);return T(s&&s.type)}function T(l){return!!l&&!!(l.dateTime||l.temporal||l.numeric||l.integer)}var z=d(31486),B=d(14172),$=d(48787),ne={provide:"quickExploreSupportability",useFactory:function(l){return(0,N.mG)(this,void 0,void 0,function(){return(0,N.Jh)(this,function(t){return[2,new Ce(l)]})})},deps:[ee.vZ]},Ce=function(){function l(t){this.featureSwitchService=t,this.isQuickExploreMultiTableEnabled$=this.featureSwitchService.featureSwitches$.pipe((0,B.U)(function(r){return r.quickExploreMultiTable}))}return l.prototype.isQuickExploreSupported=function(t){return(0,N.mG)(this,void 0,void 0,function(){return(0,N.Jh)(this,function(a){switch(a.label){case 0:return[4,this.isQuickExploreMultiTableEnabled$.pipe((0,$.q)(1)).toPromise()];case 1:return[2,a.sent()&&!t.isHidden&&!(1&~t.permissions)&&t.insightsQuerySuggestionsSupported]}})})},l.\u0275fac=function(r){return new(r||l)(p.\u0275\u0275inject(ee.vZ))},l.\u0275prov=p.\u0275\u0275defineInjectable({token:l,factory:l.\u0275fac}),l}(),ve=d(77476),Re=function(){function l(){}return l.\u0275fac=function(r){return new(r||l)},l.\u0275mod=p.\u0275\u0275defineNgModule({type:l}),l.\u0275inj=p.\u0275\u0275defineInjector({providers:[Ue,ht,z.v,i,Ke,ne],imports:[ve.CommonModule]}),l}()},31486:function(Ze,Ee,d){d.d(Ee,{v:function(){return pe}});var N=d(8590),C=d(62458),k=d(50423),le=d(43025),pe=function(){function Q(G){var j=this;this.cache=[],this.globalSubscriptionManager=G.createChannelSubscriptionManager().subscribe(N.wW,function(q,ee){return j.clear(ee.dsr.modelId)})}return Q.prototype.ngOnDestroy=function(){this.globalSubscriptionManager.unsubscribeAll()},Q.prototype.set=function(G,j){C.fF.assertValue(G,"request"),C.fF.assertValue(j,"resultPromise");var q=w(G);_.find(this.cache,function(be){return be.key===q})&&C.fF.assertFail("Cache entry already exists"),_.size(this.cache)>=50&&this.cache.splice(0,1),this.cache.push({key:q,resultPromise:j,insertTimestamp:new Date,status:1,modelId:G.ModelId})},Q.prototype.get=function(G,j){C.fF.assertValue(G,"request"),C.fF.assertAnyValue(j,"modelRefreshDate");var q=this.delete(G);if(q&&!(j&&q.insertTimestamp.getTime()<=j.getTime()))return this.cache.push(q),{resultPromise:q.resultPromise,status:q.status}},Q.prototype.remove=function(G){var j=this.delete(G);if(j)return{resultPromise:j.resultPromise,status:j.status}},Q.prototype.updateStatus=function(G,j,q){C.fF.assertValue(G,"request"),C.fF.assertValue(j,"status");var ee=w(G),be=_.find(this.cache,function(we){return we.key===ee});q||C.fF.assertValue(be,"Entry does not exist in cache"),be&&(be.status=j)},Q.prototype.clear=function(G){C.fF.assertAnyValue(G,"modelId"),null==G?this.cache=[]:_.remove(this.cache,function(j){return j.modelId===G})},Q.prototype.delete=function(G){C.fF.assertValue(G,"request");var j=w(G),q=_.remove(this.cache,function(be){return be.key===j}),ee=_.size(q);if(C.fF.assert(function(){return ee<=1},"Cache had multiple entries with same key"),0!==ee)return q[0]},Q.\u0275fac=function(j){return new(j||Q)(k.\u0275\u0275inject(le.Z))},Q.\u0275prov=k.\u0275\u0275defineInjectable({token:Q,factory:Q.\u0275fac}),Q}();function w(Q){return JSON.stringify(Q)}},68862:function(Ze,Ee,d){d.d(Ee,{$M:function(){return w},H_:function(){return Fe},Uy:function(){return k}});var N=d(41114),C="PBI.Insights.GetInsights",k=N.cx[C]=(0,N.b1)(C),le="PBI.Insights.Warnings",Fe=N.cx[le]=(0,N.b1)(le),pe="PBI.Insights.ShowInsights",w=N.cx[pe]=(0,N.b1)(pe)}}]);