"use strict";(self.webpackChunkdesktopDialogHost=self.webpackChunkdesktopDialogHost||[]).push([["rdlVisual"],{22545:function(he,S,g){g.r(S),g.d(S,{RdlVisual:function(){return pe}});var d=g(81337),R=g(41288),f=g(41114),M=g(25050),L=g(28579),m=g(46135),E="configuration-update",T="parameter-binding",P="cancel-report",y="RS.NativeVisual.LoadPage",I="PaginatedReport",w=g(38675),ie=Reflect.set,C="/groups/",F="/rdlreports/",b=!1,pe=function(){function r(){var e=this;this.datasetBindings=null,this.generateGuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var i=16*Math.random()|0;return("x"===t?i:3&i|8).toString(16)})},this.viewModel=new Proxy({toolbar:true,reportId:void 0,workspaceId:void 0,paramMappings:void 0,latestFieldValues:void 0,hostInitFinished:!1,dataInitFinished:!1,autoApplyFilters:b,paramButton:false,pageNavigation:true,exportButton:true,openReportButton:true,toolbarPosition:0,useFloatingToolbar:false,exportExcel:true,exportPDF:true,exportAccessiblePDF:true,exportCSV:true,exportPPTX:true,exportWord:true,exportMHTML:true,exportXML:true},{set:function(i,o,a){if(ie(i,o,a),("hostInitFinished"===o||"dataInitFinished"===o)&&i.hostInitFinished&&i.dataInitFinished&&!e.iframeUri){var l=R.s.getQueryStringValue("unmin")?"?unmin=1":"";e.iframeUri="".concat(e.anaheimWebappUrl,"/visual")+l,e.resetReport()}return!0}})}return r.prototype.init=function(e){var i,o,t=this,a=e.element.get(0);this.options=e;var l=d3.select(a).append("div").classed("rdl-container",!0);if(this.container=l.node(),window.hasOwnProperty("loadReportParameters")){var s=window;this.datasetBindings=null===(o=null===(i=s.loadReportParameters)||void 0===i?void 0:i.datasetBinding)||void 0===o?void 0:o.paginatedReportBindings}this.options.host.authenticationService()?(this.buildAdditionalRdlIngressInitialSplash(),this.buildAdditionalRdlIngressInitialViewModeSplash(),this.buildApplyFilterButton(),this.buildSignoutView(),this.buildTooManyValuesWarning(),this.buildIFrame(),this.getHostReady(),this.initCompleteTimeout=setTimeout(function(){t.emitInitCompleteEvent(2,"",!0,"Unable to load visual")},45e3),this.boundAnaheimMessageHandler=this.anaheimMessageHandler.bind(this),window.addEventListener("message",this.boundAnaheimMessageHandler,!1)):this.buildUnsupportedScreen()},r.prototype.destroy=function(){window.removeEventListener("message",this.boundAnaheimMessageHandler,!1),clearTimeout(this.tokenRefreshTimeout),this.signInStatusSubscription&&this.signInStatusSubscription.unsubscribe()},r.prototype.update=function(e){var i,t=this;if(!0!==this.unsupportedState)switch(e.type){case m.EP.ViewMode:this.visualEditMode=e.editMode,1===e.editMode?this.editReport():0===e.viewMode&&(this.viewModel.reportId?($(this.initialViewModeSplashContainer).hide(),$(this.initialSplashContainer).hide(),$(this.anaheimContainer).show()):($(this.anaheimContainer).hide(),$(this.initialViewModeSplashContainer).show(),$(this.initialSplashContainer).hide()));break;case m.EP.Data:if(this.shouldUpdateVisualSettings(e.dataViews[0].metadata.objects)){var o=(0,d.__assign)((0,d.__assign)({},this.getBaseMessage(E)),{toolbar:this.viewModel.toolbar,paramButton:this.viewModel.paramButton,showPaging:this.viewModel.pageNavigation,showExport:this.viewModel.exportButton,showOpenReport:this.viewModel.openReportButton,floatingToolbarDockPosition:this.viewModel.toolbarPosition,useFloatingToolbar:this.viewModel.useFloatingToolbar,exportExcel:this.viewModel.exportExcel,exportPDF:this.viewModel.exportPDF,exportAccessiblePDF:this.viewModel.exportAccessiblePDF,exportCSV:this.viewModel.exportCSV,exportPPTX:this.viewModel.exportPPTX,exportWord:this.viewModel.exportWord,exportMHTML:this.viewModel.exportMHTML,exportXML:this.viewModel.exportXML});this.sendToAnaheim(o)}else this.shouldUpdateDefaultVisualSettings(e.dataViews[0].metadata.objects)&&(o=(0,d.__assign)((0,d.__assign)({},this.getBaseMessage(E)),{toolbar:this.viewModel.toolbar,paramButton:this.viewModel.paramButton,showPaging:this.viewModel.pageNavigation,showOpenReport:this.viewModel.openReportButton,floatingToolbarDockPosition:this.viewModel.toolbarPosition,useFloatingToolbar:this.viewModel.useFloatingToolbar,showExport:this.viewModel.exportButton,exportExcel:this.viewModel.exportExcel,exportPDF:this.viewModel.exportPDF,exportAccessiblePDF:this.viewModel.exportAccessiblePDF,exportCSV:this.viewModel.exportCSV,exportPPTX:this.viewModel.exportPPTX,exportWord:this.viewModel.exportWord,exportMHTML:this.viewModel.exportMHTML,exportXML:this.viewModel.exportXML}),this.sendToAnaheim(o));if(null!=this.viewModel.reportId?($(this.initialSplashContainer).hide(),$(this.initialViewModeSplashContainer).hide(),$(this.anaheimContainer).show()):e.isInFocus||($(this.anaheimContainer).hide(),0===e.viewMode?$(this.initialViewModeSplashContainer).show():$(this.initialSplashContainer).show()),e.dataViews[0].table){var a=e.dataViews[0].table;this.viewModel.latestFieldValues=[];var l=!1;a.columns.forEach(function(s,n){var h=a.rows.map(function(ue){return t.convertTableValueToString(ue[n])});l=l||h.length>=3e4;var v=Array.from(new Set(h)),V={fieldName:s.queryName,fieldDisplayName:s.displayName,fieldType:s.type.numeric||s.type.integer?"number":s.type.dateTime||s.type.duration?"datetime":s.type.bool?"boolean":s.type.binary?"binary":"string",fieldValues:{values:v}};a.totals&&a.totals[n]&&(V.fieldValues.aggregate=t.convertTableValueToString(a.totals[n])),t.viewModel.latestFieldValues.push(V)}),l&&(this.hasWarnedUserTooManyValues||(this.tooManyValuesWarningContainer.style.display="flex",this.hasWarnedUserTooManyValues=!0)),(null===(i=this.viewModel.paramMappings)||void 0===i?void 0:i.length)>0?this.viewModel.autoApplyFilters?this.applyFilters():this.viewModel.dataInitFinished&&!e.isInFocus?this.skipNextApplyFilters?this.skipNextApplyFilters=!1:$(this.applyFilterButton).show():e.isInFocus&&e.editMode&&this.applyFilters():this.viewModel.reportId&&this.applyFilters()}else this.viewModel.latestFieldValues=void 0,this.applyFilters();this.viewModel.dataInitFinished||(this.viewModel.dataInitFinished=null==this.viewModel.paramMappings||!this.viewModel.paramMappings.length||null!=this.viewModel.latestFieldValues);break;case m.EP.Resize:e.isInFocus?this.viewModel.reportId||0!==e.viewMode?($(this.initialViewModeSplashContainer).hide(),$(this.initialSplashContainer).hide(),$(this.anaheimContainer).show()):($(this.anaheimContainer).hide(),$(this.initialViewModeSplashContainer).show(),$(this.initialSplashContainer).hide()):this.viewModel.reportId?this.sendToAnaheim(this.getBaseMessage(P)):(0===e.viewMode?$(this.initialViewModeSplashContainer).show():$(this.initialSplashContainer).show(),$(this.anaheimContainer).hide())}},r.prototype.enumerateObjectInstances=function(e){var t=new L.G;switch(e.objectName){case"toolbar":t.pushInstance({selector:null,properties:{show:this.viewModel.toolbar,pageNavigation:this.viewModel.pageNavigation,paramButton:this.viewModel.paramButton,position:this.viewModel.toolbarPosition,useFloatingToolbar:this.viewModel.useFloatingToolbar,openReportButton:this.viewModel.openReportButton},objectName:"toolbar"});break;case"export":this.viewModel.toolbar&&t.pushInstance({selector:null,properties:{show:this.viewModel.exportButton,exportExcel:this.viewModel.exportExcel,exportPDF:this.viewModel.exportPDF,exportAccessiblePDF:this.viewModel.exportAccessiblePDF,exportPPTX:this.viewModel.exportPPTX,exportCSV:this.viewModel.exportCSV,exportWord:this.viewModel.exportWord,exportMHTML:this.viewModel.exportMHTML,exportXML:this.viewModel.exportXML},objectName:"export"});break;case"autoFilter":t.pushInstance({selector:null,properties:{show:this.viewModel.autoApplyFilters},objectName:"autoFilter"})}return t.complete()},r.prototype.shouldApplyDefaultToolbarSettings=function(){return!(true===this.viewModel.toolbar&&false===this.viewModel.paramButton&&true===this.viewModel.pageNavigation&&true===this.viewModel.openReportButton&&0===this.viewModel.toolbarPosition&&false===this.viewModel.useFloatingToolbar)},r.prototype.shouldApplyDefaultExportSettings=function(){return!(true===this.viewModel.exportButton&&true===this.viewModel.exportExcel&&true===this.viewModel.exportPDF&&true===this.viewModel.exportAccessiblePDF&&true===this.viewModel.exportCSV&&true===this.viewModel.exportPPTX&&true===this.viewModel.exportWord&&true===this.viewModel.exportMHTML&&true===this.viewModel.exportXML)},r.prototype.shouldApplyDefaultAutoFilterSettings=function(){return this.viewModel.autoApplyFilters!==b},r.prototype.shouldUpdateDefaultVisualSettings=function(e){if(void 0===e)return!1;var t=!1;return void 0===e.toolbar&&this.shouldApplyDefaultToolbarSettings()&&(this.updateViewModelValue("toolbar",true),this.updateViewModelValue("paramButton",false),this.updateViewModelValue("pageNavigation",true),this.updateViewModelValue("openReportButton",true),this.updateViewModelValue("toolbarPosition",0),this.updateViewModelValue("useFloatingToolbar",false),t=!0),void 0===e.export&&this.shouldApplyDefaultExportSettings()&&(this.updateViewModelValue("exportButton",true),this.updateViewModelValue("exportExcel",true),this.updateViewModelValue("exportPDF",true),this.updateViewModelValue("exportAccessiblePDF",true),this.updateViewModelValue("exportCSV",true),this.updateViewModelValue("exportPPTX",true),this.updateViewModelValue("exportWord",true),this.updateViewModelValue("exportMHTML",true),this.updateViewModelValue("exportXML",true),t=!0),void 0===e.autoFilter&&this.shouldApplyDefaultAutoFilterSettings()&&this.updateViewModelValue("autoApplyFilters",b),t},r.prototype.shouldUpdateVisualSettings=function(e){var t=this;if(void 0===e)return!1;var i=!1;return Object.entries(e).forEach(function(o){var a,l,s=o[0],n=o[1];if("toolbar"===s)i=[i,t.updateViewModelValue("toolbar",n.show),t.updateViewModelValue("paramButton",n.paramButton),t.updateViewModelValue("pageNavigation",n.pageNavigation),t.updateViewModelValue("openReportButton",n.openReportButton),t.updateViewModelValue("toolbarPosition",n.position),t.updateViewModelValue("useFloatingToolbar",n.useFloatingToolbar)].some(function(c){return c});else if("export"===s)i=[i,t.updateViewModelValue("exportButton",n.show),t.updateViewModelValue("exportExcel",n.exportExcel),t.updateViewModelValue("exportPDF",n.exportPDF),t.updateViewModelValue("exportAccessiblePDF",n.exportAccessiblePDF),t.updateViewModelValue("exportCSV",n.exportCSV),t.updateViewModelValue("exportPPTX",n.exportPPTX),t.updateViewModelValue("exportWord",n.exportWord),t.updateViewModelValue("exportMHTML",n.exportMHTML),t.updateViewModelValue("exportXML",n.exportXML)].some(function(c){return c});else if("autoFilter"===s)t.updateViewModelValue("autoApplyFilters",n.show);else if("reportInfo"===s){var h=n.reference;t.updateViewModelValue("reportId",null===(a=h?.byReference)||void 0===a?void 0:a.itemId),t.updateViewModelValue("workspaceId",null===(l=h?.byReference)||void 0===l?void 0:l.workspaceId)}else if("parameterMapping"===s){var v=n.mappings;try{t.viewModel.paramMappings=JSON.parse(v)}catch{}}}),i},r.prototype.updateViewModelValue=function(e,t){return void 0!==t&&this.viewModel[e]!==t&&(this.viewModel[e]=t,!0)},r.prototype.getHostReady=function(){var e=this;this.options.host.authenticationService().signInStatus$&&(this.signInStatusSubscription=this.options.host.authenticationService().signInStatus$.subscribe(function(o){return e.onSignInChange(o)}));var t=this.options.host.authenticationService().getClusterInfo().then(function(o){return e.setClusterInfo(o)}),i=this.refreshToken();Promise.allSettled([i,t]).then(function(){e.accessToken&&e.clusterUri&&e.anaheimWebappUrl?e.viewModel.hostInitFinished=!0:e.buildUnsupportedScreen()})},r.prototype.loadReport=function(){var e;if(this.viewModel.hostInitFinished&&this.viewModel.dataInitFinished){this.populateFieldValuesWithParamMappings();var t=null===(e=this.options.host.visualExportService())||void 0===e?void 0:e.disableRdlVisualExport(),i=(0,d.__assign)((0,d.__assign)({},this.getBaseMessage("init")),{reportId:this.viewModel.reportId,pbiReportId:this.options.host.artifactService().getReportId(),token:this.accessToken,clusterUri:this.clusterUri,locale:this.options.host.locale&&this.options.host.locale()?this.options.host.locale():"en-US",toolbar:this.viewModel.toolbar,paramButton:this.viewModel.paramButton,parameters:this.viewModel.latestFieldValues||[],eimInformationProtectionRdlReportLabelingUI:this.options.featureSwitches.eimInformationProtectionRdlReportLabelingUI,showPaging:this.viewModel.pageNavigation,showExport:this.viewModel.exportButton,showOpenReport:this.viewModel.openReportButton,floatingToolbarDockPosition:this.viewModel.toolbarPosition,useFloatingToolbar:this.viewModel.useFloatingToolbar,useReactRenderer:this.options.featureSwitches.useReactRenderer,useReactParameterPane:this.options.featureSwitches.useReactParameterPane,rdlVisualReact:this.options.featureSwitches.rdlVisualReact,rdlVirtualizeTables:this.options.featureSwitches.rdlVirtualizeTables,exportExcel:!t&&this.viewModel.exportExcel,exportPDF:!t&&this.viewModel.exportPDF,exportAccessiblePDF:!t&&this.viewModel.exportAccessiblePDF,exportCSV:!t&&this.viewModel.exportCSV,exportPPTX:!t&&this.viewModel.exportPPTX,exportWord:!t&&this.viewModel.exportWord,exportMHTML:!t&&this.viewModel.exportMHTML,exportXML:!t&&this.viewModel.exportXML,datasetBindings:this.datasetBindings,parameterControlsUpdate:this.options.featureSwitches.parameterControlsUpdate});this.sendToAnaheim(i),1===this.visualEditMode&&this.editReport()}},r.prototype.resetReport=function(){this.anaheimFrame.src=this.iframeUri},r.prototype.buildTooManyValuesWarning=function(){var e=this;this.tooManyValuesWarningContainer=document.createElement("div"),$(this.tooManyValuesWarningContainer).addClass("toomanyvalues-container");var t=$("<div class='icon glyphicon pbi-glyph-warning glyph-med'></div>"),i=$("<div class='text'><span></span><a target='_blank'></a></div>");i.find("span").text(this.options.host.getLocalizedString("RdlVisual_TooManyValues")),i.find("a").attr("href","https://aka.ms/rdlvisualtoomanyvalues").text(this.options.host.getLocalizedString("Generic_LearnMore"));var o=$("<div class='dismiss-button'><button class='dismiss-button'></button></div>");o.find("button").text(this.options.host.getLocalizedString("Dismiss")).on("click",function(){return e.tooManyValuesWarningContainer.style.display="none"}),$(this.tooManyValuesWarningContainer).append(t).append(i).append(o).hide(),$(this.container).append(this.tooManyValuesWarningContainer)},r.prototype.buildUnsupportedScreen=function(){var e=document.createElement("div");$(e).addClass("unsupported-container");var t=$("<div class='unsupportedIcon glyphicon pbi-glyph-error glyph-med'></div>"),i=$("<div class='unsupportedText'></div>").text(this.options.host.getLocalizedString("RdlVisual_Unsupported"));$(e).append(t).append(i),$(this.container).append(e),null!=this.anaheimContainer&&$(this.anaheimContainer).hide(),this.unsupportedState=!0},r.prototype.buildAdditionalRdlIngressInitialSplash=function(){this.initialSplashContainer=document.createElement("div"),$(this.initialSplashContainer).addClass("splash-container");var e=$("<div class='splash-detail-image'></div>").attr("alt",this.options.host.getLocalizedString("RdlVisual_Splash_Detail_Header")),t=$("<div class='splash-detail-header'></div>").text(this.options.host.getLocalizedString("RdlVisual_Splash_Detail_Header")),i=$("<div class='splash-detail-body'></div>").text(this.options.host.getLocalizedString("RdlVisual_Splash_Detail_Body")),o=$("<div class='connect-report-button'><button class='connect-report-button'></button></div>");o.find("button").text(this.options.host.getLocalizedString("RdlVisual_Splash_Button")).on("click",this.connectReportAction.bind(this));var a=$("<div class='create-paginated-button'><button class='create-paginated-button'></button></div>");a.find("button").text(this.options.host.getLocalizedString("DatasetContextMenu_CreatePaginatedReport")).on("click",this.createPaginatedReportAction.bind(this));var l=$("<div class='splash-buttons'></div>").append(a).append(o);$(this.initialSplashContainer).append(e).append(t).append(i).append(l).hide(),$(this.container).append(this.initialSplashContainer)},r.prototype.connectReportAction=function(){this.trace(2,"ConnectToReport action"),this.toggleConfigurationMode(!0)},r.prototype.createPaginatedReportAction=function(){var e,t=this.frontendUrl+"/groups/me/create?source=rdl-visual";this.publishCreatePaginatedReportCertifiedEvent(),null===(e=window.open(t,"_blank","noopener,noreferrer"))||void 0===e||e.focus()},r.prototype.buildAdditionalRdlIngressInitialViewModeSplash=function(){this.initialViewModeSplashContainer=document.createElement("div"),$(this.initialViewModeSplashContainer).addClass("splash-container");var e=$("<div class='splash-detail-image'></div>").attr("alt",this.options.host.getLocalizedString("RdlVisual_Splash_Detail_Header")),t=$("<div class='splash-detail-body'></div>").text(this.options.host.getLocalizedString("RdlVisual_Splash_Detail_View_Mode")),i=$("<div class='splash-button disabled'><button class='splash-button disabled'></button></div>");i.find("button").text(this.options.host.getLocalizedString("RdlVisual_Splash_Button"));var o=$("<div class='create-paginated-button disabled'><button class='create-paginated-button disabled'></button></div>");o.find("button").text(this.options.host.getLocalizedString("DatasetContextMenu_CreatePaginatedReport"));var a=$("<div class='splash-buttons'></div>").append(o).append(i);$(this.initialViewModeSplashContainer).append(e).append(t).append(a).hide(),$(this.container).append(this.initialViewModeSplashContainer)},r.prototype.buildOpenReportUrlTooLongDialog=function(e){var t=this;this.openReportUrlDialogContainer&&this.openReportUrlDialogContainer.remove(),this.openReportUrlDialogContainer=$('\n            <div class="modal-dialog">\n                <div class="dark-overlay"></div>\n                <div class="dialog-container" tabindex="0">\n                    <div class="dialog-header">\n                        <div class="dialog-header-text">'.concat(this.options.host.getLocalizedString("RdlVisual_Url_Too_Long"),'</div>\n                        <div class="dialog-cancel">\n                            <button\n                                class="dialog-cancel-button glyphicon pbi-glyph-exit glyph-small"\n                                tabindex="0"\n                                aria-label="').concat(this.options.host.getLocalizedString("Close"),'"\n                                title="').concat(this.options.host.getLocalizedString("Close"),'">\n                            </button>\n                        </div>\n                    </div>\n                    <div class="dialog-content">\n                        <div class="dialog-content-text">').concat(this.options.host.getLocalizedString("RdlVisual_Url_Too_Long_Text"),'</div>\n                        <div class="dialog-ok">\n                            <button class="dialog-ok-button btn primary" tabindex="0">').concat(this.options.host.getLocalizedString("ModalDialogButtonText_Ok"),"</button>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        ")),$(this.container).append(this.openReportUrlDialogContainer),this.openReportUrlDialogContainer.find("div.dark-overlay").on("click",function(){return t.openReportUrlDialogContainer.remove()}),this.openReportUrlDialogContainer.find("button.dialog-cancel-button").on("click",function(){return t.openReportUrlDialogContainer.remove()}),this.openReportUrlDialogContainer.find("button.dialog-ok-button").on("click",function(){t.openBaseReportUrl(e),t.openReportUrlDialogContainer.remove()}).trigger("focus")},r.prototype.toggleConfigurationMode=function(e){this.skipNextApplyFilters=!0,this.options.host.onSwitchFocusModeState(e)},r.prototype.buildSignoutView=function(){this.signoutViewContainer=document.createElement("div");var e=document.createElement("h1"),t=document.createElement("p");$(this.signoutViewContainer).addClass("signed-out-container"),$(e).text(this.options.host.getLocalizedString("Desktop_FileMenu_SignInDescription")),$(t).text(this.options.host.getLocalizedString("RdlVisual_SignRequired_Info")),$(this.signoutViewContainer).append(e).append(t).hide(),$(this.container).append(this.signoutViewContainer)},r.prototype.buildIFrame=function(){this.anaheimContainer=document.createElement("div"),this.anaheimFrame=document.createElement("iframe"),$(this.anaheimContainer).addClass("rdl-viewer-container"),$(this.anaheimFrame).addClass("rdl-frame"),$(this.anaheimContainer).append(this.anaheimFrame).hide(),$(this.container).append(this.anaheimContainer)},r.prototype.buildApplyFilterButton=function(){var e=this;this.applyFilterButton=document.createElement("button");var t=document.createElement("i"),i=document.createElement("span");$(t).addClass("glyphicon pbi-glyph-refresh glyph-mini"),$(this.applyFilterButton).addClass("floating rdl-apply-filter").on("click",function(){return e.applyFilters()}),$(i).addClass("rdl-apply-filter-text").text(this.options.host.getLocalizedString("Apply_Changes_Button")),$(this.container).append(this.applyFilterButton),$(this.applyFilterButton).append(t).append(i).hide()},r.prototype.applyFilters=function(){this.populateFieldValuesWithParamMappings();var e=(0,d.__assign)((0,d.__assign)({},this.getBaseMessage(T)),{mappings:this.viewModel.latestFieldValues||[]});this.sendToAnaheim(e),$(this.applyFilterButton).hide(),this.traceCrossFilteringEvent(e.mappings)},r.prototype.populateFieldValuesWithParamMappings=function(){var t,e=this;null===(t=this.viewModel.latestFieldValues)||void 0===t||t.forEach(function(i){var o,a=null===(o=e.viewModel.paramMappings)||void 0===o?void 0:o.find(function(l){return l.fieldName===i.fieldName});a&&(i.paramName=a.paramName,null!=a.useDefault&&(i.useDefault=a.useDefault),null!=a.isMultiValue&&(i.isMultiValue=a.isMultiValue))})},r.prototype.editReport=function(){var e=this.getBaseMessage("edit");this.sendToAnaheim(e),$(this.applyFilterButton).hide()},r.prototype.anaheimMessageHandler=function(e){var t=this,i=e.data;if("rdl-refreshpage"===i)this.resetReport();else if("rdl-rvinit-ready"===i.event)this.loadReport();else if(i.hostInstanceId===this.options.host.instanceId)switch(i.event){case"rdl-rvinit-complete":clearTimeout(this.initCompleteTimeout),this.emitInitCompleteEvent(i.rdlNativeVisualVersion,i.reportViewerVersion,!1);break;case"export-begin":this.exportReportBegin(i);break;case T:this.reportPickerRestoreMessage=void 0,this.setParameterBinding(i),this.toggleConfigurationMode(!1);break;case"set-report":this.reportPickerRestoreMessage={reportId:this.viewModel.reportId,workspaceId:this.viewModel.workspaceId},this.setReportId(i);break;case P:this.reportPickerRestoreMessage&&(this.setReportId(this.reportPickerRestoreMessage),this.reportPickerRestoreMessage=void 0),this.toggleConfigurationMode(!1),this.viewModel.reportId||($(this.initialSplashContainer).show(),$(this.anaheimContainer).hide(),this.resetReport());break;case"emit-telemetry":var a=i,l=a.info;this.traceCustom({name:a.name,id:a.id,time:a.time,category:M.zD.Verbose,info:a.info,shouldBeLogged:!0,formatted:function(){return(0,f.lG)({reportViewerVersion:a.info.reportViewerVersion,visualHostVersion:a.info.visualHostVersion,reportId:a.info.reportId,rid:a.info.rid,isError:a.info.isError,visualViewMode:0===t.options.host.getViewMode()?"view":"edit"},t.generateOptionalTelemetryProperties(a.name,l))}}),a.name===y&&this.publishLoadPageCertifiedEvent(l);break;case"focus-rdl-visual":this.options.element.get(0).click();break;case"rdl-visual-open-report":this.openReportUrlWithParams(i)}},r.prototype.setReportId=function(e){var t,i;if(this.viewModel.reportId=e.reportId,this.viewModel.workspaceId=e.workspaceId,this.options.host.persistProperties(this.viewModel.reportId?{merge:[{objectName:w.eH.reportInfo.reference.objectName,selector:null,properties:(t={},t[w.eH.reportInfo.reference.propertyName]={byReference:{itemId:this.viewModel.reportId,workspaceId:this.viewModel.workspaceId}},t)}]}:{remove:[{objectName:w.eH.reportInfo.reference.objectName,selector:null,properties:(i={},i[w.eH.reportInfo.reference.propertyName]=null,i)}]},!1),this.viewModel.latestFieldValues){var o=(0,d.__assign)((0,d.__assign)({},this.getBaseMessage(T)),{mappings:this.viewModel.latestFieldValues});this.sendToAnaheim(o)}},r.prototype.publishLoadPageCertifiedEvent=function(e){try{var t=JSON.parse(e.payload),i=t.platform,o=t.subRoute,a=t.userLicense,l=t.createdBy,s=t.updatedBy,n=t.capacitySkuTier;this.logStandardizedFeatureEvent({featureName:I,activityName:"LoadPage",activityStatus:e.isError&&"System"===e?.errorSource?"Failed":"Succeeded",activityAttributes:{platform:i,userLicense:a,subRoute:o,capacitySkuTier:n,createdBy:l??"Unknown",updatedBy:s??"Unknown"}})}catch{this.trace(2,"PaginatedReport Standardized event failed to emit")}},r.prototype.publishCreatePaginatedReportCertifiedEvent=function(){this.trace(2,"CreatePaginatedReport action");try{this.logStandardizedFeatureEvent({featureName:I,activityName:"CreatePaginatedReport",activityStatus:"Succeeded"})}catch{this.trace(2,"PaginatedReport Standardized event failed to emit")}},r.prototype.exportReportBegin=function(e){var t=this;this.options.host.downloadService().downloadFile(e.resourceLocation,e.fileName,e.fileType,e.fileDescription).then(function(){var i=(0,d.__assign)((0,d.__assign)({},t.getBaseMessage("export-delete")),{resourceId:e.resourceId});t.sendToAnaheim(i)}).catch(function(i){var o=(0,d.__assign)((0,d.__assign)({},t.getBaseMessage("export-rejected")),{exportPayload:e});t.sendToAnaheim(o)})},r.prototype.setParameterBinding=function(e){var t=e.mappings.map(function(i){return i.fieldValues=void 0,i});this.options.host.persistProperties({replace:[{objectName:"parameterMapping",selector:null,properties:{mappings:JSON.stringify(t)}}]},!1)},r.prototype.setVisualState=function(e){e?$(this.signoutViewContainer).hide():$(this.signoutViewContainer).show()},r.prototype.refreshToken=function(){return(0,d.__awaiter)(this,void 0,void 0,function(){var e;return(0,d.__generator)(this,function(i){switch(i.label){case 0:return i.trys.push([0,2,,3]),e=this,[4,this.options.host.authenticationService().getSignedInAccessToken()];case 1:return e.accessToken=i.sent(),this.setupTokenRefresh(),[3,3];case 2:return i.sent(),this.accessToken=null,[3,3];case 3:return this.setVisualState(null!==this.accessToken),[2]}})})},r.prototype.onSignInChange=function(e){return(0,d.__awaiter)(this,void 0,void 0,function(){var t;return(0,d.__generator)(this,function(i){switch(i.label){case 0:return this.accessToken=e.accessToken,e.isSignedIn?(t=this.setClusterInfo,[4,this.options.host.authenticationService().getClusterInfo()]):[3,2];case 1:return t.apply(this,[i.sent()]),this.resetReport(),this.setupTokenRefresh(),[3,3];case 2:this.anaheimFrame.src="about:blank",this.iframeUri=void 0,clearTimeout(this.tokenRefreshTimeout),i.label=3;case 3:return this.viewModel.hostInitFinished=e.isSignedIn,this.setVisualState(e.isSignedIn),[2]}})})},r.prototype.setClusterInfo=function(e){this.clusterUri=e.backendUrl,this.anaheimWebappUrl=e.paginatedReportUrl,this.frontendUrl=e.frontendUrl},r.prototype.setupTokenRefresh=function(){var e=this;if(null!=this.accessToken){var t=this.getParsedJwt(this.accessToken);if(void 0!==t&&null!=t.exp){clearTimeout(this.tokenRefreshTimeout);var i=1e3*t.exp-(new Date).getTime();this.tokenRefreshTimeout=setTimeout(function(){return(0,d.__awaiter)(e,void 0,void 0,function(){return(0,d.__generator)(this,function(o){switch(o.label){case 0:return[4,this.refreshToken()];case 1:return o.sent(),null!=this.accessToken&&this.sendToAnaheim({authToken:this.accessToken}),[2]}})})},i)}}},r.prototype.getParsedJwt=function(e){try{return JSON.parse(atob(e.split(".")[1]))}catch{return}},r.prototype.getBaseMessage=function(e){return{hostInstanceId:this.options.host.instanceId,rdlNativeVisualVersion:2,event:e}},r.prototype.sendToAnaheim=function(e){this.anaheimFrame&&this.anaheimFrame.contentWindow&&this.anaheimFrame.contentWindow.postMessage(e,"*")},r.prototype.generateOptionalTelemetryProperties=function(e,t){var i={payload:t.payload,rdlSessionId:t.rdlSessionId};switch(t.isError&&(i=(0,d.__assign)((0,d.__assign)({},i),{errorSource:t.errorSource,errorText:t.errorText,statusCode:t.statusCode})),e){case"RS.NativeVisual.Parameters":var o=t;return(0,d.__assign)((0,d.__assign)({},i),{parameters:o.parameters});case"RS.NativeVisual.RenderPage":case y:var a=t;return(0,d.__assign)((0,d.__assign)({},i),{reportViewType:a.reportViewType});case"RS.NativeVisual.ReportList":var l=t;return(0,d.__assign)((0,d.__assign)({},i),{reportList:l.reportList});case"RS.NativeVisual.BindParameters":var s=t;return(0,d.__assign)((0,d.__assign)({},i),{reportParameters:s.reportParameters,boundParameters:s.boundParameters,fieldToParameterTypesMap:s.parameterToFieldTypesMap});default:return i}},r.prototype.emitInitCompleteEvent=function(e,t,i,o){var a=this,l={name:"RS.NativeVisual.ReportViewerLoaded",time:Date.now(),category:M.zD.Verbose,shouldBeLogged:!0,id:this.generateGuid(),info:{reportViewerVersion:t,visualHostVersion:e},formatted:function(){return(0,f.lG)({reportViewerVersion:t,visualHostVersion:e,isError:i,visualViewMode:0===a.options.host.getViewMode()?"view":"edit"},{errorText:o})}};this.traceCustom(l)},r.prototype.convertTableValueToString=function(e){return null==e?e:e instanceof Date?e.getFullYear()+"-"+this.toPaddedString(e.getMonth()+1)+"-"+this.toPaddedString(e.getDate())+" "+this.toPaddedString(e.getHours())+":"+this.toPaddedString(e.getMinutes())+":"+this.toPaddedString(e.getSeconds())+"."+e.getMilliseconds():e.toString()},r.prototype.toPaddedString=function(e){return e.toString().padStart(2,"0")},r.prototype.appendUrlParam=function(e,t){return null===t?e+":isnull=true&":e+"="+encodeURIComponent(t)+"&"},r.prototype.openBaseReportUrl=function(e){var t,i=this.frontendUrl+C+this.viewModel.workspaceId+F+this.viewModel.reportId+this.getWindowLocationSearch();this.traceOpenReportUrl(0,!1,e),null===(t=window.open(i,"_blank","noopener,noreferrer"))||void 0===t||t.focus()},r.prototype.openReportUrlWithParams=function(e){var i,t=this,o="",a=0;_.filter(this.viewModel.latestFieldValues||[],function(v){return!!v.paramName}).forEach(function(v){var c="rp:"+v.paramName;v.fieldValues&&(v.isMultiValue?v.fieldValues.values.forEach(function(V){o+=t.appendUrlParam(c,V),a++}):(o+=t.appendUrlParam(c,v.fieldValues.values[0]),a++))});var s=R.s.parseQueryString(this.getWindowLocationSearch());s.ctid&&(o+="ctid="+s.ctid+"&"),_.isEmpty(o)||(o=o.slice(0,-1));var n=this.frontendUrl+C+this.viewModel.workspaceId+F+this.viewModel.reportId,h=n.length+o.length>1e3;h?this.buildOpenReportUrlTooLongDialog(e):(n+=_.isEmpty(o)?"":"?"+o,this.traceOpenReportUrl(a,h,e),null===(i=window.open(n,"_blank","noopener,noreferrer"))||void 0===i||i.focus())},r.prototype.getWindowLocationSearch=function(){return window.location.search},r.prototype.traceOpenReportUrl=function(e,t,i){var o=this,a={name:"RS.NativeVisual.OpenReportUrl",time:Date.now(),category:M.zD.Verbose,shouldBeLogged:!0,id:this.generateGuid(),info:{visualHostVersion:i?.rdlNativeVisualVersion,numParamsAppended:e,paramsExceededUrlLimit:t},formatted:function(){return(0,f.lG)({visualHostVersion:i?.rdlNativeVisualVersion,isError:!1,visualViewMode:0===o.options.host.getViewMode()?"view":"edit",numParamsAppended:e,paramsExceededUrlLimit:t},{})}};this.traceCustom(a)},r.prototype.traceCrossFilteringEvent=function(e){var t=this,i={name:"RS.NativeVisual.CrossFiltering",time:Date.now(),category:M.zD.Verbose,shouldBeLogged:!0,id:this.generateGuid(),info:{},formatted:function(){return(0,f.lG)({visualViewMode:0===t.options.host.getViewMode()?"view":"edit",visualHostVersion:2,reportId:t.viewModel.reportId,mappings:JSON.stringify(e.map(function(a){var l,s,n;return{fieldType:a.fieldType,useDefault:a.useDefault,isMultiValue:a.isMultiValue,valuesCount:null===(s=null===(l=a.fieldValues)||void 0===l?void 0:l.values)||void 0===s?void 0:s.length,useAggregate:!(null===(n=a.fieldValues)||void 0===n||!n.aggregate)}}))},{})}};this.traceCustom(i)},Object.defineProperty(r.prototype,"telemetryService",{get:function(){var t;return null===(t=this.options.host)||void 0===t?void 0:t.telemetry()},enumerable:!1,configurable:!0}),r.prototype.trace=function(e,t){var i;null===(i=this.telemetryService)||void 0===i||i.trace(e,t)},r.prototype.traceCustom=function(e){var t;null===(t=this.telemetryService)||void 0===t||t.traceCustom(e)},r.prototype.logStandardizedFeatureEvent=function(e){var t;null===(t=this.telemetryService)||void 0===t||t.logStandardizedFeatureEvent(e)},r}()}}]);