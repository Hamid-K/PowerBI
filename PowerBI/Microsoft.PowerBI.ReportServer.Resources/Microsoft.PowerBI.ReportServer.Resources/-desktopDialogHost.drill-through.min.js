"use strict";(self.webpackChunkdesktopDialogHost=self.webpackChunkdesktopDialogHost||[]).push([["drill-through"],{63055:function(xt,L,h){h.r(L),h.d(L,{DrillThroughModule:function(){return yt}});var y=h(81337),J=h(26898),W=h(39503),G=h(49080),X=h(83008),j=h(50423),Z=function(){function n(){}return n.prototype.getNavigators=function(){return[]},n.\u0275prov=j.\u0275\u0275defineInjectable({token:n,factory:n.\u0275fac=function(t){return new(t||n)},providedIn:"root"}),n}(),K=h(11494),Y=h(9380),$=h(8590),V=h(74082),U=h(45413),f=h(62458),k=h(38078),q=h(80366),tt=h(76001),H=h(45334),et=h(70489),rt=h(60661),z=function(){function n(){}return n.getApplyStateInfoForInternallDrillthrough=function(e,t,r,a){var i;void 0===r&&(r=!0),void 0===a&&(a=0),f.fF.assertValue(e,"targetSection"),f.fF.assertAnyValue(t,"drillthroughFilterInfo");var o=n.getFiltersState(e,{skipUnmatchedDrillthroughFilters:!1,filterMatchingBehavior:a},t);return{state:{activeSection:r?e.name:void 0,sections:(i={},i[e.name]={filters:o},i)},options:{clearUnmatchedData:!1,suppressDataSourceVariables:!0,suppressActiveSection:!r}}},n.getFiltersState=function(e,t,r){f.fF.assertValue(e,"targetSection"),f.fF.assertValue(t,"options"),f.fF.assertAnyValue(r,"drillthroughFilterInfo");var a=[],i=r?(0,y.__spreadArray)([],r||[],!0):[],s={},o=t.filterMatchingBehavior;if(!_.isEmpty(e.filters))for(var u=function(p){if(5!==p.howCreated||p.isTransient)return"continue";f.fF.assertValue(p.expression,"drillthrough non transient filter should always have expression");var M=_.find(i,function(D){return(1===o||!D.isTransient)&&D.filterExpressionMetadata&&1===D.filterExpressionMetadata.expressions.length&&(0,U.fS)(D.filterExpressionMetadata.expressions[0],p.expression)}),F=(0,et.e)(p);if(M)_.remove(i,M),F.filter=M.filter,F.cachedValueItems=void 0;else{if(t.skipUnmatchedDrillthroughFilters)return"continue";F.filter=void 0,F.cachedValueItems=void 0}a.push(F),s[p.name]=!0},l=0,v=e.filters;l<v.length;l++)u(v[l]);var g={exprIdentifiedMerges:a};if(0===o&&_.some(i,function(A){return A.isTransient})||1===o&&!_.isEmpty(i)){for(var d=[],m=function(p){f.fF.assert(function(){return 1===o||!!p.isTransient},"remaining drillthroughFilterInfo should always be transient");var M=(0,k.zE)(s,"transientFilter");s[M]=!0;var F={name:M,expression:_.isEmpty(p.filterExpressionMetadata)||1!==p.filterExpressionMetadata.expressions.length?void 0:p.filterExpressionMetadata.expressions[0],type:p.type,restatement:p.restatement,filter:p.filter,howCreated:5,isTransient:!0,displayName:p.displayName};d.push(F)},S=0,x=i;S<x.length;S++)m(x[S]);g.transientFilters=d}return g},n.getMatchedLinkFieldsFromParameters=function(e,t,r,a){var i=_.map(e,function(s){var o={fieldExpr:s.fieldExpr,asAggregation:s.asAggregation};return f.fF.assert(function(){return null==o.fieldExpr||!(0,V.kb)(o.fieldExpr)||!0!==o.asAggregation},"A pod parameter from a measure should never have asAggregation to be true"),null==o.asAggregation&&o.fieldExpr&&(0,V.kb)(o.fieldExpr)&&(o.asAggregation=!1),o});if(!_.isEmpty(i))return this.getMatchedLinkFields(i,t,r,a)},n.getMatchedLinkFields=function(e,t,r,a){for(var i=[],s=function(c){var g=c.fieldExpr;if(!g)return"continue";if(f.fF.assert(function(){return(0,V.kb)(g)||(0,V.t3)(g)||(0,V.wD)(g)||(0,V.ez)(g)},"only have support for measure, column, grouping column and hierarchy level"),(0,V.kb)(g))f.fF.assert(function(){return!1===c.asAggregation},"asAggregation should always be false when the fieldExpr is a measure"),_.find(r,function(p){return(0,V.kb)(p)&&(0,U.fS)(p,g)})&&i.push(c);else{var m=g.getKeyColumns(a);if(!_.isEmpty(m))if(c.asAggregation)for(var S=0,x=r;S<x.length;S++){var E=x[S];if((0,V.iV)(E)){var A=E.arg.getKeyColumns(a);if(H.m.isSubset(m,A)){i.push(c);break}}}else H.m.isSubset(m,t)&&i.push(c)}},o=0,u=e;o<u.length;o++)s(u[o]);return i},n.getMeasuresFromSelectors=function(e,t,r){for(var a=[],i=(0,rt.Xf)(t),s=0,o=e;s<o.length;s++){var u=o[s];if(u.metadata)for(var l=0,v=u.metadata;l<v.length;l++){var c=v[l],g=i.defn.select().withName(c);if(g&&g.expr){var d=(0,tt.Q)(g.expr,r),m=(0,q.bO)(d);a.push(m)}}}return a},n}(),nt=h(42614),P=h(94419),it=function(n){function e(t){var r=n.call(this)||this;return r.schema=t,r}return(0,y.__extends)(e,n),e.prototype.visitEntity=function(t){var r=this.getVariationMapping(t);return r?new P.PN(t.schema,r.sourceEntity.name):t},e.prototype.visitColumnRef=function(t){var r=t.source.accept(this);if(r!==t.source){var a=this.getVariationMapping(t.source);if(a){var i=_.find(a.variation.defaultHierarchy.levels,function(s){return s.column.name===t.ref});if(i)return new P.vD(new P.jE(new P.c7(r,a.variation.name,a.sourceProperty.name),a.variation.defaultHierarchy.name),i.name)}}return t},e.prototype.getVariationMapping=function(t){var r=this.schema.schema(t.schema).findVariationToHierarchyMappings(t.entity);if(r)return _.last(r)},e}(h(5361).b),ot=h(26743),b=h(95462),Q=h(30351);function lt(n,e,t,r){return f.fF.assertValue(n,"matchedSection"),f.fF.assertAnyValue(e,"selectorColumnValuePairs"),f.fF.assertAnyValue(t,"visualContainerAppliedFilters"),f.fF.assertValue(r,"schema"),{targetSectionName:n.sectionName,targetReportGuid:n.reportObjectId?n.reportObjectId:void 0,sectionDisplayName:n.sectionDisplayName,reportDisplayName:n.reportDisplayName?n.reportDisplayName:void 0,getFilterContext:function(){return function(n,e,t,r){for(var a=[],i=[],s=0,o=n.matchedLinkFields;s<o.length;s++){var u=o[s],l=u.fieldExpr;if(!u.asAggregation&&!(0,V.kb)(l)){for(var v=l.getKeyColumns(r),c=[],g=[],d=function(T){var I=_.findIndex(e,function(C){return(0,U.fS)(C.column,T)});f.fF.assert(function(){return-1!==I},"Expect every groupOn key of a matched section's column-type link field has a match in the selectors"),i.push(I),c.push(e[I].column),g.push(e[I].value)},m=0,S=v;m<S.length;m++)d(S[m]);var E=b.yl.fromSQExpr((0,P.Sh)(c,[g]));a.push({filterExpressionMetadata:{expressions:[l]},filter:E,isTransient:!1})}}if(1===n.allowedFiltersFromSource||2===n.allowedFiltersFromSource){if(!_.isEmpty(t)){var A=nt.l.getFiltersToApplyFromVisualQueryFilterContext(t);2!==n.allowedFiltersFromSource&&_.remove(A,function(w){return 2===w.scope});for(var p=0,M=A;p<M.length;p++){var F=M[p];a.push({filter:F.filter,isTransient:!0,filterExpressionMetadata:F.filterExpressionMetadata,restatement:F.restatement,type:F.type,displayName:F.displayName})}}for(var D=new it(r),N=function(T){if(_.includes(i,T))return"continue";var I=e[T],C=b.yl.fromSQExpr((0,P.qu)(0,I.column,I.value)),R=b.yl.fromSQExpr((0,P.Sh)([I.column],[[I.value]]));if(!_.find(a,function(B){return b.yl.isSameFilter(B.filter,C)||b.yl.isSameFilter(B.filter,R)})){var Ft=I.column.accept(D);a.push({filterExpressionMetadata:{expressions:[Ft]},filter:R,isTransient:!0})}},O=0;O<e.length;O++)N(O)}return a}(n,e,t,r)},applyState:n.applyState}}var ht={provide:"drillthrough",useFactory:function(n,e,t,r,a,i,s){var o=new pt(n,e,t,r,a,s),u=[];if(u.push(o),i){var l=i.getNavigators();l&&u.push.apply(u,l||[])}return new Promise(function(v){v(new vt(e,t,s,o,u))})},deps:[K.J,J.i,X.D,W.z,G.J,Z,Y.vZ]},vt=function(){function n(e,t,r,a,i){this.conceptualSchemaProxy=e,this.dataSources=t,this.featureSwitchService=r,this.defaultNavigator=a,this.drillthroughNavigators=i}return n.prototype.getMatchedSectionsInfo=function(e,t,r,a,i){return(0,y.__awaiter)(this,void 0,void 0,function(){var s;return(0,y.__generator)(this,function(o){switch(o.label){case 0:return[4,this.getMatchedSections(e,void 0,t,r,a,i)];case 1:return s=o.sent(),[2,_.map(s,function(u){return _.extend(u.sectionInfo,{getFilterContext:u.action.getFilterContext})})]}})})},n.prototype.getForcedMatchSectionInfo=function(e,t,r,a,i,s){return(0,y.__awaiter)(this,void 0,void 0,function(){var o,u,l;return(0,y.__generator)(this,function(v){switch(v.label){case 0:return[4,this.getMatchedSections(e,t,r,a,i,s)];case 1:return o=v.sent(),u=_.size(o),f.fF.assert(function(){return u<=1},"The target section name is given, at most 1 matching section might be found."),u<1?[2]:(l=o[0],[2,_.extend(l.sectionInfo,{getFilterContext:l.action.getFilterContext})])}})})},n.prototype.getDrillthroughActions=function(e,t,r,a){return(0,y.__awaiter)(this,void 0,void 0,function(){var i;return(0,y.__generator)(this,function(s){switch(s.label){case 0:return[4,this.getMatchedSections(this.featureSwitchService.featureSwitches.onObject?2:0,void 0,e,t,r,a)];case 1:return i=s.sent(),[2,_.map(i,function(o){return o.action})]}})})},n.prototype.applyDrillthroughState=function(e,t){return void 0===t&&(t=!0),(0,y.__awaiter)(this,void 0,void 0,function(){return(0,y.__generator)(this,function(r){return f.fF.assertValue(e,"action"),[2,e.applyState(e,t)]})})},n.prototype.getDrillthroughParameters=function(e){for(var t=[],r=0,a=this.drillthroughNavigators;r<a.length;r++){var s=a[r].getDrillthroughParameters(e);_.isEmpty(s)||t.push.apply(t,s||[])}return t},n.prototype.getMatchedSections=function(e,t,r,a,i,s){return(0,y.__awaiter)(this,void 0,void 0,function(){var o,u,l,v,c,g,d,S;return(0,y.__generator)(this,function(x){switch(x.label){case 0:return 1!==_.size(i)?[2]:(o=function(n){f.fF.assertValue(n,"selectors");for(var e=[],t=0,r=n;t<r.length;t++){var a=r[t];if(a.dataMap)for(var i in a.dataMap)for(var s=0,o=a.dataMap[i];s<o.length;s++){var u=o[s];if(u){var v=u.expr;if(v){var c=(0,ot.FD)(v);e.push(c)}}}}return e}(i),u=function(n){if(n){for(var e=[],t=function(o){o&&!_.isEmpty(o.args)&&1===o.values.length&&_.every(o.args,function(u,l){return e.push({column:u,value:o.values[0][l]})})},r=0,a=n;r<a.length;r++)t(a[r]);return e}}(o),0===_.size(u)&&0!==_.size(o)?[2]:(l=_.map(u,function(E){return E.column}),[4,this.conceptualSchemaProxy.get(this.dataSources.get())]));case 1:v=x.sent(),c=[],g=0,d=this.drillthroughNavigators,x.label=2;case 2:return g<d.length?[4,d[g].getMatchedSections(e,t,r,l,a,i,v)]:[3,5];case 3:S=x.sent(),_.isEmpty(S)||c.push.apply(c,S||[]),x.label=4;case 4:return g++,[3,2];case 5:return[2,_.map(c,function(E){return{sectionInfo:E,action:lt(E,u,s,v)}})]}})})},n.\u0275fac=function(t){j.\u0275\u0275invalidFactory()},n.\u0275prov=j.\u0275\u0275defineInjectable({token:n,factory:n.\u0275fac}),n}(),pt=function(){function n(e,t,r,a,i,s){this.eventBridge=e,this.conceptualSchemaProxy=t,this.dataSources=r,this.explorationNavigationService=a,this.explorationStateManager=i,this.featureSwitchService=s}return n.prototype.getMatchedSections=function(e,t,r,a,i,s,o){return(0,y.__awaiter)(this,void 0,void 0,function(){var u,l,c;return(0,y.__generator)(this,function(g){return f.fF.assertValue(e,"targetSectionType"),f.fF.assertAnyValue(t,"targetSectionName"),f.fF.assert(function(){return!_.isEmpty(r)},"sourceSectionName should not be empty."),f.fF.assertAnyValue(a,"selectorColumnExprs"),f.fF.assertValue(i,"visualContainer"),f.fF.assertAnyValue(s,"selectors"),f.fF.assertValue(o,"schema"),(u=this.featureSwitchService.featureSwitches.onObject)&&0===e?(f.fF.assertFail("We do NOT expect calling getMatchedSections with targetSectionType being SectionType.Regular when onObject FS is on"),[2,[]]):u||2!==e?(l=z.getMeasuresFromSelectors(s,i,o),c=this.getMatchedSectionInfoImpl(1===e?2:1,t,r,a,l,o),_.isEmpty(c)?[2]:[2,c]):(f.fF.assertFail("We do NOT expect calling getMatchedSections with targetSectionType being SectionType.Drillthrough when onObject FS is off"),[2,[]])})})},n.prototype.applyDrillthroughState=function(e,t){return(0,y.__awaiter)(this,void 0,void 0,function(){var r,a,i,s,o;return(0,y.__generator)(this,function(u){switch(u.label){case 0:if(f.fF.assertValue(e,"action"),!(r=this.explorationNavigationService.getSectionByName(e.targetSectionName)))return[2];if(!(a=z.getApplyStateInfoForInternallDrillthrough(r,e.getFilterContext(),t)))return[2];i=this.explorationStateManager.createApplyBookmarkActivity("DrillThroughFilters"),u.label=1;case 1:return u.trys.push([1,3,,4]),[4,this.conceptualSchemaProxy.get(this.dataSources.get())];case 2:return s=u.sent(),this.explorationStateManager.apply(a.state,s,a.options,i),t&&this.eventBridge.publishToChannel($.t4l,{explorationContentChanged:!0}),i.resolve(),[3,4];case 3:return o=u.sent(),i.reject(o),[3,4];case 4:return[2]}})})},n.prototype.getDrillthroughParameters=function(e){if(_.isEmpty(e))return[];var t=this.explorationNavigationService.getCurrentExploration(),a=_.find(t.pods,function(i){return i.boundSection===e&&1===i.type});return a?a.parameters:[]},n.prototype.getMatchedSectionInfoImpl=function(e,t,r,a,i,s){var o=this;if(f.fF.assert(function(){return!_.isEmpty(r)},"fromSectionName should not be empty."),f.fF.assertAnyValue(a,"selectorColumnExprs"),f.fF.assertAnyValue(i,"selectorAggAndMeasureSQExprs"),f.fF.assertValue(s,"schema"),!_.isEmpty(a)||!_.isEmpty(i)){var u=this.explorationNavigationService.getCurrentExploration();f.fF.assertValue(u,"exploration");var v,l=u.pods;v=_.filter(l,function(D){return D.boundSection!==r&&(N=D,_.isEmpty(t)||N.boundSection===t)&&function(N){return N.type===e}(D);var N});for(var d=[],m=this.explorationNavigationService.getAllSections(),S=function(N){var O=_.find(m,function(T){return T.name===N.boundSection}),w=x.getMatchedInfoFromPod(N,O,a,i,s);w&&d.push(w)},x=this,E=0,A=v;E<A.length;E++)S(p=A[E]);if(!_.isEmpty(t)&&_.isEmpty(d)){var M=_.find(m,function(N){return N.name===t});if(!M||!this.isMatchingType(M.type,e))return;var p,F=1;(p=_.find(l,function(N){return N.boundSection===t}))&&1===p.config.acceptsFilterContext&&!(0,Q.i)(p.type,p.parameters)&&(F=0),d.push({sectionDisplayName:M.displayName,sectionName:M.name,matchedLinkFields:[],allowedFiltersFromSource:F,applyState:function(O,w){return o.applyDrillthroughState(O,w)}})}return d}},n.prototype.getMatchedInfoFromPod=function(e,t,r,a,i){var s=this,o=_.filter(e.parameters,function(v){return!v.isLegacySingleSelection});if(!_.isEmpty(o)){var u=z.getMatchedLinkFieldsFromParameters(o,r,a,i);if(!_.isEmpty(u)){var l=0===e.config.acceptsFilterContext||(0,Q.i)(e.type,e.parameters);return{sectionDisplayName:t.displayName,sectionName:t.name,matchedLinkFields:u,allowedFiltersFromSource:l?1:0,applyState:function(c,g){return s.applyDrillthroughState(c,g)}}}}},n.prototype.isMatchingType=function(e,t){return void 0===e||0===e?this.featureSwitchService.featureSwitches.onObject?0===t:1===t:2===e?1===t:1===e&&2===t},n}(),gt=h(77476),dt=h(52910),mt=h(82156),yt=function(){function n(){}return n.\u0275fac=function(t){return new(t||n)},n.\u0275mod=j.\u0275\u0275defineNgModule({type:n}),n.\u0275inj=j.\u0275\u0275defineInjector({providers:[ht],imports:[gt.CommonModule,dt.O,mt.N]}),n}()}}]);