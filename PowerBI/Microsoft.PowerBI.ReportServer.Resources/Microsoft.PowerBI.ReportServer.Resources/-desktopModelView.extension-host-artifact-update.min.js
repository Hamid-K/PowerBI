"use strict";(self.webpackChunkdesktopModelView=self.webpackChunkdesktopModelView||[]).push([["extension-host-artifact-update"],{90002:function(It,F,c){c.r(F),c.d(F,{ExtensionHostArtifactUpdateModule:function(){return dt}});var G=c(77476),j=c(60756),s=c(85732),C=c(14172),L=c(77526),X=c(6663),Z=c(17653),Q=c(79078),h=c(73471),z=c(60397),x=c(17899),I=c(25082),u=(c(12315),c(81337)),H=c(8894),y=c(71477),P=c(33827);function R(t,e){return{objectId:t,artifactIds:e.map(function(a){return a.objectId})}}var k=(0,H.H)({selectId:function(e){return e.objectId}}),$=k.getInitialState({loaded:!1});(0,s.Lq)($,(0,s.on)(P.$W,function(t,e){var a=e.myFolderObjectId;return(0,u.__assign)((0,u.__assign)({},t),{myFolderObjectId:a})}),(0,s.on)(P._t,function(t,e){var a=e.objectId,n=e.artifacts,r=function(f,p,b){return k.upsertOne((0,u.__assign)((0,u.__assign)({},R(p,b)),{loading:!1,loaded:!0,fetchedTimestamp:Date.now()}),f)},o=r(t,a,n);return t.myFolderObjectId&&("me"===a?o=r(o,t.myFolderObjectId,n):a===t.myFolderObjectId&&(o=r(o,"me",n))),o}),(0,s.on)(I.j$.RN,I.j$.aX,I.j$.UB,y.W2,y.C2,y.lK,function(t,e){var a=e.artifact,n=function(i,f,p){var b,A=p.objectId,g=i.entities[f];return g?null!==(b=g.artifactIds)&&void 0!==b&&b.includes(A)?i:k.updateOne({id:f,changes:{artifactIds:(0,u.__spreadArray)((0,u.__spreadArray)([],g.artifactIds,!0),[A],!1)}},i):k.addOne((0,u.__assign)((0,u.__assign)({},R(f,[p])),{loading:!1,loaded:!1}),i)},r=n(t,a.folderObjectId,a);return a.folderObjectId===t.myFolderObjectId&&(r=n(r,"me",a)),r}),(0,s.on)(I.j$.pY,I.j$.qU,y.As,function(t,e){var a=e.objectId,n=t.ids.map(function(r){var o=t.entities[r];return o?.artifactIds.includes(a)?{id:o.objectId,changes:{artifactIds:o.artifactIds.filter(function(i){return i!==a})}}:null}).filter(function(r){return null!==r});return k.updateMany(n,t)}),(0,s.on)(I.j$.QB,function(t,e){var a=e.objectIds,n=t.ids.map(function(r){var o=t.entities[r];return null!=o?{id:o.objectId,changes:{artifactIds:o.artifactIds.filter(function(i){return!a.find(function(f){return i===f})})}}:null}).filter(function(r){return null!==r});return k.updateMany(n,t)}));var v=c(50423),_=(new v.InjectionToken("WorkspaceArtifactUrl"),new v.InjectionToken("WorkspaceArtifactToken"),(0,s.ZF)("workspace-artifact")),tt=(0,s.P1)(_,function(t){return t||$}),et=(0,s.P1)(tt,function(t){return k.getSelectors().selectEntities(t)}),at=c(1662),rt=(0,s.P1)(I.rT,et,at.L1,function(t,e,a){var n={};return Object.keys(e).forEach(function(r){n[r]=function(e,a,n){return e?.artifactIds.map(function(r){return(0,u.__assign)((0,u.__assign)({},a[r]),n[r])})}(e[r],t,a)}),n}),K=(0,s.PH)("[Extension Host Artifact Update] Subscribe Artifact Update",(0,s.Ky)()),w=(0,s.PH)("[Extension Host Artifact Update] Unsubscribe Artifact Update",(0,s.Ky)()),N="extensionHostArtifactUpdate",M=(0,H.H)({selectId:function(e){return e.subscriptionId}}),ot={artifactUpdateSubscriptions:M.getInitialState()},nt=(0,s.ZF)(N),ct=(0,s.P1)(nt,function(t){return M.getSelectors().selectAll(t.artifactUpdateSubscriptions)}),it=function(){function t(e,a,n){var r=this;this.actions$=e,this.messageBroker=a,this.store=n,this.onSubscribeArtifactUpdateReceived$=(0,x.Av)(this.actions$,this.messageBroker,h.Vm.subscribeArtifactUpdate,function(o){var i=o.iframeId,f=o.workspaceObjectId,p=(0,Q.Z)();return r.store.dispatch(K({subscriptionId:p,iframeId:i,workspaceObjectId:f})),h.Vm.subscribeArtifactUpdate.resolve({subscriptionId:p})}),this.onUnsubscribeArtifactUpdateReceived$=(0,j.GW)(function(){return r.actions$.pipe((0,x.pR)(h.Vm.unsubscribeArtifactUpdate),(0,C.U)(function(o){return w({subscriptionId:o.subscriptionId})}))}),this.pushArtifactUpdate$=(0,j.GW)(function(){return r.store.select(rt).pipe((0,L.x)(),(0,X.G)(),(0,j.IC)(function(){return r.store.select(ct)}),(0,C.U)(function(o){for(var i=o[0],f=i[0],p=i[1],A=[],g=function(lt,vt,W){var U=[],E=f[W],D=p[W];E&&D&&(D.forEach(function(d){var l=E.find(function(m){return m.objectId===d.objectId});d.objectId&&d.artifactType&&!l&&U.push({changeType:"add",workspaceObjectId:W,artifactObjectId:d.objectId,artifactType:d.artifactType})}),E.forEach(function(d){var l=D.find(function(m){return m.objectId===d.objectId});d.objectId&&d.artifactType&&!l&&U.push({changeType:"remove",workspaceObjectId:W,artifactObjectId:d.objectId,artifactType:d.artifactType})}),D.forEach(function(d){var l=E.find(function(m){return m.objectId===d.objectId});d.objectId&&d.artifactType&&d.lastUpdatedDate&&l&&l.objectId&&l.artifactType&&l.lastUpdatedDate&&l.lastUpdatedDate.getTime()!==d.lastUpdatedDate.getTime()&&U.push({changeType:"edit",workspaceObjectId:W,artifactObjectId:d.objectId,artifactType:d.artifactType})})),U.length>0&&A.push(h.Vm.onArtifactUpdate({subscriptionId:lt,changes:U})(vt))},O=0,Y=o[1];O<Y.length;O++){var S=Y[O];g(S.subscriptionId,S.iframeId,S.workspaceObjectId)}return A}),(0,Z.b)(function(o){o.forEach(function(i){r.messageBroker.send(i)})}))},{dispatch:!1})}return t.\u0275fac=function(a){return new(a||t)(v.\u0275\u0275inject(j.eX),v.\u0275\u0275inject(z.u),v.\u0275\u0275inject(s.yh))},t.\u0275prov=v.\u0275\u0275defineInjectable({token:t,factory:t.\u0275fac}),t}(),B=c(36012);function st(t,e){return(0,s.Lq)(ot,(0,B.P)(K,function(a,n){a.artifactUpdateSubscriptions=M.upsertOne({subscriptionId:n.subscriptionId,iframeId:n.iframeId,workspaceObjectId:n.workspaceObjectId},a.artifactUpdateSubscriptions)}),(0,B.P)(w,function(a,n){a.artifactUpdateSubscriptions=M.removeOne(n.subscriptionId,a.artifactUpdateSubscriptions)}))(t,e)}var dt=function(){function t(){}return t.\u0275fac=function(a){return new(a||t)},t.\u0275mod=v.\u0275\u0275defineNgModule({type:t}),t.\u0275inj=v.\u0275\u0275defineInjector({imports:[G.CommonModule,s.Aw.forFeature(N,st),j.sQ.forFeature([it])]}),t}()}}]);