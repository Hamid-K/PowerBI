"use strict";(self.webpackChunkmobile=self.webpackChunkmobile||[]).push([["aiNarratives"],{36883:function(O,m,c){c.r(m),c.d(m,{AINarratives:function(){return D}});var l=c(81337),I=c(48787),d=c(83978),y=c(90120),M=c(18664),A=c(32105),V=c(92374),g=c(45296),C=c(79154),F=c(2931),v=c(62458),z=c(38265),k=c(46135),p=c(82755),S=c(56578),T=function(){function a(e){this.host=e}return a.prototype.getFormattingModel=function(e){var i=this;return new S.Nq(function(){var t;return i.getTextFormattingCard(null===(t=e.theme)||void 0===t?void 0:t.text)}).build()},a.prototype.getTextFormattingCard=function(e){var i=this,r=new S.CQ(new S.lg("text"),"Text",[d.w$.text.fontFamily,d.w$.text.fontSize,d.w$.text.fontColor,d.w$.text.textAlignment],function(n){return i.host.getLocalizedString(n)});return r.addGroup("style",function(s){s.addCompositeSlice("fontProperties","Font",(new S.UN).withFontFamily({descriptor:d.w$.text.fontFamily,value:e.fontFamily}).withFontSizeProperties({descriptor:d.w$.text.fontSize,value:e.fontSize.pt}).build()).addSimpleSlice(d.w$.text.fontColor.propertyName,new S.BT({descriptor:d.w$.text.fontColor,value:{value:e.fontColor}}).build()).addSimpleSlice(d.w$.text.textAlignment.propertyName,new S.Gp({descriptor:d.w$.text.textAlignment,value:e.textAlignment,mode:"horizontalAlignment"}).build(),function(n){return n.withCustomDisplayName("Visual_Alignment_Horizontal")})}),r.build()},a}(),w='<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class='.concat("copilotIcon",'>\n    <path d="M4.69429 17.2446C5.25015 17.2628 5.50485 17.4557 5.68005 17.6881C5.91763 18.0032 6.05585 18.4507 6.24215 19.0836L6.25279 19.1197C6.4174 19.6793 6.63037 20.4032 7.07683 20.9707C7.58382 21.6151 8.33368 22.0002 9.40384 22.0002H16.6326C18.1223 22.0002 19.2189 21.0357 20.0075 19.8691C20.8007 18.6958 21.3885 17.1702 21.8441 15.71L21.8457 15.7049C22.3665 14.0357 23.0275 11.9171 23.003 10.2055C22.9905 9.33717 22.8027 8.45216 22.2169 7.78029C21.6122 7.08675 20.7052 6.75637 19.5547 6.75637H19.3135C18.7576 6.73824 18.5029 6.54532 18.3277 6.31296C18.0902 5.99786 17.9519 5.55028 17.7656 4.91746L17.755 4.88131C17.5904 4.32172 17.3774 3.59778 16.931 3.03032C16.424 2.38592 15.6741 2.00079 14.6039 2.00079H7.37517C5.88549 2.00079 4.78888 2.96535 4.00031 4.13188C3.20712 5.30525 2.61926 6.83079 2.16369 8.29097L2.16208 8.29611C1.6413 9.96532 0.980312 12.0839 1.00481 13.7955C1.01724 14.6638 1.20514 15.5489 1.79094 16.2207C2.39564 16.9143 3.30262 17.2446 4.45308 17.2446H4.69429ZM3.59561 8.73772C4.03915 7.31613 4.57516 5.95989 5.24302 4.97193C5.9155 3.97712 6.6171 3.50079 7.37517 3.50079H12.0044C11.8124 3.84488 11.6507 4.22575 11.5052 4.6185C11.3068 5.15409 11.1228 5.75728 10.9337 6.37682L10.8916 6.51482C10.1411 8.97189 9.20227 12.1375 8.59743 14.1874C8.33231 15.086 7.52332 15.7101 6.59356 15.7433H4.6071C4.59163 15.7433 4.57627 15.7437 4.56102 15.7446H4.45308C3.58731 15.7446 3.15634 15.5043 2.92154 15.235C2.66783 14.944 2.51468 14.4741 2.50466 13.7741C2.48429 12.3509 3.05144 10.4819 3.59561 8.73772ZM18.7648 19.0291C18.0923 20.0239 17.3907 20.5002 16.6326 20.5002H12.0033C12.1954 20.1561 12.3571 19.7753 12.5026 19.3825C12.701 18.8469 12.885 18.2437 13.0741 17.6242L13.1162 17.4862C13.8667 15.0291 14.8055 11.8636 15.4104 9.81361C15.6755 8.91506 16.4845 8.29097 17.4142 8.25776H19.4007C19.4162 8.25776 19.4315 8.25729 19.4468 8.25637H19.5547C20.4205 8.25637 20.8514 8.49676 21.0863 8.76606C21.34 9.05704 21.4931 9.52695 21.5031 10.2269C21.5235 11.6501 20.9563 13.5191 20.4122 15.2633C19.9686 16.6849 19.4326 18.0411 18.7648 19.0291ZM10.4647 15.7433H9.47652C9.72214 15.4081 9.91354 15.0273 10.0361 14.6119C10.3023 13.7096 10.633 12.5921 10.9836 11.4147L11.4679 9.80149C11.7429 8.8852 12.5864 8.25776 13.5431 8.25776H14.5313C14.2857 8.59293 14.0942 8.97372 13.9717 9.38912C13.7055 10.2914 13.3748 11.4089 13.0242 12.5863L12.5399 14.1995C12.2648 15.1158 11.4214 15.7433 10.4647 15.7433ZM13.5431 6.75776C13.1182 6.75776 12.7065 6.83089 12.322 6.96679L12.3643 6.82822C12.5577 6.19447 12.7294 5.63203 12.9118 5.13951C13.1071 4.61215 13.2967 4.21683 13.5001 3.93828C13.5472 3.87383 13.6783 3.75782 13.906 3.65616C14.1245 3.55862 14.3741 3.50079 14.6039 3.50079C15.2611 3.50079 15.5573 3.71029 15.7521 3.95782C15.9977 4.26999 16.1427 4.71614 16.3267 5.3411L16.3498 5.41962C16.468 5.82265 16.6107 6.30933 16.844 6.75776H13.5431ZM10.4647 17.2433C10.8896 17.2433 11.3013 17.1701 11.6858 17.0342L11.6435 17.1728C11.4501 17.8065 11.2784 18.369 11.096 18.8615C10.9006 19.3889 10.711 19.7842 10.5077 20.0627C10.4606 20.1272 10.3295 20.2432 10.1018 20.3449C9.8833 20.4424 9.63371 20.5002 9.40384 20.5002C8.74665 20.5002 8.45046 20.2907 8.2557 20.0432C8.0101 19.731 7.86508 19.2849 7.68109 18.6599L7.65803 18.5814C7.53983 18.1784 7.39709 17.6917 7.16382 17.2433H10.4647Z" fill="currentColor"/>\n    </svg>'),D=function(){function a(){this.isNew=!0,this.visualDestroyed=!1,this.loadingCounter=0,this.copilotTermsLink="https://aka.ms/CopilotTerms",this.learnMoreLink="https://aka.ms/AAmx9hj"}return a.prototype.init=function(e){var i=this;v.fF.assertValue(e,"options"),this.hostServices=e.host,this.featureSwitches=e.featureSwitches,this.stringResourceProvider={get:function(r){return i.hostServices.getLocalizedString(r)},format:function(r){for(var s,n=[],o=1;o<arguments.length;o++)n[o-1]=arguments[o];return(s=i.hostServices).getLocalizedString.apply(s,(0,l.ev)([r],n,!1))},getOptional:function(){}},this.viewModel={isSummaryAllowed:!1,isEditorAllowed:!1,isEditMode:1===this.hostServices.getViewMode()},this.buildVisual(e.element),this.style=e.style,this.settings={theme:{text:this.getTextFormattingSettings(void 0)}},this.updateSize(e.viewport)},a.prototype.ensureCopilotStatusSubscription=function(){return(0,l.mG)(this,void 0,void 0,function(){var e,i=this;return(0,l.Jh)(this,function(t){switch(t.label){case 0:return this.copilotStatusSubscription?[3,2]:(e=this,[4,this.aiNarrativesService.getCopilotStatus$().pipe((0,I.q)(1)).toPromise()]);case 1:e.copilotStatus=t.sent(),this.setCopilotStatusState(this.copilotStatus),this.copilotStatusSubscription=this.aiNarrativesService.getCopilotStatus$().subscribe(function(r){i.setCopilotStatusState(r)}),t.label=2;case 2:return[2]}})})},a.prototype.onResizing=function(e){this.updateSize(e)},a.prototype.update=function(e){return(0,l.mG)(this,void 0,void 0,function(){return(0,l.Jh)(this,function(t){switch(t.label){case 0:return e.type===k.EP.Data?[3,1]:[3,3];case 1:return[4,this.dataChanged(e)];case 2:return t.sent(),[3,3];case 3:return[2]}})})},a.prototype.dataChanged=function(e){var i;return(0,l.mG)(this,void 0,void 0,function(){var t,r,s,n,o,u;return(0,l.Jh)(this,function(h){switch(h.label){case 0:return(t=_.first(e.dataViews))?(r=t.metadata&&t.metadata.objects,this.aiNarrativesService?[3,3]:(s=this,[4,this.hostServices.aiNarrativesService()])):[2];case 1:return s.aiNarrativesService=h.sent(),n=this,[4,this.aiNarrativesService.ensureFeatureSwitches()];case 2:n.featureSwitches=h.sent(),h.label=3;case 3:return null!==(i=this.featureSwitches)&&void 0!==i&&i.aiNarrativesVisual?[4,this.ensureCopilotStatusSubscription()]:(this.setFeatureSwitchError(),[2]);case 4:return h.sent(),this.viewModel.requireVisualSelection=this.requireVisualSelection(r),[4,this.setVisualSelectionState()];case 5:return h.sent(),this.viewModel.requireVisualSelection?[2]:(this.setEmptyState(),this.settings.theme.text=this.getTextFormattingSettings(r),this.applyFormatting(),u={text:this.getUserPromptText(r)},[4,this.getUserPromptSelectedVisuals(r)]);case 6:return u.selectedVisuals=h.sent(),o=u,_.isEqual(o,this.viewModel.userPrompt)||(this.viewModel.userPrompt=o,this.getSummary(!0)),this.ensureSummarySubscription(),this.setEditorState(),[2]}})})},a.prototype.destroy=function(){var e,i;null===(e=this.copilotStatusSubscription)||void 0===e||e.unsubscribe(),null===(i=this.aiNarrativesService)||void 0===i||i.unsubscribeFromReportUpdates(),this.removeEditorFromVisualContainer(),this.visualDestroyed=!0},a.prototype.getSettings=function(){return this.settings},a.prototype.getFormattingModel=function(){return new T(this.hostServices).getFormattingModel(this.settings)},a.prototype.applyFormatting=function(){d3.select(this.aiNarrativesContainer.get(0)).style("color",this.settings.theme.text.fontColor).style("font-size",this.settings.theme.text.fontSize.px+"px").style("font-family",this.settings.theme.text.fontFamily).style("text-align",this.settings.theme.text.textAlignment)},a.prototype.getTextFormattingSettings=function(e){var i=y.v.create(this.style),t=(0,M.Zi)(e?.text,{color:"fontColor",family:"fontFamily",size:"fontSize"},i,this.style,"foreground","label",{color:y.v.getThemeColor(this.style,"foreground"),family:z.Wn.regular.family,size:A.B.createFromPt(9)}),r=(0,p.NA)(e,d.w$.text.textAlignment,V.D.left);return{fontColor:t.color,fontSize:t.size,fontFamily:t.family,textAlignment:r}},a.prototype.onViewModeChanged=function(e){this.viewModel.isEditMode=1===e,(this.viewModel.showDataReductionWarning||this.viewModel.showLLMLimitWarning)&&this.setWarnings(),this.viewModel.isEditMode?this.summaryContainer.addClass(a.editModeClass):this.summaryContainer.removeClass(a.editModeClass),this.setEditorState(),this.setEmptyState(),this.setVisualSelectionState()},a.prototype.setVisualSelectionState=function(){return(0,l.mG)(this,void 0,void 0,function(){return(0,l.Jh)(this,function(e){return this.viewModel.requireVisualSelection?(this.initialLoadOverlay.hide(),this.viewModel.isEditMode?this.visualSelectionOverlay.show():(this.visualSelectionOverlay.hide(),this.emptyStateOverlay.hide())):this.visualSelectionOverlay.hide(),[2]})})},a.prototype.requireVisualSelection=function(e){if(!this.featureSwitches.aiNarrativesSingleEntryPoint)return!1;var i=(0,p.NA)(e,d.w$.userPrompt.text);return!(0,p.NA)(e,d.w$.narrativeSelection.dismissSelectionScreen)&&!this.hasUserSetPrompt(i)},a.prototype.setVisualSelectionCopilotButtonState=function(e,i){var t=this,r=this.visualSelectionOverlay.find(".copilot");if(e)r.prop("disabled",!1),r.removeClass("disabled"),this.removeTooltip(r),r.find(".copilot-button-spinner").hide();else{r.prop("disabled",!0),r.addClass("disabled"),"PendingStatus"===i?r.find(".copilot-button-spinner").show():r.find(".copilot-button-spinner").hide();var s=function(){switch(i){case"AINarrativesVisual_NotSupported":return t.hostServices.getLocalizedString("AINarrativesVisual_Error_NotSupported");case"UserNotSignedIn":return t.hostServices.getLocalizedString("AINarrativesVisual_Error_SignInRequired_Switcher");case"AI_Disallowed":return t.hostServices.getLocalizedString("CopilotCapability_AdminDisabled_Message");case"NoneCapacity":return t.hostServices.getLocalizedString("AINarrativesVisual_Error_NoPremiumCapacity");case"AI_Scenarios_CapacityRequired":case"PowerBIFolderNotFound":case"AI_Scenarios_FolderRequired":case"AI_Scenarios_SkuNotSupported":return t.hostServices.getLocalizedString("CopilotCapability_SaveToWorkspace_Message");case"AI_DisallowedForCrossRegion":return t.hostServices.getLocalizedString("CopilotCapability_CrossGeoNotAllowed_Message");case"PendingStatus":return;default:return v.fF.assertFail("Unexpected disabled reason"),t.hostServices.getLocalizedString("AINarrativesVisual_GenericDisabled_Message")}}();s&&this.applyTextTooltip(r,s)}},a.prototype.getUserPromptText=function(e){var i=this.featureSwitches.aiNarrativesEmptyState?void 0:this.hostServices.getLocalizedString("AINarrativesVisual_DefaultUserPromptString");return(0,p.NA)(e,d.w$.userPrompt.text,i)},a.prototype.getUserPromptSelectedVisuals=function(e){return(0,l.mG)(this,void 0,void 0,function(){var i,t,r;return(0,l.Jh)(this,function(s){return(i=(0,p.NA)(e,d.w$.userPrompt.selectedVisualsJson,""))?(t=JSON.parse(i),Array.isArray(t)?(r=(0,p.NA)(e,d.w$.userPrompt.useAllVisuals,!1),[2,this.aiNarrativesService.convertSelectedVisualsArray(t,r)]):[2,t]):[2,this.featureSwitches.aiNarrativesEmptyState?void 0:this.aiNarrativesService.convertSelectedVisualsArray([],!0)]})})},a.prototype.getSummary=function(e){var i;return(0,l.mG)(this,void 0,void 0,function(){var t=this;return(0,l.Jh)(this,function(r){return this.hasUserSetPrompt(null===(i=this.viewModel.userPrompt)||void 0===i?void 0:i.text)&&this.viewModel.isSummaryAllowed?(e&&(setTimeout(function(){t.currentRequest&&t.setErrorState()},200),this.setPausedBannerState(!1)),this.setLoadingState(!0),this.currentRequest&&(this.currentRequest.unsubscribe(),this.currentRequest=null,this.setLoadingState(!1)),this.currentRequest=this.aiNarrativesService.getSummary(this.viewModel.userPrompt,e).subscribe(function(s){t.visualDestroyed||(t.setSummary(s),t.setPausedBannerState(!1))},function(s){t.visualDestroyed||(t.hostServices.setWarnings([]),t.currentRequest=null,t.handleError(s),t.setLoadingState(!1))},function(){t.visualDestroyed||(t.currentRequest=null,t.setLoadingState(!1))}),[2]):[2]})})},a.prototype.ensureSummarySubscription=function(){var i,e=this;this.isNew&&this.aiNarrativesService&&this.hasUserSetPrompt(null===(i=this.viewModel.userPrompt)||void 0===i?void 0:i.text)&&this.viewModel.isSummaryAllowed&&(setTimeout(function(){return e.getSummary(!0)},0),this.aiNarrativesService.subscribeToReportUpdates(function(t){e.getSummary(t)}),this.isNew=!1,this.initialLoadOverlay.show(),this.aiNarrativesContainer.show(),this.setEmptyState())},a.prototype.hasUserSetPrompt=function(e){return!_.isNil(e)},a.prototype.setSummary=function(e){this.viewModel.isSummaryAllowed&&(this.viewModel.summary=e.summaryHtml,this.viewModel.showDataReductionWarning=e.dataTruncationWarning,this.viewModel.showLLMLimitWarning=!1===e.isOutputComplete,this.summaryContainer.html(this.viewModel.summary),this.viewModel.summary&&this.initialLoadOverlay.hide(),this.setupReferenceLinks(e.references),this.setWarnings(),this.setErrorState())},a.prototype.setWarnings=function(){var e=[];this.viewModel.showDataReductionWarning&&e.push(this.viewModel.isEditMode?new g.ox:new g.GU),this.viewModel.showLLMLimitWarning&&e.push(this.viewModel.isEditMode?new g.iB:new g.pj),this.hostServices.setWarnings(e),this.hostServices.triggerUpdate()},a.prototype.setupReferenceLinks=function(e){var i=this;$(this.summaryContainer).find("a").each(function(t,r){var s,n=r.getAttribute("href"),o=e[n];o?($(r).addClass("referenceLink"),i.applyReferenceTooltip($(r),o,null===(s=r.textContent)||void 0===s?void 0:s.trim()),"visual"===o.referenceType?($(r).on("click",function(u){u.preventDefault(),u.stopImmediatePropagation(),i.aiNarrativesService.navigateToVisual(o.visualName,o.sectionName)}),$(r).on("pointerenter",function(){return i.aiNarrativesService.highlightVisual(o.visualName,o.sectionName)}),$(r).on("pointerleave",function(){return i.aiNarrativesService.highlightVisual(null)})):($(r).attr("tabindex",-1),$(r).attr("focusable","false"),$(r).addClass("not-clickable"),$(r).on("click",function(u){u.preventDefault(),u.stopImmediatePropagation()}))):v.fF.assertFail("No reference found in lookup for ".concat(n))})},a.prototype.setEmptyState=function(){this.isNew&&this.featureSwitches.aiNarrativesEmptyState?(this.emptyStateOverlay.show(),this.viewModel.isEditMode?this.emptyStateOverlay.find(".banner").show():this.emptyStateOverlay.find(".banner").hide()):this.emptyStateOverlay.hide()},a.prototype.setLoadingState=function(e){var i=this;0===this.loadingCounter&&e?this.viewModel.summary?this.aiNarrativesService.startProgressBar(!0):(this.initialLoadOverlay.find(".loadingContent").text(this.hostServices.getLocalizedString("AINarrativesVisual_LoadingState")),this.initialLoadOverlay.show(),this.aiNarrativesService.startProgressBar(!1)):1===this.loadingCounter&&!e&&((this.viewModel.summary||this.viewModel.error)&&this.initialLoadOverlay.hide(),this.aiNarrativesService.stopProgressBar()),this.loadingCounter+=e?1:-1,v.fF.assert(function(){return i.loadingCounter>=0},"Loading counter should never be negative")},a.prototype.setErrorState=function(e,i){this.viewModel.error=e,e&&!i?(this.showErrorOverlay(e),this.viewModel.summary=void 0):this.errorOverlay.hide(),this.viewModel.isSummaryAllowed=!e?.disallowSummary,this.ensureSummarySubscription(),this.setEditorState()},a.prototype.setEditorState=function(){var e;this.viewModel.isEditorAllowed=!(!this.aiNarrativesService||1!==this.hostServices.getViewMode()||!this.viewModel.userPrompt||null!==(e=this.viewModel.error)&&void 0!==e&&e.disallowEditor),this.viewModel.isEditorAllowed?(this.createEditorComponentInstance(),this.anchorEditorWithVisualContainer()):this.removeEditorFromVisualContainer()},a.prototype.setPausedBannerState=function(e){e?(this.pauseQueriesOverlay.show(),this.viewModel.showPausedBanner=!0):(this.pauseQueriesOverlay.hide(),this.viewModel.showPausedBanner=!1)},a.prototype.createEditorComponentInstance=function(){if(!this.aiNarrativesEditorContainer){var e=this.hostServices.getUIComponentFactory();v.fF.assertValue(e,"uiComponentFactory"),this.aiNarrativesEditorContainer=$("<section>").addClass("ai-narratives-component-container").addClass("themeableElement"),e.createAINarrativesEditor({container:this.aiNarrativesEditorContainer.get(0),visualHostService:this.aiNarrativesService,userPrompt:this.viewModel.userPrompt})}},a.prototype.anchorEditorWithVisualContainer=function(){this.hostServices.setToolbar(this.aiNarrativesEditorContainer,{preferHorizontalLayout:!0})},a.prototype.removeEditorFromVisualContainer=function(){this.hostServices.setToolbar(null)},a.prototype.updateSize=function(e){this.heightWrapper.css("height","".concat(e.height,"px"))},a.prototype.buildVisual=function(e){this.heightWrapper=$("<div>").addClass("aiNarratives-height-wrapper"),e.append(this.heightWrapper),this.pauseQueriesOverlay=this.buildPauseQueriesMessageBanner(),this.aiNarrativesContainer=this.buildSummary(),this.emptyStateOverlay=this.buildEmptyState(),this.initialLoadOverlay=this.buildInitialLoadOverlay(),this.errorOverlay=this.buildErrorOverlay(),this.visualSelectionOverlay=this.buildVisualSelectionOverlay();var i=$("<div>").addClass("aiNarratives-wrapper");this.heightWrapper.append(this.pauseQueriesOverlay,i),i.append(this.aiNarrativesContainer,this.emptyStateOverlay,this.initialLoadOverlay,this.errorOverlay,this.visualSelectionOverlay)},a.prototype.buildSummary=function(){var e=this.hostServices.getLocalizedString("AINarrativesVisual_Label");this.summaryContainer=$("<div>").addClass(a.SummaryContainer.class),this.viewModel.isEditMode&&this.summaryContainer.addClass(a.editModeClass);var i=this.hostServices.getLocalizedString("AINarrativesVisual_FooterCreatedWithAI"),t=$("<p>").text(i),r=this.hostServices.getLocalizedString("CopilotInline_PreviewLink"),s=$("<a>").addClass("termsLink pbi-external-link").text(r).attr("href",this.copilotTermsLink).attr("target","_blank").attr("rel","noreferrer noopener"),n=$("<footer>").addClass("summaryFooter");n.append(t),t.append(s);var o=$("<article>").attr("aria-label",e).attr("tabindex",0).attr("focusable","true").attr("focus-nav-mode","Group").addClass(a.AINarrativesContainer.class);return o.append(this.summaryContainer,n),o.hide(),o},a.prototype.buildEmptyState=function(){var e=$("<div>").addClass("aiNarratives-overlay emptyState"),i=$("<div>").addClass("banner");e.append(i),i.append($("<div>").addClass("glyphicon pbi-glyph-info glyph-small"));var t=$("<div>").addClass("bannerText");i.append(t),t.append($("<span>").text(this.hostServices.getLocalizedString("AINarrativesVisual_EmptyState_Text")));var r=$("<a>").addClass("termsLink").text(this.hostServices.getLocalizedString("CopilotInline_PreviewLink")).attr("href",this.copilotTermsLink).attr("target","_blank").attr("rel","noreferrer noopener");return t.append(r),e.append($(w)),e.hide(),e},a.prototype.buildVisualSelectionOverlay=function(){var e=this,i=$("<div>").addClass("aiNarratives-overlay visualSelection"),t=$("<div>").addClass("visualSelectionCard");i.append(t);var r=$("<div>").addClass("title");r.text(this.hostServices.getLocalizedString("AINarrativesVisual_VisualSelectionTitle")),t.append(r);var s=$("<div>").addClass("content");s.text(this.hostServices.getLocalizedString("AINarrativesVisual_VisualSelectionContent")),t.append(s);var n=this.hostServices.getLocalizedString("AINarrativesVisual_VisualSelectionReadTerms"),o=$("<a>").addClass("emptyStateTermsLink pbi-external-link").text(n).attr("href",this.copilotTermsLink).attr("target","_blank").attr("rel","noreferrer noopener");s.append(o);var u=$("<div>").addClass("actions");t.append(u);var h=$("<button>").addClass("copilot primary"),b=$('\n            <svg class="copilot-button-spinner" style="display: none;">\n                <circle class="copilot-button-spinner-track" />\n                <circle class="copilot-button-spinner-tail" />\n            </svg>\n        ');h.append(b,$(w),$("<div>").text(this.hostServices.getLocalizedString("Copilot_Preview"))),h.on("click",function(){return e.onClickCopilotButton()}),u.append(h);var f=$("<button>").addClass("custom");f.text(this.hostServices.getLocalizedString("Custom")),f.on("click",function(){return(0,l.mG)(e,void 0,void 0,function(){return(0,l.Jh)(this,function(L){switch(L.label){case 0:return[4,this.hostServices.aiNarrativesService()];case 1:return L.sent().convertToSmartNarrativesVisual(),[2]}})})}),u.append(f);var N=$("<div>").addClass("infoColumn");i.append(N);var E=$("<div>").addClass("glyphicon pbi-glyph-info glyph-small").attr("tabindex","0");return this.applyTextTooltip(E,this.hostServices.getLocalizedString("AINarrativesVisual_VisualSelectionInfo")),N.append(E),i.hide(),i},a.prototype.onClickCopilotButton=function(){return(0,l.mG)(this,void 0,void 0,function(){var e,i,t;return(0,l.Jh)(this,function(r){switch(r.label){case 0:return(e=this.copilotStatus)?!e.enabled&&e.isFixable?[4,this.aiNarrativesService.remediateCopilotStatus()]:[3,2]:(v.fF.assertFail("Copilot status should be set by the time you can click the Copilot button"),[2]);case 1:return e=r.sent(),[3,3];case 2:!e.enabled&&!e.isFixable&&v.fF.assertFail("Copilot button should be disabled if status is not fixable"),r.label=3;case 3:return e.enabled&&(i={merge:[{objectName:d.w$.narrativeSelection.dismissSelectionScreen.objectName,properties:(t={},t[d.w$.narrativeSelection.dismissSelectionScreen.propertyName]=!0,t),selector:null}]},this.hostServices.persistProperties(i),this.hostServices.triggerUpdate()),[2]}})})},a.prototype.buildInitialLoadOverlay=function(){var e=$("<div>").addClass("aiNarratives-overlay initialLoad"),i=$("<div>").addClass("loadingCard"),t=$("<div>").addClass("loadingContent");t.text(this.hostServices.getLocalizedString("AINarrativesVisual_LoadingState"));var r=$("<div>").addClass("wrapper"),s=$("<div>").addClass("loadingBar");return i.append(t),r.append(s),e.append(i,r),e.hide(),e},a.prototype.buildErrorOverlay=function(){var e=this,i=$("<div>").addClass("aiNarratives-overlay errorMessage"),t=$("<div>").addClass("glyphicon pbi-glyph-error glyph-med");i.append(t);var r=$("<div>").addClass("errorDiv");i.append(r);var s=$("<span>").addClass("errorSpan").text("Error");r.append(s);var n=$("<button>").addClass("errorSeeMore").text(this.hostServices.getLocalizedString("VisualContainer_ShowErrorDetails")).on("click",function(h){return e.showErrorDetails(h)});r.append(n);var o=$("<button>").addClass("errorFixIt").text(this.hostServices.getLocalizedString("ErrorBar_FixItText"));r.append(o);var u=$("<a>").addClass("termsLink pbi-external-link").text(this.hostServices.getLocalizedString("Generic_LearnMore_With_Period")).attr("href",this.learnMoreLink).attr("target","_blank").attr("rel","noreferrer noopener");return r.append(u),i.hide(),i},a.prototype.buildPauseQueriesMessageBanner=function(){var e=this,i=$("<div>").addClass("aiNarratives-messageBanner pauseQueries"),t=$("<div>").addClass("glyphicon pbi-glyph-info glyph-small pause-info-icon");this.applyTextTooltip(t,this.hostServices.getLocalizedString("AINarrativesVisual_Paused_Visual_Info"));var r=$("<span>").text(this.hostServices.getLocalizedString("Paused_Visual_Pending_Status")).addClass("message"),s=$("<div>").addClass("pause-wrapper");s.append(t,r),i.append(s);var n=$("<button>").text(this.hostServices.getLocalizedString("Refresh")).addClass("pbi-fluent-button banner-refresh-button").on("click",function(o){o.stopPropagation(),e.getSummary(!0)});return i.append(n),i.hide(),i},a.prototype.handleError=function(e){if(_.isNil(e))this.setErrorState({code:"",details:{message:this.hostServices.getLocalizedString("ServiceError_CapacityPausedTitle"),displayableErrorInfo:[],source:"PowerBI"},disallowEditor:!0});else{var i=e.code,t="pbi.error"in e;switch(i){case F.e$:this.setPausedBannerState(!0);break;case"PendingStatus":this.initialLoadOverlay.find(".loadingContent").text(this.hostServices.getLocalizedString("AINarrativesVisual_Error_StatusCheckPending")),this.initialLoadOverlay.show(),this.setErrorState({code:e.code,details:null,disallowSummary:!0,disallowEditor:!0},!0);break;case"UserNotSignedIn":this.setErrorState({code:e.code,details:{message:this.hostServices.getLocalizedString("AINarrativesVisual_Error_SignInRequired"),displayableErrorInfo:[]},disallowSummary:!0,disallowEditor:!0,fixItLink:e.isFixable?"SignIn":"None"});break;case"AI_Scenarios_CapacityRequired":case"PowerBIFolderNotFound":case"AI_Scenarios_FolderRequired":case"AI_Scenarios_SkuNotSupported":case"NoWorkspaceId":this.setErrorState({code:e.code,details:{message:this.hostServices.getLocalizedString(e.isFixable?"CopilotCapability_SelectAWorkspace_Message":"CopilotCapability_SaveToWorkspace_Message"),displayableErrorInfo:[],hideDebugInfo:!0},disallowEditor:!0,disallowSummary:!0,showLearnMore:!e.isFixable,fixItLink:e.isFixable?"FixWorkspace":"None"});break;case"NoneCapacity":this.setErrorState({code:e.code,details:{message:this.hostServices.getLocalizedString("AINarrativesVisual_Error_NoPremiumCapacity"),displayableErrorInfo:[],hideDebugInfo:!0},disallowEditor:!0,disallowSummary:!0,showLearnMore:!e.isFixable,fixItLink:e.isFixable?"FixWorkspace":"None"});break;case"AI_Scenarios_CapacityLimitExceeded":this.setErrorState({code:e.code,details:{message:this.hostServices.getLocalizedString("Copilot_Throttled"),displayableErrorInfo:[]}});break;case"AI_Disallowed":this.setErrorState({code:e.code,details:{message:this.hostServices.getLocalizedString("CopilotCapability_AdminDisabled_Message"),displayableErrorInfo:[],hideDebugInfo:!0},disallowEditor:!0,disallowSummary:!0,showLearnMore:!e.isFixable,fixItLink:e.isFixable?"FixWorkspace":"None"});break;case"AI_DisallowedForCrossRegion":this.setErrorState({code:e.code,details:{message:this.hostServices.getLocalizedString("CopilotCapability_CrossGeoNotAllowed_Message"),displayableErrorInfo:[],hideDebugInfo:!0},disallowEditor:!0,disallowSummary:!0,showLearnMore:!e.isFixable,fixItLink:e.isFixable?"FixWorkspace":"None"});break;case"AINarrativesVisual_NotSupported":case"DataContext_Unavailable":this.setErrorState({code:e.code,details:{message:this.hostServices.getLocalizedString("AINarrativesVisual_Error_NotSupported"),displayableErrorInfo:[],hideDebugInfo:!0},disallowEditor:!0,disallowSummary:!0});break;case"DataContext_NoAvailableVisuals":this.setErrorState({code:e.code,details:{message:this.hostServices.getLocalizedString(this.viewModel.isEditMode?"AINarrativesVisual_Error_NoAvailableVisuals":"AINarrativesVisual_Error_ContactReportCreator"),displayableErrorInfo:[],source:e.source},disallowEditor:!1});break;case"DataContext_NoSelectedVisuals":this.setErrorState({code:e.code,details:{message:this.hostServices.getLocalizedString(this.viewModel.isEditMode?"AINarrativesVisual_Error_NoSelectedVisuals":"AINarrativesVisual_Error_ContactReportCreator"),displayableErrorInfo:[],source:e.source},disallowEditor:!1,fixItLink:this.viewModel.isEditMode?"OpenEditor":"None"});break;case"DataContext_NoData":this.setErrorState({code:e.code,details:{message:this.hostServices.getLocalizedString(this.viewModel.isEditMode?"AINarrativesVisual_Error_NoData":"AINarrativesVisual_Error_ContactReportCreator"),displayableErrorInfo:[],source:e.source},disallowEditor:!1});break;case"DataContext_TooManyVisuals":this.setErrorState({code:e.code,details:{message:this.hostServices.getLocalizedString(this.viewModel.isEditMode?"AINarrativesVisual_Error_TooManyVisuals":"AINarrativesVisual_Error_ContactReportCreator"),displayableErrorInfo:[],source:e.source},disallowEditor:!1});break;case"DataContext_QueryError":this.setErrorState({code:e.code,details:e.getDetails(this.stringResourceProvider),disallowEditor:!1});break;case"UnknownStatus":this.setErrorState({code:e.code,details:{message:this.hostServices.getLocalizedString("AINarrativesVisual_GenericDisabled_Message"),displayableErrorInfo:[]},disallowEditor:!0,disallowSummary:!0});break;default:var r=void 0;t?r=this.getDisplayableErrorInfo(e["pbi.error"].details):e.getDetails?r=e.getDetails(this.stringResourceProvider).displayableErrorInfo:e.message&&(r=[{errorInfoKey:this.hostServices.getLocalizedString("AINarrativesVisual_Error_UnableToCreateSummary"),errorInfoValue:e.message}]);var s={code:i,details:{message:this.hostServices.getLocalizedString("AINarrativesVisual_Error_UnableToCreateSummary"),displayableErrorInfo:r,showSeeDetails:!!r,source:t?"PowerBI":e.source},disallowEditor:!1};this.setErrorState(s)}}},a.prototype.getDisplayableErrorInfo=function(e){if(!e)return null;for(var i=[],t=0,r=e;t<r.length;t++){var s=r[t];i.push({errorInfoKey:s.code,errorInfoValue:s.detail.value})}return i},a.prototype.showErrorOverlay=function(e){var t,r,i=this;this.errorOverlay.find(".errorSpan").text(null===(t=e.details)||void 0===t?void 0:t.message);var n=this.errorOverlay.find(".errorSeeMore");null!==(r=e.details)&&void 0!==r&&r.showSeeDetails?n.show():n.hide();var o=this.errorOverlay.find(".errorFixIt"),u=function(f){f.stopPropagation(),i.aiNarrativesService.remediateCopilotStatus()};switch(o.off("click"),e.fixItLink){case"OpenEditor":o.text(this.hostServices.getLocalizedString("ErrorBar_FixItText")),o.show();break;case"SignIn":o.on("click",u),o.text(this.hostServices.getLocalizedString("AuthDialog_LinkText_SignIn")),o.show();break;case"FixWorkspace":o.on("click",u),o.text(this.hostServices.getLocalizedString("WorkspacesSelect_Label_Text")),o.show();break;default:o.hide()}var h=this.errorOverlay.find(".termsLink");e.showLearnMore?h.show():h.hide(),this.errorOverlay.show()},a.prototype.showErrorDetails=function(e){var i;e.stopPropagation();var t=this.viewModel.error;v.fF.assertValue(t,"No error to show details for"),null===(i=this.aiNarrativesService)||void 0===i||i.showErrorDialog(t.code,t.details,!1,!0)},a.prototype.setFeatureSwitchError=function(){this.setErrorState({code:"AINarrativesDisabled",details:{message:this.hostServices.getLocalizedString("AINarrativesVisual_Error_FeatureDisabled"),displayableErrorInfo:[]},disallowSummary:!0,disallowEditor:!0})},a.prototype.setCopilotStatusState=function(e){return(0,l.mG)(this,void 0,void 0,function(){var i;return(0,l.Jh)(this,function(t){return i=e.enabled&&this.copilotStatus&&!this.copilotStatus.enabled,this.copilotStatus=e,e.enabled?(this.setErrorState(),this.setVisualSelectionCopilotButtonState(!0),this.initialLoadOverlay.hide()):(this.handleError({code:e.reason,isFixable:e.isFixable}),this.setVisualSelectionCopilotButtonState(e.isFixable,e.reason),this.setPausedBannerState(!1)),i&&this.getSummary(!0),[2]})})},a.prototype.applyTextTooltip=function(e,i){var r,t=this;e.on("focus mouseenter",function(){r=t.renderTextTooltip(e.get(0),i)}),e.on("blur mouseleave",function(){r?.close(),r=null})},a.prototype.renderTextTooltip=function(e,i){var t;return this.textTooltip&&this.textTooltip.close(),this.textTooltip=null===(t=this.hostServices.getUIComponentFactory())||void 0===t?void 0:t.createTooltip(e,i),this.textTooltip},a.prototype.applyReferenceTooltip=function(e,i,t){var r=this;e.on("focus mouseenter",function(){r.renderReferenceTooltip(e.get(0),i,t)}),e.on("blur mouseleave",function(){r.aiNarrativesService.hideTooltip()})},a.prototype.renderReferenceTooltip=function(e,i,t){this.aiNarrativesService.showTooltip(e,i,t)},a.prototype.removeTooltip=function(e){e.off("focus mouseenter blur mouseleave keydown")},a.SummaryContainer=(0,C.CH)("summaryContainer"),a.AINarrativesContainer=(0,C.CH)("aiNarrativeContainer"),a.editModeClass="editMode",a}()}}]);