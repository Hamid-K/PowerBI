"use strict";(self.webpackChunkdesktopDataExplore=self.webpackChunkdesktopDataExplore||[]).push([["quick-calc"],{15175:function(ne,y,r){r.r(y),r.d(y,{QuickCalcModule:function(){return ae}});var d=r(81337),Q=r(22695),S=r(40112),D=r(57151),z=r(80435),P=r(35911),N=r(28199),A=r(26898),O=r(83008),V=r(40823),j=r(66890),I=r(68082),U=r(53439),p=r(54834),L=r(60661),k=r(62458),B=r(98094),x=r(94419),J=r(45334),X=r(65181),H=r(75334),C=r(12985),M=r(4633),K=r(58938),W=r(48787),g=r(74082),Z=r(58295),$=r(45413),E=function(c){function e(t){return c.call(this,t)||this}return(0,d.__extends)(e,c),e}(P.sH),Y={provide:"quickCalcModern",useFactory:function(c,e,t,a,n,i,s,o,u,m,l,h){var v=new b(c,e,t,a,n,i,s,o,u,m,l,h);return Promise.resolve(v)},deps:[N.C,A.i,O.D,X.o,U.S,I.n,D.c,j.$8,M.y0,z.r3,K.x,V._]},b=function(){function c(e,t,a,n,i,s,o,u,m,l,h,v){this.aggrOps=e,this.conceptualSchemaProxy=t,this.dataSources=a,this.localizationService=n,this.modelAuthoring=i,this.dataModelService=s,this.daxTemplateService=o,this.visualAuthoringService=u,this.telemetryService=m,this.daxCapabilitiesService=l,this.dialogService=h,this.dataSourceSerializer=v}return c.prototype.buildDaxTemplateArgs=function(e,t,a){return(0,d.__awaiter)(this,void 0,void 0,function(){var n,i,s,o,u,m,l,h;return(0,d.__generator)(this,function(v){switch(v.label){case 0:return n=this.dataSources.get(),[4,this.conceptualSchemaProxy.get(n)];case 1:return i=v.sent(),a?s=_.sortBy((0,L.oJ)(a.visualContainer),function(f){return(0,$.fS)(e,f.expr)?0:1}):(0,g.Lk)(e)?(s=[],o=e):((m=(u=e).getMetadata(i))&&m.type.numeric&&!J.m.discourageAggregation(e,i)&&(u=this.aggrOps.createExprWithAggregate(e,i,!0,[{numeric:!0}])),s=[{expr:u,name:void 0}]),l=this.telemetryService.logEvent(S.lp,{entryPoint:t,numberOfSelects:s.length}),h=function(c){for(var e=0,t=c.schemas;e<t.length;e++){var a=t[e];if(a.capabilities.canEdit)return a.name}}(i),[2,{selects:_.map(s,function(f){return p.ib.serializeExpr(f.expr)}),dataSources:this.dataSourceSerializer.serializeDataSources(n),schemaName:h,openDaxTemplateEvent:l,targetEntity:o&&p.ib.serializeExpr(o)}]}})})},c.prototype.launchDaxTemplateDialog=function(e,t,a){return(0,d.__awaiter)(this,void 0,void 0,function(){var n,i,s,o,m=this;return(0,d.__generator)(this,function(l){switch(l.label){case 0:return k.fF.assertValue(e,"expression"),[4,this.daxCapabilitiesService.getCapabilities()];case 1:return n=l.sent(),i=this.telemetryService.startChildEvent(t.openDaxTemplateEvent,S.Xi,{}),[4,this.conceptualSchemaProxy.get(this.dataSources.get())];case 2:return s=l.sent(),o=new B.B,[4,this.showQuickCalcDialog(t)];case 3:return l.sent().afterClosed().pipe((0,W.q)(1)).subscribe(function(h){return(0,d.__awaiter)(m,void 0,void 0,function(){return(0,d.__generator)(this,function(v){switch(v.label){case 0:return v.trys.push([0,,2,3]),[4,this.handleQuickCalcDialogResult(e,h,s,t.schemaName,n,i,a)];case 1:return v.sent(),[3,3];case 2:return o.resolve(),[7];case 3:return[2]}})})}),[4,o.promise];case 4:return l.sent(),[2]}})})},c.prototype.handleQuickCalcDialogResult=function(e,t,a,n,i,s,o){return(0,d.__awaiter)(this,void 0,void 0,function(){var u,m,l,h,v,f=this;return(0,d.__generator)(this,function(F){switch(F.label){case 0:return u=this.dataSources.get(),s.event.info.connectionimport=this.getConnectionType(a,n),t?(m=this.daxTemplateService.getTemplates(a,i,n,1),(l=_.find(m,function(ie){return ie.capabilities.name===t.template.name}))?(s.event.info.selectedQuickMeasure=l.capabilities.name,s.resolve(),[4,this.createNewMeasureInternal(t,l,a,i)]):(s.event.info.selectedQuickMeasure="Cancel",s.resolve(),[2,Promise.reject(new E("Dax template undefined"))])):(s.event.info.selectedQuickMeasure="Cancel",s.resolve(),[2]);case 1:return h=F.sent(),o&&(v=(0,x.mv)((0,x.nw)(h.schema,h.entity),h.name),this.visualAuthoringService.addFieldToVisual(v,u,o.visualContainer).catch(function(){return(0,Z.k)(e)?f.visualAuthoringService.replaceField(v,o.role,o.index,o.visualContainer,u):Promise.reject(new E("Original expression is not a measure"))})),[2]}})})},c.prototype.showQuickCalcDialog=function(e){return(0,d.__awaiter)(this,void 0,void 0,function(){var t;return(0,d.__generator)(this,function(a){return t={title:this.localizationService.get("QuickMeasure"),input:e,hideOkButton:!1,hideCancelButton:!1,footerLink:{text:this.localizationService.get("DaxTemplates_IdeasPost"),url:"https://go.microsoft.com/fwlink/?linkid=842906",type:"external"}},[2,this.dialogService.showTemplateDialog(Q.T,t)]})})},c.prototype.createNewQuickMeasure=function(e,t,a,n,i,s){return(0,d.__awaiter)(this,void 0,void 0,function(){var o,u,m,l,h;return(0,d.__generator)(this,function(v){switch(v.label){case 0:return o=H.cm.makeValidName(this.dataModelService.getDataModel(),this.localizationService,"Measure",e,a,t),(u=[]).push(m={newMeasureCreated:{entity:e,name:o,schema:t,expression:n}}),l={version:0,daxTemplateName:i},u.push({setJsonExtendedMetadata:{modelObject:C.X6.getMeasureUrn(e,o,t),name:"MeasureTemplate",value:JSON.stringify(l)}}),(h=s(o))&&u.push(h),[4,this.modelAuthoring.apply({changes:u})];case 1:return v.sent(),[2,m.newMeasureCreated]}})})},c.prototype.createNewMeasureInternal=function(e,t,a,n){var i=this,s=_.mapValues(e.parameters,function(v){return{expression:p.ib.deserializeExpr(v.expression)}}),o=t.apply(a,n,{schemaName:e.newMeasureMetadata.schema,inputValues:s});return this.createNewQuickMeasure(e.newMeasureMetadata.entity,e.newMeasureMetadata.schema,e.newMeasureMetadata.measureName,o.dax,t.capabilities.name,function(f){return i.getFormattingSchemaChange(e.newMeasureMetadata,f,a)})},c.prototype.getFormattingSchemaChange=function(e,t,a){if(null!=e.formatType){var n=this.convertFormatToFormatKind(e.formatType);if(n)return{setFormatting:{format:n,modelObject:C.X6.getMeasureUrn(e.entity,t,e.schema)}}}else if(e.formatSource){var i=this.getActualFormattingSource(e.formatSource,a);if(i)return{copyFormatting:{sourceSchema:i.schema,sourceEntity:i.entity,sourceProperty:i.property,schema:e.schema,targetEntity:e.entity,targetProperty:t,objectType:"Measure"}}}},c.prototype.getActualFormattingSource=function(e,t){var a=p.ib.deserializeExpr(e);if((0,g.kb)(a))return(n=a.source.getTargetEntity())&&{schema:n.schema,entity:n.entity,property:a.ref};if((0,g.iV)(a)){var i=a.arg.getTargetColumnRef(t);if(!i)return;var s=a.getMetadata(t),o=i.getMetadata(t),n=i.source.getTargetEntity();return s&&o&&n&&s.type.isCompatibleFrom(o.type)&&{schema:n.schema,entity:n.entity,property:i.ref}}},c.prototype.convertFormatToFormatKind=function(e){if(0===e)return"Percentage"},c.prototype.getConnectionType=function(e,t){return e.schema(t).isExtensionSchema?"LiveConnect":"InternalModel"},c}(),R=r(52910),q=r(31109),ee=r(22346),te=r(75768),re=r(90938),T=r(50423),ae=function(){function c(){}return c.\u0275fac=function(t){return new(t||c)},c.\u0275mod=T.\u0275\u0275defineNgModule({type:c}),c.\u0275inj=T.\u0275\u0275defineInjector({providers:[Y],imports:[R.O,q.F,ee.J,te.Zz,M.e3,re.g]}),c}()}}]);