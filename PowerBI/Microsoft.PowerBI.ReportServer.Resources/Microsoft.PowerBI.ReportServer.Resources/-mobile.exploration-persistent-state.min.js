"use strict";(self.webpackChunkmobile=self.webpackChunkmobile||[]).push([["exploration-persistent-state"],{51177:function(At,O,p){p.r(O),p.d(O,{ExplorationPersistentStateModule:function(){return Ht}});var c=p(81337),et=p(18873),it=p(48145),rt=p(77200),P=p(11494),b=p(39503),M=p(9380),D=p(28894),w=p(8590),nt=p(83400),T=p(65195),at=p(43286),F=p(65181),C=p(46544),st=p(43743),ot=p(72308),ut={provide:"dirtyStateHandler",useFactory:function(o,t,e,i,a,n,r,s,u,l,v){return new ct(window,t,e,o,i,a,n,r,s,u,l,v)},deps:[st.l,M.vZ,ot.a,it.U,D.H,F.o,et.W,C.BE,rt.kc,P.J,b.z]},ct=function(){function o(t,e,i,a,n,r,s,u,l,v,h,f){var d=this;this.windowService=t,this.featureSwitchService=e,this.explorationResolver=i,this.checkUnsavedService=a,this.explorationCapabilities=n,this.lazyScopedProviderModern=r,this.localization=s,this.navigation=u,this.pageVisibility=l,this.viewModeState=v,this.eventBridge=h,this.explorationNavigation=f,this.onUnloadCallback=function(){return d.onWindowUnload()}}return o.prototype.registerHandler=function(t){return(0,c.mG)(this,void 0,void 0,function(){var e,i=this;return(0,c.Jh)(this,function(a){switch(a.label){case 0:return this.unRegisterHandler(),[4,this.lazyScopedProviderModern.get("persistentState")];case 1:return e=a.sent(),this.channelSubscriptionManager=this.eventBridge.createChannelSubscriptionManager().subscribe(w.t4l,function(n,r){i.resetPageVisibilityHandler();var s=i.viewModeState.getMode();i.reportChangedInEditMode=r.explorationContentChanged&&1===s,i.checkUnsavedService.setReportSavedState(i.reportChangedInEditMode),i.userStateChangedInViewMode=r.explorationContentChanged&&0===s,i.explorationCapabilities.getCapabilities().persistentUserStateEnabled&&i.userStateChangedInViewMode&&(e.captureUserState(),i.setupPageVisibilityHandler(e))}).subscribe(w.R4M,function(n,r){return(0,c.mG)(i,void 0,void 0,function(){return(0,c.Jh)(this,function(s){return[2,this.trySave(e,t,{preventDefault:n.preventDefault},{viewMode:r.targetViewMode},{viewMode:r.startViewMode},void 0,!0)]})})}),this.windowService.addEventListener(T.OV,this.onUnloadCallback),this.explorationResolver.setDirtyHandler(function(n,r){return i.trySave(e,t,void 0,void 0,void 0,n,r)}),[2]}})})},o.prototype.unRegisterHandler=function(){this.userStateChangedInViewMode=!1,this.reportChangedInEditMode=!1,this.resetReportChangedListener(),this.resetRouteChangeListeners(),this.resetPageVisibilityHandler(),this.resetOnWindowUnloadListener()},o.prototype.resetReportChangedListener=function(){this.channelSubscriptionManager&&(this.channelSubscriptionManager.unsubscribeAll(),this.channelSubscriptionManager=null)},o.prototype.resetRouteChangeListeners=function(){this.routeStateChangeEvent&&(this.routeStateChangeEvent(),this.routeStateChangeEvent=null)},o.prototype.setupPageVisibilityHandler=function(t){var e=this;this.pageVisibilityHandler||(this.pageVisibilityHandler={onBrowserTabHidden:function(){e.resetPageVisibilityHandler(),t.saveState()}}),this.pageVisibility.register(this.pageVisibilityHandler)},o.prototype.resetPageVisibilityHandler=function(){this.pageVisibilityHandler&&this.pageVisibility.unregister(this.pageVisibilityHandler)},o.prototype.resetOnWindowUnloadListener=function(){this.windowService.removeEventListener(T.OV,this.onUnloadCallback)},o.prototype.onWindowUnload=function(){var t=this.viewModeState.getMode();if(this.checkUnsavedService.userHasUnsavedWork&&1===t)return this.localization.get("ReportContainer_WindowUnload")},o.prototype.trySave=function(t,e,i,a,n,r,s){return(0,c.mG)(this,void 0,void 0,function(){var u,l,v,h,f;return(0,c.Jh)(this,function(S){switch(S.label){case 0:return u=this.explorationCapabilities.getCapabilities().persistentUserStateEnabled,l=(0,nt.sk)(this.explorationNavigation.getAllSections()),v=this.explorationResolver.getCurrentReport(),h=!v||(0,at.yE)(v.permissions,2),this.reportChangedInEditMode||l&&this.userStateChangedInViewMode&&null==n&&null==a&&h?(i&&i.preventDefault(),[2,e(r,s)]):[3,1];case 1:return u?this.userStateChangedInViewMode?(t.saveState(),[3,6]):[3,2]:[3,7];case 2:return n&&a&&1===n.viewMode&&0===a.viewMode?[4,t.reset()]:[3,6];case 3:return S.sent(),f={persistentUserStateThrottlingEnabled:this.explorationCapabilities.getCapabilities().persistentUserStateThrottlingEnabled},[4,this.lazyScopedProviderModern.get("originalExplorationState")];case 4:return[4,S.sent().captureOriginalExplorationState(void 0)];case 5:S.sent(),t.init(f,void 0),S.label=6;case 6:return[2,0];case 7:return[2]}})})},o}(),pt=p(40290),H=p(47497),m=p(62458),j=p(64329),I=p(5265),vt=p(45413),y=p(50423),ht=function(){function o(){}return o.prototype.diff=function(t,e,i){m.fF.assertValue(t,"original"),m.fF.assertValue(e,"other");var a=e.activeSection!==t.activeSection,n=e.dataSourceVariables&&e.dataSourceVariables!==t.dataSourceVariables,r={activeSection:a?e.activeSection:void 0,dataSourceVariables:n?e.dataSourceVariables:void 0},s=this.diffSections(t.sections,e.sections,i);_.isEmpty(s)||(r.sections=s);var u=this.diffFilterStates(t.filters,e.filters);_.isEmpty(u)||(r.filters=u);var l=this.diffExplorationObjects(t.objects,e.objects);if(_.isEmpty(l)||(r.objects=l),!(_.isEmpty(s)&&_.isEmpty(u)&&_.isEmpty(l))||a||n)return r},o.prototype.diffExplorationObjects=function(t,e){var i={};for(var a in t=t||{merge:{}},(e=e||{merge:{}}).merge)for(var n=0,r=e.merge[a];n<r.length;n++){var s=r[n],u=(0,I.d9)(t.merge),l=(0,I.zx)(u,a,s.selector);for(var v in s.properties){var h=s.properties[v];(0,I.ES)(l.properties[v],h)||(i.merge=i.merge||{},(0,I.sO)(i.merge,{objectName:a,propertyName:v},null,h))}}return i},o.prototype.diffSections=function(t,e,i){if(t&&e){var a={};for(var n in e){var s=t[n];if(s){var u=this.diffSectionState(s,e[n],i);u&&(a[n]=u)}}return a}},o.prototype.diffSectionState=function(t,e,i){m.fF.assertValue(t,"original"),m.fF.assertValue(e,"other");var a={},n=!1,r=this.diffVisualContainers(t.visualContainers,e.visualContainers,i);_.isEmpty(r)||(a.visualContainers=r,n=!0);var s=this.diffVisualContainerGroups(t.visualContainerGroups,e.visualContainerGroups);_.isEmpty(s)||(a.visualContainerGroups=s,n=!0);var u=this.diffFilterStates(t.filters,e.filters);return _.isEmpty(u)||(a.filters=u,n=!0),n&&a},o.prototype.diffVisualContainers=function(t,e,i){if(t&&e){var a={};for(var n in e){var r={},s=e[n],u=t[n];if(u){var l=this.diffFilterStates(u.filters,s.filters);_.isEmpty(l)||(r.filters=l),u.highlight!==s.highlight&&(r.highlight=s.highlight),u.visibility!==s.visibility&&(r.visibility=s.visibility);var v=(0,H.jp)(u.singleVisual,r.visibility,i),h=(0,H.jp)(s.singleVisual,r.visibility,i);(0,j.fS)(v,h)||(r.singleVisual=s.singleVisual),_.isEmpty(r)||(a[n]=r)}}return a}},o.prototype.diffVisualContainerGroups=function(t,e){if(t&&e){var i={};for(var a in e){var n={},r=e[a],s=t[a];if(s){var u=void 0;s.isHidden!==r.isHidden&&(n.isHidden=r.isHidden,u=!0);var l=r.children,v=s.children;if(!_.isEmpty(v)&&!_.isEmpty(l)){var h=this.diffVisualContainerGroups(v,l);_.isEmpty(h)||(n.children=h,u=!0)}u&&(i[a]=n)}}return _.isEmpty(i)?void 0:i}},o.prototype.diffFilterStates=function(t,e){if(!t)return e;var i={},a=this.diffFilterContainerStatesDictionary(t.nameIdentifiedMerges,(e=e||{}).nameIdentifiedMerges);_.isEmpty(a)||(i.nameIdentifiedMerges=a);var n=function(h,f){return(0,vt.fS)(f.expression,h.expression)&&f.howCreated===h.howCreated},r=this.diffFilterContainerStatesArray(t.exprIdentifiedMerges,e.exprIdentifiedMerges,n);_.isEmpty(r)||(i.exprIdentifiedMerges=r);var s=this.diffFilterContainerStatesArray(t.transientFilters,e.transientFilters,n);_.isEmpty(s)||(i.transientFilters=s);var l=this.diffFilterContainerStatesArray(t.typeIdentifiedMerges,e.typeIdentifiedMerges,function(h,f){return f.type===h.type});return _.isEmpty(l)||(i.typeIdentifiedMerges=l),i},o.prototype.diffFilterContainerStatesDictionary=function(t,e){if(_.isEmpty(t))return e;var i={},a=_.clone(e||{});for(var n in t){var r=t[n],s=a[n];if(delete a[n],s){var u=this.diffFilterContainerStates(r,s);if(!u)continue;i[n]=u}else{var l=this.createClearedFilterContainerState(r);if(!l)continue;i[n]=l}}return i},o.prototype.diffFilterContainerStatesArray=function(t,e,i){if(_.isEmpty(t))return e;for(var a=[],n=(0,c.ev)([],(e=e||[])||[],!0),r=function(f){var d=_.findIndex(n,function(R){return i(f,R)}),S=n[d];if(_.pullAt(n,d),S){var x=s.diffFilterContainerStates(f,S);if(!x)return"continue";a.push(x)}else{var E=s.createClearedFilterContainerState(f);if(!E)return"continue";a.push(E)}},s=this,u=0,l=t;u<l.length;u++)r(l[u]);return n.length>0&&a.push.apply(a,n),a},o.prototype.diffFilterContainerStates=function(t,e){if(!t||!(0,j.fS)(t,e))return e},o.prototype.createClearedFilterContainerState=function(t){if(t&&t.type!==pt.vA.Passthrough)return{name:t.name,type:t.type,expression:t.expression,howCreated:t.howCreated}},o.\u0275prov=y.\u0275\u0275defineInjectable({token:o,factory:o.\u0275fac=function(e){return new(e||o)},providedIn:"root"}),o}(),g=p(41114),A="PBI.PersistentState.SaveRequest",ft=g.cx[A]=(0,g.b1)(A),J="PBI.PersistentState.DeleteRequest",B=g.cx[J]=(0,g.b1)(J),G="PBI.PersistentState.Init",N=g.cx[G]=(0,g.b1)(G),k="PBI.OriginalExplorationState.Capture",dt=g.cx[k]=(0,g.b1)(k),L="PBI.PersistentState.ThrottledSave",St=g.cx[L]=(0,g.b1)(L),V=p(26898),z=p(49080),yt=p(3404),gt=p(39445),U=p(83008),W=p(14463),mt=p(26112),xt=p(40960),Z=p(60661),Ct={provide:"originalExplorationState",useFactory:function(o,t,e,i,a,n,r,s,u,l){return new bt(o,t,e,i,a,n,r,s,u,l)},deps:[V.i,xt.Y,U.D,b.z,z.J,yt.L,gt.H,W.t,C.y0,M.vZ]},bt=function(){function o(t,e,i,a,n,r,s,u,l,v){this.conceptualSchemaProxy=t,this.customVisualLoader=e,this.dataSources=i,this.explorationNavigation=a,this.explorationStateManager=n,this.explorationSerializer=r,this.explorationState=s,this.promiseFactory=u,this.telemetry=l,this.featureSwitchService=v}return o.prototype.captureOriginalExplorationState=function(t,e){return(0,c.mG)(this,void 0,void 0,function(){var i,a,n,r;return(0,c.Jh)(this,function(s){switch(s.label){case 0:this.captureDeferred=this.promiseFactory.defer(this.featureSwitchService.featureSwitches.telemetryV2),this.capturedOriginalState=!0,i=this.dataSources.get(),s.label=1;case 1:return s.trys.push([1,4,,5]),[4,this.conceptualSchemaProxy.get(i)];case 2:return a=s.sent(),n=void 0,e&&(n=e.createChildActivity({name:"Copy Exploration State"})),[4,this.captureExplorationState(a,t)];case 3:return s.sent(),n&&n.resolve(),this.captureDeferred.resolve(null),[3,5];case 4:return r=s.sent(),this.logAndRejectCapture(r),[3,5];case 5:return[2,this.captureDeferred.promise]}})})},o.prototype.getOriginalExplorationState=function(t){return(0,c.mG)(this,void 0,void 0,function(){return(0,c.Jh)(this,function(e){switch(e.label){case 0:return this.capturedOriginalState?[3,2]:[4,this.captureOriginalExplorationState(t)];case 1:e.sent(),e.label=2;case 2:return[4,this.captureDeferred.promise];case 3:return e.sent(),[2,this.originalExplorationState]}})})},o.prototype.captureExplorationState=function(t,e){return(0,c.mG)(this,void 0,void 0,function(){var i,a,r,s;return(0,c.Jh)(this,function(u){switch(u.label){case 0:return this.featureSwitchService.featureSwitches.deferExplorationStateCapture&&e?(i=(0,mt.K)(e),a=this.explorationSerializer.parseExplorationConfigs(i),r=this.explorationSerializer.deserializeExploration(a,[],!0),(0,Z.gj)(r)?[4,this.ensureUsedCustomVisualResources(r)]:[3,2]):[3,3];case 1:u.sent(),u.label=2;case 2:return this.originalExplorationState=this.explorationState.capture(r,t,{captureAllSections:!0}),[2];case 3:return(s=this.explorationNavigation.getCurrentExploration())&&(0,Z.gj)(s)?[4,this.ensureUsedCustomVisualResources(s)]:[3,5];case 4:u.sent(),u.label=5;case 5:return this.originalExplorationState=this.explorationStateManager.capture(t,{captureAllSections:!0}),[2]}})})},o.prototype.ensureUsedCustomVisualResources=function(t){return(0,c.mG)(this,void 0,void 0,function(){return(0,c.Jh)(this,function(e){switch(e.label){case 0:return this.customVisualLoader.setState(!0),[4,this.customVisualLoader.ensureCustomVisualResources(t)];case 1:return e.sent(),[2]}})})},o.prototype.logAndRejectCapture=function(t){t&&this.telemetry.logEvent(dt,{isFailure:!0,stack:t.stack,message:t.message}),this.captureDeferred.reject(t)},o}(),It=p(41779),Pt=p(94853),Dt=p(73875),wt=p(44511),Q=function(){function o(t,e,i){this.httpService=t,this.telemetryService=e,this.userStateService=i,m.fF.assertValue(t,"httpService")}return o.prototype.save=function(t,e,i){return(0,c.mG)(this,void 0,void 0,function(){var a,n,r,s,u;return(0,c.Jh)(this,function(l){switch(l.label){case 0:try{a=this.userStateService.serialize(t,i)}catch(v){return v&&this.telemetryService.logEvent(It.rj,{stack:v.stack,message:v.message}),[2]}n={userState:JSON.stringify(a)},r=this.telemetryService.startEvent(ft),l.label=1;case 1:return l.trys.push([1,3,,4]),s=this.httpService.powerbiRequestOptions(r.event,"SaveUserState"),[4,this.httpService.post("explore/reports/".concat(e,"/userState"),n,s)];case 2:return l.sent(),r.resolve(),[3,4];case 3:return u=l.sent(),this.handleError(u,r),[3,4];case 4:return[2]}})})},o.prototype.delete=function(t,e){return(0,c.mG)(this,void 0,void 0,function(){var i,a,n;return(0,c.Jh)(this,function(r){switch(r.label){case 0:i=e?this.telemetryService.startChildEvent(e.event,B):this.telemetryService.startEvent(B),r.label=1;case 1:return r.trys.push([1,3,,4]),a=this.httpService.powerbiRequestOptions(i.event,"DeleteUserState"),[4,this.httpService.delete("explore/reports/".concat(t,"/userState"),a)];case 2:return r.sent(),i.resolve(),[3,4];case 3:return n=r.sent(),this.handleError(n,i),[3,4];case 4:return[2]}})})},o.prototype.handleError=function(t,e){e.reject((0,Pt.GB)(t&&t.error,t&&t.status))},o.\u0275fac=function(e){return new(e||o)(y.\u0275\u0275inject(Dt.O),y.\u0275\u0275inject(C.y0),y.\u0275\u0275inject(wt.P))},o.\u0275prov=y.\u0275\u0275defineInjectable({token:o,factory:o.\u0275fac,providedIn:"root"}),o}(),K=p(73192),Y=p(19276),X=p(17328),$=p(80068),q=new y.InjectionToken("PersistentStateThrottleTime"),tt=p(76072),Ft=p(61903),Vt=p(84376),Ut={provide:"persistentState",useFactory:function(o,t,e,i,a,n,r,s,u,l,v,h,f,d,S,x,E){return new Ot(o,t,e,i,a,n,r,s,u,l,v,h,f,d,S,x,E)},deps:[V.i,U.D,D.H,Y.j,z.J,b.z,W.t,C.y0,M.vZ,K.u,X.F,P.J,Q,tt.E,F.o,[new y.Optional,q],[new y.Optional,$.g]]},Ot=function(){function o(t,e,i,a,n,r,s,u,l,v,h,f,d,S,x,E,R){this.conceptualSchemaProxy=t,this.dataSources=e,this.lazyScopedProviderModern=i,this.explorationStateApplier=a,this.navigation=r,this.promiseFactory=s,this.telemetry=u,this.featureSwitchService=l,this.explorationProxy=v,this.formFactor=h,this.eventBridge=f,this.persistentStateProxy=d,this.lazyProvider=S,this.localizationService=x,this.persistentStateThrottleTimeInjectionToken=E,this.mobileStateResetInjectionToken=R,this.setupThrottledSave();var jt=l&&l.isFeatureSwitchesRegistered()&&l.featureSwitches.telemetryV2;this.initializationDeferred=this.promiseFactory.defer(jt),this.core=new Tt(t,e,n,r,l,d,S)}return o.prototype.init=function(t,e){return(0,c.mG)(this,void 0,void 0,function(){var i,a,n,r,s,u=this;return(0,c.Jh)(this,function(l){switch(l.label){case 0:if(this.options=t,i=this.navigation.getCurrentExploration(),a=i.userState,this.wireContractJSON=e,n=!1,!a||!a.explorationState)return[3,9];l.label=1;case 1:return l.trys.push([1,7,,8]),this.shouldDeferCapture(this.featureSwitchService.featureSwitches.deferExplorationStateCapture,!!this.wireContractJSON)?[3,4]:(this.initializationStarted=!0,r=this,[4,this.getOriginalExplorationState()]);case 2:return r.originalExplorationState=l.sent(),[4,this.applyUserState(i.userState,t.openReportContextActivity)];case 3:return l.sent(),this.initializationDeferred.resolve(null),n=!0,[3,6];case 4:return[4,this.applyUserState(i.userState,t.openReportContextActivity)];case 5:l.sent(),l.label=6;case 6:return[3,8];case 7:return s=l.sent(),this.logAndRejectInit(s),[3,8];case 8:return[3,10];case 9:this.shouldDeferCapture(this.featureSwitchService.featureSwitches.deferExplorationStateCapture,!!this.wireContractJSON)||(this.initializationStarted=!0,this.getOriginalExplorationState().then(function(){u.initializationDeferred.resolve(null)}).catch(_.noop)),l.label=10;case 10:return[2,n]}})})},o.prototype.awaitInitialization=function(t){return(0,c.mG)(this,void 0,void 0,function(){var e=this;return(0,c.Jh)(this,function(i){switch(i.label){case 0:return!this.initializationStarted&&!t&&(this.initializationStarted=!0,this.getOriginalExplorationState().then(function(){return e.initializationDeferred.resolve(null)},function(a){return e.initializationDeferred.reject(a)})),[4,this.initializationDeferred.promise];case 1:return i.sent(),[2]}})})},o.prototype.reset=function(){this.initializationDeferred.reject(),this.isUserStateDirty=!1,this.originalExplorationState=null,this.initializationDeferred=this.promiseFactory.defer(),this.initializationStarted=!1,this.cancelThrottledSave()},o.prototype.saveState=function(t){return(0,c.mG)(this,void 0,void 0,function(){var e,i;return(0,c.Jh)(this,function(a){switch(a.label){case 0:return[4,this.awaitInitialization(!0)];case 1:return a.sent(),e=t||this.navigation.getCurrentExploration(),i=e.userState,this.isUserStateDirty?(this.cancelThrottledSave(),this.isUserStateDirty=!1,[2,this.core.save(i,e.reportId)]):[2]}})})},o.prototype.captureUserState=function(){return(0,c.mG)(this,void 0,void 0,function(){var t,e,i;return(0,c.Jh)(this,function(a){switch(a.label){case 0:return[4,this.awaitInitialization()];case 1:return a.sent(),t=this,[4,this.getOriginalExplorationState()];case 2:return t.originalExplorationState=a.sent(),e=this.navigation.getCurrentExploration(),[4,this.core.capture(this.originalExplorationState)];case 3:return function(o,t){if(o===t||_.isEmpty(o)&&_.isEmpty(t))return!0;if(_.isEmpty(o)||_.isEmpty(t))return!1;if(o.bookmarkRef||t.bookmarkRef)return _.isEqual(o.bookmarkRef,t.bookmarkRef);var e=o.explorationState,i=t.explorationState;return!!(e===i||_.isEmpty(e)&&_.isEmpty(i))||_.isEqual(e,i)}(i=a.sent(),e.userState)||(e.userState=i,this.isUserStateDirty=!0,this.options.persistentUserStateThrottlingEnabled&&this.throttledSave(i,e.reportId)),[2]}})})},o.prototype.clearUserState=function(t,e,i,a){return(0,c.mG)(this,void 0,void 0,function(){var n,r,s,u,l,v;return(0,c.Jh)(this,function(f){switch(f.label){case 0:return n=this.navigation.getCurrentExploration(),r=n.reportId,s=!_.isEmpty(n.userState),e?(u=this.explorationProxy.get({allowResultFromClientCache:!0,id:r,parentActivity:i}),l=void 0,this.mobileStateResetInjectionToken?[4,this.getExplorationWithMobileState(u,r)]:[3,2]):[3,7];case 1:return l=f.sent(),[3,4];case 2:return[4,u];case 3:l=f.sent().exploration,f.label=4;case 4:return a&&l&&n?.settings&&(l.settings=l.settings||{},l.settings.pagesPosition=n.settings.pagesPosition),v=this.resetExplorationStateAndReturnTargetIndex(n,l),t.viewModel.exploration=(0,Ft.vi)(l,this.formFactor.getCurrentLayout(),v,void 0,this.localizationService),this.navigation.loadExploration(l),this.navigation.updateActiveSection({targetSectionIndex:v,forceUpdate:!0,suppressHistory:!0,parentActivity:i}),[4,this.lazyScopedProviderModern.get("originalExplorationState")];case 5:return[4,f.sent().captureOriginalExplorationState(this.wireContractJSON)];case 6:f.sent(),f.label=7;case 7:return s?[4,this.clearInternal(r,i)]:[3,9];case 8:f.sent(),f.label=9;case 9:return[2]}})})},o.prototype.resetVisualContainer=function(t){return(0,c.mG)(this,void 0,void 0,function(){var n,r,s,u,l,v,h;return(0,c.Jh)(this,function(f){switch(f.label){case 0:return h=this.navigation.getCurrentExploration(),n=h.sections[h.activeSectionIndex].name,[4,this.explorationProxy.get({allowResultFromClientCache:!0,id:h.reportId})];case 1:return r=f.sent().exploration,(s=_.find(r.sections,function(d){return d.name===n}))&&(u=t.name,(l=_.find(s.visualContainers,function(d){return d.name===u}))&&(v=t.config.singleVisual.display,t.config=l.config,t.config.singleVisual.display=v,t.filters=l.filters,t.drillMode=l.drillMode,this.eventBridge.publishToChannel(w.jCS,{allowResultFromClientCache:!0,sourceLabelKey:"UserAction_EditVisual",affectContainer:function(S){return S.name===u}}))),[2]}})})},o.prototype.shouldDeferCapture=function(t,e){return t&&e},o.prototype.getExplorationWithMobileState=function(t,e){return(0,c.mG)(this,void 0,void 0,function(){var i,a,n;return(0,c.Jh)(this,function(s){switch(s.label){case 0:return[4,this.lazyProvider.get("@powerbi/MobileExplore/mobile-explore.module#MobileExploreModule","mobileStateHttpService")];case 1:return i=s.sent(),[4,t];case 2:return a=s.sent(),[4,i.get(e,a.exploration.reportObjectsProperties,this.telemetry.startEvent(Vt.Nq))];case 3:return n=s.sent(),!_.isEmpty(n.visualPositions)||n.bookmark?[4,this.lazyScopedProviderModern.get("mobileStateConsumptionService")]:[3,5];case 4:return[2,s.sent().apply(this.formFactor.getCurrentLayout(),a.exploration,n)||a.exploration];case 5:return[2,a.exploration]}})})},o.prototype.resetExplorationStateAndReturnTargetIndex=function(t,e){e.userState=null,e.activeWebBookmark=null,t.themeCollection.highContrastTheme&&(e.themeCollection.highContrastTheme=t.themeCollection.highContrastTheme);var i=t.activeSectionIndex;return(null==i||i<0||i>=e.sections.length)&&(i=0),i},o.prototype.clearInternal=function(t,e){return(0,c.mG)(this,void 0,void 0,function(){return(0,c.Jh)(this,function(i){switch(i.label){case 0:return[4,this.awaitInitialization()];case 1:return i.sent(),this.cancelThrottledSave(),this.isUserStateDirty=!1,[2,this.core.delete(t,e)]}})})},o.prototype.applyUserState=function(t,e){return(0,c.mG)(this,void 0,void 0,function(){var i,a,n,r;return(0,c.Jh)(this,function(s){switch(s.label){case 0:if(!t||!t.explorationState)return[2];i=this.explorationStateApplier.createApplyBookmarkActivity("PersistentStateInit",e),s.label=1;case 1:return s.trys.push([1,3,,4]),a=this.dataSources.get(),[4,this.conceptualSchemaProxy.get(a)];case 2:return n=s.sent(),this.explorationStateApplier.applyDirty(t.explorationState,n,{clearUnmatchedData:!1,suppressActiveSection:!0,suppressData:!1,suppressDisplay:{outspacePane:!1,visuals:!0},stopDataQueries:!0,clearQueryCaches:!0,isPersistentState:!0},i),this.telemetry.logEvent(N,{isFailure:!1}),i.resolve(),[3,4];case 3:throw r=s.sent(),i.reject(r),r;case 4:return[2]}})})},o.prototype.setupThrottledSave=function(){var t=this,e=this.featureSwitchService.featureSwitches.teamsThrottledSave&&this.persistentStateThrottleTimeInjectionToken?this.persistentStateThrottleTimeInjectionToken:6e4;this.throttledSave=_.throttle(function(i,a){t.isUserStateDirty=!1,t.telemetry.logEvent(St,{throttleTime:e}),t.core.save(i,a)},e,{trailing:!0,leading:!1})},o.prototype.cancelThrottledSave=function(){this.throttledSave.cancel()},o.prototype.logAndRejectInit=function(t){t&&this.telemetry.logEvent(N,{isFailure:!0,stack:t.stack,message:t.message}),m.fF.assertValue(this.initializationDeferred,"init deferred should exist"),this.initializationDeferred.reject(t)},o.prototype.getOriginalExplorationState=function(){return(0,c.mG)(this,void 0,void 0,function(){return(0,c.Jh)(this,function(e){switch(e.label){case 0:return[4,this.lazyScopedProviderModern.get("originalExplorationState")];case 1:return[2,e.sent().getOriginalExplorationState(this.wireContractJSON)]}})})},(0,c.gn)([(0,c.fM)(15,(0,y.Optional)()),(0,c.fM)(15,(0,y.Inject)(q)),(0,c.fM)(16,(0,y.Optional)()),(0,c.fM)(16,(0,y.Inject)($.g)),(0,c.w6)("design:paramtypes",[V.i,U.D,D.H,Y.j,z.J,b.z,Object,C.y0,M.vZ,K.u,X.F,P.J,Q,tt.E,F.o,Number,Boolean])],o)}(),Tt=function(){function o(t,e,i,a,n,r,s){this.conceptualSchemaProxy=t,this.dataSources=e,this.explorationStateManager=i,this.explorationNavigationService=a,this.featureSwitchService=n,this.proxy=r,this.lazyProvider=s}return o.prototype.capture=function(t){return(0,c.mG)(this,void 0,void 0,function(){var e,i,a,n,r,s;return(0,c.Jh)(this,function(u){switch(u.label){case 0:return m.fF.assertValue(t,"Exploration State never initialized"),this.featureSwitchService.featureSwitches.userStateBookmarkImprovements&&(e=this.tryCaptureActiveBookmark())?[2,{bookmarkRef:e}]:[4,this.conceptualSchemaProxy.get(this.dataSources.get())];case 1:return i=u.sent(),a=this.explorationStateManager.capture(i,{captureAllSections:!0,capturePresentation:!1}),[4,this.lazyProvider.get("@powerbi/ExplorationPersistentState/exploration-persistent-state.module#ExplorationPersistentStateModule","explorationStateDiffer")];case 2:return n=u.sent(),r=n.diff(t,a,this.featureSwitchService),s=r&&_.isEmpty(r.filters)&&_.isEmpty(r.objects)&&_.isEmpty(r.sections)&&_.isEmpty(r.dataSourceVariables),_.isEmpty(r)||s?[2]:[2,{explorationState:r}]}})})},o.prototype.save=function(t,e){return _.isEmpty(t)||_.isEmpty(t.explorationState)&&_.isEmpty(t.bookmarkRef)?this.delete(e):(m.fF.assert(function(){return!!t.bookmarkRef||!!t.explorationState},"expected a value for userState"),this.proxy.save(t,e,this.featureSwitchService))},o.prototype.delete=function(t,e){return this.proxy.delete(t,e)},o.prototype.tryCaptureActiveBookmark=function(){var t=this.explorationNavigationService.getCurrentExploration();return t.activeBookmark?{ref:t.activeBookmark.name}:t.activeWebBookmark&&2===t.activeWebBookmark.type?{bookmark:t.activeWebBookmark}:void 0},o}(),Ht=function(){function o(){}return o.\u0275fac=function(e){return new(e||o)},o.\u0275mod=y.\u0275\u0275defineNgModule({type:o}),o.\u0275inj=y.\u0275\u0275defineInjector({providers:[ut,Ct,Ut,{provide:"explorationStateDiffer",useExisting:ht}]}),o}()}}]);